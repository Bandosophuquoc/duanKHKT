


<!doctype html>
<html lang="vi">
<head>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc ‚Äî D·ª± √°n KHKT: T·ª± h√†o qu√™ h∆∞∆°ng</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --accent:#C62828; /* ƒë·ªè */
    --gold:#FFD54F;
    --bg:#FBFBFB;
    --nature:#A5D6A7; /* Xanh l√° pastel */
    --culture:#FFCC80; /* Cam pastel */
    --entertainment:#CE93D8; /* T√≠m pastel */
    --craft:#EF9A9A; /* ƒê·ªè pastel */
  }
  body{font-family: "Noto Sans", system-ui, sans-serif; background:var(--bg); color:#111;}
  .container-main{max-width:1100px;margin:auto;}
  .logo{width:60px;height:60px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#B71C1C);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:22px}
  .hero{background:linear-gradient(90deg, rgba(198,40,40,0.06), rgba(255,213,79,0.02));padding:22px;border-radius:12px;margin:18px 0}
  .btn-accent{background:linear-gradient(90deg,var(--accent),#EF5350);color:white;border:none}
  #map{height:64vh;border-radius:12px}
  .badge-img{width:56px;height:56px;border-radius:8px;object-fit:cover}
  .marker-emoji{font-size:20px}
  .diatic-title{font-weight:700}
  .game-card{border-radius:10px;background:white;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  footer{padding:18px 0;color:#666;text-align:center;margin-top:18px}
  .correct{color:green;font-weight:700}
  .wrong{color:#c62828;font-weight:700}
  .explain{font-size:0.95rem;color:#444}
  
  /* Overlay khi m·ªü menu */
  .menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    display: none;
  }
  .menu-overlay.active {
    display: block;
  }
  
  /* Menu dropdown */
  .menu-dropdown {
    position: absolute;
    top: 70px;
    right: 10px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    z-index: 1000;
    min-width: 200px;
    display: none;
    overflow: hidden;
  }
  .menu-dropdown.active {
    display: block;
  }
  .menu-item {
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .menu-item:hover {
    background: #f8f9fa;
  }
  .menu-item:last-child {
    border-bottom: none;
  }
  .menu-item.active {
    background: var(--accent);
    color: white;
  }
  
  /* PQ Stories - Wall of Notes */
  .stories-wall {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    padding: 20px 0;
  }
  .story-note {
    background: #fff9c4;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-left: 5px solid var(--accent);
    position: relative;
    transition: transform 0.3s;
  }
  .story-note:hover {
    transform: translateY(-5px);
  }
  .story-note::before {
    content: '';
    position: absolute;
    top: -10px;
    right: -10px;
    width: 40px;
    height: 40px;
    background: var(--accent);
    border-radius: 50%;
    opacity: 0.1;
  }
  .story-media {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  .story-content {
    margin-bottom: 15px;
    line-height: 1.6;
  }
  .story-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    color: #666;
  }
  .story-actions {
    display: flex;
    gap: 15px;
    margin-top: 10px;
  }
  .story-action {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    transition: color 0.3s;
  }
  .story-action:hover {
    color: var(--accent);
  }
  
  /* Upload form */
  .upload-form {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  .upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 20px;
  }
  .upload-area:hover {
    border-color: var(--accent);
    background: #fff5f5;
  }
  .upload-area i {
    font-size: 3rem;
    color: #dee2e6;
    margin-bottom: 15px;
  }
  
  /* Marker tooltip */
  .marker-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 14px;
    white-space: nowrap;
    z-index: 1000;
    pointer-events: none;
    transform: translateY(-100%);
    margin-top: -10px;
  }
  .marker-tooltip:after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
  }
  
 /* CSS cho game l·∫≠t th·∫ª */
  /* C·∫≠p nh·∫≠t CSS cho game l·∫≠t th·∫ª tr√™n ƒëi·ªán tho·∫°i */
@media (max-width: 767px) {
  .memory-board {
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 12px;
    max-width: 100%;
  }
  
  .memory-card {
    height: 150px !important;
    width: 100%;
    max-width: 200px;
    margin: 0 auto;
  }
  
  .card-back .card-content img {
    max-width: 100%;
    max-height: 100%;
    object-fit: cover;
  }
  
  .stories-wall {
    grid-template-columns: 1fr;
  }
  
  .menu-dropdown {
    right: 5px;
    left: 5px;
    min-width: auto;
  }
}
@media (max-width: 480px) {
  .memory-card {
    height: 140px !important;
    max-width: 180px;
  }
}
@media (max-width: 360px) {
  .memory-card {
    height: 130px !important;
    max-width: 160px;
  }
}
  .memory-container {
    max-width: 100%;
    margin: 0 auto;
    height: 100%;
    overflow-y: auto;
    padding: 15px;
  }
  .memory-stats {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .memory-board {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    max-width: 500px;
    margin: 0 auto;
  }
  .memory-card {
    aspect-ratio: 3/4;
    perspective: 1000px;
    cursor: pointer;
  }
  .card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.6s;
    transform-style: preserve-3d;
  }
  .memory-card.flipped .card-inner {
    transform: rotateY(180deg);
  }
  .memory-card.matched .card-inner {
    transform: rotateY(180deg);
  }
  .memory-card.matched {
    cursor: default;
  }
  .card-front, .card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    box-sizing: border-box;
  }
  .card-front {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  .card-back {
    background: white;
    border: 2px solid #dee2e6;
    transform: rotateY(180deg);
  }
  .card-content {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .card-back .card-content img {
    max-width: 100%;
    max-height: 100%;
    object-fit: cover;
    border-radius: 6px;
  }
  .card-front .card-content i {
    font-size: 2rem;
  }
  .memory-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
    flex-wrap: wrap;
  }
  .memory-complete {
    margin-top: 20px;
  }
  /* Hi·ªáu ·ª©ng l·∫Øc khi sai */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
  /* Hi·ªáu ·ª©ng huy hi·ªáu l·ªõn */
  .badge-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
  }
  .badge-popup-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: popIn 0.5s ease;
    max-width: 300px;
    width: 90%;
  }
  .badge-popup-img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 auto 15px;
    border: 4px solid var(--gold);
    animation: bounce 1s ease infinite;
  }
  .badge-popup-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 10px;
  }
  .badge-popup-message {
    color: #666;
    margin-bottom: 20px;
  }
  /* GAME FULLSCREEN MODE */
  .game-fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    z-index: 9999;
    overflow-y: auto;
    display: none;
  }
  .game-fullscreen.active {
    display: block;
  }
  .game-fullscreen-header {
    background: linear-gradient(90deg, var(--accent), #d32);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  .game-fullscreen-title {
    font-size: 1.3rem;
    font-weight: bold;
    margin: 0;
  }
  .game-fullscreen-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
  }
  .game-fullscreen-body {
    padding: 20px;
    height: calc(100% - 70px);
    overflow-y: auto;
  }
  .quiz-container {
    max-width: 800px;
    margin: 0 auto;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  .quiz-question {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid var(--accent);
  }
  .quiz-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 20px 0;
  }
  .quiz-option {
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
  }
  .quiz-option:hover {
    border-color: var(--accent);
    background: #fff5f5;
  }
  .quiz-option.selected {
    border-color: var(--accent);
    background: #ffeaea;
  }
  .quiz-feedback {
    margin-top: 20px;
    padding: 15px;
    border-radius: 8px;
    display: none;
  }
  .quiz-feedback.correct {
    background: #e8f5e8;
    border: 1px solid #4caf50;
    display: block;
  }
  .quiz-feedback.wrong {
    background: #ffebee;
    border: 1px solid #f44336;
    display: block;
  }
  .quiz-controls {
    margin-top: auto;
    display: flex;
    justify-content: space-between;
    padding: 20px 0;
  }
  /* Victory Popup */
  .victory-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
  }
  .victory-content {
    background: white;
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    animation: popIn 0.5s ease;
    max-width: 400px;
    width: 90%;
    position: relative;
    z-index: 10001;
  }
  .victory-title {
    font-size: 2rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 15px;
  }
  .victory-message {
    color: #666;
    font-size: 1.1rem;
    margin-bottom: 25px;
  }
  /* Profile Page */
  .profile-container {
    max-width: 800px;
    margin: 0 auto;
  }
  .profile-header {
    background: linear-gradient(135deg, var(--accent), #d32);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    text-align: center;
  }
  .profile-badges {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  .profile-auth {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes popIn {
    0% { transform: scale(0.5); opacity: 0; }
    70% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  /* ========== NEW PQ STORIES DESIGN ========== */
  #page-stories {
    min-height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 0;
    margin: 0;
  }
  
  .stories-hero {
    text-align: center;
    padding: 80px 20px 40px;
    background: linear-gradient(135deg, rgba(198,40,40,0.1) 0%, rgba(255,213,79,0.05) 100%);
    position: relative;
    overflow: hidden;
  }
  
  .stories-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="%23C62828" opacity="0.03"><circle cx="20" cy="20" r="5"/><circle cx="80" cy="30" r="8"/><circle cx="40" cy="80" r="6"/><circle cx="70" cy="70" r="4"/></svg>');
    background-size: 200px 200px;
  }
  
  .stories-hero h1 {
    font-size: 3.5rem;
    font-weight: 800;
    color: var(--accent);
    margin-bottom: 15px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    position: relative;
    z-index: 2;
  }
  
  .stories-hero p {
    font-size: 1.3rem;
    color: #555;
    max-width: 600px;
    margin: 0 auto;
    position: relative;
    z-index: 2;
  }
  
  .stories-wall-container {
    position: relative;
    padding: 40px 20px 100px;
    min-height: 60vh;
  }
  
  .stories-wall-new {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
    max-width: 1400px;
    margin: 0 auto;
    position: relative;
    z-index: 2;
  }
  
  .story-note-new {
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  
  .story-note-new::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(90deg, var(--accent), var(--gold));
  }
  
  .story-note-new:hover {
    transform: translateY(-8px) rotate(1deg);
    box-shadow: 0 15px 30px rgba(0,0,0,0.15);
  }
  
  .story-note-new h3 {
    margin-top: 0;
    font-size: 1.3rem;
    color: #333;
    line-height: 1.4;
    margin-bottom: 10px;
  }
  
  .story-content-new {
    flex-grow: 1;
    margin-bottom: 15px;
    line-height: 1.5;
    color: #555;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 5;
    -webkit-box-orient: vertical;
  }
  
  .story-media-new {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 15px;
    max-height: 200px;
    object-fit: cover;
  }
  
  .story-meta-new {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
    color: #777;
    margin-bottom: 10px;
  }
  
  .story-actions-new {
    display: flex;
    gap: 15px;
    margin-top: 10px;
  }
  
  .story-action-new {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
  }
  
  .story-action-new:hover {
    color: var(--accent);
    transform: scale(1.1);
  }
  
  .story-action-new.liked {
    color: #e74c3c;
  }
  
  .story-comments {
    margin-top: 15px;
    border-top: 1px solid rgba(0,0,0,0.1);
    padding-top: 15px;
    display: none;
  }
  
  .story-comment {
    padding: 8px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  
  .story-comment:last-child {
    border-bottom: none;
  }
  
  .story-comment-author {
    font-weight: bold;
    font-size: 0.9rem;
    color: #333;
  }
  
  .story-comment-content {
    font-size: 0.85rem;
    color: #555;
    margin-top: 3px;
  }
  
  .add-comment-form {
    margin-top: 10px;
    display: flex;
    gap: 8px;
  }
  
  .add-comment-input {
    flex-grow: 1;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 0.85rem;
    outline: none;
  }
  
  .add-comment-btn {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .add-comment-btn:hover {
    background: #b71c1c;
  }
  
  .add-story-btn-container {
    position: fixed;
    bottom: 30px;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: center;
    z-index: 10;
  }
  
  .add-story-btn {
    background: linear-gradient(135deg, var(--accent), #d32);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 15px 30px;
    font-size: 1.1rem;
    font-weight: 600;
    box-shadow: 0 5px 20px rgba(198,40,40,0.4);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 100;
  }
  
  .add-story-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(198,40,40,0.5);
  }
  
  .add-story-btn:active {
    transform: translateY(1px);
  }
  
  /* Story Modal */
  .story-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
  }
  
  .story-modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }
  
  .story-modal {
    background: white;
    border-radius: 20px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    transform: scale(0.9);
    transition: all 0.3s;
    position: relative;
  }
  
  .story-modal-overlay.active .story-modal {
    transform: scale(1);
  }
  
  .story-modal-header {
    padding: 25px 30px 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .story-modal-header h2 {
    margin: 0;
    color: var(--accent);
    font-size: 1.5rem;
  }
  
  .story-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #777;
    cursor: pointer;
    transition: color 0.3s;
  }
  
  .story-modal-close:hover {
    color: var(--accent);
  }
  
  .story-modal-body {
    padding: 20px 30px 30px;
  }
  
  .story-form-group {
    margin-bottom: 20px;
  }
  
  .story-form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
  }
  
  .story-form-input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s;
  }
  
  .story-form-input:focus {
    border-color: var(--accent);
    outline: none;
  }
  
  .story-form-textarea {
    min-height: 120px;
    resize: vertical;
  }
  
  .word-count {
    text-align: right;
    font-size: 0.85rem;
    color: #777;
    margin-top: 5px;
  }
  
  .word-count.warning {
    color: #e74c3c;
  }
  
  .upload-area-new {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 15px;
  }
  
  .upload-area-new:hover {
    border-color: var(--accent);
    background: rgba(198,40,40,0.03);
  }
  
  .upload-area-new i {
    font-size: 2.5rem;
    color: #ddd;
    margin-bottom: 10px;
    display: block;
  }
  
  .file-preview-new {
    margin-top: 15px;
    text-align: center;
  }
  
  .file-preview-new img {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    margin-bottom: 10px;
  }
  
  .file-preview-new video {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    margin-bottom: 10px;
  }
  
  .remove-file {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    font-size: 0.85rem;
    cursor: pointer;
  }
  
  .story-modal-footer {
    padding: 20px 30px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
  }
  
  .btn-post-story {
    background: linear-gradient(135deg, var(--accent), #d32);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 30px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .btn-post-story:hover {
    background: linear-gradient(135deg, #b71c1c, #c62828);
    transform: translateY(-2px);
  }
  
  .btn-post-story:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
  }
  
  /* Success Message */
  .success-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 10000;
    transform: translateX(150%);
    transition: transform 0.3s;
  }
  
  .success-message.show {
    transform: translateX(0);
  }
  
  .success-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
  }
  
  /* Note colors */
  .note-color-1 { background: #FFEAA7; }
  .note-color-2 { background: #D8BFD8; }
  .note-color-3 { background: #A5D6A7; }
  .note-color-4 { background: #81D4FA; }
  .note-color-5 { background: #FFCC80; }
  .note-color-6 { background: #F8BBD0; }
  .note-color-7 { background: #C5E1A5; }
  .note-color-8 { background: #B39DDB; }
  
  /* Analytics Dashboard */
  .analytics-dashboard {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  
  .stat-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    border-left: 4px solid var(--accent);
  }
  
  .stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 5px;
  }
  
  .stat-label {
    color: #666;
    font-size: 0.9rem;
  }
  
  .chart-container {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .stories-hero h1 {
      font-size: 2.5rem;
    }
    
    .stories-hero p {
      font-size: 1.1rem;
    }
    
    .stories-wall-new {
      grid-template-columns: 1fr;
    }
    
    .story-modal {
      width: 95%;
    }
    
    .stat-card {
      margin-bottom: 15px;
    }
  }
</style>
</head>
<body>
<div class="container container-main py-3">
  <!-- NAV / header -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex gap-3 align-items-center">
      <div class="logo">
        <i class="fas fa-map" style="color:white; font-size: 24px;"></i>
      </div>
      <div>
        <div style="font-weight:800;font-size:1.15rem">B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc</div>
        <div style="color:#666;font-size:0.9rem">D·ª± √°n KHKT - Gi√°o d·ª•c l√≤ng t·ª± h√†o d√¢n t·ªôc v√† t√¨nh y√™u qu√™ h∆∞∆°ng ƒë·∫•t n∆∞·ªõc cho tu·ªïi tr·∫ª tr∆∞·ªùng THPT An Th·ªõi</div>
      </div>
    </div>
    <div style="position:relative">
      <button id="nav-menu" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-bars me-1"></i>M·ª•c l·ª•c
      </button>
      <div class="menu-dropdown" id="menuDropdown">
        <div class="menu-item active" data-page="home">
          <i class="fas fa-home"></i>Trang ch·ªß
        </div>
        <div class="menu-item" data-page="map">
          <i class="fas fa-map-marked-alt"></i>B·∫£n ƒë·ªì s·ªë
        </div>
        <div class="menu-item" data-page="stories">
          <i class="fas fa-book-open"></i>PQ Stories
        </div>
        <div class="menu-item" data-page="profile">
          <i class="fas fa-user"></i>Trang c√° nh√¢n
        </div>
        <div class="menu-item" data-page="analytics">
          <i class="fas fa-chart-bar"></i>Th·ªëng k√™
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay khi menu m·ªü -->
  <div class="menu-overlay" id="menuOverlay"></div>

  <!-- HOME -->
  <section id="page-home">
    <div class="hero">
      <h1 style="margin:0;color:var(--accent)">B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc</h1>
      <p style="margin-top:10px;margin-bottom:8px; font-size: 1.1rem; line-height: 1.6;">
        <strong>H√†nh tr√¨nh v·ªÅ ngu·ªìn ch∆∞a bao gi·ªù s·ªëng ƒë·ªông v√† c·∫£m x√∫c ƒë·∫øn th·∫ø!</strong>
      </p>
      <p style="margin:0 0 6px 0;color:#444; line-height: 1.6">
        B·∫£n ƒê·ªì S·ªë Ph√∫ Qu·ªëc kh√¥ng ch·ªâ l√† m·ªôt website, ƒë√≥ l√† c√¢y c·∫ßu k·∫øt n·ªëi th·∫ø h·ªá tr·∫ª v·ªõi h√†nh tr√¨nh ƒë·∫ßy t·ª± h√†o c·ªßa cha √¥ng. Ch√∫ng t√¥i m·ªùi b·∫°n b∆∞·ªõc v√†o m·ªôt th·∫ø gi·ªõi n∆°i m·ªói di t√≠ch l√† m·ªôt c√¢u chuy·ªán ch·ªù ƒë∆∞·ª£c k·ªÉ, m·ªói nh√¢n v·∫≠t l·ªãch s·ª≠ l√† m·ªôt ng∆∞·ªùi h√πng ch·ªù ƒë∆∞·ª£c th·∫•u hi·ªÉu.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        T·∫°i ƒë√¢y, b·∫°n s·∫Ω:<br>
        ‚Ä¢ Ch·∫°m v√†o l·ªãch s·ª≠ b·∫±ng c·∫£m x√∫c ch√¢n th·∫≠t nh·∫•t.<br>
        ‚Ä¢ Kh√°m ph√° v·∫ª ƒë·∫πp c·ªßa qu√™ h∆∞∆°ng qua lƒÉng k√≠nh m·ªõi m·∫ª, tr·ª±c quan.<br>
        ‚Ä¢ R√®n luy·ªán t∆∞ duy ph·∫£n bi·ªán v√† k·ªπ nƒÉng k·ªÉ chuy·ªán ƒë·ªÉ tr·ªü th√†nh nh·ªØng ƒë·∫°i s·ª© vƒÉn h√≥a t∆∞∆°ng lai.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        H√£y ƒë·ªÉ ch√∫ng t√¥i ƒë·ªìng h√†nh c√πng b·∫°n tr√™n h√†nh tr√¨nh kh∆°i d·∫≠y l√≤ng t·ª± h√†o d√¢n t·ªôc v√† t√¨nh y√™u v·ªõi m·∫£nh ƒë·∫•t Ph√∫ Qu·ªëc anh h√πng.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        B·∫£n ƒë·ªì s·ªë l√† gi·∫£i ph√°p thu·ªôc khu√¥n kh·ªï d·ª± √°n khoa h·ªçc kƒ© thu·∫≠t "<strong>Gi√°o d·ª•c l√≤ng t·ª± h√†o d√¢n t·ªôc v√† t√¨nh y√™u qu√™ h∆∞∆°ng ƒë·∫•t n∆∞·ªõc cho tu·ªïi tr·∫ª THPT An Th·ªõi</strong>".
      </p>
      <div class="mt-3">
        <button id="btn-start" class="btn btn-accent btn-lg">B·∫Øt ƒë·∫ßu kh√°m ph√°</button>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-md-12">
        <div class="game-card">
          <h5>H∆∞·ªõng d·∫´n nhanh</h5>
          <ol style="padding-left:18px">
            <li>Nh·∫•n "B·∫Øt ƒë·∫ßu kh√°m ph√°" ƒë·ªÉ sang trang b·∫£n ƒë·ªì</li>
            <li>Click marker ƒë·ªÉ xem th√¥ng tin; n·∫øu c√≥ mini-game, b·∫•m "Ch∆°i"</li>
            <li>Truy c·∫≠p "PQ Stories" ƒë·ªÉ chia s·∫ª k√Ω ·ª©c c·ªßa b·∫°n</li>
            <li>V√†o "Trang c√° nh√¢n" ƒë·ªÉ xem th√†nh t√≠ch v√† huy hi·ªáu</li>
            <li>Xem "Th·ªëng k√™" ƒë·ªÉ theo d√µi ho·∫°t ƒë·ªông trang web</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- MAP PAGE -->
  <section id="page-map" style="display:none">
    <div id="map" class="mb-3"></div>
  </section>

  <!-- PQ STORIES PAGE -->
  <section id="page-stories" style="display:none">
    <div class="stories-hero">
      <h1>PQ Stories</h1>
      <p>N∆°i b·∫°n chia s·∫ª v√† lan to·∫£ nh·ªØng c√¢u chuy·ªán ƒë·∫πp v·ªÅ Ph√∫ Qu·ªëc</p>
    </div>
    
    <div class="stories-wall-container">
      <div class="stories-wall-new" id="storiesWallNew">
        <!-- Stories will be dynamically added here -->
      </div>
    </div>
    
    <div class="add-story-btn-container">
      <button class="add-story-btn" id="addStoryBtn">
        <i class="fas fa-plus"></i>
        K·ªÉ c√¢u chuy·ªán c·ªßa ri√™ng b·∫°n t·∫°i ƒë√¢y
      </button>
    </div>
  </section>

  <!-- PROFILE PAGE -->
  <section id="page-profile" style="display:none">
    <div class="profile-container">
      <div class="profile-header">
        <h2>Trang C√° Nh√¢n</h2>
        <p class="mb-0">Qu·∫£n l√Ω t√†i kho·∫£n v√† xem th√†nh t√≠ch c·ªßa b·∫°n</p>
      </div>
      <div class="profile-auth">
        <h4 class="mb-3">T√†i kho·∫£n</h4>
        <div id="profile-info" class="alert alert-info">
          B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u ti·∫øn tr√¨nh v√† nh·∫≠n huy hi·ªáu.
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button id="btn-profile-register" class="btn btn-outline-dark">ƒêƒÉng k√Ω</button>
          <button id="btn-profile-login" class="btn btn-dark">ƒêƒÉng nh·∫≠p</button>
          <button id="btn-profile-logout" class="btn btn-outline-secondary" style="display:none">ƒêƒÉng xu·∫•t</button>
        </div>
      </div>
      <div class="profile-badges">
        <h4 class="mb-3">Huy hi·ªáu c·ªßa b·∫°n</h4>
        <div style="color:#666;font-size:0.9rem" class="mb-3">Khi ho√†n th√†nh c√°c ƒëi·ªÅu ki·ªán, huy hi·ªáu s·∫Ω hi·ªán ·ªü ƒë√¢y.</div>
        <div id="profile-badge-area" class="d-flex gap-3 flex-wrap justify-content-center">
          <!-- Badges will appear here -->
        </div>
      </div>
    </div>
  </section>

  <!-- ANALYTICS PAGE -->
  <section id="page-analytics" style="display:none">
    <div class="profile-container">
      <div class="profile-header">
        <h2>Th·ªëng k√™ & Ph√¢n t√≠ch</h2>
        <p class="mb-0">Theo d√µi ho·∫°t ƒë·ªông v√† t∆∞∆°ng t√°c tr√™n trang web</p>
      </div>
      
      <div class="analytics-dashboard">
        <h4 class="mb-4">T·ªïng quan ho·∫°t ƒë·ªông</h4>
        
        <div class="row">
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div class="stat-number" id="totalVisitors">0</div>
              <div class="stat-label">T·ªïng l∆∞·ª£t truy c·∫≠p</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div class="stat-number" id="uniqueVisitors">0</div>
              <div class="stat-label">Ng∆∞·ªùi d√πng duy nh·∫•t</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div class="stat-number" id="registeredUsers">0</div>
              <div class="stat-label">Ng∆∞·ªùi d√πng ƒëƒÉng k√Ω</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div class="stat-number" id="totalStories">0</div>
              <div class="stat-label">C√¢u chuy·ªán ƒë√£ ƒëƒÉng</div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="chart-container">
              <h5>L∆∞·ª£t truy c·∫≠p theo trang</h5>
              <div id="pageViewsChart">
                <!-- Chart will be rendered here -->
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="chart-container">
              <h5>Thi·∫øt b·ªã truy c·∫≠p</h5>
              <div id="deviceChart">
                <!-- Chart will be rendered here -->
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-12">
            <div class="chart-container">
              <h5>Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h5>
              <div id="recentActivity">
                <!-- Recent activity will be shown here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer>
    D·ª± √°n KHKT ‚Äî THPT An Th·ªõi \
  </footer>
</div>

<!-- Story Modal -->
<div class="story-modal-overlay" id="storyModalOverlay">
  <div class="story-modal">
    <div class="story-modal-header">
      <h2>Chia s·∫ª c√¢u chuy·ªán c·ªßa b·∫°n</h2>
      <button class="story-modal-close" id="storyModalClose">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="story-modal-body">
      <form id="storyFormNew">
        <div class="story-form-group">
          <label for="storyTitleNew">Ti√™u ƒë·ªÅ c√¢u chuy·ªán</label>
          <input type="text" class="story-form-input" id="storyTitleNew" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ h·∫•p d·∫´n...">
        </div>
        
        <div class="story-form-group">
          <label for="storyContentNew">K·ªÉ cho m·ªçi ng∆∞·ªùi nghe c√¢u chuy·ªán c·ªßa b·∫°n</label>
          <textarea class="story-form-input story-form-textarea" id="storyContentNew" placeholder="Chia s·∫ª c√¢u chuy·ªán ƒë√°ng nh·ªõ c·ªßa b·∫°n v·ªÅ Ph√∫ Qu·ªëc... (gi·ªõi h·∫°n 200 t·ª´)"></textarea>
          <div class="word-count" id="wordCount">0/200 t·ª´</div>
        </div>
        
        <div class="story-form-group">
          <label>Th√™m h√¨nh ·∫£nh, video ho·∫∑c √¢m thanh</label>
          <div class="upload-area-new" id="uploadAreaNew">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</p>
            <p class="text-muted" style="font-size: 0.9rem; margin-top: 5px;">H·ªó tr·ª£: ·∫£nh, video, √¢m thanh</p>
            <input type="file" id="fileInputNew" accept="image/*,video/*,audio/*" style="display:none">
          </div>
          <div id="filePreviewNew" class="file-preview-new" style="display:none">
            <!-- Preview will be shown here -->
          </div>
        </div>
      </form>
    </div>
    <div class="story-modal-footer">
      <button class="btn-post-story" id="btnPostStory">ƒêƒÉng story</button>
    </div>
  </div>
</div>

<!-- Success Message -->
<div class="success-message" id="successMessage">
  <i class="fas fa-check-circle"></i>
  <span>B·∫°n ƒë√£ ƒëƒÉng t·∫£i th√†nh c√¥ng c√¢u chuy·ªán c·ªßa m√¨nh</span>
  <button class="success-close" id="successClose">
    <i class="fas fa-times"></i>
  </button>
</div>

<!-- C√°c modal v√† popup kh√°c gi·ªØ nguy√™n -->
<!-- DI T√çCH MODAL -->
<div class="modal fade" id="diModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background:linear-gradient(90deg,var(--accent),#d32);color:white">
        <h5 class="modal-title" id="diTitle"></h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="diBody"></div>
      <div class="modal-footer">
        <div class="me-auto">
          <small class="text-muted">To·∫° ƒë·ªô: <span id="diCoords"></span></small>
        </div>
        <button id="btn-checkin" class="btn btn-outline-success">Check-in (T√¥i ƒë√£ ƒë·∫øn)</button>
        <button id="btn-play" class="btn btn-accent" style="display:none">Ch∆°i mini-game</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>

<!-- GAME FULLSCREEN MODE -->
<div id="gameFullscreen" class="game-fullscreen">
  <div class="game-fullscreen-header">
    <h2 class="game-fullscreen-title" id="gameFullscreenTitle">Mini-game</h2>
    <button class="game-fullscreen-close" id="gameFullscreenClose">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="game-fullscreen-body" id="gameFullscreenBody">
    <!-- N·ªôi dung game s·∫Ω ƒë∆∞·ª£c ƒë·∫∑t ·ªü ƒë√¢y -->
  </div>
</div>

<!-- VICTORY POPUP -->
<div id="victoryPopup" class="victory-popup" style="display:none">
  <div class="victory-content">
    <div class="victory-title">üéâ Chi·∫øn Th·∫Øng!</div>
    <div class="victory-message" id="victoryMessage">B·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc th·ª≠ th√°ch!</div>
    <button id="victoryClose" class="btn btn-accent btn-lg">Tuy·ªát v·ªùi!</button>
  </div>
</div>

<!-- AUTH modal -->
<div class="modal fade" id="authModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="authTitle">ƒêƒÉng k√Ω</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="authAlert" class="alert alert-danger d-none"></div>
        <input id="inName" class="form-control mb-2" placeholder="T√™n hi·ªÉn th·ªã">
        <input id="inEmail" class="form-control mb-2" placeholder="Email">
        <input id="inPass" type="password" class="form-control mb-2" placeholder="M·∫≠t kh·∫©u">
        <div class="form-text">L∆∞u t·∫°i tr√¨nh duy·ªát. ƒê·ªÉ d√πng th·ª±c, s·∫Ω h∆∞·ªõng d·∫´n t√≠ch h·ª£p Firebase.</div>
      </div>
      <div class="modal-footer">
        <button id="authSubmit" class="btn btn-dark">X√°c nh·∫≠n</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">H·ªßy</button>
      </div>
    </div>
  </div>
</div>

<!-- Badge Popup Modal -->
<div id="badgePopup" class="badge-popup" style="display:none">
  <div class="badge-popup-content">
    <img id="badgePopupImg" src="" class="badge-popup-img" alt="Huy hi·ªáu">
    <div id="badgePopupTitle" class="badge-popup-title"></div>
    <div id="badgePopupMessage" class="badge-popup-message">Ch√∫c m·ª´ng! B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c huy hi·ªáu</div>
    <button id="badgePopupClose" class="btn btn-accent">Tuy·ªát v·ªùi!</button>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
/* ---------------------------
  C·∫¨P NH·∫¨T: Th√™m t√≠nh nƒÉng Menu, PQ Stories v√† H·ªá th·ªëng ƒëƒÉng k√Ω/ƒëƒÉng nh·∫≠p
----------------------------*/

// Bi·∫øn to√†n c·ª•c m·ªõi
let currentPage = 'home';
let stories = [];

/* ---------- H·ªÜ TH·ªêNG ƒêƒÇNG K√ù/ƒêƒÇNG NH·∫¨P ---------- */
const STORAGE_USERS = 'pq_users_v2';
const STORAGE_SESSIONS = 'pq_sessions_v1';
const STORAGE_ANALYTICS = 'pq_analytics_v1';

// Kh·ªüi t·∫°o d·ªØ li·ªáu
function initData() {
  // Kh·ªüi t·∫°o users n·∫øu ch∆∞a c√≥
  if (!localStorage.getItem(STORAGE_USERS)) {
    localStorage.setItem(STORAGE_USERS, JSON.stringify([]));
  }
  
  // Kh·ªüi t·∫°o analytics n·∫øu ch∆∞a c√≥
  if (!localStorage.getItem(STORAGE_ANALYTICS)) {
    const initialAnalytics = {
      totalVisits: 0,
      uniqueVisitors: new Set(),
      pageViews: {
        home: 0,
        map: 0,
        stories: 0,
        profile: 0,
        analytics: 0
      },
      devices: {
        desktop: 0,
        mobile: 0,
        tablet: 0
      },
      userActions: [],
      registeredUsers: 0
    };
    localStorage.setItem(STORAGE_ANALYTICS, JSON.stringify(initialAnalytics));
  }
  
  // Ghi nh·∫≠n l∆∞·ª£t truy c·∫≠p
  recordVisit();
}

// Ghi nh·∫≠n l∆∞·ª£t truy c·∫≠p
function recordVisit() {
  const analytics = getAnalytics();
  analytics.totalVisits++;
  
  // T·∫°o visitor ID n·∫øu ch∆∞a c√≥
  let visitorId = localStorage.getItem('pq_visitor_id');
  if (!visitorId) {
    visitorId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('pq_visitor_id', visitorId);
  }
  
  analytics.uniqueVisitors.add(visitorId);
  
  // X√°c ƒë·ªãnh thi·∫øt b·ªã
  const userAgent = navigator.userAgent.toLowerCase();
  if (/mobile|android|iphone|ipad/.test(userAgent)) {
    analytics.devices.mobile++;
  } else if (/tablet|ipad/.test(userAgent)) {
    analytics.devices.tablet++;
  } else {
    analytics.devices.desktop++;
  }
  
  // Ghi nh·∫≠n h√†nh ƒë·ªông
  analytics.userActions.push({
    type: 'page_visit',
    page: currentPage,
    timestamp: new Date().toISOString(),
    visitorId: visitorId
  });
  
  // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng h√†nh ƒë·ªông l∆∞u tr·ªØ
  if (analytics.userActions.length > 1000) {
    analytics.userActions = analytics.userActions.slice(-500);
  }
  
  saveAnalytics(analytics);
}

// Ghi nh·∫≠n l∆∞·ª£t xem trang
function recordPageView(page) {
  const analytics = getAnalytics();
  if (analytics.pageViews[page] !== undefined) {
    analytics.pageViews[page]++;
    
    analytics.userActions.push({
      type: 'page_view',
      page: page,
      timestamp: new Date().toISOString(),
      visitorId: localStorage.getItem('pq_visitor_id')
    });
    
    saveAnalytics(analytics);
  }
}

// L·∫•y d·ªØ li·ªáu analytics
function getAnalytics() {
  const data = JSON.parse(localStorage.getItem(STORAGE_ANALYTICS) || '{}');
  // Kh√¥i ph·ª•c Set t·ª´ Array
  if (data.uniqueVisitors && Array.isArray(data.uniqueVisitors)) {
    data.uniqueVisitors = new Set(data.uniqueVisitors);
  }
  return data;
}

// L∆∞u d·ªØ li·ªáu analytics
function saveAnalytics(analytics) {
  // Chuy·ªÉn Set th√†nh Array ƒë·ªÉ l∆∞u tr·ªØ
  const dataToSave = {
    ...analytics,
    uniqueVisitors: Array.from(analytics.uniqueVisitors)
  };
  localStorage.setItem(STORAGE_ANALYTICS, JSON.stringify(dataToSave));
}

// Hi·ªÉn th·ªã analytics
function renderAnalytics() {
  const analytics = getAnalytics();
  
  // C·∫≠p nh·∫≠t s·ªë li·ªáu
  document.getElementById('totalVisitors').textContent = analytics.totalVisits;
  document.getElementById('uniqueVisitors').textContent = analytics.uniqueVisitors.size;
  document.getElementById('registeredUsers').textContent = analytics.registeredUsers || 0;
  document.getElementById('totalStories').textContent = stories.length;
  
  // Hi·ªÉn th·ªã l∆∞·ª£t xem trang
  const pageViewsHtml = Object.entries(analytics.pageViews).map(([page, views]) => `
    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
      <span>${getPageName(page)}</span>
      <span class="badge bg-primary">${views}</span>
    </div>
  `).join('');
  document.getElementById('pageViewsChart').innerHTML = pageViewsHtml || '<p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
  
  // Hi·ªÉn th·ªã thi·∫øt b·ªã
  const deviceHtml = Object.entries(analytics.devices).map(([device, count]) => `
    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
      <span>${getDeviceName(device)}</span>
      <span class="badge bg-info">${count}</span>
    </div>
  `).join('');
  document.getElementById('deviceChart').innerHTML = deviceHtml || '<p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
  
  // Hi·ªÉn th·ªã ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
  const recentActions = analytics.userActions.slice(-10).reverse();
  const activityHtml = recentActions.map(action => `
    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
      <div>
        <small class="text-muted">${formatTimeAgo(action.timestamp)}</small>
        <div>${getActionDescription(action)}</div>
      </div>
    </div>
  `).join('');
  document.getElementById('recentActivity').innerHTML = activityHtml || '<p class="text-muted">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</p>';
}

function getPageName(page) {
  const pages = {
    home: 'Trang ch·ªß',
    map: 'B·∫£n ƒë·ªì',
    stories: 'PQ Stories',
    profile: 'Trang c√° nh√¢n',
    analytics: 'Th·ªëng k√™'
  };
  return pages[page] || page;
}

function getDeviceName(device) {
  const devices = {
    desktop: 'M√°y t√≠nh',
    mobile: 'ƒêi·ªán tho·∫°i',
    tablet: 'M√°y t√≠nh b·∫£ng'
  };
  return devices[device] || device;
}

function getActionDescription(action) {
  switch (action.type) {
    case 'page_visit':
      return `Truy c·∫≠p ${getPageName(action.page)}`;
    case 'page_view':
      return `Xem ${getPageName(action.page)}`;
    case 'user_register':
      return 'ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi';
    case 'user_login':
      return 'ƒêƒÉng nh·∫≠p';
    case 'story_post':
      return 'ƒêƒÉng c√¢u chuy·ªán m·ªõi';
    default:
      return action.type;
  }
}

/* ---------- H·ªÜ TH·ªêNG NG∆Ø·ªúI D√ôNG ---------- */
function getUsers() {
  return JSON.parse(localStorage.getItem(STORAGE_USERS) || '[]');
}

function saveUsers(users) {
  localStorage.setItem(STORAGE_USERS, JSON.stringify(users));
}

function findUserByEmail(email) {
  const users = getUsers();
  return users.find(user => user.email === email);
}

function registerUser(name, email, password) {
  const users = getUsers();
  
  // Ki·ªÉm tra email ƒë√£ t·ªìn t·∫°i
  if (findUserByEmail(email)) {
    return { success: false, message: 'Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng' };
  }
  
  // T·∫°o user m·ªõi
  const newUser = {
    id: 'user_' + Date.now(),
    name: name,
    email: email,
    password: password, // Trong th·ª±c t·∫ø n√™n m√£ h√≥a password
    createdAt: new Date().toISOString(),
    badges: [],
    visitedSites: [],
    completedGames: {}
  };
  
  users.push(newUser);
  saveUsers(users);
  
  // C·∫≠p nh·∫≠t analytics
  const analytics = getAnalytics();
  analytics.registeredUsers = users.length;
  analytics.userActions.push({
    type: 'user_register',
    email: email,
    timestamp: new Date().toISOString()
  });
  saveAnalytics(analytics);
  
  return { success: true, user: newUser };
}

function loginUser(email, password) {
  const user = findUserByEmail(email);
  
  if (!user) {
    return { success: false, message: 'Email kh√¥ng t·ªìn t·∫°i' };
  }
  
  if (user.password !== password) {
    return { success: false, message: 'M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng' };
  }
  
  // T·∫°o session
  const session = {
    userId: user.id,
    token: 'token_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // 7 ng√†y
  };
  
  localStorage.setItem(STORAGE_SESSIONS, JSON.stringify(session));
  
  // C·∫≠p nh·∫≠t analytics
  const analytics = getAnalytics();
  analytics.userActions.push({
    type: 'user_login',
    email: email,
    timestamp: new Date().toISOString()
  });
  saveAnalytics(analytics);
  
  return { success: true, user: user };
}

function getCurrentUser() {
  const session = JSON.parse(localStorage.getItem(STORAGE_SESSIONS) || 'null');
  
  if (!session || new Date(session.expiresAt) < new Date()) {
    // Session h·∫øt h·∫°n
    localStorage.removeItem(STORAGE_SESSIONS);
    return null;
  }
  
  const users = getUsers();
  return users.find(user => user.id === session.userId) || null;
}

function logoutUser() {
  localStorage.removeItem(STORAGE_SESSIONS);
  return { success: true };
}

function updateUser(user) {
  const users = getUsers();
  const index = users.findIndex(u => u.id === user.id);
  if (index !== -1) {
    users[index] = user;
    saveUsers(users);
    return true;
  }
  return false;
}

/* ---------- Menu Navigation ---------- */
const menuBtn = document.getElementById('nav-menu');
const menuDropdown = document.getElementById('menuDropdown');
const menuOverlay = document.getElementById('menuOverlay');
const menuItems = document.querySelectorAll('.menu-item');

// Toggle menu
menuBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  menuDropdown.classList.toggle('active');
  menuOverlay.classList.toggle('active');
});

// ƒê√≥ng menu khi click overlay
menuOverlay.addEventListener('click', () => {
  menuDropdown.classList.remove('active');
  menuOverlay.classList.remove('active');
});

// X·ª≠ l√Ω ch·ªçn menu item
menuItems.forEach(item => {
  item.addEventListener('click', () => {
    const page = item.dataset.page;
    showPage(page);
    menuDropdown.classList.remove('active');
    menuOverlay.classList.remove('active');
    
    // C·∫≠p nh·∫≠t active state
    menuItems.forEach(i => i.classList.remove('active'));
    item.classList.add('active');
  });
});

// H√†m hi·ªÉn th·ªã trang
function showPage(page) {
  // ·∫®n t·∫•t c·∫£ c√°c trang
  document.querySelectorAll('section[id^="page-"]').forEach(section => {
    section.style.display = 'none';
  });
  
  // Hi·ªÉn th·ªã trang ƒë∆∞·ª£c ch·ªçn
  document.getElementById(`page-${page}`).style.display = 'block';
  
  // Ghi nh·∫≠n l∆∞·ª£t xem trang
  recordPageView(page);
  
  // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho t·ª´ng trang
  if (page === 'map') {
    setTimeout(() => map.invalidateSize(), 300);
  } else if (page === 'stories') {
    loadStories();
  } else if (page === 'analytics') {
    renderAnalytics();
  }
  
  currentPage = page;
}

/* ---------- NEW PQ STORIES FUNCTIONALITY ---------- */
const addStoryBtn = document.getElementById('addStoryBtn');
const storyModalOverlay = document.getElementById('storyModalOverlay');
const storyModalClose = document.getElementById('storyModalClose');
const storyFormNew = document.getElementById('storyFormNew');
const uploadAreaNew = document.getElementById('uploadAreaNew');
const fileInputNew = document.getElementById('fileInputNew');
const filePreviewNew = document.getElementById('filePreviewNew');
const storiesWallNew = document.getElementById('storiesWallNew');
const storyContentNew = document.getElementById('storyContentNew');
const wordCount = document.getElementById('wordCount');
const btnPostStory = document.getElementById('btnPostStory');
const successMessage = document.getElementById('successMessage');
const successClose = document.getElementById('successClose');

// M·ªü modal khi click n√∫t th√™m story
addStoryBtn.addEventListener('click', () => {
  const user = getCurrentUser();
  if (!user) {
    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ chia s·∫ª c√¢u chuy·ªán.');
    showPage('profile');
    return;
  }
  storyModalOverlay.classList.add('active');
});

// ƒê√≥ng modal
storyModalClose.addEventListener('click', () => {
  storyModalOverlay.classList.remove('active');
});

// ƒê√≥ng modal khi click b√™n ngo√†i
storyModalOverlay.addEventListener('click', (e) => {
  if (e.target === storyModalOverlay) {
    storyModalOverlay.classList.remove('active');
  }
});

// Upload area click
uploadAreaNew.addEventListener('click', () => {
  fileInputNew.click();
});

// File input change
fileInputNew.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      let previewHTML = '';
      
      if (file.type.startsWith('image/')) {
        previewHTML = `<img src="${e.target.result}" alt="Preview">`;
      } else if (file.type.startsWith('video/')) {
        previewHTML = `<video controls><source src="${e.target.result}" type="${file.type}">Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.</video>`;
      } else if (file.type.startsWith('audio/')) {
        previewHTML = `<audio controls><source src="${e.target.result}" type="${file.type}">Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ audio.</audio>`;
      } else {
        previewHTML = `<p>File: ${file.name}</p>`;
      }
      
      previewHTML += `<button class="remove-file" onclick="removeFile()">X√≥a</button>`;
      filePreviewNew.innerHTML = previewHTML;
      filePreviewNew.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
});

// X√≥a file preview
function removeFile() {
  filePreviewNew.style.display = 'none';
  fileInputNew.value = '';
}

// ƒê·∫øm s·ªë t·ª´
storyContentNew.addEventListener('input', () => {
  const content = storyContentNew.value;
  const words = content.trim() === '' ? 0 : content.trim().split(/\s+/).length;
  wordCount.textContent = `${words}/200 t·ª´`;
  
  if (words > 200) {
    wordCount.classList.add('warning');
    btnPostStory.disabled = true;
  } else {
    wordCount.classList.remove('warning');
    btnPostStory.disabled = false;
  }
});

// Story form submit
btnPostStory.addEventListener('click', (e) => {
  e.preventDefault();
  
  const title = document.getElementById('storyTitleNew').value;
  const content = document.getElementById('storyContentNew').value;
  const user = getCurrentUser();
  
  if (!user) {
    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ chia s·∫ª c√¢u chuy·ªán.');
    return;
  }
  
  if (!title || !content) {
    alert('Vui l√≤ng ƒëi·ªÅn ti√™u ƒë·ªÅ v√† n·ªôi dung c√¢u chuy·ªán.');
    return;
  }
  
  const words = content.trim().split(/\s+/).length;
  if (words > 200) {
    alert('N·ªôi dung c√¢u chuy·ªán v∆∞·ª£t qu√° 200 t·ª´. Vui l√≤ng r√∫t g·ªçn.');
    return;
  }
  
  const newStory = {
    id: Date.now(),
    title: title,
    content: content,
    author: user.name,
    authorId: user.id,
    timestamp: new Date().toISOString(),
    likes: 0,
    comments: [],
    liked: false,
    media: fileInputNew.files[0] ? URL.createObjectURL(fileInputNew.files[0]) : null,
    mediaType: fileInputNew.files[0] ? fileInputNew.files[0].type : null,
    colorClass: `note-color-${Math.floor(Math.random() * 8) + 1}`
  };
  
  // Th√™m story v√†o m·∫£ng
  stories.unshift(newStory);
  
  // L∆∞u v√†o localStorage
  saveStories();
  
  // C·∫≠p nh·∫≠t giao di·ªán
  renderStories();
  
  // ƒê√≥ng modal
  storyModalOverlay.classList.remove('active');
  
  // Reset form
  storyFormNew.reset();
  filePreviewNew.style.display = 'none';
  fileInputNew.value = '';
  wordCount.textContent = '0/200 t·ª´';
  wordCount.classList.remove('warning');
  
  // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
  showSuccessMessage();
});

// Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
function showSuccessMessage() {
  successMessage.classList.add('show');
  
  // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
  setTimeout(() => {
    successMessage.classList.remove('show');
  }, 5000);
}

// ƒê√≥ng th√¥ng b√°o th√†nh c√¥ng
successClose.addEventListener('click', () => {
  successMessage.classList.remove('show');
});

// Load stories t·ª´ localStorage
function loadStories() {
  const savedStories = localStorage.getItem('pq_stories');
  if (savedStories) {
    stories = JSON.parse(savedStories);
  }
  renderStories();
}

// Save stories to localStorage
function saveStories() {
  localStorage.setItem('pq_stories', JSON.stringify(stories));
}

// Render stories
function renderStories() {
  storiesWallNew.innerHTML = '';
  
  if (stories.length === 0) {
    storiesWallNew.innerHTML = `
      <div class="col-12 text-center py-5" style="grid-column: 1 / -1;">
        <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Ch∆∞a c√≥ c√¢u chuy·ªán n√†o</h4>
        <p class="text-muted">H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n chia s·∫ª k√Ω ·ª©c v·ªÅ Ph√∫ Qu·ªëc!</p>
      </div>
    `;
    return;
  }
  
  stories.forEach(story => {
    const storyElement = document.createElement('div');
    storyElement.className = `story-note-new ${story.colorClass}`;
    storyElement.innerHTML = `
      <div>
        <h3>${story.title}</h3>
        ${story.media ? (
          story.mediaType.startsWith('image/') ? 
            `<img src="${story.media}" alt="${story.title}" class="story-media-new">` :
          story.mediaType.startsWith('video/') ? 
            `<video controls class="story-media-new"><source src="${story.media}" type="${story.mediaType}">Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.</video>` :
          story.mediaType.startsWith('audio/') ? 
            `<audio controls class="story-media-new"><source src="${story.media}" type="${story.mediaType}">Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ audio.</audio>` :
            ''
        ) : ''}
        <div class="story-content-new">${story.content}</div>
      </div>
      <div>
        <div class="story-meta-new">
          <span>${story.author}</span>
          <span>${formatTimeAgo(story.timestamp)}</span>
        </div>
        <div class="story-actions-new">
          <div class="story-action-new ${story.liked ? 'liked' : ''}" onclick="likeStory(${story.id})">
            <i class="fas fa-heart"></i>
            <span>${story.likes}</span>
          </div>
          <div class="story-action-new" onclick="toggleComments(${story.id})">
            <i class="fas fa-comment"></i>
            <span>${story.comments.length}</span>
          </div>
        </div>
        <div class="story-comments" id="comments-${story.id}">
          ${story.comments.map(comment => `
            <div class="story-comment">
              <div class="story-comment-author">${comment.author}</div>
              <div class="story-comment-content">${comment.content}</div>
            </div>
          `).join('')}
          <div class="add-comment-form">
            <input type="text" class="add-comment-input" id="comment-input-${story.id}" placeholder="Vi·∫øt b√¨nh lu·∫≠n...">
            <button class="add-comment-btn" onclick="addComment(${story.id})">G·ª≠i</button>
          </div>
        </div>
      </div>
    `;
    storiesWallNew.appendChild(storyElement);
  });
}

// Like story function
function likeStory(storyId) {
  const user = getCurrentUser();
  if (!user) {
    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√≠ch c√¢u chuy·ªán.');
    return;
  }
  
  const story = stories.find(s => s.id === storyId);
  if (story) {
    if (story.liked) {
      story.likes--;
      story.liked = false;
    } else {
      story.likes++;
      story.liked = true;
    }
    saveStories();
    renderStories();
  }
}

// Toggle comments
function toggleComments(storyId) {
  const commentsDiv = document.getElementById(`comments-${storyId}`);
  if (commentsDiv.style.display === 'block') {
    commentsDiv.style.display = 'none';
  } else {
    commentsDiv.style.display = 'block';
  }
}

// Add comment
function addComment(storyId) {
  const user = getCurrentUser();
  if (!user) {
    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n.');
    return;
  }
  
  const commentInput = document.getElementById(`comment-input-${storyId}`);
  const content = commentInput.value.trim();
  
  if (!content) {
    alert('Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n.');
    return;
  }
  
  const story = stories.find(s => s.id === storyId);
  if (story) {
    story.comments.push({
      author: user.name,
      content: content,
      timestamp: new Date().toISOString()
    });
    saveStories();
    renderStories();
    commentInput.value = '';
  }
}

// Format time ago
function formatTimeAgo(timestamp) {
  const now = new Date();
  const storyTime = new Date(timestamp);
  const diffInSeconds = Math.floor((now - storyTime) / 1000);
  
  if (diffInSeconds < 60) return 'V·ª´a xong';
  if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} ph√∫t tr∆∞·ªõc`;
  if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} gi·ªù tr∆∞·ªõc`;
  return `${Math.floor(diffInSeconds / 86400)} ng√†y tr∆∞·ªõc`;
}

/* ---------------------------
  D·ªØ li·ªáu ƒëi·ªÉm (ƒë√£ c·∫≠p nh·∫≠t v·ªõi t·ªça ƒë·ªô ch√≠nh x√°c c·ªßa b·∫°n)
----------------------------*/
const DI_TICH = [
  // Nh√≥m Thi√™n Nhi√™n (Xanh L√° pastel)
  {
    id:'vuon-quoc-gia',
    name:'V∆∞·ªùn qu·ªëc gia Ph√∫ Qu·ªëc',
    address:'V∆∞·ªùn qu·ªëc gia Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'V∆∞·ªùn qu·ªëc gia v·ªõi h·ªá sinh th√°i r·ª´ng nhi·ªát ƒë·ªõi phong ph√∫, n∆°i b·∫£o t·ªìn nhi·ªÅu lo√†i ƒë·ªông th·ª±c v·∫≠t qu√Ω hi·∫øm.',
    extra:['Di·ªán t√≠ch: 31.422 ha', 'C√≥ nhi·ªÅu lo√†i ƒë·ªông th·ª±c v·∫≠t qu√Ω hi·∫øm', 'H·ªá sinh th√°i r·ª´ng nhi·ªát ƒë·ªõi ƒëa d·∫°ng'],
    lat:10.3645, lng:103.9919,
    games:[],
    img: 'images/vuon.jpg',
    category: 'nature'
  },
  {
    id:'bai-sao',
    name:'B√£i Sao',
    address:'B√£i Sao, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'B√£i bi·ªÉn ƒë·∫πp v·ªõi c√°t tr·∫Øng m·ªãn, n∆∞·ªõc bi·ªÉn trong xanh, h√¨nh l∆∞·ª°i li·ªÅm ƒë·∫∑c tr∆∞ng.',
    extra:['C√°t tr·∫Øng m·ªãn', 'N∆∞·ªõc bi·ªÉn trong xanh', 'H√¨nh d·∫°ng l∆∞·ª°i li·ªÅm ƒë·ªôc ƒë√°o'],
    lat:10.0572, lng:104.0360,
    games:[],
    img:'images/baisao.jpg',
    category: 'nature'
  },
  {
    id:'hon-thom',
    name:'H√≤n Th∆°m',
    address:'H√≤n Th∆°m, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'H√≤n ƒë·∫£o l·ªõn th·ª© hai trong qu·∫ßn ƒë·∫£o An Th·ªõi, n·ªïi ti·∫øng v·ªõi c·∫£nh quan thi√™n nhi√™n hoang s∆°.',
    extra:['ƒê·∫£o l·ªõn th·ª© hai qu·∫ßn ƒë·∫£o An Th·ªõi', 'C·∫£nh quan thi√™n nhi√™n hoang s∆°', 'Nhi·ªÅu b√£i bi·ªÉn ƒë·∫πp'],
    lat:9.9560, lng:104.0179,
    games:[],
    img:'images/honthom.jpg',
    category: 'nature'
  },
  
  // Nh√≥m VƒÉn H√≥a - L·ªãch S·ª≠ (Cam pastel)
  {
    id:'nha-tu',
    name:'Nh√† t√π Ph√∫ Qu·ªëc',
    address:'350 ƒê. Nguy·ªÖn VƒÉn C·ª´, An Th·ªõi, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Di t√≠ch l·ªãch s·ª≠ c·∫•p Qu·ªëc gia ƒë·∫∑c bi·ªát (2014). N∆°i giam gi·ªØ nhi·ªÅu t√π binh trong kh√°ng chi·∫øn; ch·ª©ng t√≠ch tra t·∫•n, nh∆∞ng c≈©ng l√† bi·ªÉu t∆∞·ª£ng √Ω ch√≠ ki√™n c∆∞·ªùng.',
    extra:[
      'NƒÉm x√¢y d·ª±ng: 01/06/1967',
      'C√≤n g·ªçi: Nh√† lao C√¢y D·ª´a',
      'Kho·∫£ng 40.000 t√π binh t·ª´ng b·ªã giam; nhi·ªÅu t√π nh√¢n b·ªã tra t·∫•n d√£ man. C√≥ 45 cu·ªôc v∆∞·ª£t ng·ª•c ghi nh·∫≠n.'
    ],
    lat:10.044417, lng:104.017639,
    games:['quiz_nhatu', 'memory_nhatu'],
    img: 'images/nhatupq3.jpg',
    category: 'culture'
  },
  {
    id:'chua',
    name:'Ch√πa H·ªô Qu·ªëc',
    address:'426H+GVQ, D∆∞∆°ng T∆°, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Thi·ªÅn vi·ªán Tr√∫c L√¢m H·ªô Qu·ªëc ‚Äî ki·∫øn tr√∫c t√¢m linh l·ªõn, phong c√°ch c·ªï truy·ªÅn Vi·ªát.',
    extra:['Ng√¥i ch√πa l·ªõn nh·∫•t Ph√∫ Qu·ªëc', 'Ki·∫øn tr√∫c truy·ªÅn th·ªëng Vi·ªát Nam', 'Kh√¥ng gian t√¢m linh thanh t·ªãnh'],
    lat:10.110028, lng:104.029056,
    games:[],
    img: 'images/chua.jpg',
    category: 'culture'
  },
  {
    id:'dinh-ntt',
    name:'ƒê√¨nh Th·∫ßn Nguy·ªÖn Trung Tr·ª±c',
    address:'9RFV+848, G√†nh D·∫ßu, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Di t√≠ch l·ªãch s·ª≠ vƒÉn h√≥a. ƒê√¨nh th·ªù Anh h√πng d√¢n t·ªôc Nguy·ªÖn Trung Tr·ª±c (1839-1868).',
    extra:[
      'ƒê√¨nh ƒë∆∞·ª£c x√¢y d·ª±ng t·ª´ nƒÉm 1882',
      'L·ªÖ gi·ªó t·ªï ch·ª©c h√†ng nƒÉm (√¢m l·ªãch) ‚Äî ho·∫°t ƒë·ªông truy·ªÅn th·ªëng h∆°n 100 nƒÉm',
      'Nguy·ªÖn Trung Tr·ª±c n·ªïi ti·∫øng v·ªõi chi·∫øn c√¥ng ƒë·ªët t√†u Ph√°p tr√™n s√¥ng Nh·∫≠t T·∫£o.'
    ],
    lat:10.373306, lng:103.842972,
    games:['quiz_trungtruc', 'memory_trungtruc'],
    img:'images/dinhntt.jpg',
    category: 'culture'
  },
  {
    id:'baotang',
    name:'B·∫£o t√†ng C·ªôi Ngu·ªìn',
    address:'Ph√∫ Qu·ªëc, Ki√™n Giang',
    note:'B·∫£o t√†ng tr∆∞ng b√†y l·ªãch s·ª≠-vƒÉn h√≥a ƒë·ªãa ph∆∞∆°ng',
    extra:['Tr∆∞ng b√†y l·ªãch s·ª≠, vƒÉn h√≥a Ph√∫ Qu·ªëc', 'B·ªô s∆∞u t·∫≠p c·ªï v·∫≠t phong ph√∫', 'Ki·∫øn tr√∫c ƒë·ªôc ƒë√°o'],
    lat:10.192500, lng:103.967000,
    games:[],
    img:'images/coinguon.jpg',
    category: 'culture'
  },
  {
    id:'dinh-cau',
    name:'Dinh C·∫≠u',
    address:'Khu ph·ªë 2, Tp. Ph√∫ Qu·ªëc, Ki√™n Giang 92500, Vi·ªát Nam',
    note:'Di t√≠ch th·∫Øng c·∫£nh; t√≠n ng∆∞·ª°ng c·ªßa ng∆∞ d√¢n, c√≥ l·ªÖ h·ªôi h√†ng nƒÉm (15‚Äì16/10 √¢m l·ªãch).',
    extra:['X√¢y d·ª±ng: 1937 (tu s·ª≠a 1997)','Bi·ªÉu t∆∞·ª£ng t√¢m linh c·ªßa ng∆∞·ªùi d√¢n ƒë·ªãa ph∆∞∆°ng', 'V·ªã tr√≠ ƒë·∫πp nh√¨n ra bi·ªÉn'],
    lat:10.217194, lng:103.956500,
    games:[],
    img:'images/dinhcau.jpg',
    category: 'culture'
  },
  
  // Nh√≥m Gi·∫£i Tr√≠ & Hi·ªán ƒê·∫°i (T√≠m pastel)
  {
    id:'cap-treo',
    name:'C√°p treo H√≤n Th∆°m',
    address:'C√°p treo H√≤n Th∆°m, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Tuy·∫øn c√°p treo v∆∞·ª£t bi·ªÉn d√†i nh·∫•t th·∫ø gi·ªõi, k·∫øt n·ªëi ƒë·∫£o Ph√∫ Qu·ªëc v·ªõi ƒë·∫£o H√≤n Th∆°m.',
    extra:['Tuy·∫øn c√°p treo v∆∞·ª£t bi·ªÉn d√†i nh·∫•t th·∫ø gi·ªõi', 'K·∫øt n·ªëi ƒë·∫£o Ph√∫ Qu·ªëc v·ªõi H√≤n Th∆°m', 'Cung ƒë∆∞·ªùng ng·∫Øm c·∫£nh tuy·ªát ƒë·∫πp'],
    lat:10.0269, lng:104.0073,
    games:[],
    img:'images/captreo.jpg',
    category: 'entertainment'
  },
  {
    id:'grand-world',
    name:'Grand World Ph√∫ Qu·ªëc',
    address:'Grand World Ph√∫ Qu·ªëc, B√£i D√†i, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Khu ph·ª©c h·ª£p gi·∫£i tr√≠, mua s·∫Øm v√† ·∫©m th·ª±c v·ªõi ki·∫øn tr√∫c ch√¢u √Çu ƒë·ªôc ƒë√°o.',
    extra:['Khu ph·ª©c h·ª£p gi·∫£i tr√≠ hi·ªán ƒë·∫°i', 'Ki·∫øn tr√∫c ch√¢u √Çu ƒë·ªôc ƒë√°o', 'Nhi·ªÅu ho·∫°t ƒë·ªông vui ch∆°i, mua s·∫Øm'],
    lat:10.3289, lng:103.8629,
    games:[],
    img:'images/grandworld.jpg',
    category: 'entertainment'
  },
  
  // Nh√≥m ·∫®m Th·ª±c & L√†ng Ngh·ªÅ (ƒê·ªè pastel)
  {
    id:'nha-thung',
    name:'Nh√† th√πng n∆∞·ªõc m·∫Øm Ph√∫ Qu·ªëc (Ph·ª•ng H∆∞ng)',
    address:'471 ƒê. Nguy·ªÖn VƒÉn C·ª´, Khu 2, Ph√∫ Qu·ªëc, Ki√™n Giang',
    note:'Nh√† th√πng n∆∞·ªõc m·∫Øm truy·ªÅn th·ªëng; ngh·ªÅ truy·ªÅn th·ªëng c·ªßa ƒë·∫£o.',
    extra:['L·ªãch s·ª≠: h√†ng trƒÉm nƒÉm, ph∆∞∆°ng th·ª©c ·ªß mu·ªëi truy·ªÅn th·ªëng', 'N∆∞·ªõc m·∫Øm Ph√∫ Qu·ªëc n·ªïi ti·∫øng th∆°m ngon'],
    lat:10.044917, lng:104.017444,
    games:[],
    img:'images/nhathung.jpg',
    category: 'craft'
  },
  {
    id:'ngoc-trai',
    name:'C∆° s·ªü nu√¥i c·∫•y ng·ªçc trai (Ng·ªçc Hi·ªÅn Pearl)',
    address:'C∆° s·ªü nu√¥i c·∫•y ng·ªçc trai Ng·ªçc Hi·ªÅn Pearl, Ph√∫ Qu·ªëc, Ki√™n Giang',
    note:'C∆° s·ªü nu√¥i c·∫•y v√† ch·∫ø t√°c ng·ªçc trai n·ªïi ti·∫øng t·∫°i Ph√∫ Qu·ªëc.',
    extra:['Nu√¥i c·∫•y v√† ch·∫ø t√°c ng·ªçc trai', 'S·∫£n ph·∫©m ng·ªçc trai ch·∫•t l∆∞·ª£ng cao', 'Quy tr√¨nh nu√¥i c·∫•y c√¥ng phu'],
    lat:10.1701, lng:103.9703, // C·∫≠p nh·∫≠t t·ªça ƒë·ªô m·ªõi
    games:[],
    img:'images/ngoctrai.jpg',
    category: 'craft'
  },
  {
    id:'ham-ninh',
    name:'L√†ng ch√†i H√†m Ninh',
    address:'52JV+6XX, TL47, R·∫°ch H√†m, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'L√†ng ch√†i c·ªï, n·ªïi ti·∫øng h·∫£i s·∫£n t∆∞∆°i, gh·∫π H√†m Ninh.',
    extra:['L√†ng ch√†i truy·ªÅn th·ªëng l√¢u ƒë·ªùi', 'N·ªïi ti·∫øng v·ªõi gh·∫π H√†m Ninh t∆∞∆°i ngon', 'C·∫£nh bi·ªÉn ƒë·∫πp, b√¨nh y√™n'],
    lat:10.180917, lng:104.048472,
    games:[],
    img:'images/langchai.jpg',
    category: 'craft'
  }
];

/* -----------------------
  Local storage keys
------------------------*/
const STORAGE_USER = 'pq_user_v1';
const STORAGE_BADGES = 'pq_badges_v1';
const STORAGE_DONE = 'pq_done_games_v1';
const STORAGE_VISIT = 'pq_visited_v1';
const STORAGE_STORIES = 'pq_stories';

/* --------- Helpers ------------- */
function saveUser(u){ localStorage.setItem(STORAGE_USER, JSON.stringify(u)) }
function loadUser(){ return JSON.parse(localStorage.getItem(STORAGE_USER) || 'null') }
function loadBadges(){ return JSON.parse(localStorage.getItem(STORAGE_BADGES) || '[]') }
function saveBadges(a){ localStorage.setItem(STORAGE_BADGES, JSON.stringify(a)) }
function loadDone(){ return JSON.parse(localStorage.getItem(STORAGE_DONE) || '{}') }
function saveDone(o){ localStorage.setItem(STORAGE_DONE, JSON.stringify(o)) }
function loadVisited(){ return JSON.parse(localStorage.getItem(STORAGE_VISIT) || '[]') }
function saveVisited(a){ localStorage.setItem(STORAGE_VISIT, JSON.stringify(a)) }
function saveStories(){ localStorage.setItem(STORAGE_STORIES, JSON.stringify(stories)) }

/* ---------- UI & Navigation ---------- */
const pageHome = document.getElementById('page-home');
const pageMap = document.getElementById('page-map');
const pageProfile = document.getElementById('page-profile');
const btnStart = document.getElementById('btn-start');

// C·∫≠p nh·∫≠t s·ª± ki·ªán cho n√∫t B·∫Øt ƒë·∫ßu kh√°m ph√°
btnStart.onclick = () => { 
  showPage('map'); 
  window.scrollTo(0,0); 
};

/* Auth modal */
const authModal = new bootstrap.Modal(document.getElementById('authModal'));
document.getElementById('btn-profile-register').addEventListener('click', ()=> {
  document.getElementById('authTitle').innerText = 'ƒêƒÉng k√Ω'; 
  document.getElementById('authSubmit').onclick = authRegister; 
  document.getElementById('authAlert').classList.add('d-none');
  authModal.show();
});

document.getElementById('btn-profile-login').addEventListener('click', ()=> {
  document.getElementById('authTitle').innerText = 'ƒêƒÉng nh·∫≠p'; 
  document.getElementById('authSubmit').onclick = authLogin; 
  document.getElementById('authAlert').classList.add('d-none');
  authModal.show();
});

document.getElementById('btn-profile-logout').addEventListener('click', ()=> {
  logoutUser();
  refreshProfileAuthUI();
  alert('ƒêƒÉng xu·∫•t th√†nh c√¥ng.');
});

/* auth functions */
function authRegister(){
  const name = document.getElementById('inName').value.trim();
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  if(!name || !email || !pass){ showAuthError('ƒêi·ªÅn ƒë·ªß t√™n, email, m·∫≠t kh·∫©u'); return; }
  
  const result = registerUser(name, email, pass);
  if (result.success) {
    alert('ƒêƒÉng k√Ω th√†nh c√¥ng. Vui l√≤ng ƒëƒÉng nh·∫≠p.');
    authModal.hide();
  } else {
    showAuthError(result.message);
  }
}

function authLogin(){
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  
  const result = loginUser(email, pass);
  if (result.success) {
    authModal.hide();
    refreshProfileAuthUI();
    alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng. Xin ch√†o ' + result.user.name);
  } else {
    showAuthError(result.message);
  }
}

function showAuthError(msg){ 
  const a=document.getElementById('authAlert'); 
  a.innerText=msg; 
  a.classList.remove('d-none'); 
}

function refreshProfileAuthUI(){
  const u = getCurrentUser();
  const profileInfo = document.getElementById('profile-info');
  const btnLogin = document.getElementById('btn-profile-login');
  const btnRegister = document.getElementById('btn-profile-register');
  const btnLogout = document.getElementById('btn-profile-logout');
  
  if(u){ 
    btnLogin.style.display='none'; 
    btnRegister.style.display='none'; 
    btnLogout.style.display='inline-block'; 
    profileInfo.innerHTML = `Xin ch√†o <strong>${u.name}</strong> ‚Äî ${u.email}`;
    profileInfo.className = 'alert alert-success';
    renderUserBadges(u);
  } else { 
    btnLogin.style.display='inline-block'; 
    btnRegister.style.display='inline-block'; 
    btnLogout.style.display='none'; 
    profileInfo.innerHTML = 'B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u ti·∫øn tr√¨nh v√† nh·∫≠n huy hi·ªáu.';
    profileInfo.className = 'alert alert-info';
    renderProfileBadges();
  }
}

function renderUserBadges(user) {
  const wrap = document.getElementById('profile-badge-area');
  wrap.innerHTML = '';
  
  if(!user.badges || user.badges.length === 0) {
    wrap.innerHTML = '<div class="text-muted">Ch∆∞a c√≥ huy hi·ªáu n√†o. H√£y kh√°m ph√° c√°c ƒë·ªãa ƒëi·ªÉm v√† ho√†n th√†nh th·ª≠ th√°ch!</div>';
    return;
  }
  
  user.badges.forEach(b=>{
    const el = document.createElement('div');
    el.className = 'text-center';
    el.innerHTML = `
      <img src="${b.icon}" class="badge-img" alt="${b.name}">
      <div style="font-size:12px; max-width:80px">${b.name}</div>
    `;
    wrap.appendChild(el);
  });
}

    /* ---------- Map init ---------- */
const map = L.map('map', {zoomControl:true}).setView([10.28,103.98], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(map);

// T·∫°o tooltip cho marker
let currentTooltip = null;

function createCustomIcon(category, hasGame) {
  const colorMap = {
    'nature': '#A5D6A7', // Xanh l√° pastel
    'culture': '#FFCC80', // Cam pastel
    'entertainment': '#CE93D8', // T√≠m pastel
    'craft': '#EF9A9A' // ƒê·ªè pastel
  };
  
  const color = colorMap[category] || '#90CAF9';
  
  return L.divIcon({
    className: 'custom-pin',
    html: `
      <div style="
        background: ${color}; 
        width: 24px; 
        height: 24px; 
        border-radius: 50%; 
        border: 3px solid white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      "></div>
    `,
    iconSize: [30, 30],
    iconAnchor: [15, 15]
  });
}

/* render markers */
DI_TICH.forEach(p=>{
  const m = L.marker([p.lat,p.lng], {icon: createCustomIcon(p.category, p.games.length>0)}).addTo(map);
  
  // Th√™m tooltip khi hover
  m.on('mouseover', function(e) {
    if (currentTooltip) {
      document.body.removeChild(currentTooltip);
    }
    
    currentTooltip = document.createElement('div');
    currentTooltip.className = 'marker-tooltip';
    currentTooltip.textContent = p.name;
    
    const point = map.latLngToContainerPoint(e.latlng);
    currentTooltip.style.left = (point.x + 20) + 'px';
    currentTooltip.style.top = (point.y - 10) + 'px';
    
    document.body.appendChild(currentTooltip);
  });
  
  m.on('mouseout', function() {
    if (currentTooltip) {
      document.body.removeChild(currentTooltip);
      currentTooltip = null;
    }
  });
  
  // S·ª¨A L·∫†I PH·∫¶N N√ÄY - ƒê·∫£m b·∫£o s·ª± ki·ªán click ƒë∆∞·ª£c x·ª≠ l√Ω ƒë√∫ng
  m.on('click', function(e) {
    // ƒê√≥ng tooltip n·∫øu ƒëang m·ªü
    if (currentTooltip) {
      document.body.removeChild(currentTooltip);
      currentTooltip = null;
    }
    openDiModal(p);
  });
  
  // Th√™m popup c∆° b·∫£n ƒë·ªÉ test
  m.bindPopup(`<strong>${p.name}</strong><br>${p.address}`, {
    closeButton: true,
    autoClose: false
  });
});

/* modal instances */
const diModal = new bootstrap.Modal(document.getElementById('diModal'));

/* open di t√≠ch modal (with details) */
function openDiModal(p){
  document.getElementById('diTitle').innerText = p.name;
  const extras = p.extra.map(x=>`<li>${x}</li>`).join('');
  const html = `
    <div class="row">
      <div class="col-md-5"><img src="${p.img}" alt="${p.name}" style="width:100%;border-radius:8px;object-fit:cover"></div>
      <div class="col-md-7">
        <h5 class="diatic-title">${p.name}</h5>
        <p style="margin:0">${p.address}</p>
        <p style="margin-top:8px;color:#333">${p.note}</p>
        ${extras ? `<ul>${extras}</ul>` : ''}
      </div>
    </div>
  `;
  document.getElementById('diBody').innerHTML = html;
  document.getElementById('diCoords').innerText = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
  const btnPlay = document.getElementById('btn-play');
  if(p.games && p.games.length){
    btnPlay.style.display='inline-block';
    btnPlay.onclick = ()=> { diModal.hide(); openGamePicker(p); };
  } else { btnPlay.style.display='none'; btnPlay.onclick=null; }
  // check-in button
  document.getElementById('btn-checkin').onclick = ()=> {
    const u = getCurrentUser();
    if(!u){ alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi check-in.'); return; }
    markVisited(p.id);
    awardBadgeSite(p.id,p.name);
// Th√™m v√†o cu·ªëi ph·∫ßn Map init ƒë·ªÉ test
console.log('Map initialized, markers created:', DI_TICH.length);
  };
  diModal.show();
}

/* ---------- Badges & check-in logic ---------- */
function getBadges(){ return loadBadges(); }

function awardBadge(id,name,icon){
  const user = getCurrentUser();
  if (!user) return false;
  
  if(!user.badges) user.badges = [];
  if(user.badges.find(b=>b.id===id)) return false;
  
  user.badges.push({id,name,icon:icon || `https://via.placeholder.com/64/FFD54F/000?text=${encodeURIComponent(name.charAt(0))}`});
  updateUser(user);
  renderUserBadges(user);
  
  // Hi·ªÉn th·ªã popup huy hi·ªáu
  showBadgePopup(name, icon);
  return true;
}

function renderProfileBadges(){
  const wrap = document.getElementById('profile-badge-area');
  wrap.innerHTML = '';
  const arr = getBadges();
  
  if(arr.length === 0) {
    wrap.innerHTML = '<div class="text-muted">Ch∆∞a c√≥ huy hi·ªáu n√†o. H√£y kh√°m ph√° c√°c ƒë·ªãa ƒëi·ªÉm v√† ho√†n th√†nh th·ª≠ th√°ch!</div>';
    return;
  }
  
  arr.forEach(b=>{
    const el = document.createElement('div');
    el.className = 'text-center';
    el.innerHTML = `
      <img src="${b.icon}" class="badge-img" alt="${b.name}">
      <div style="font-size:12px; max-width:80px">${b.name}</div>
    `;
    wrap.appendChild(el);
  });
}

/* mark visited and award site badge */
function markVisited(siteId){
  const user = getCurrentUser();
  if (!user) return;
  
  if(!user.visitedSites) user.visitedSites = [];
  if(!user.visitedSites.includes(siteId)){ 
    user.visitedSites.push(siteId); 
    updateUser(user);
    renderUserBadges(user);
  }
}

function awardBadgeSite(siteId, siteName){
  const id = `site_${siteId}`;
  const name = `${siteName}`;
  const badgeIcons = {
    'chua': 'images/hhchua.jpg',
    'nha-tu': 'images/hhnhatupq.jpg',
    'nha-thung': 'images/hhnhathung.jpg',
    'ham-ninh': 'images/hhlangchai.jpg',
    'baotang': 'images/hhcoinguon.jpg',
    'dinh-cau': 'images/hhdinhcau.jpg',
    'dinh-ntt': 'images/hhdinhntt.jpg',
    'vuon-quoc-gia': 'images/hhvuon.jpg',
    'bai-sao': 'images/hhbaisao.jpg',
    'hon-thom': 'images/hhhonthom.jpg',
    'cap-treo': 'images/hhcaptreo.jpg',
    'grand-world': 'images/hhgrandworld.jpg',
    'ngoc-trai': 'images/hhngoctrai.jpg'
  };
  
  const badgeIcon = badgeIcons[siteId] || `https://via.placeholder.com/64/C33/fff?text=${encodeURIComponent(siteName.split(' ')[0].charAt(0))}`;
  awardBadge(id, name, badgeIcon);
}

/* Hi·ªÉn th·ªã popup huy hi·ªáu l·ªõn */
function showBadgePopup(badgeName, badgeIcon) {
  const popup = document.getElementById('badgePopup');
  const popupImg = document.getElementById('badgePopupImg');
  const popupTitle = document.getElementById('badgePopupTitle');
  
  popupImg.src = badgeIcon;
  popupTitle.textContent = badgeName;
  popup.style.display = 'flex';
  
  // B·∫Øn ph√°o hoa
  confetti({
    particleCount: 150,
    spread: 70,
    origin: { y: 0.6 },
    colors: ['#C62828', '#FFD54F', '#4CAF50', '#2196F3']
  });
  
  const autoClose = setTimeout(() => {
    closeBadgePopup();
  }, 3000);
  
  document.getElementById('badgePopupClose').onclick = () => {
    clearTimeout(autoClose);
    closeBadgePopup();
  };
  
  popup.onclick = (e) => {
    if (e.target === popup) {
      clearTimeout(autoClose);
      closeBadgePopup();
    }
  };
}

function closeBadgePopup() {
  document.getElementById('badgePopup').style.display = 'none';
}

/* record game completion */
function recordDone(siteId, gameId){
  const user = getCurrentUser();
  if (!user) return;
  
  if(!user.completedGames) user.completedGames = {};
  if(!user.completedGames[siteId]) user.completedGames[siteId] = [];
  if(!user.completedGames[siteId].includes(gameId)){ 
    user.completedGames[siteId].push(gameId); 
    updateUser(user);
    renderUserBadges(user);
  }
}

/* ---------- Game picker & implementations ---------- */
function openGamePicker(site){
  const html = `<div class="text-center">
    <h4 class="mb-4">Ch·ªçn mini-game ‚Äî ${site.name}</h4>
    <div class="d-flex flex-column gap-3 align-items-center">
      ${site.games.map(g=>`<button class="btn btn-accent btn-lg w-75 game-choice" data-game="${g}">${labelGame(g)}</button>`).join('')}
    </div>
    <p class="mt-4 text-muted">M·ªói mini-game c√≥ c√°c b∆∞·ªõc th·ª≠ th√°ch. K·∫øt qu·∫£ s·∫Ω l∆∞u v√†o h·ªì s∆° c·ªßa b·∫°n.</p>
  </div>`;
  
  showGameFullscreen('Ch·ªçn mini-game', html);
  
  document.querySelectorAll('.game-choice').forEach(btn=> btn.addEventListener('click', ()=> {
    const g = btn.dataset.game;
    startGameInstance(g, site);
  }));
}

function labelGame(id){
  const map = {
    'quiz_nhatu':'Quiz (Nh√† t√π)',
    'quiz_trungtruc':'Quiz (ƒê√¨nh)',
    'memory_nhatu':'Memory Vi·ªát (Nh√† t√π)',
    'memory_trungtruc':'Memory Vi·ªát (ƒê√¨nh)'
  };
  return map[id]||id;
}

/* ---------- GAME FULLSCREEN MODE ---------- */
const gameFullscreen = document.getElementById('gameFullscreen');
const gameFullscreenTitle = document.getElementById('gameFullscreenTitle');
const gameFullscreenBody = document.getElementById('gameFullscreenBody');
const gameFullscreenClose = document.getElementById('gameFullscreenClose');

gameFullscreenClose.addEventListener('click', () => {
  hideGameFullscreen();
});

function showGameFullscreen(title, content) {
  gameFullscreenTitle.textContent = title;
  gameFullscreenBody.innerHTML = content;
  gameFullscreen.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function hideGameFullscreen() {
  gameFullscreen.classList.remove('active');
  document.body.style.overflow = 'auto';
}

/* ---------- Victory Popup ---------- */
const victoryPopup = document.getElementById('victoryPopup');
const victoryMessage = document.getElementById('victoryMessage');
const victoryClose = document.getElementById('victoryClose');

victoryClose.addEventListener('click', () => {
  victoryPopup.style.display = 'none';
});

function showVictory(message) {
  victoryMessage.textContent = message;
  victoryPopup.style.display = 'flex';
  
  // B·∫Øn ph√°o hoa ·ªü ph√≠a tr∆∞·ªõc
  confetti({
    particleCount: 200,
    spread: 100,
    origin: { y: 0.3 },
    colors: ['#C62828', '#FFD54F', '#4CAF50', '#2196F3'],
    startVelocity: 30,
    gravity: 0.8
  });
  
  // Th√™m hi·ªáu ·ª©ng ph√°o hoa t·ª´ hai b√™n
  setTimeout(() => {
    confetti({
      particleCount: 100,
      angle: 60,
      spread: 80,
      origin: { x: 0, y: 0.5 },
      colors: ['#C62828', '#FFD54F']
    });
    confetti({
      particleCount: 100,
      angle: 120,
      spread: 80,
      origin: { x: 1, y: 0.5 },
      colors: ['#4CAF50', '#2196F3']
    });
  }, 500);
}

/* ---------- GAME L·∫¨T TH·∫∫ (MEMORY CARD) ---------- */
const MEMORY_GAMES = {
  'memory_nhatu': {
    title: 'Memory Vi·ªát - Nh√† t√π Ph√∫ Qu·ªëc',
    cards: [
      { id: 1, image: 'images/nhatucard1.jpg', matchId: 2 },
      { id: 2, image: 'images/nhatutext1.jpg', matchId: 1 },
      { id: 3, image: 'images/nhatucard2.jpg', matchId: 4 },
      { id: 4, image: 'images/nhatutext2.jpg', matchId: 3 },
      { id: 5, image: 'images/nhatucard3.jpg', matchId: 6 },
      { id: 6, image: 'images/nhatutext3.jpg', matchId: 5 },
      { id: 7, image: 'images/nhatucard4.jpg', matchId: 8 },
      { id: 8, image: 'images/nhatutext4.jpg', matchId: 7 }
    ]
  },
  'memory_trungtruc': {
    title: 'Memory Vi·ªát - ƒê√¨nh Nguy·ªÖn Trung Tr·ª±c',
    cards: [
      { id: 1, image: 'images/dinhcard1.jpg', matchId: 2 },
      { id: 2, image: 'images/dinhtext1.jpg', matchId: 1 },
      { id: 3, image: 'images/dinhcard2.jpg', matchId: 4 },
      { id: 4, image: 'images/dinhtext2.jpg', matchId: 3 },
      { id: 5, image: 'images/dinhcard3.jpg', matchId: 6 },
      { id: 6, image: 'images/dinhtext3.jpg', matchId: 5 },
      { id: 7, image: 'images/dinhcard4.jpg', matchId: 8 },
      { id: 8, image: 'images/dinhtext4.jpg', matchId: 7 }
    ]
  }
};

let currentMemoryGame = null;
let flippedCards = [];
let matchedPairs = 0;
let canFlip = true;
let flipCount = 0;

function startMemoryGame(gameId, site) {
  const gameData = MEMORY_GAMES[gameId];
  if (!gameData) {
    alert('Game Memory Vi·ªát ch∆∞a c√≥ n·ªôi dung.');
    return;
  }
  currentMemoryGame = { id: gameId, site: site, gameData: gameData };
  flippedCards = [];
  matchedPairs = 0;
  canFlip = true;
  flipCount = 0;
  const html = `
    <div class="memory-container text-center">
      <h4 class="mb-3">${gameData.title}</h4>
      <div class="memory-stats mb-3">
        <span class="badge bg-primary">C·∫∑p ƒë√£ t√¨m: <span id="matchedCount">0</span>/4</span>
        <span class="badge bg-secondary ms-2">L∆∞·ª£t l·∫≠t: <span id="flipCount">0</span></span>
      </div>
      
      <div class="memory-board" id="memoryBoard">
        <!-- Cards will be generated here -->
      </div>
      
      <div class="memory-controls mt-4">
        <button class="btn btn-accent" onclick="finishMemoryGame()">Ho√†n th√†nh</button>
        <button class="btn btn-outline-secondary" onclick="resetMemoryGame()">Ch∆°i l·∫°i</button>
      </div>
      
      <div class="memory-complete mt-3" id="memoryComplete" style="display: none;">
        <div class="alert alert-success">
          <h5>üéâ Ch√∫c m·ª´ng!</h5>
          <p>B·∫°n ƒë√£ ho√†n th√†nh game Memory Vi·ªát!</p>
        </div>
      </div>
    </div>
  `;
  showGameFullscreen(gameData.title, html);
  initializeMemoryGame();
}

function initializeMemoryGame() {
  const board = document.getElementById('memoryBoard');
  const gameData = currentMemoryGame.gameData;
  
  const shuffledCards = [...gameData.cards].sort(() => Math.random() - 0.5);
  
  board.innerHTML = shuffledCards.map(card => `
    <div class="memory-card" data-card-id="${card.id}" data-match-id="${card.matchId}">
      <div class="card-inner">
        <div class="card-front">
          <div class="card-content">
            <i class="fas fa-question"></i>
          </div>
        </div>
        <div class="card-back">
          <div class="card-content">
            <img src="${card.image}" alt="Memory card" onerror="this.style.display='none'">
          </div>
        </div>
      </div>
    </div>
  `).join('');
  document.querySelectorAll('.memory-card').forEach(card => {
    card.addEventListener('click', handleCardClick);
  });
  flipCount = 0;
  updateFlipCount();
}

function handleCardClick() {
  if (!canFlip) return;
  if (this.classList.contains('flipped') || this.classList.contains('matched')) return;
  if (flippedCards.length >= 2) return;
  this.classList.add('flipped');
  flippedCards.push(this);
  flipCount++;
  updateFlipCount();
  if (flippedCards.length === 2) {
    canFlip = false;
    setTimeout(checkForMatch, 800);
  }
}

function checkForMatch() {
  const [card1, card2] = flippedCards;
  const matchId1 = card1.dataset.matchId;
  const matchId2 = card2.dataset.matchId;
  if (card1.dataset.cardId === matchId2 && card2.dataset.cardId === matchId1) {
    card1.classList.add('matched');
    card2.classList.add('matched');
    matchedPairs++;
    updateMatchedCount();
    if (matchedPairs === 4) {
      setTimeout(() => {
        document.getElementById('memoryComplete').style.display = 'block';
       showVictory('üéâ Xu·∫•t s·∫Øc! B·∫°n ƒë√£ ho√†n th√†nh Memory Vi·ªát!');
      }, 500);
    }
  } else {
    card1.classList.remove('flipped');
    card2.classList.remove('flipped');
  }
  flippedCards = [];
  canFlip = true;
}

function updateMatchedCount() {
  document.getElementById('matchedCount').textContent = matchedPairs;
}

function updateFlipCount() {
  document.getElementById('flipCount').textContent = flipCount;
}

function resetMemoryGame() {
  flippedCards = [];
  matchedPairs = 0;
  canFlip = true;
  flipCount = 0;
  
  document.querySelectorAll('.memory-card').forEach(card => {
    card.classList.remove('flipped', 'matched');
  });
  
  document.getElementById('memoryComplete').style.display = 'none';
  updateMatchedCount();
  updateFlipCount();
  
  const board = document.getElementById('memoryBoard');
  const cards = Array.from(board.children);
  cards.sort(() => Math.random() - 0.5);
  cards.forEach(card => board.appendChild(card));
}

function finishMemoryGame() {
  if (matchedPairs === 4) {
    recordDone(currentMemoryGame.site.id, currentMemoryGame.id);
    hideGameFullscreen();
  } else {
    alert(`B·∫°n ƒë√£ t√¨m ƒë∆∞·ª£c ${matchedPairs}/4 c·∫∑p th·∫ª. H√£y ti·∫øp t·ª•c!`);
  }
}

/* ---------- GAME QUIZ ---------- */
const QUIZZES = {
  'quiz_nhatu': {
    title:'Quiz Nh√† t√π Ph√∫ Qu·ªëc',
    items:[
      {
        q:'Di t√≠ch Tr·∫°i giam Ph√∫ Qu·ªëc ƒë∆∞·ª£c ch√≠nh th·ª©c x·∫øp h·∫°ng Di t√≠ch Qu·ªëc gia ƒë·∫∑c bi·ªát v√†o th·ªùi ƒëi·ªÉm n√†o?',
        opts:['Ng√†y 30/4/1975','Ng√†y 27/7/2013','Ng√†y 31/12/2014','Ng√†y 20/10/2016'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. CƒÉn c·ª© theo Quy·∫øt ƒë·ªãnh s·ªë 2408/Qƒê-TTg ng√†y 31/12/2014 c·ªßa Th·ªß t∆∞·ªõng Ch√≠nh ph·ªß.'
      },
      {
        q:'"ƒê·ªãa ng·ª•c tr·∫ßn gian" Ph√∫ Qu·ªëc ch√≠nh th·ª©c t·ªìn t·∫°i trong kho·∫£ng th·ªùi gian n√†o?',
        opts:['T·ª´ nƒÉm 1949 ƒë·∫øn nƒÉm 1954','T·ª´ th√°ng 6/1967 ƒë·∫øn th√°ng 3/1973','T·ª´ nƒÉm 1965 ƒë·∫øn nƒÉm 1975','T·ª´ nƒÉm 1954 ƒë·∫øn nƒÉm 1975'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. Theo t∆∞ li·ªáu, tr·∫°i giam t·ªìn t·∫°i ch∆∞a ƒë·∫ßy 6 nƒÉm trong giai ƒëo·∫°n n√†y d∆∞·ªõi s·ª± qu·∫£n l√Ω c·ªßa ch√≠nh quy·ªÅn M·ªπ - Ng·ª•y.'
      },
      {
        q:'∆Ø·ªõc t√≠nh c√≥ bao nhi√™u t√π binh ƒë√£ b·ªã gi·∫øt h·∫°i t·∫°i Tr·∫°i giam Ph√∫ Qu·ªëc?',
        opts:['Kho·∫£ng 1.000 ng∆∞·ªùi','Kho·∫£ng 2.000 ng∆∞·ªùi','Kho·∫£ng 4.000 ng∆∞·ªùi','Kho·∫£ng 10.000 ng∆∞·ªùi'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. T∆∞ li·ªáu ghi r√µ con s·ªë kho·∫£ng 4.000 t√π binh ƒë√£ b·ªã gi·∫øt h·∫°i t·∫°i ƒë√¢y.'
      },
      {
        q:'M·ªôt trong nh·ªØng h√¨nh th·ª©c tra t·∫•n ƒë·∫∑c bi·ªát d√£ man, n∆°i t√π binh b·ªã nh·ªët trong c√°c c√¥ng-ten-n∆° nh·ªè ƒë∆∞·ª£c g·ªçi l√† g√¨?',
        opts:['Chu·ªìng c·ªçp xi mƒÉng','Th√πng cat-x√¥','H·∫ßm ƒë√° v√¥i','Ng·ª•c t·ªëi'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. ƒê√¢y l√† m·ªôt ki·ªÉu giam gi·ªØ ƒë∆∞·ª£c m√¥ t·∫£ trong t∆∞ li·ªáu, s·ª≠ d·ª•ng c√°c c√¥ng-ten-n∆° nh·ªè, tr√™n ƒë·ªânh ƒë·ª•c l·ªó th√¥ng h∆°i, r·∫•t ch·∫≠t h·∫πp v√† ng·ªôt ng·∫°t.'
      },
      {
        q:'C√°c t√π binh t·∫°i Tr·∫°i giam Ph√∫ Qu·ªëc ƒë√£ t·ªï ch·ª©c bao nhi√™u cu·ªôc v∆∞·ª£t ng·ª•c v·ªõi nhi·ªÅu h√¨nh th·ª©c kh√°c nhau?',
        opts:['12 cu·ªôc','25 cu·ªôc','45 cu·ªôc','52 cu·ªôc'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. Th·ªÉ hi·ªán tinh th·∫ßn ƒë·∫•u tranh b·∫•t khu·∫•t, c√°c t√π binh ƒë√£ t·ªï ch·ª©c th√†nh c√¥ng 45 cu·ªôc v∆∞·ª£t ng·ª•c.'
      },
      {
        q:'Khu v·ª±c n√†o sau ƒë√¢y KH√îNG ph·∫£i l√† m·ªôt ph·∫ßn c·ªßa Di t√≠ch Tr·∫°i giam Ph√∫ Qu·ªëc ng√†y nay?',
        opts:['Ph√¢n khu B2 (ƒë∆∞·ª£c ph·ª•c d·ª±ng)','Nghƒ©a ƒë·ªãa t√π binh (ƒê·ªìi 100)','Nh√† t√π C√¥n S∆°n','ƒê√†i t∆∞·ªüng ni·ªám li·ªát sƒ© t·∫°i ƒê·ªìi Sim'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. Nh√† t√π C√¥n S∆°n l√† m·ªôt di t√≠ch l·ªãch s·ª≠ ho√†n to√†n kh√°c, n·∫±m ·ªü C√¥n ƒê·∫£o, t·ªânh B√† R·ªãa - V≈©ng T√†u.'
      },
      {
        q:'T·ªïng di·ªán t√≠ch c·ªßa Tr·∫°i giam Ph√∫ Qu·ªëc trong l·ªãch s·ª≠ l√™n ƒë·∫øn bao nhi√™u?',
        opts:['100 hecta','200 hecta','400 hecta','500 hecta'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. Tr·∫°i giam c√≥ quy m√¥ r·∫•t l·ªõn, v·ªõi t·ªïng di·ªán t√≠ch l√™n ƒë·∫øn 400 hecta, ƒë∆∞·ª£c chia th√†nh 12 khu v·ª±c.'
      }
    ]
  },
  'quiz_trungtruc': {
    title:'Quiz ƒê√¨nh Nguy·ªÖn Trung Tr·ª±c',
    items:[
      {
        q:'Nguy·ªÖn Trung Tr·ª±c l√† th·ªß lƒ©nh n·ªïi ti·∫øng c·ªßa phong tr√†o kh√°ng chi·∫øn ch·ªëng?',
        opts:['Ch·ªëng Ph√°p','Ch·ªëng Ph√°p v√† ch·ªëng M·ªπ','Ch·ªëng M·ªπ','Ch·ªëng Nh·∫≠t'],
        ans:0,
        explain:'ƒê√°p √°n ƒë√∫ng l√† A. Nguy·ªÖn Trung Tr·ª±c l√† th·ªß lƒ©nh nghƒ©a qu√¢n ch·ªëng l·∫°i th·ª±c d√¢n Ph√°p x√¢m l∆∞·ª£c ·ªü Nam K·ª≥ v√†o n·ª≠a cu·ªëi th·∫ø k·ª∑ 19 (t·ª´ 1861-1868).'
      },
      {
        q:'Nguy·ªÖn Trung Tr·ª±c ƒë√£ ch·ªâ huy nghƒ©a qu√¢n ƒë·ªët ch√°y t√†u chi·∫øn n√†o c·ªßa Ph√°p tr√™n s√¥ng V√†m C·ªè ƒê√¥ng v√†o nƒÉm 1861, g√¢y ti·∫øng vang l·ªõn?',
        opts:['T√†u Hy V·ªçng (L\'Esp√©rance)','T√†u H·∫±ng T√¢m (La Pers√©v√©rance)','T√†u Jaccar√©','T√†u Avalanche'],
        ans:0,
        explain:'ƒê√°p √°n ƒë√∫ng l√† A. Chi·∫øn c√¥ng n·ªïi ti·∫øng nh·∫•t c·ªßa √¥ng l√† ch·ªâ huy nghƒ©a qu√¢n ƒë·ªët ch√°y ti·ªÉu h·∫°m L\'Esp√©rance (c√≥ t√™n Vi·ªát l√† "Hy V·ªçng") c·ªßa Ph√°p tr√™n s√¥ng V√†m C·ªè ƒê√¥ng nƒÉm 1861.'
      },
      {
        q:'C√¢u n√≥i b·∫•t h·ªß "Bao gi·ªù ng∆∞·ªùi T√¢y nh·ªï h·∫øt c·ªè n∆∞·ªõc Nam th√¨ m·ªõi h·∫øt ng∆∞·ªùi Nam ƒë√°nh T√¢y" ƒë∆∞·ª£c Nguy·ªÖn Trung Tr·ª±c n√≥i trong ho√†n c·∫£nh n√†o?',
        opts:['Khi ƒë·ªông vi√™n nghƒ©a qu√¢n tr∆∞·ªõc tr·∫≠n ƒë√°nh','Khi b·ªã th·ª±c d√¢n Ph√°p d·ª• h√†ng v√† k·∫øt √°n t·ª≠ h√¨nh','Khi tr·∫£ l·ªùi ph·ªèng v·∫•n c·ªßa m·ªôt nh√† b√°o Ph√°p','Trong m·ªôt b·ª©c th∆∞ g·ª≠i cho Tri·ªÅu ƒë√¨nh Hu·∫ø'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. C√¢u n√≥i b·∫•t h·ªß n√†y th·ªÉ hi·ªán kh√≠ ph√°ch ki√™n c∆∞·ªùng c·ªßa √¥ng, ƒë∆∞·ª£c √¥ng th·ªët l√™n khi ƒë·ªëi di·ªán v·ªõi c√°i ch·∫øt, tr∆∞·ªõc s·ª± d·ª• d·ªó c·ªßa k·∫ª th√π.'
      },
      {
        q:'Nguy·ªÖn Trung Tr·ª±c b·ªã th·ª±c d√¢n Ph√°p x·ª≠ ch√©m t·∫°i ƒë√¢u?',
        opts:['S√†i G√≤n','B·∫øn Tre','R·∫°ch Gi√°','C·∫ßn Th∆°'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. Sau khi kh√°ng chi·∫øn ·ªü H√≤n Ch√¥ng th·∫•t b·∫°i v√† b·ªã b·∫Øt, √¥ng b·ªã th·ª±c d√¢n Ph√°p x·ª≠ ch√©m t·∫°i ch·ª£ R·∫°ch Gi√° v√†o ng√†y 27/10/1868 (16/9 nƒÉm M·∫≠u Th√¨n).'
      },
      {
        q:'L·ªÖ h·ªôi t∆∞·ªüng ni·ªám Nguy·ªÖn Trung Tr·ª±c ƒë∆∞·ª£c t·ªï ch·ª©c h·∫±ng nƒÉm v√†o nh·ªØng ng√†y n√†o?',
        opts:['Ch·ªâ ng√†y 27 th√°ng 10 D∆∞∆°ng l·ªãch','T·ª´ ng√†y 26 ƒë·∫øn 28 th√°ng 8 √Çm l·ªãch','Ch·ªâ ng√†y 16 th√°ng 9 √Çm l·ªãch','T·ª´ ng√†y 1 ƒë·∫øn 3 th√°ng 1 D∆∞∆°ng l·ªãch'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. L·ªÖ h·ªôi ch√≠nh K·ª≥ y√™n t·∫°i ƒê√¨nh th·∫ßn Nguy·ªÖn Trung Tr·ª±c ·ªü R·∫°ch Gi√°, Ki√™n Giang ƒë∆∞·ª£c t·ªï ch·ª©c trang tr·ªçng trong 3 ng√†y t·ª´ 26 ƒë·∫øn 28 th√°ng 8 √Çm l·ªãch h·∫±ng nƒÉm, v·ªõi ng√†y ch√°nh gi·ªó (ng√†y hy sinh) l√† 27/8 √Çm l·ªãch.'
      },
      {
        q:'Anh h√πng d√¢n t·ªôc Nguy·ªÖn Trung Tr·ª±c ƒë√£ b·ªã th·ª±c d√¢n Ph√°p h√†nh quy·∫øt v√†o ng√†y n√†o?',
        opts:['Ng√†y 27 th√°ng 10 nƒÉm 1868','Ng√†y 16 th√°ng 9 nƒÉm 1868','Ng√†y 25 th√°ng 10 nƒÉm 1868','Ng√†y 16 th√°ng 9 nƒÉm 1869'],
        ans:0,
        explain:'ƒê√°p √°n ƒë√∫ng l√† A. Nguy·ªÖn Trung Tr·ª±c hy sinh v√†o ng√†y 27 th√°ng 10 nƒÉm 1868.'
      }
    ]
  }
};

/* Start quiz run: show one question at a time with explanation */
let currentQuiz = null;
let currentQIndex = 0;
let selectedOption = null;

function startQuiz(quizId, site){
  const qset = QUIZZES[quizId];
  if(!qset){ alert('Quiz ch∆∞a c√≥ n·ªôi dung.'); return; }
  currentQuiz = {id:quizId, site:site, qset:qset};
  currentQIndex = 0;
  selectedOption = null;
  renderCurrentQuestion();
}

function renderCurrentQuestion(){
  const qobj = currentQuiz.qset.items[currentQIndex];
  
  const html = `
    <div class="quiz-container">
      <div class="quiz-question">
        <h5>C√¢u ${currentQIndex+1} / ${currentQuiz.qset.items.length}</h5>
        <p class="fs-5">${qobj.q}</p>
      </div>
      
      <div class="quiz-options" id="quizOptions">
        ${qobj.opts.map((opt, i) => `
          <div class="quiz-option" data-index="${i}">
            ${opt}
          </div>
        `).join('')}
      </div>
      
      <div class="quiz-feedback" id="quizFeedback"></div>
      
      <div class="quiz-controls">
        <button class="btn btn-outline-secondary" onclick="hideGameFullscreen()">Tho√°t</button>
        <button class="btn btn-accent" id="quizNextBtn" onclick="handleAnswerAndNext()" disabled>Ti·∫øp t·ª•c</button>
      </div>
    </div>
  `;
  
  showGameFullscreen(currentQuiz.qset.title, html);
  
  document.querySelectorAll('.quiz-option').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('.quiz-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      option.classList.add('selected');
      selectedOption = parseInt(option.dataset.index);
      document.getElementById('quizNextBtn').disabled = false;
    });
  });
}

function handleAnswerAndNext(){
  if(selectedOption === null){ 
    alert('Vui l√≤ng ch·ªçn 1 ƒë√°p √°n'); 
    return; 
  }
  
  const qobj = currentQuiz.qset.items[currentQIndex];
  const fb = document.getElementById('quizFeedback');
  
  if(selectedOption === qobj.ans){
    fb.innerHTML = `<div class="correct">‚úì ƒê√°p √°n ƒë√∫ng</div><div class="explain mt-2">${qobj.explain}</div>`;
    fb.className = 'quiz-feedback correct';
  } else {
    fb.innerHTML = `<div class="wrong">‚úó ƒê√°p √°n sai</div><div class="explain mt-2">ƒê√°p √°n ƒë√∫ng: <strong>${qobj.opts[qobj.ans]}</strong><br>${qobj.explain}</div>`;
    fb.className = 'quiz-feedback wrong';
  }
  
  setTimeout(()=> {
    currentQIndex++;
    if(currentQIndex < currentQuiz.qset.items.length){
      selectedOption = null;
      renderCurrentQuestion();
    } else {
      recordDone(currentQuiz.site.id, currentQuiz.id);
      showVictory('üéâ Xu·∫•t s·∫Øc! B·∫°n ƒë√£ ho√†n th√†nh quiz!');
      hideGameFullscreen();
    }
  }, 1500);
}

/* startGameInstance wrapper called from picker */
function startGameInstance(gid, site){
  if(gid.startsWith('quiz_')) startQuiz(gid, site);
  else if(gid.startsWith('memory_')) startMemoryGame(gid, site);
  else { alert('Game ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£'); }
}

/* ---------- initial UI state ---------- */
initData();
refreshProfileAuthUI();
renderProfileBadges();
loadStories();

/* ensure map resizes when switching pages */
window.addEventListener('resize', ()=> {
  if (currentPage === 'map') {
    map.invalidateSize();
  }
});

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const analytics = firebase.analytics();
const auth = firebase.auth();
const db = firebase.firestore();

// Enable offline persistence
db.enablePersistence()
  .catch((err) => {
    console.log('Persistence failed: ', err);
  });
/* ---------------------------
  FIREBASE AUTHENTICATION SYSTEM
----------------------------*/

// Bi·∫øn to√†n c·ª•c
let currentUser = null;
let isAdmin = false;

// Theo d√µi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
auth.onAuthStateChanged(async (user) => {
  currentUser = user;
  
  if (user) {
    console.log('User logged in:', user.email);
    await checkIfAdmin(user.uid);
    refreshProfileAuthUI();
    await loadUserData();
  } else {
    console.log('User logged out');
    isAdmin = false;
    document.getElementById('analyticsMenuItem').style.display = 'none';
    refreshProfileAuthUI();
    clearLocalUserData();
  }
});

/* ---------------------------
  AUTH FUNCTIONS - THAY TH·∫æ LOCALSTORAGE
----------------------------*/

// ƒêƒÉng k√Ω v·ªõi email/password
async function registerWithEmail(name, email, password) {
  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const user = userCredential.user;
    
    await user.updateProfile({ displayName: name });
    
    await db.collection('users').doc(user.uid).set({
      name: name,
      email: email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
      badges: [],
      visitedSites: [],
      completedGames: {},
      stories: [],
      role: 'user',
      isActive: true
    });
    
    return { success: true, user: user };
  } catch (error) {
    return { success: false, message: error.message };
  }
}

// ƒêƒÉng nh·∫≠p v·ªõi email/password
async function loginWithEmail(email, password) {
  try {
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    const user = userCredential.user;
    
    await db.collection('users').doc(user.uid).update({
      lastLogin: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    return { success: true, user: user };
  } catch (error) {
    return { success: false, message: error.message };
  }
}

// ƒêƒÉng xu·∫•t
async function signOutUser() {
  try {
    await auth.signOut();
    return { success: true };
  } catch (error) {
    return { success: false, message: error.message };
  }
}
/* ---------------------------
  USER DATA MANAGEMENT
----------------------------*/

// L·∫•y th√¥ng tin user t·ª´ Firestore
async function getUserData(uid) {
  try {
    const userDoc = await db.collection('users').doc(uid).get();
    return userDoc.exists ? userDoc.data() : null;
  } catch (error) {
    console.error('Error getting user data:', error);
    return null;
  }
}

// C·∫≠p nh·∫≠t th√¥ng tin user
async function updateUserData(uid, data) {
  try {
    await db.collection('users').doc(uid).update(data);
    return true;
  } catch (error) {
    console.error('Error updating user data:', error);
    return false;
  }
}

// Load d·ªØ li·ªáu ng∆∞·ªùi d√πng
async function loadUserData() {
  if (!currentUser) return;
  
  try {
    const userData = await getUserData(currentUser.uid);
    if (userData) {
      renderUserBadges(userData.badges || []);
    }
  } catch (error) {
    console.error('Error loading user data:', error);
  }
}

// X√≥a d·ªØ li·ªáu c·ª•c b·ªô khi ƒëƒÉng xu·∫•t
function clearLocalUserData() {
  const badgeArea = document.getElementById('profile-badge-area');
  if (badgeArea) {
    badgeArea.innerHTML = '<div class="text-muted">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem huy hi·ªáu c·ªßa b·∫°n</div>';
  }
}

// Render huy hi·ªáu
function renderUserBadges(badges) {
  const wrap = document.getElementById('profile-badge-area');
  if (!wrap) return;
  
  wrap.innerHTML = '';
  
  if (!badges || badges.length === 0) {
    wrap.innerHTML = '<div class="text-muted">Ch∆∞a c√≥ huy hi·ªáu n√†o. H√£y kh√°m ph√° c√°c ƒë·ªãa ƒëi·ªÉm!</div>';
    return;
  }
  
  badges.forEach(badge => {
    const el = document.createElement('div');
    el.className = 'text-center';
    el.innerHTML = `
      <img src="${badge.icon}" class="badge-img" alt="${badge.name}">
      <div style="font-size:12px; max-width:80px">${badge.name}</div>
    `;
    wrap.appendChild(el);
  });
}
/* ---------------------------
  UI UPDATES & MIGRATION
----------------------------*/

// C·∫≠p nh·∫≠t UI ƒëƒÉng nh·∫≠p
function refreshProfileAuthUI() {
  const profileInfo = document.getElementById('profile-info');
  const btnLogin = document.getElementById('btn-profile-login');
  const btnRegister = document.getElementById('btn-profile-register');
  const btnLogout = document.getElementById('btn-profile-logout');
  
  if (!profileInfo) return;
  
  if (currentUser) {
    if (btnLogin) btnLogin.style.display = 'none';
    if (btnRegister) btnRegister.style.display = 'none';
    if (btnLogout) btnLogout.style.display = 'inline-block';
    profileInfo.innerHTML = `Xin ch√†o <strong>${currentUser.displayName}</strong> ‚Äî ${currentUser.email}`;
    profileInfo.className = 'alert alert-success';
  } else {
    if (btnLogin) btnLogin.style.display = 'inline-block';
    if (btnRegister) btnRegister.style.display = 'inline-block';
    if (btnLogout) btnLogout.style.display = 'none';
    profileInfo.innerHTML = 'B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u ti·∫øn tr√¨nh v√† nh·∫≠n huy hi·ªáu.';
    profileInfo.className = 'alert alert-info';
  }
}

// Migration d·ªØ li·ªáu t·ª´ localStorage c≈©
async function migrateLocalDataToFirebase() {
  if (!currentUser) return;
  
  try {
    const localUser = JSON.parse(localStorage.getItem('pq_user_v1'));
    if (!localUser) return;
    
    const existingData = await getUserData(currentUser.uid);
    if (!existingData.badges || existingData.badges.length === 0) {
      // Migrate badges, visited sites, games
      await updateUserData(currentUser.uid, {
        badges: localUser.badges || [],
        visitedSites: localUser.visitedSites || [],
        completedGames: localUser.completedGames || {}
      });
      
      console.log('Migration completed successfully');
    }
  } catch (error) {
    console.error('Migration failed:', error);
  }
}

// C·∫≠p nh·∫≠t h√†m auth trong modal
document.addEventListener('DOMContentLoaded', function() {
  // C·∫≠p nh·∫≠t s·ª± ki·ªán cho n√∫t ƒëƒÉng k√Ω/ƒëƒÉng nh·∫≠p
  const authModal = new bootstrap.Modal(document.getElementById('authModal'));
  
  document.getElementById('btn-profile-register')?.addEventListener('click', () => {
    document.getElementById('authTitle').innerText = 'ƒêƒÉng k√Ω';
    document.getElementById('authSubmit').onclick = handleRegister;
    document.getElementById('authAlert').classList.add('d-none');
    authModal.show();
  });
  
  document.getElementById('btn-profile-login')?.addEventListener('click', () => {
    document.getElementById('authTitle').innerText = 'ƒêƒÉng nh·∫≠p';
    document.getElementById('authSubmit').onclick = handleLogin;
    document.getElementById('authAlert').classList.add('d-none');
    authModal.show();
  });
  
  document.getElementById('btn-profile-logout')?.addEventListener('click', () => {
    signOutUser();
    alert('ƒêƒÉng xu·∫•t th√†nh c√¥ng.');
  });
});

// X·ª≠ l√Ω ƒëƒÉng k√Ω
async function handleRegister() {
  const name = document.getElementById('inName').value.trim();
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  
  if (!name || !email || !pass) {
    showAuthError('ƒêi·ªÅn ƒë·ªß t√™n, email, m·∫≠t kh·∫©u');
    return;
  }
  
  const result = await registerWithEmail(name, email, pass);
  if (result.success) {
    bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
    alert('ƒêƒÉng k√Ω th√†nh c√¥ng!');
  } else {
    showAuthError(result.message);
  }
}

// X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
async function handleLogin() {
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  
  const result = await loginWithEmail(email, pass);
  if (result.success) {
    bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
    alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
  } else {
    showAuthError(result.message);
  }
}

function showAuthError(msg) {
  const a = document.getElementById('authAlert');
  a.innerText = msg;
  a.classList.remove('d-none');
}


// Enable offline persistence
db.enablePersistence()
  .catch((err) => {
    console.log('Persistence failed: ', err);
  });

// Ki·ªÉm tra admin
async function checkIfAdmin(uid) {
  try {
    const userDoc = await db.collection('users').doc(uid).get();
    if (userDoc.exists && userDoc.data().role === 'admin') {
      isAdmin = true;
      document.getElementById('analyticsMenuItem').style.display = 'block';
    }
  } catch (error) {
    console.error('Error checking admin:', error);
  }
}
</script>
</body>
</html>

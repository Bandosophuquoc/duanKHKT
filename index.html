<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc ‚Äî D·ª± √°n KHKT: T·ª± h√†o qu√™ h∆∞∆°ng</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
  :root{
    --accent:#C62828; /* ƒë·ªè */
    --gold:#FFD54F;
    --bg:#FBFBFB;
  }
  body{font-family: "Noto Sans", system-ui, sans-serif; background:var(--bg); color:#111;}
  .container-main{max-width:1100px;margin:auto;}
  .logo{width:60px;height:60px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#B71C1C);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:22px}
  .hero{background:linear-gradient(90deg, rgba(198,40,40,0.06), rgba(255,213,79,0.02));padding:22px;border-radius:12px;margin:18px 0}
  .btn-accent{background:linear-gradient(90deg,var(--accent),#EF5350);color:white;border:none}
  #map{height:64vh;border-radius:12px}
  .badge-img{width:56px;height:56px;border-radius:8px;object-fit:cover}
  .marker-emoji{font-size:20px}
  .diatic-title{font-weight:700}
  .game-card{border-radius:10px;background:white;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  footer{padding:18px 0;color:#666;text-align:center;margin-top:18px}
  .correct{color:green;font-weight:700}
  .wrong{color:#c62828;font-weight:700}
  .explain{font-size:0.95rem;color:#444}

  /* CSS cho game gh√©p h√¨nh */
  .puzzle-container {
    text-align: center;
    padding: 20px;
  }
  
  .puzzle-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 20px;
  }
  
  .puzzle-area {
    display: flex;
    flex-direction: column;
    gap: 20px;
    align-items: center;
  }
  
  .puzzle-pieces {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    max-width: 600px;
    min-height: 100px;
    border: 2px dashed #ddd;
    padding: 15px;
    border-radius: 10px;
    background: #f8f9fa;
  }
  
  .puzzle-piece {
    width: 80px;
    height: 80px;
    border: 2px solid #ddd;
    border-radius: 8px;
    cursor: grab;
    transition: transform 0.2s;
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
    touch-action: none;
  }
  
  .puzzle-piece:hover {
    transform: scale(1.05);
    border-color: var(--accent);
  }
  
  .puzzle-board {
    width: 240px;
    height: 240px;
    border: 3px dashed #ccc;
    border-radius: 12px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    gap: 2px;
    background-color: #f8f9fa;
    padding: 5px;
    touch-action: none;
  }
  
  .puzzle-slot {
    border: 1px solid #eee;
    border-radius: 4px;
    transition: background-color 0.3s;
    touch-action: none;
  }
  
  .puzzle-slot.hover {
    background-color: #e3f2fd;
  }
  
  .puzzle-slot.filled {
    border: 2px solid #4CAF50;
  }

  .puzzle-progress {
    margin: 15px 0;
    font-weight: bold;
    color: var(--accent);
    font-size: 1.1rem;
  }
  
  .puzzle-info {
    margin-top: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
    border-radius: 10px;
    border-left: 4px solid var(--accent);
    display: none;
  }
  
  .puzzle-info.show {
    display: block;
    animation: fadeIn 0.5s ease;
  }
  
  .puzzle-complete {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, #E8F5E8, #C8E6C9);
    border-radius: 10px;
    margin-top: 20px;
    display: none;
  }
  
  .puzzle-complete.show {
    display: block;
    animation: popIn 0.5s ease;
  }

  .puzzle-controls {
    margin: 15px 0;
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .puzzle-hint {
    text-align: center;
    margin: 10px 0;
  }

  .hint-image {
    max-width: 150px;
    border-radius: 8px;
    border: 2px solid var(--accent);
    display: none;
  }

  .hint-image.show {
    display: inline-block;
    animation: fadeIn 0.5s ease;
  }

  /* Hi·ªáu ·ª©ng l·∫Øc khi sai */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  /* Hi·ªáu ·ª©ng huy hi·ªáu l·ªõn */
  .badge-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
  }

  .badge-popup-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: popIn 0.5s ease;
    max-width: 300px;
    width: 90%;
  }

  .badge-popup-img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 auto 15px;
    border: 4px solid var(--gold);
    animation: bounce 1s ease infinite;
  }

  .badge-popup-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 10px;
  }

  .badge-popup-message {
    color: #666;
    margin-bottom: 20px;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes popIn {
    0% { transform: scale(0.5); opacity: 0; }
    70% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  /* small responsive tweaks */
  @media (max-width:767px){ 
    .hero{padding:14px} 
    .badge-popup-content {
      padding: 20px;
    }
    .badge-popup-img {
      width: 100px;
      height: 100px;
    }
    .puzzle-piece {
      width: 70px;
      height: 70px;
    }
    .puzzle-board {
      width: 210px;
      height: 210px;
    }
  }

  @media (max-width:480px){ 
    .puzzle-piece {
      width: 60px;
      height: 60px;
    }
    .puzzle-board {
      width: 180px;
      height: 180px;
    }
  }
</style>
</head>
<body>
<div class="container container-main py-3">
  <!-- NAV / header -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex gap-3 align-items-center">
      <div class="logo">PQ</div>
      <div>
        <div style="font-weight:800;font-size:1.15rem">B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc</div>
        <div style="color:#666;font-size:0.9rem">D·ª± √°n KHKT ‚Äî Gi√°o d·ª•c l√≤ng t·ª± h√†o d√¢n t·ªôc (THPT An Th·ªõi)</div>
      </div>
    </div>
    <div>
      <button id="nav-home" class="btn btn-sm btn-outline-secondary me-1">Trang ch·ªß</button>
      <button id="nav-map" class="btn btn-sm btn-accent">B·∫£n ƒë·ªì s·ªë</button>
      <button id="btn-profile" class="btn btn-sm btn-outline-primary" style="display:none">T√†i kho·∫£n</button>
      <button id="btn-register" class="btn btn-sm btn-outline-dark">ƒêƒÉng k√Ω</button>
      <button id="btn-login" class="btn btn-sm btn-dark">ƒêƒÉng nh·∫≠p</button>
      <button id="btn-logout" class="btn btn-sm btn-outline-secondary" style="display:none">ƒêƒÉng xu·∫•t</button>
    </div>
  </div>

  <!-- HOME -->
  <section id="page-home">
    <div class="hero">
      <h1 style="margin:0;color:var(--accent)">B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc</h1>
      <p style="margin-top:10px;margin-bottom:8px">B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc l√† m·ªôt website gi√°o d·ª•c t∆∞∆°ng t√°c ‚Äî n∆°i h·ªçc sinh kh√°m ph√° di t√≠ch, h·ªçc l·ªãch s·ª≠ qua tr√≤ ch∆°i v√† nh·∫≠n huy hi·ªáu (badge). N·ªôi dung ph√π h·ª£p v·ªõi ch·ªß ƒë·ªÅ gi√°o d·ª•c l√≤ng t·ª± h√†o d√¢n t·ªôc v√† t√¨nh y√™u qu√™ h∆∞∆°ng.</p>
      <p style="margin:0 0 6px 0;color:#444">Trang web gi√∫p h·ªçc sinh: (1) hi·ªÉu gi√° tr·ªã di t√≠ch; (2) r√®n k·ªπ nƒÉng k·ªÉ chuy·ªán, d·ªãch thu·∫≠t v√† t∆∞ duy l·ªãch s·ª≠; (3) tr·∫£i nghi·ªám ho·∫°t ƒë·ªông h·ªçc t·∫≠p t∆∞∆°ng t√°c, g·∫ßn g≈©i Gen Z.</p>
      <p style="margin:0 0 8px 0;color:#444">B·∫£n ƒë·ªì s·ªë l√† gi·∫£i ph√°p thu·ªôc khu√¥n kh·ªï d·ª± √°n khoa h·ªçc kƒ© thu·∫≠t "<strong>Gi√°o d·ª•c l√≤ng t·ª± h√†o d√¢n t·ªôc v√† t√¨nh y√™u qu√™ h∆∞∆°ng ƒë·∫•t n∆∞·ªõc cho tu·ªïi tr·∫ª THPT An Th·ªõi</strong>".</p>
      <div class="mt-3">
        <button id="btn-start" class="btn btn-accent btn-lg">B·∫Øt ƒë·∫ßu kh√°m ph√°</button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <div class="game-card">
          <h5>√ù t∆∞·ªüng ch√≠nh</h5>
          <ul>
            <li>T√≠ch h·ª£p b·∫£n ƒë·ªì di t√≠ch ‚Äî m·ªói ƒëi·ªÉm c√≥ tin, ·∫£nh, video v√† mini-game nh·ªè.</li>
            <li>Badge & h·ªá ƒëi·ªÉm khuy·∫øn kh√≠ch, d·ªÖ ƒëo l∆∞·ªùng cho b√°o c√°o KHKT.</li>
            <li>Ph√π h·ª£p pilot: ch·∫°y ·ªü quy m√¥ l·ªõp/l·ªõp h·ªçc, kh√¥ng c·∫ßn mua host (GitHub Pages demo).</li>
          </ul>
        </div>
      </div>
      <div class="col-md-6">
        <div class="game-card">
          <h5>H∆∞·ªõng d·∫´n nhanh</h5>
          <ol style="padding-left:18px">
            <li>Nh·∫•n "B·∫Øt ƒë·∫ßu kh√°m ph√°" ƒë·ªÉ sang trang b·∫£n ƒë·ªì.</li>
            <li>Click marker ƒë·ªÉ xem th√¥ng tin; n·∫øu c√≥ mini-game, b·∫•m "Ch∆°i".</li>
            <li>ƒêƒÉng k√Ω/ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u huy hi·ªáu (demo l∆∞u local).</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- MAP PAGE -->
  <section id="page-map" style="display:none">
    <div id="map" class="mb-3"></div>

    <div class="card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div style="font-weight:700">Huy hi·ªáu c·ªßa b·∫°n</div>
          <div style="color:#666;font-size:0.9rem">L∆∞u t·∫°m tr√™n tr√¨nh duy·ªát (demo). Khi ho√†n th√†nh c√°c ƒëi·ªÅu ki·ªán, huy hi·ªáu s·∫Ω hi·ªán ·ªü ƒë√¢y.</div>
        </div>
        <div id="badge-area" class="d-flex gap-2"></div>
      </div>
    </div>

    <!-- profile area (simple) -->
    <div class="card p-3 mb-3">
      <div id="profile-area">
        <div style="font-weight:700">Trang c√° nh√¢n (demo)</div>
        <div id="profile-info" style="color:#444;margin-top:6px">B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.</div>
      </div>
    </div>
  </section>

  <footer>
    ¬© D·ª± √°n KHKT ‚Äî THPT An Th·ªõi ‚Äî Demo (mi·ªÖn ph√≠)
  </footer>
</div>

<!-- DI T√çCH MODAL -->
<div class="modal fade" id="diModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background:linear-gradient(90deg,var(--accent),#d32);color:white">
        <h5 class="modal-title" id="diTitle"></h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="diBody"></div>
      <div class="modal-footer">
        <div class="me-auto">
          <small class="text-muted">To·∫° ƒë·ªô: <span id="diCoords"></span></small>
        </div>
        <button id="btn-checkin" class="btn btn-outline-success">Check-in (T√¥i ƒë√£ ƒë·∫øn)</button>
        <button id="btn-play" class="btn btn-accent" style="display:none">Ch∆°i mini-game</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>

<!-- GAME MODAL -->
<div class="modal fade" id="gameModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background:#222;color:var(--gold)">
        <h5 class="modal-title" id="gameTitle"></h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="gameBody"></div>
      <div class="modal-footer">
        <div class="me-auto"><small id="gameNote" class="text-muted"></small></div>
        <button id="gameNext" class="btn btn-dark" style="display:none">Ti·∫øp</button>
        <button id="gameSubmit" class="btn btn-accent">Ho√†n th√†nh</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Tho√°t</button>
      </div>
    </div>
  </div>
</div>

<!-- AUTH modal -->
<div class="modal fade" id="authModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="authTitle">ƒêƒÉng k√Ω</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="authAlert" class="alert alert-danger d-none"></div>
        <input id="inName" class="form-control mb-2" placeholder="T√™n hi·ªÉn th·ªã">
        <input id="inEmail" class="form-control mb-2" placeholder="Gmail">
        <input id="inPass" type="password" class="form-control mb-2" placeholder="M·∫≠t kh·∫©u">
        <div class="form-text">Demo l∆∞u t·∫°i tr√¨nh duy·ªát. ƒê·ªÉ d√πng th·ª±c, s·∫Ω h∆∞·ªõng d·∫´n t√≠ch h·ª£p Firebase.</div>
      </div>
      <div class="modal-footer">
        <button id="authSubmit" class="btn btn-dark">X√°c nh·∫≠n</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">H·ªßy</button>
      </div>
    </div>
  </div>
</div>

<!-- Badge Popup Modal -->
<div id="badgePopup" class="badge-popup" style="display:none">
  <div class="badge-popup-content">
    <img id="badgePopupImg" src="" class="badge-popup-img" alt="Huy hi·ªáu">
    <div id="badgePopupTitle" class="badge-popup-title"></div>
    <div id="badgePopupMessage" class="badge-popup-message">Ch√∫c m·ª´ng! B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c huy hi·ªáu</div>
    <button id="badgePopupClose" class="btn btn-accent">Tuy·ªát v·ªùi!</button>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
/* ---------------------------
  D·ªØ li·ªáu ƒëi·ªÉm (ƒë√£ c·∫≠p nh·∫≠t v·ªõi t·ªça ƒë·ªô ch√≠nh x√°c c·ªßa b·∫°n)
----------------------------*/
const DI_TICH = [
  {
    id:'chua',
    name:'Ch√πa H·ªô Qu·ªëc',
    address:'426H+GVQ, D∆∞∆°ng T∆°, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Thi·ªÅn vi·ªán Tr√∫c L√¢m H·ªô Qu·ªëc ‚Äî ki·∫øn tr√∫c t√¢m linh l·ªõn, phong c√°ch c·ªï truy·ªÅn Vi·ªát.',
    extra:['Ng√¥i ch√πa l·ªõn nh·∫•t Ph√∫ Qu·ªëc', 'Ki·∫øn tr√∫c truy·ªÅn th·ªëng Vi·ªát Nam', 'Kh√¥ng gian t√¢m linh thanh t·ªãnh'],
    lat:10.110028, lng:104.029056, // 10¬∞06'36.1"N 104¬∞01'44.6"E
    games:[],
    img: 'images/chua.jpg'
  },
  {
    id:'nha-tu',
    name:'Nh√† t√π Ph√∫ Qu·ªëc',
    address:'350 ƒê. Nguy·ªÖn VƒÉn C·ª´, An Th·ªõi, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Di t√≠ch l·ªãch s·ª≠ c·∫•p Qu·ªëc gia ƒë·∫∑c bi·ªát (2014). N∆°i giam gi·ªØ nhi·ªÅu t√π binh trong kh√°ng chi·∫øn; ch·ª©ng t√≠ch tra t·∫•n, nh∆∞ng c≈©ng l√† bi·ªÉu t∆∞·ª£ng √Ω ch√≠ ki√™n c∆∞·ªùng.',
    extra:[
      'NƒÉm x√¢y d·ª±ng: 01/06/1967',
      'C√≤n g·ªçi: Nh√† lao C√¢y D·ª´a',
      'Kho·∫£ng 40.000 t√π binh t·ª´ng b·ªã giam; nhi·ªÅu t√π nh√¢n b·ªã tra t·∫•n d√£ man. C√≥ 45 cu·ªôc v∆∞·ª£t ng·ª•c ghi nh·∫≠n.'
    ],
    lat:10.044417, lng:104.017639, // 10¬∞02'39.9"N 104¬∞01'03.5"E
    games:['quiz_nhatu', 'puzzle_nhatu'],
    img: 'images/nhatupq3.jpg'
  },
  {
    id:'nha-thung',
    name:'Nh√† th√πng n∆∞·ªõc m·∫Øm Ph√∫ Qu·ªëc (Ph·ª•ng H∆∞ng)',
    address:'471 ƒê. Nguy·ªÖn VƒÉn C·ª´, Khu 2, Ph√∫ Qu·ªëc, Ki√™n Giang',
    note:'Nh√† th√πng n∆∞·ªõc m·∫Øm truy·ªÅn th·ªëng; ngh·ªÅ truy·ªÅn th·ªëng c·ªßa ƒë·∫£o.',
    extra:['L·ªãch s·ª≠: h√†ng trƒÉm nƒÉm, ph∆∞∆°ng th·ª©c ·ªß mu·ªëi truy·ªÅn th·ªëng', 'N∆∞·ªõc m·∫Øm Ph√∫ Qu·ªëc n·ªïi ti·∫øng th∆°m ngon'],
    lat:10.044917, lng:104.017444, // 10¬∞02'41.7"N 104¬∞01'02.8"E
    games:[],
    img:'images/nhathung.jpg'
  },
  {
    id:'ham-ninh',
    name:'L√†ng ch√†i H√†m Ninh',
    address:'52JV+6XX, TL47, R·∫°ch H√†m, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'L√†ng ch√†i c·ªï, n·ªïi ti·∫øng h·∫£i s·∫£n t∆∞∆°i, gh·∫π H√†m Ninh.',
    extra:['L√†ng ch√†i truy·ªÅn th·ªëng l√¢u ƒë·ªùi', 'N·ªïi ti·∫øng v·ªõi gh·∫π H√†m Ninh t∆∞∆°i ngon', 'C·∫£nh bi·ªÉn ƒë·∫πp, b√¨nh y√™n'],
    lat:10.180917, lng:104.048472, // 10¬∞10'51.3"N 104¬∞02'54.5"E
    games:[],
    img:'images/langchai.jpg'
  },
  {
    id:'baotang',
    name:'B·∫£o t√†ng C·ªôi Ngu·ªìn',
    address:'Ph√∫ Qu·ªëc, Ki√™n Giang',
    note:'B·∫£o t√†ng tr∆∞ng b√†y l·ªãch s·ª≠-vƒÉn h√≥a ƒë·ªãa ph∆∞∆°ng',
    extra:['Tr∆∞ng b√†y l·ªãch s·ª≠, vƒÉn h√≥a Ph√∫ Qu·ªëc', 'B·ªô s∆∞u t·∫≠p c·ªï v·∫≠t phong ph√∫', 'Ki·∫øn tr√∫c ƒë·ªôc ƒë√°o'],
    lat:10.192500, lng:103.967000, // 10¬∞11'33.0"N 103¬∞58'01.2"E
    games:[],
    img:'images/coinguon.jpg'
  },
  {
    id:'dinh-cau',
    name:'Dinh C·∫≠u',
    address:'Khu ph·ªë 2, Tp. Ph√∫ Qu·ªëc, Ki√™n Giang 92500, Vi·ªát Nam',
    note:'Di t√≠ch th·∫Øng c·∫£nh; t√≠n ng∆∞·ª°ng c·ªßa ng∆∞ d√¢n, c√≥ l·ªÖ h·ªôi h√†ng nƒÉm (15‚Äì16/10 √¢m l·ªãch).',
    extra:['X√¢y d·ª±ng: 1937 (tu s·ª≠a 1997)','Bi·ªÉu t∆∞·ª£ng t√¢m linh c·ªßa ng∆∞·ªùi d√¢n ƒë·ªãa ph∆∞∆°ng', 'V·ªã tr√≠ ƒë·∫πp nh√¨n ra bi·ªÉn'],
    lat:10.217194, lng:103.956500, // 10¬∞13'01.9"N 103¬∞57'23.4"E
    games:[],
    img:'images/dinhcau.jpg'
  },
  {
    id:'dinh-ntt',
    name:'ƒê√¨nh Th·∫ßn Nguy·ªÖn Trung Tr·ª±c',
    address:'9RFV+848, G√†nh D·∫ßu, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Di t√≠ch l·ªãch s·ª≠ vƒÉn h√≥a. ƒê√¨nh th·ªù Anh h√πng d√¢n t·ªôc Nguy·ªÖn Trung Tr·ª±c (1839-1868).',
    extra:[
      'ƒê√¨nh ƒë∆∞·ª£c x√¢y d·ª±ng t·ª´ nƒÉm 1882',
      'L·ªÖ gi·ªó t·ªï ch·ª©c h√†ng nƒÉm (√¢m l·ªãch) ‚Äî ho·∫°t ƒë·ªông truy·ªÅn th·ªëng h∆°n 100 nƒÉm',
      'Nguy·ªÖn Trung Tr·ª±c n·ªïi ti·∫øng v·ªõi chi·∫øn c√¥ng ƒë·ªët t√†u Ph√°p tr√™n s√¥ng Nh·∫≠t T·∫£o.'
    ],
    lat:10.373306, lng:103.842972, // 10¬∞22'23.9"N 103¬∞50'34.7"E
    games:['quiz_trungtruc', 'puzzle_trungtruc'],
    img:'images/dinhntt.jpg'
  }
];

/* -----------------------
  Local demo storage keys
------------------------*/
const STORAGE_USER = 'pq_user_demo_v1';
const STORAGE_BADGES = 'pq_badges_demo_v1';
const STORAGE_DONE = 'pq_done_games_v1';
const STORAGE_VISIT = 'pq_visited_v1';

/* --------- Helpers ------------- */
function saveUser(u){ localStorage.setItem(STORAGE_USER, JSON.stringify(u)) }
function loadUser(){ return JSON.parse(localStorage.getItem(STORAGE_USER) || 'null') }
function loadBadges(){ return JSON.parse(localStorage.getItem(STORAGE_BADGES) || '[]') }
function saveBadges(a){ localStorage.setItem(STORAGE_BADGES, JSON.stringify(a)) }
function loadDone(){ return JSON.parse(localStorage.getItem(STORAGE_DONE) || '{}') }
function saveDone(o){ localStorage.setItem(STORAGE_DONE, JSON.stringify(o)) }
function loadVisited(){ return JSON.parse(localStorage.getItem(STORAGE_VISIT) || '[]') }
function saveVisited(a){ localStorage.setItem(STORAGE_VISIT, JSON.stringify(a)) }

/* ---------- UI & Navigation ---------- */
const pageHome = document.getElementById('page-home');
const pageMap = document.getElementById('page-map');
const navHome = document.getElementById('nav-home');
const navMap = document.getElementById('nav-map');
const btnStart = document.getElementById('btn-start');
const btnRegister = document.getElementById('btn-register');
const btnLogin = document.getElementById('btn-login');
const btnLogout = document.getElementById('btn-logout');
const btnProfileNav = document.getElementById('btn-profile');

function showHome(){ pageHome.style.display='block'; pageMap.style.display='none'; }
function showMap(){ pageHome.style.display='none'; pageMap.style.display='block'; setTimeout(()=> map.invalidateSize(),300); }

navHome.onclick = showHome;
navMap.onclick = showMap;
btnStart.onclick = ()=> { showMap(); window.scrollTo(0,0); }

/* Auth modal */
const authModal = new bootstrap.Modal(document.getElementById('authModal'));
document.getElementById('btn-register').addEventListener('click', ()=> {
  document.getElementById('authTitle').innerText = 'ƒêƒÉng k√Ω'; document.getElementById('authSubmit').onclick = authRegister; document.getElementById('authAlert').classList.add('d-none');
  authModal.show();
});
document.getElementById('btn-login').addEventListener('click', ()=> {
  document.getElementById('authTitle').innerText = 'ƒêƒÉng nh·∫≠p'; document.getElementById('authSubmit').onclick = authLogin; document.getElementById('authAlert').classList.add('d-none');
  authModal.show();
});
document.getElementById('btn-logout').addEventListener('click', ()=> {
  localStorage.removeItem(STORAGE_USER);
  refreshAuthUI();
  alert('ƒêƒÉng xu·∫•t th√†nh c√¥ng (demo).');
});

/* auth functions */
function authRegister(){
  const name = document.getElementById('inName').value.trim();
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  if(!name || !email || !pass){ showAuthError('ƒêi·ªÅn ƒë·ªß t√™n, email, m·∫≠t kh·∫©u'); return; }
  // simple store (demo) ‚Äî overwrite allowed
  const u = {name,email,pass};
  saveUser(u);
  alert('ƒêƒÉng k√Ω th√†nh c√¥ng (demo). Vui l√≤ng ƒëƒÉng nh·∫≠p.');
  authModal.hide();
}
function authLogin(){
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  const u = loadUser();
  if(!u || u.email !== email || u.pass !== pass){ showAuthError('Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng (demo)'); return; }
  // login success
  authModal.hide();
  refreshAuthUI();
  alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng. Xin ch√†o ' + u.name);
}
function showAuthError(msg){ const a=document.getElementById('authAlert'); a.innerText=msg; a.classList.remove('d-none'); }
function refreshAuthUI(){
  const u = loadUser();
  if(u){ document.getElementById('btn-login').style.display='none'; document.getElementById('btn-register').style.display='none'; document.getElementById('btn-logout').style.display='inline-block'; document.getElementById('btn-profile').style.display='inline-block'; document.getElementById('btn-profile').innerText = u.name; document.getElementById('profile-info').innerText = `Xin ch√†o, ${u.name} ‚Äî ${u.email}`; renderBadges(); } else { document.getElementById('btn-login').style.display='inline-block'; document.getElementById('btn-register').style.display='inline-block'; document.getElementById('btn-logout').style.display='none'; document.getElementById('btn-profile').style.display='none'; document.getElementById('profile-info').innerText = 'B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.'; renderBadges(); }
}
btnProfileNav.addEventListener('click', ()=> { showMap(); window.scrollTo(0,0); });

/* ---------- Map init ---------- */
const map = L.map('map', {zoomControl:true}).setView([10.28,103.98], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(map);

function makeIcon(hasGame){
  const color = hasGame ? '#C62828' : '#1976D2';
  return L.divIcon({className:'custom-pin', html:`<div style="background:${color};width:18px;height:18px;border-radius:50%;border:3px solid white"></div>`, iconSize:[24,24], iconAnchor:[12,12]});
}

/* render markers */
DI_TICH.forEach(p=>{
  const m = L.marker([p.lat,p.lng], {icon: makeIcon(p.games.length>0)}).addTo(map);
  m.on('click', ()=> openDiModal(p));
});

/* modal instances */
const diModal = new bootstrap.Modal(document.getElementById('diModal'));
const gameModal = new bootstrap.Modal(document.getElementById('gameModal'));

/* open di t√≠ch modal (with details) */
function openDiModal(p){
  document.getElementById('diTitle').innerText = p.name;
  // build html content with full details
  const extras = p.extra.map(x=>`<li>${x}</li>`).join('');
  const html = `
    <div class="row">
      <div class="col-md-5"><img src="${p.img}" alt="${p.name}" style="width:100%;border-radius:8px;object-fit:cover"></div>
      <div class="col-md-7">
        <h5 class="diatic-title">${p.name}</h5>
        <p style="margin:0">${p.address}</p>
        <p style="margin-top:8px;color:#333">${p.note}</p>
        ${extras ? `<ul>${extras}</ul>` : ''}
      </div>
    </div>
  `;
  document.getElementById('diBody').innerHTML = html;
  document.getElementById('diCoords').innerText = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
  const btnPlay = document.getElementById('btn-play');
  if(p.games && p.games.length){
    btnPlay.style.display='inline-block';
    btnPlay.onclick = ()=> { diModal.hide(); openGamePicker(p); };
  } else { btnPlay.style.display='none'; btnPlay.onclick=null; }
  // check-in button
  document.getElementById('btn-checkin').onclick = ()=> {
    const u = loadUser();
    if(!u){ alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi check-in.'); return; }
    markVisited(p.id);
    awardBadgeSite(p.id,p.name);
  };
  diModal.show();
}

/* ---------- Badges & check-in logic ---------- */
function getBadges(){ return loadBadges(); }
function awardBadge(id,name,icon){
  const arr = getBadges();
  if(arr.find(b=>b.id===id)) return false;
  arr.push({id,name,icon:icon || `https://via.placeholder.com/64/FFD54F/000?text=${encodeURIComponent(name.charAt(0))}`});
  saveBadges(arr);
  renderBadges();
  confetti({particleCount:80,spread:60,origin:{y:0.4}});
  return true;
}
function renderBadges(){
  const wrap = document.getElementById('badge-area');
  wrap.innerHTML = '';
  const arr = getBadges();
  arr.forEach(b=>{
    const el = document.createElement('div');
    el.innerHTML = `<div style="text-align:center"><img src="${b.icon}" class="badge-img"><div style="font-size:12px">${b.name}</div></div>`;
    wrap.appendChild(el);
  });
  // also show in profile area if logged in
  const u = loadUser();
  if(u){
    document.getElementById('profile-info').innerHTML = `Xin ch√†o ${u.name} ‚Äî <div style="margin-top:6px">Huy hi·ªáu: ${arr.map(x=>x.name).join(', ') || 'Ch∆∞a c√≥'}</div>`;
  }
}

/* mark visited and award site badge */
function markVisited(siteId){
  const v = loadVisited();
  if(!v.includes(siteId)){ v.push(siteId); saveVisited(v); renderBadges(); }
}
function awardBadgeSite(siteId, siteName){
  const id = `site_${siteId}`;
  const name = `${siteName}`;
  // T·∫°o mapping gi·ªØa siteId v√† URL ·∫£nh huy hi·ªáu
  const badgeIcons = {
    'chua': 'images/hhchua.jpg',
    'nha-tu': 'images/hhnhatupq.jpg',
    'nha-thung': 'images/hhnhathung.jpg',
    'ham-ninh': 'images/hhlangchai.jpg',
    'baotang': 'images/hhcoinguon.jpg',
    'dinh-cau': 'images/hhdinhcau.jpg',
    'dinh-ntt': 'images/hhdinhntt.jpg'
  };
  
  const badgeIcon = badgeIcons[siteId] || `https://via.placeholder.com/64/C33/fff?text=${encodeURIComponent(siteName.split(' ')[0].charAt(0))}`;
  
  // Hi·ªÉn th·ªã popup huy hi·ªáu
  showBadgePopup(name, badgeIcon);
  
  awardBadge(id, name, badgeIcon);
}

/* Hi·ªÉn th·ªã popup huy hi·ªáu l·ªõn */
function showBadgePopup(badgeName, badgeIcon) {
  const popup = document.getElementById('badgePopup');
  const popupImg = document.getElementById('badgePopupImg');
  const popupTitle = document.getElementById('badgePopupTitle');
  const popupClose = document.getElementById('badgePopupClose');
  
  // Thi·∫øt l·∫≠p n·ªôi dung
  popupImg.src = badgeIcon;
  popupTitle.textContent = badgeName;
  
  // Hi·ªÉn th·ªã popup
  popup.style.display = 'flex';
  
  // B·∫Øn ph√°o hoa
  confetti({
    particleCount: 150,
    spread: 70,
    origin: { y: 0.6 },
    colors: ['#C62828', '#FFD54F', '#4CAF50', '#2196F3']
  });
  
  // T·ª± ƒë·ªông t·∫Øt sau 3 gi√¢y ho·∫∑c khi click
  const autoClose = setTimeout(() => {
    closeBadgePopup();
  }, 3000);
  
  // S·ª± ki·ªán click ƒë·ªÉ ƒë√≥ng
  popupClose.onclick = () => {
    clearTimeout(autoClose);
    closeBadgePopup();
  };
  
  // Click ra ngo√†i ƒë·ªÉ ƒë√≥ng
  popup.onclick = (e) => {
    if (e.target === popup) {
      clearTimeout(autoClose);
      closeBadgePopup();
    }
  };
}

function closeBadgePopup() {
  const popup = document.getElementById('badgePopup');
  popup.style.display = 'none';
}

/* record game completion */
function recordDone(siteId, gameId){
  const o = loadDone();
  if(!o[siteId]) o[siteId]=[];
  if(!o[siteId].includes(gameId)){ o[siteId].push(gameId); saveDone(o); renderBadges(); }
}

/* ---------- Game picker & implementations ---------- */
function openGamePicker(site){
  document.getElementById('gameTitle').innerText = `Mini-game ‚Äî ${site.name}`;
  // build a selection
  const html = `<div><p>Ch·ªçn mini-game:</p><div class="d-flex gap-2 flex-wrap">` +
    site.games.map(g=>`<button class="btn btn-outline-dark game-choice" data-game="${g}">${labelGame(g)}</button>`).join('') +
    `</div></div>`;
  document.getElementById('gameBody').innerHTML = html;
  document.getElementById('gameNote').innerText = 'M·ªói mini-game c√≥ 1‚Äì6 b∆∞·ªõc. K·∫øt qu·∫£ s·∫Ω l∆∞u v√†o h·ªì s∆° c·ªßa b·∫°n (demo).';
  document.getElementById('gameSubmit').style.display='none';
  document.getElementById('gameNext').style.display='none';
  gameModal.show();
  // attach click listeners
  document.querySelectorAll('.game-choice').forEach(btn=> btn.addEventListener('click', ()=> {
    const g = btn.dataset.game;
    startGameInstance(g, site);
  }));
}

function labelGame(id){
  const map = {
    'quiz_nhatu':'Quiz (Nh√† t√π)',
    'quiz_trungtruc':'Quiz (ƒê√¨nh)',
    'puzzle_nhatu':'M·∫£nh gh√©p l·ªãch s·ª≠ (Nh√† t√π)',
    'puzzle_trungtruc':'M·∫£nh gh√©p l·ªãch s·ª≠ (ƒê√¨nh)'
  };
  return map[id]||id;
}
/* ---------- GAME GH√âP H√åNH ---------- */
const PUZZLE_GAMES = {
  'puzzle_nhatu': {
    title: 'M·∫£nh gh√©p l·ªãch s·ª≠ - Nh√† t√π Ph√∫ Qu·ªëc',
    pieceImages: [
      'images/chuongcop1.jpg',
      'images/chuongcop2.jpg',
      'images/chuongcop3.jpg',
      'images/chuongcop4.jpg',
      'images/chuongcop5.jpg',
      'images/chuongcop6.jpg',
      'images/chuongcop7.jpg',
      'images/chuongcop8.jpg',
      'images/chuongcop9.jpg'
    ],
    pieces: 9,
    info: 'Chu·ªìng c·ªçp k·∫Ωm gai t·∫°i Nh√† t√π Ph√∫ Qu·ªëc - m·ªôt trong nh·ªØng h√¨nh th·ª©c tra t·∫•n d√£ man nh·∫•t. T√π nh√¢n b·ªã nh·ªët trong c√°c chu·ªìng s·∫Øt nh·ªè h·∫πp v·ªõi h√†ng r√†o k·∫Ωm gai bao quanh, kh√¥ng th·ªÉ ƒë·ª©ng th·∫≥ng hay n·∫±m tho·∫£i m√°i. H·ªç ph·∫£i ch·ªãu ƒë·ª±ng c√°i n√≥ng thi√™u ƒë·ªët ban ng√†y v√† c√°i l·∫°nh bu·ªët x∆∞∆°ng ban ƒë√™m, c√πng v·ªõi nh·ªØng v·∫øt th∆∞∆°ng do k·∫Ωm gai g√¢y ra.'
  },
  'puzzle_trungtruc': {
    title: 'M·∫£nh gh√©p l·ªãch s·ª≠ - ƒê√¨nh Nguy·ªÖn Trung Tr·ª±c',
    pieceImages: [
      'images/NguyenTT1.jpg',
      'images/NguyenTT2.jpg',
      'images/NguyenTT3.jpg',
      'images/NguyenTT4.jpg',
      'images/NguyenTT5.jpg',
      'images/NguyenTT6.jpg',
      'images/NguyenTT7.jpg',
      'images/NguyenTT8.jpg',
      'images/NguyenTT9.jpg'
    ],
    pieces: 9,
    info: 'ƒê√¨nh th·∫ßn Nguy·ªÖn Trung Tr·ª±c - c√¥ng tr√¨nh ki·∫øn tr√∫c t√¢m linh quan tr·ªçng b·∫≠c nh·∫•t ·ªü Ph√∫ Qu·ªëc. ƒê√¨nh ƒë∆∞·ª£c x√¢y d·ª±ng t·ª´ nƒÉm 1882 ƒë·ªÉ th·ªù v·ªã anh h√πng d√¢n t·ªôc Nguy·ªÖn Trung Tr·ª±c - ng∆∞·ªùi ƒë√£ c√≥ c√¥ng l·ªõn trong cu·ªôc kh√°ng chi·∫øn ch·ªëng th·ª±c d√¢n Ph√°p. Ki·∫øn tr√∫c ƒë√¨nh mang ƒë·∫≠m phong c√°ch Nam B·ªô v·ªõi m√°i ng√≥i √¢m d∆∞∆°ng, c·ªôt g·ªó qu√Ω v√† c√°c h·ªça ti·∫øt trang tr√≠ tinh x·∫£o.'
  }
};

let currentPuzzleGame = null;
let placedPieces = 0;
let draggedPiece = null;

function startPuzzleGame(gameId, site) {
  const puzzleData = PUZZLE_GAMES[gameId];
  if (!puzzleData) {
    alert('Game gh√©p h√¨nh ch∆∞a c√≥ n·ªôi dung.');
    return;
  }

  currentPuzzleGame = { id: gameId, site: site, puzzleData: puzzleData };
  placedPieces = 0;
  
  loadPuzzle();
  
  document.getElementById('gameTitle').innerText = puzzleData.title;
  document.getElementById('gameNote').innerText = 'K√©o th·∫£ c√°c m·∫£nh gh√©p v√†o ƒë√∫ng v·ªã tr√≠ tr√™n b·∫£ng';
  document.getElementById('gameSubmit').style.display = 'none';
  document.getElementById('gameNext').style.display = 'none';
  
  gameModal.show();
}

function loadPuzzle() {
  const puzzle = currentPuzzleGame.puzzleData;
  
  const html = `
    <div class="puzzle-container">
      <div class="puzzle-title">${puzzle.title}</div>
      <div class="puzzle-progress">ƒê√£ gh√©p: <span id="placedCount">0</span>/${puzzle.pieces} m·∫£nh</div>
      
      <div class="puzzle-controls">
        <button class="btn btn-outline-primary btn-sm" onclick="showHint()">Xem g·ª£i √Ω (3s)</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="shufflePieces()">X√°o tr·ªôn l·∫°i</button>
      </div>
      
      <div class="puzzle-hint">
        <img id="hintImage" class="hint-image" src="${puzzle.pieceImages[0].replace('1.jpg', 'full.jpg')}" alt="G·ª£i √Ω">
      </div>
      
      <div class="puzzle-area">
        <div class="puzzle-pieces" id="puzzlePieces">
          <div style="color:#666;padding:20px">ƒêang t·∫£i m·∫£nh gh√©p...</div>
        </div>
        <div class="puzzle-board" id="puzzleBoard"></div>
      </div>
      
      <div class="puzzle-info" id="puzzleInfo"></div>
      <div class="puzzle-complete" id="puzzleComplete">
        <h5>üéâ Ch√∫c m·ª´ng!</h5>
        <p>B·∫°n ƒë√£ ho√†n th√†nh gh√©p h√¨nh!</p>
        <button class="btn btn-accent mt-2" onclick="finishPuzzleGame()">Ho√†n th√†nh</button>
      </div>
    </div>
  `;
  
  document.getElementById('gameBody').innerHTML = html;
  
  // T·∫°o board v·ªõi c√°c √¥
  const board = document.getElementById('puzzleBoard');
  const piecesContainer = document.getElementById('puzzlePieces');
  
  // X√≥a n·ªôi dung c≈©
  piecesContainer.innerHTML = '';
  board.innerHTML = '';
  
  // T·∫°o c√°c √¥ tr·ªëng tr√™n board
  for (let i = 0; i < puzzle.pieces; i++) {
    const slot = document.createElement('div');
    slot.className = 'puzzle-slot';
    slot.dataset.index = i;
    board.appendChild(slot);
  }
  
  // T·∫°o c√°c m·∫£nh gh√©p
  createPuzzlePieces();
}

function createPuzzlePieces() {
  const puzzle = currentPuzzleGame.puzzleData;
  const piecesContainer = document.getElementById('puzzlePieces');
  
  piecesContainer.innerHTML = '';
  
  // T·∫°o t·∫•t c·∫£ 9 m·∫£nh gh√©p
  for (let i = 0; i < puzzle.pieces; i++) {
    const piece = document.createElement('div');
    piece.className = 'puzzle-piece';
    piece.dataset.index = i;
    
    // T·∫°o placeholder v·ªõi s·ªë th·ª© t·ª±
    piece.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;font-size:14px;font-weight:bold;">${i+1}</div>`;
    piece.style.background = '#f8f9fa';
    piece.style.border = '2px solid #dee2e6';
    
    // Th√™m s·ª± ki·ªán k√©o th·∫£
    addDragEvents(piece);
    
    piecesContainer.appendChild(piece);
  }
  
  // T·∫£i ·∫£nh th·ª±c t·∫ø
  loadActualImages();
}

function loadActualImages() {
  const puzzle = currentPuzzleGame.puzzleData;
  const pieces = document.querySelectorAll('.puzzle-piece');
  let loadedCount = 0;
  
  console.log(`B·∫Øt ƒë·∫ßu t·∫£i ${puzzle.pieces} ·∫£nh cho game ${currentPuzzleGame.id}`);
  
  pieces.forEach((piece, index) => {
    const img = new Image();
    
    img.onload = function() {
      console.log(`‚úÖ ƒê√£ t·∫£i ·∫£nh ${index + 1}: ${puzzle.pieceImages[index]}`);
      // Khi ·∫£nh t·∫£i xong, c·∫≠p nh·∫≠t background
      piece.style.backgroundImage = `url('${puzzle.pieceImages[index]}')`;
      piece.style.backgroundSize = 'cover';
      piece.style.backgroundPosition = 'center';
      piece.style.backgroundRepeat = 'no-repeat';
      piece.innerHTML = ''; // X√≥a s·ªë placeholder
      
      loadedCount++;
      console.log(`üìä ƒê√£ t·∫£i ${loadedCount}/${puzzle.pieces} ·∫£nh`);
      
      // Khi t·∫•t c·∫£ ·∫£nh ƒë√£ t·∫£i xong
      if (loadedCount === puzzle.pieces) {
        console.log('üéâ T·∫•t c·∫£ ·∫£nh ƒë√£ t·∫£i xong!');
        addSlotEvents();
        shufflePieces();
      }
    };
    
    img.onerror = function() {
      console.error(`‚ùå L·ªói t·∫£i ·∫£nh ${index + 1}: ${puzzle.pieceImages[index]}`);
      // Gi·ªØ nguy√™n placeholder n·∫øu ·∫£nh l·ªói
      piece.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#dc3545;font-size:12px;">L·ªói<br>·∫£nh ${index+1}</div>`;
      piece.style.background = '#ffebee';
      piece.style.border = '2px solid #dc3545';
      
      loadedCount++;
      if (loadedCount === puzzle.pieces) {
        addSlotEvents();
        shufflePieces();
      }
    };
    
    // B·∫Øt ƒë·∫ßu t·∫£i ·∫£nh
    console.log(`üîÑ ƒêang t·∫£i ·∫£nh ${index + 1}: ${puzzle.pieceImages[index]}`);
    img.src = puzzle.pieceImages[index];
  });
}

// H√ÄM TH√äM S·ª∞ KI·ªÜN K√âO TH·∫¢
function addDragEvents(element) {
  // Desktop events
  element.addEventListener('dragstart', handleDragStart);
  element.addEventListener('dragend', handleDragEnd);
  
  // Mobile touch events
  element.addEventListener('touchstart', handleTouchStart, { passive: false });
  element.addEventListener('touchmove', handleTouchMove, { passive: false });
  element.addEventListener('touchend', handleTouchEnd);
}

function addSlotEvents() {
  const slots = document.querySelectorAll('.puzzle-slot');
  slots.forEach(slot => {
    slot.addEventListener('dragover', handleDragOver);
    slot.addEventListener('drop', handleDrop);
    slot.addEventListener('dragenter', handleDragEnter);
    slot.addEventListener('dragleave', handleDragLeave);
    
    // Mobile events for slots
    slot.addEventListener('touchmove', handleTouchMove, { passive: false });
    slot.addEventListener('touchend', handleTouchEnd);
  });
}

// TOUCH HANDLERS CHO MOBILE
function handleTouchStart(e) {
  e.preventDefault();
  const touch = e.touches[0];
  draggedPiece = this;
  this.style.opacity = '0.7';
  
  const rect = this.getBoundingClientRect();
  this.dataset.startX = touch.clientX - rect.left;
  this.dataset.startY = touch.clientY - rect.top;
}

function handleTouchMove(e) {
  e.preventDefault();
  if (!draggedPiece) return;
  
  const touch = e.touches[0];
  draggedPiece.style.position = 'fixed';
  draggedPiece.style.zIndex = '1000';
  draggedPiece.style.left = (touch.clientX - draggedPiece.dataset.startX) + 'px';
  draggedPiece.style.top = (touch.clientY - draggedPiece.dataset.startY) + 'px';
}

function handleTouchEnd(e) {
  if (!draggedPiece) return;
  
  const touch = e.changedTouches[0];
  const elements = document.elementsFromPoint(touch.clientX, touch.clientY);
  const slot = elements.find(el => el.classList.contains('puzzle-slot'));
  
  if (slot && !slot.hasChildNodes()) {
    handleDropOnSlot(slot, draggedPiece);
  }
  
  // Reset style
  draggedPiece.style.position = '';
  draggedPiece.style.zIndex = '';
  draggedPiece.style.left = '';
  draggedPiece.style.top = '';
  draggedPiece.style.opacity = '1';
  draggedPiece = null;
}

// DRAG AND DROP HANDLERS (DESKTOP)
function handleDragStart(e) {
  draggedPiece = this;
  this.style.opacity = '0.7';
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', this.dataset.index);
}

function handleDragEnd(e) {
  this.style.opacity = '1';
  draggedPiece = null;
}

function handleDragOver(e) {
  e.preventDefault();
  return false;
}

function handleDragEnter(e) {
  this.classList.add('hover');
}

function handleDragLeave(e) {
  this.classList.remove('hover');
}

function handleDrop(e) {
  e.preventDefault();
  this.classList.remove('hover');
  
  if (draggedPiece && !this.hasChildNodes()) {
    handleDropOnSlot(this, draggedPiece);
  }
  return false;
}

// H√ÄM X·ª¨ L√ù CHUNG CHO C·∫¢ DESKTOP V√Ä MOBILE
function handleDropOnSlot(slot, piece) {
  const pieceIndex = parseInt(piece.dataset.index);
  const slotIndex = parseInt(slot.dataset.index);
  
  if (pieceIndex === slotIndex) {
    // ƒê√∫ng v·ªã tr√≠
    slot.appendChild(piece);
    slot.classList.add('filled');
    piece.style.cursor = 'default';
    piece.draggable = false;
    
    // Remove touch events khi ƒë√£ ƒë·∫∑t ƒë√∫ng
    piece.removeEventListener('touchstart', handleTouchStart);
    piece.removeEventListener('touchmove', handleTouchMove);
    piece.removeEventListener('touchend', handleTouchEnd);
    
    placedPieces++;
    document.getElementById('placedCount').textContent = placedPieces;
    
    // Ki·ªÉm tra ho√†n th√†nh
    if (placedPieces === currentPuzzleGame.puzzleData.pieces) {
      showPuzzleInfo();
    }
  } else {
    // Sai v·ªã tr√≠ - hi·ªáu ·ª©ng l·∫Øc
    piece.style.animation = 'shake 0.5s';
    setTimeout(() => {
      piece.style.animation = '';
    }, 500);
  }
}

function shufflePieces() {
  const pieces = document.querySelectorAll('.puzzle-piece');
  const piecesArray = Array.from(pieces);
  const piecesContainer = document.getElementById('puzzlePieces');
  
  // X√≥a h·∫øt tr∆∞·ªõc khi x√°o tr·ªôn
  piecesContainer.innerHTML = '';
  
  // X√°o tr·ªôn v√† th√™m l·∫°i
  for (let i = piecesArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    piecesContainer.appendChild(piecesArray[j]);
  }
}

function showHint() {
  const hintImage = document.getElementById('hintImage');
  hintImage.classList.add('show');
  
  setTimeout(() => {
    hintImage.classList.remove('show');
  }, 3000);
}

function showPuzzleInfo() {
  const puzzle = currentPuzzleGame.puzzleData;
  const infoDiv = document.getElementById('puzzleInfo');
  const completeDiv = document.getElementById('puzzleComplete');
  
  infoDiv.innerHTML = `<h6>Th√¥ng tin l·ªãch s·ª≠:</h6><p>${puzzle.info}</p>`;
  infoDiv.classList.add('show');
  completeDiv.classList.add('show');
  
  // B·∫Øn ph√°o hoa
  confetti({
    particleCount: 100,
    spread: 70,
    origin: { y: 0.6 }
  });
}

function finishPuzzleGame() {
  recordDone(currentPuzzleGame.site.id, currentPuzzleGame.id);
  alert(`Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh gh√©p h√¨nh v·ªÅ ${currentPuzzleGame.site.name}`);
  gameModal.hide();
}

/* ---------- GAME QUIZ ---------- */
const QUIZZES = {
  'quiz_nhatu': {
    title:'Quiz Nh√† t√π Ph√∫ Qu·ªëc',
    items:[
      {
        q:'Di t√≠ch Tr·∫°i giam Ph√∫ Qu·ªëc ƒë∆∞·ª£c ch√≠nh th·ª©c x·∫øp h·∫°ng Di t√≠ch Qu·ªëc gia ƒë·∫∑c bi·ªát v√†o th·ªùi ƒëi·ªÉm n√†o?',
        opts:['Ng√†y 30/4/1975','Ng√†y 27/7/2013','Ng√†y 31/12/2014','Ng√†y 20/10/2016'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. CƒÉn c·ª© theo Quy·∫øt ƒë·ªãnh s·ªë 2408/Qƒê-TTg ng√†y 31/12/2014 c·ªßa Th·ªß t∆∞·ªõng Ch√≠nh ph·ªß.'
      },
      {
        q:'"ƒê·ªãa ng·ª•c tr·∫ßn gian" Ph√∫ Qu·ªëc ch√≠nh th·ª©c t·ªìn t·∫°i trong kho·∫£ng th·ªùi gian n√†o?',
        opts:['T·ª´ nƒÉm 1949 ƒë·∫øn nƒÉm 1954','T·ª´ th√°ng 6/1967 ƒë·∫øn th√°ng 3/1973','T·ª´ nƒÉm 1965 ƒë·∫øn nƒÉm 1975','T·ª´ nƒÉm 1954 ƒë·∫øn nƒÉm 1975'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. Theo t∆∞ li·ªáu, tr·∫°i giam t·ªìn t·∫°i ch∆∞a ƒë·∫ßy 6 nƒÉm trong giai ƒëo·∫°n n√†y d∆∞·ªõi s·ª± qu·∫£n l√Ω c·ªßa ch√≠nh quy·ªÅn M·ªπ - Ng·ª•y.'
      },
      {
        q:'∆Ø·ªõc t√≠nh c√≥ bao nhi√™u t√π binh ƒë√£ b·ªã gi·∫øt h·∫°i t·∫°i Tr·∫°i giam Ph√∫ Qu·ªëc?',
        opts:['Kho·∫£ng 1.000 ng∆∞·ªùi','Kho·∫£ng 2.000 ng∆∞·ªùi','Kho·∫£ng 4.000 ng∆∞·ªùi','Kho·∫£ng 10.000 ng∆∞·ªùi'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. T∆∞ li·ªáu ghi r√µ con s·ªë kho·∫£ng 4.000 t√π binh ƒë√£ b·ªã gi·∫øt h·∫°i t·∫°i ƒë√¢y.'
      }
    ]
  },
  'quiz_trungtruc': {
    title:'Quiz ƒê√¨nh Nguy·ªÖn Trung Tr·ª±c',
    items:[
      {
        q:'Nguy·ªÖn Trung Tr·ª±c l√† th·ªß lƒ©nh n·ªïi ti·∫øng c·ªßa phong tr√†o kh√°ng chi·∫øn ch·ªëng?',
        opts:['Ch·ªëng Ph√°p','Ch·ªëng Ph√°p v√† ch·ªëng M·ªπ','Ch·ªëng M·ªπ','Ch·ªëng Nh·∫≠t'],
        ans:0,
        explain:'ƒê√°p √°n ƒë√∫ng l√† A. Nguy·ªÖn Trung Tr·ª±c l√† th·ªß lƒ©nh nghƒ©a qu√¢n ch·ªëng l·∫°i th·ª±c d√¢n Ph√°p x√¢m l∆∞·ª£c ·ªü Nam K·ª≥ v√†o n·ª≠a cu·ªëi th·∫ø k·ª∑ 19 (t·ª´ 1861-1868).'
      },
      {
        q:'Nguy·ªÖn Trung Tr·ª±c ƒë√£ ch·ªâ huy nghƒ©a qu√¢n ƒë·ªët ch√°y t√†u chi·∫øn n√†o c·ªßa Ph√°p tr√™n s√¥ng V√†m C·ªè ƒê√¥ng v√†o nƒÉm 1861, g√¢y ti·∫øng vang l·ªõn?',
        opts:['T√†u Hy V·ªçng (L\'Esp√©rance)','T√†u H·∫±ng T√¢m (La Pers√©v√©rance)','T√†u Jaccar√©','T√†u Avalanche'],
        ans:0,
        explain:'ƒê√°p √°n ƒë√∫ng l√† A. Chi·∫øn c√¥ng n·ªïi ti·∫øng nh·∫•t c·ªßa √¥ng l√† ch·ªâ huy nghƒ©a qu√¢n ƒë·ªët ch√°y ti·ªÉu h·∫°m L\'Esp√©rance (c√≥ t√™n Vi·ªát l√† "Hy V·ªçng") c·ªßa Ph√°p tr√™n s√¥ng V√†m C·ªè ƒê√¥ng nƒÉm 1861.'
      },
      {
        q:'C√¢u n√≥i b·∫•t h·ªß "Bao gi·ªù ng∆∞·ªùi T√¢y nh·ªï h·∫øt c·ªè n∆∞·ªõc Nam th√¨ m·ªõi h·∫øt ng∆∞·ªùi Nam ƒë√°nh T√¢y" ƒë∆∞·ª£c Nguy·ªÖn Trung Tr·ª±c n√≥i trong ho√†n c·∫£nh n√†o?',
        opts:['Khi ƒë·ªông vi√™n nghƒ©a qu√¢n tr∆∞·ªõc tr·∫≠n ƒë√°nh','Khi b·ªã th·ª±c d√¢n Ph√°p d·ª• h√†ng v√† k·∫øt √°n t·ª≠ h√¨nh','Khi tr·∫£ l·ªùi ph·ªèng v·∫•n c·ªßa m·ªôt nh√† b√°o Ph√°p','Trong m·ªôt b·ª©c th∆∞ g·ª≠i cho Tri·ªÅu ƒë√¨nh Hu·∫ø'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. C√¢u n√≥i b·∫•t h·ªß n√†y th·ªÉ hi·ªán kh√≠ ph√°ch ki√™n c∆∞·ªùng c·ªßa √¥ng, ƒë∆∞·ª£c √¥ng th·ªët l√™n khi ƒë·ªëi di·ªán v·ªõi c√°i ch·∫øt, tr∆∞·ªõc s·ª± d·ª• d·ªó c·ªßa k·∫ª th√π.'
      }
    ]
  }
};

/* Start quiz run: show one question at a time with explanation */
let currentQuiz = null;
let currentQIndex = 0;
function startQuiz(quizId, site){
  const qset = QUIZZES[quizId];
  if(!qset){ alert('Quiz ch∆∞a c√≥ n·ªôi dung.'); return; }
  currentQuiz = {id:quizId, site:site, qset:qset};
  currentQIndex = 0;
  renderCurrentQuestion();
  document.getElementById('gameSubmit').style.display = 'none';
  document.getElementById('gameNext').style.display = 'inline-block';
  document.getElementById('gameTitle').innerText = qset.title;
  document.getElementById('gameNote').innerText = `Tr·∫£ l·ªùi t·ª´ng c√¢u ‚Äî b·∫°n s·∫Ω nh·∫≠n ph·∫£n h·ªìi ngay sau m·ªói c√¢u.`;
  gameModal.show();
}
function renderCurrentQuestion(){
  const body = document.getElementById('gameBody');
  const qobj = currentQuiz.qset.items[currentQIndex];
  let html = `<div><strong>C√¢u ${currentQIndex+1} / ${currentQuiz.qset.items.length}</strong><p style="margin-top:8px"><em>${qobj.q}</em></p>`;
  html += `<div>`;
  qobj.opts.forEach((opt,i)=> html += `<div style="margin-bottom:6px"><label><input type="radio" name="opt" value="${i}"> ${opt}</label></div>`);
  html += `</div><div id="qFeedback" style="margin-top:10px"></div></div>`;
  body.innerHTML = html;
  document.getElementById('gameNext').innerText = currentQIndex+1 < currentQuiz.qset.items.length ? 'Tr·∫£ l·ªùi & Ti·∫øp' : 'Tr·∫£ l·ªùi & Ho√†n th√†nh';
  document.getElementById('gameNext').onclick = handleAnswerAndNext;
}
function handleAnswerAndNext(){
  const sel = document.querySelector('input[name="opt"]:checked');
  if(!sel){ alert('Vui l√≤ng ch·ªçn 1 ƒë√°p √°n'); return; }
  const chosen = Number(sel.value);
  const qobj = currentQuiz.qset.items[currentQIndex];
  const fb = document.getElementById('qFeedback');
  if(chosen === qobj.ans){
    fb.innerHTML = `<div class="correct">ƒê√°p √°n ƒë√∫ng ‚úì</div><div class="explain">${qobj.explain}</div>`;
  } else {
    fb.innerHTML = `<div class="wrong">ƒê√°p √°n sai ‚úó</div><div class="explain">ƒê√°p √°n ƒë√∫ng: <strong>${qobj.opts[qobj.ans]}</strong><br>${qobj.explain}</div>`;
  }
  // brief pause then next or finish
  setTimeout(()=> {
    currentQIndex++;
    if(currentQIndex < currentQuiz.qset.items.length){
      renderCurrentQuestion();
    } else {
      // quiz finished: record and show final
      recordDone(currentQuiz.site.id, currentQuiz.id);
      alert('B·∫°n ƒë√£ ho√†n th√†nh quiz: ' + currentQuiz.qset.title);
      gameModal.hide();
    }
  }, 700);
}

/* startGameInstance wrapper called from picker */
function startGameInstance(gid, site){
  document.getElementById('gameBody').innerHTML = '';
  document.getElementById('gameSubmit').style.display='none';
  document.getElementById('gameNext').style.display='none';
  if(gid.startsWith('quiz_')) startQuiz(gid, site);
  else if(gid.startsWith('puzzle_')) startPuzzleGame(gid, site);
  else { alert('Game ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£'); }
}

/* ---------- initial UI state ---------- */
refreshAuthUI();
renderBadges();

/* ensure map resizes when switching pages */
window.addEventListener('resize', ()=> map.invalidateSize());
</script>
</body>
</html>

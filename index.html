<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
/* ---------------------------
  C·∫¨P NH·∫¨T: S·ª≠a l·ªói click kh√¥ng ho·∫°t ƒë·ªông
----------------------------*/

// Bi·∫øn to√†n c·ª•c m·ªõi
let currentPage = 'home';
let stories = [];
let currentUser = null;

// Firebase configuration - ƒê·∫∂T ·ªû ƒê·∫¶U V√Ä CH·ªà M·ªòT L·∫¶N
const firebaseConfig = {
  apiKey: "AIzaSyCB9Ff43rlcqrR8huhMk3Z-vVuSxL63TGI",
  authDomain: "pqstorymap.xyz",
  projectId: "phuquoc-map-6bb91",
  storageBucket: "phuquoc-map-6bb91.firebasestorage.app",
  messagingSenderId: "1035203802998",
  appId: "1:1035203802998:web:1d509c4f2bb00dc341ec57",
  measurementId: "G-YEYE6GKYVZ"
};

// Khai b√°o bi·∫øn Firebase (s·∫Ω ƒë∆∞·ª£c kh·ªüi t·∫°o sau)
let auth, db, analytics;

/* ---------- H·ªÜ TH·ªêNG ƒêƒÇNG K√ù/ƒêƒÇNG NH·∫¨P ---------- */
const STORAGE_USERS = 'pq_users_v2';
const STORAGE_SESSIONS = 'pq_sessions_v1';
const STORAGE_ANALYTICS = 'pq_analytics_v1';

// Kh·ªüi t·∫°o d·ªØ li·ªáu
function initData() {
  // Kh·ªüi t·∫°o users n·∫øu ch∆∞a c√≥
  if (!localStorage.getItem(STORAGE_USERS)) {
    localStorage.setItem(STORAGE_USERS, JSON.stringify([]));
  }
  
  // Kh·ªüi t·∫°o analytics n·∫øu ch∆∞a c√≥
  if (!localStorage.getItem(STORAGE_ANALYTICS)) {
    const initialAnalytics = {
      totalVisits: 0,
      uniqueVisitors: new Set(),
      pageViews: {
        home: 0,
        map: 0,
        stories: 0,
        profile: 0,
        analytics: 0
      },
      devices: {
        desktop: 0,
        mobile: 0,
        tablet: 0
      },
      userActions: [],
      registeredUsers: 0
    };
    localStorage.setItem(STORAGE_ANALYTICS, JSON.stringify(initialAnalytics));
  }
  
  // Ghi nh·∫≠n l∆∞·ª£t truy c·∫≠p
  recordVisit();
}

// Ghi nh·∫≠n l∆∞·ª£t truy c·∫≠p
function recordVisit() {
  const analytics = getAnalytics();
  analytics.totalVisits++;
  
  // T·∫°o visitor ID n·∫øu ch∆∞a c√≥
  let visitorId = localStorage.getItem('pq_visitor_id');
  if (!visitorId) {
    visitorId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('pq_visitor_id', visitorId);
  }
  
  analytics.uniqueVisitors.add(visitorId);
  
  // X√°c ƒë·ªãnh thi·∫øt b·ªã
  const userAgent = navigator.userAgent.toLowerCase();
  if (/mobile|android|iphone|ipad/.test(userAgent)) {
    analytics.devices.mobile++;
  } else if (/tablet|ipad/.test(userAgent)) {
    analytics.devices.tablet++;
  } else {
    analytics.devices.desktop++;
  }
  
  // Ghi nh·∫≠n h√†nh ƒë·ªông
  analytics.userActions.push({
    type: 'page_visit',
    page: currentPage,
    timestamp: new Date().toISOString(),
    visitorId: visitorId
  });
  
  // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng h√†nh ƒë·ªông l∆∞u tr·ªØ
  if (analytics.userActions.length > 1000) {
    analytics.userActions = analytics.userActions.slice(-500);
  }
  
  saveAnalytics(analytics);
}

// Ghi nh·∫≠n l∆∞·ª£t xem trang
function recordPageView(page) {
  const analytics = getAnalytics();
  if (analytics.pageViews[page] !== undefined) {
    analytics.pageViews[page]++;
    
    analytics.userActions.push({
      type: 'page_view',
      page: page,
      timestamp: new Date().toISOString(),
      visitorId: localStorage.getItem('pq_visitor_id')
    });
    
    saveAnalytics(analytics);
  }
}

// L·∫•y d·ªØ li·ªáu analytics
function getAnalytics() {
  const data = JSON.parse(localStorage.getItem(STORAGE_ANALYTICS) || '{}');
  // Kh√¥i ph·ª•c Set t·ª´ Array
  if (data.uniqueVisitors && Array.isArray(data.uniqueVisitors)) {
    data.uniqueVisitors = new Set(data.uniqueVisitors);
  }
  return data;
}

// L∆∞u d·ªØ li·ªáu analytics
function saveAnalytics(analytics) {
  // Chuy·ªÉn Set th√†nh Array ƒë·ªÉ l∆∞u tr·ªØ
  const dataToSave = {
    ...analytics,
    uniqueVisitors: Array.from(analytics.uniqueVisitors)
  };
  localStorage.setItem(STORAGE_ANALYTICS, JSON.stringify(dataToSave));
}

// Hi·ªÉn th·ªã analytics
function renderAnalytics() {
  const analytics = getAnalytics();
  
  // C·∫≠p nh·∫≠t s·ªë li·ªáu
  document.getElementById('totalVisitors').textContent = analytics.totalVisits;
  document.getElementById('uniqueVisitors').textContent = analytics.uniqueVisitors.size;
  document.getElementById('registeredUsers').textContent = analytics.registeredUsers || 0;
  document.getElementById('totalStories').textContent = stories.length;
  
  // Hi·ªÉn th·ªã l∆∞·ª£t xem trang
  const pageViewsHtml = Object.entries(analytics.pageViews).map(([page, views]) => `
    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
      <span>${getPageName(page)}</span>
      <span class="badge bg-primary">${views}</span>
    </div>
  `).join('');
  document.getElementById('pageViewsChart').innerHTML = pageViewsHtml || '<p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
  
  // Hi·ªÉn th·ªã thi·∫øt b·ªã
  const deviceHtml = Object.entries(analytics.devices).map(([device, count]) => `
    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
      <span>${getDeviceName(device)}</span>
      <span class="badge bg-info">${count}</span>
    </div>
  `).join('');
  document.getElementById('deviceChart').innerHTML = deviceHtml || '<p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
  
  // Hi·ªÉn th·ªã ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
  const recentActions = analytics.userActions.slice(-10).reverse();
  const activityHtml = recentActions.map(action => `
    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
      <div>
        <small class="text-muted">${formatTimeAgo(action.timestamp)}</small>
        <div>${getActionDescription(action)}</div>
      </div>
    </div>
  `).join('');
  document.getElementById('recentActivity').innerHTML = activityHtml || '<p class="text-muted">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</p>';
}

function getPageName(page) {
  const pages = {
    home: 'Trang ch·ªß',
    map: 'B·∫£n ƒë·ªì',
    stories: 'PQ Stories',
    profile: 'Trang c√° nh√¢n',
    analytics: 'Th·ªëng k√™'
  };
  return pages[page] || page;
}

function getDeviceName(device) {
  const devices = {
    desktop: 'M√°y t√≠nh',
    mobile: 'ƒêi·ªán tho·∫°i',
    tablet: 'M√°y t√≠nh b·∫£ng'
  };
  return devices[device] || device;
}

function getActionDescription(action) {
  switch (action.type) {
    case 'page_visit':
      return `Truy c·∫≠p ${getPageName(action.page)}`;
    case 'page_view':
      return `Xem ${getPageName(action.page)}`;
    case 'user_register':
      return 'ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi';
    case 'user_login':
      return 'ƒêƒÉng nh·∫≠p';
    case 'story_post':
      return 'ƒêƒÉng c√¢u chuy·ªán m·ªõi';
    default:
      return action.type;
  }
}

/* ---------- H·ªÜ TH·ªêNG NG∆Ø·ªúI D√ôNG ---------- */
function getUsers() {
  return JSON.parse(localStorage.getItem(STORAGE_USERS) || '[]');
}

function saveUsers(users) {
  localStorage.setItem(STORAGE_USERS, JSON.stringify(users));
}

function findUserByEmail(email) {
  const users = getUsers();
  return users.find(user => user.email === email);
}

function registerUser(name, email, password) {
  const users = getUsers();
  
  // Ki·ªÉm tra email ƒë√£ t·ªìn t·∫°i
  if (findUserByEmail(email)) {
    return { success: false, message: 'Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng' };
  }
  
  // T·∫°o user m·ªõi
  const newUser = {
    id: 'user_' + Date.now(),
    name: name,
    email: email,
    password: password, // Trong th·ª±c t·∫ø n√™n m√£ h√≥a password
    createdAt: new Date().toISOString(),
    badges: [],
    visitedSites: [],
    completedGames: {}
  };
  
  users.push(newUser);
  saveUsers(users);
  
  // C·∫≠p nh·∫≠t analytics
  const analytics = getAnalytics();
  analytics.registeredUsers = users.length;
  analytics.userActions.push({
    type: 'user_register',
    email: email,
    timestamp: new Date().toISOString()
  });
  saveAnalytics(analytics);
  
  return { success: true, user: newUser };
}

function loginUser(email, password) {
  const user = findUserByEmail(email);
  
  if (!user) {
    return { success: false, message: 'Email kh√¥ng t·ªìn t·∫°i' };
  }
  
  if (user.password !== password) {
    return { success: false, message: 'M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng' };
  }
  
  // T·∫°o session
  const session = {
    userId: user.id,
    token: 'token_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // 7 ng√†y
  };
  
  localStorage.setItem(STORAGE_SESSIONS, JSON.stringify(session));
  
  // C·∫≠p nh·∫≠t analytics
  const analytics = getAnalytics();
  analytics.userActions.push({
    type: 'user_login',
    email: email,
    timestamp: new Date().toISOString()
  });
  saveAnalytics(analytics);
  
  return { success: true, user: user };
}

function getCurrentUser() {
  const session = JSON.parse(localStorage.getItem(STORAGE_SESSIONS) || 'null');
  
  if (!session || new Date(session.expiresAt) < new Date()) {
    // Session h·∫øt h·∫°n
    localStorage.removeItem(STORAGE_SESSIONS);
    return null;
  }
  
  const users = getUsers();
  return users.find(user => user.id === session.userId) || null;
}

function logoutUser() {
  localStorage.removeItem(STORAGE_SESSIONS);
  return { success: true };
}

function updateUser(user) {
  const users = getUsers();
  const index = users.findIndex(u => u.id === user.id);
  if (index !== -1) {
    users[index] = user;
    saveUsers(users);
    return true;
  }
  return false;
}

/* ---------- Menu Navigation ---------- */
const menuBtn = document.getElementById('nav-menu');
const menuDropdown = document.getElementById('menuDropdown');
const menuOverlay = document.getElementById('menuOverlay');
const menuItems = document.querySelectorAll('.menu-item');

// Toggle menu
menuBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  menuDropdown.classList.toggle('active');
  menuOverlay.classList.toggle('active');
});

// ƒê√≥ng menu khi click overlay
menuOverlay.addEventListener('click', () => {
  menuDropdown.classList.remove('active');
  menuOverlay.classList.remove('active');
});

// X·ª≠ l√Ω ch·ªçn menu item
menuItems.forEach(item => {
  item.addEventListener('click', () => {
    const page = item.dataset.page;
    showPage(page);
    menuDropdown.classList.remove('active');
    menuOverlay.classList.remove('active');
    
    // C·∫≠p nh·∫≠t active state
    menuItems.forEach(i => i.classList.remove('active'));
    item.classList.add('active');
  });
});

// H√†m hi·ªÉn th·ªã trang
function showPage(page) {
  // ·∫®n t·∫•t c·∫£ c√°c trang
  document.querySelectorAll('section[id^="page-"]').forEach(section => {
    section.style.display = 'none';
  });
  
  // Hi·ªÉn th·ªã trang ƒë∆∞·ª£c ch·ªçn
  document.getElementById(`page-${page}`).style.display = 'block';
  
  // Ghi nh·∫≠n l∆∞·ª£t xem trang
  recordPageView(page);
  
  // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho t·ª´ng trang
  if (page === 'map') {
    setTimeout(() => {
      if (typeof map !== 'undefined') {
        map.invalidateSize();
      }
    }, 300);
  } else if (page === 'stories') {
    loadStories();
  } else if (page === 'analytics') {
    renderAnalytics();
  }
  
  currentPage = page;
}

/* ---------- NEW PQ STORIES FUNCTIONALITY ---------- */
const addStoryBtn = document.getElementById('addStoryBtn');
const storyModalOverlay = document.getElementById('storyModalOverlay');
const storyModalClose = document.getElementById('storyModalClose');
const storyFormNew = document.getElementById('storyFormNew');
const uploadAreaNew = document.getElementById('uploadAreaNew');
const fileInputNew = document.getElementById('fileInputNew');
const filePreviewNew = document.getElementById('filePreviewNew');
const storiesWallNew = document.getElementById('storiesWallNew');
const storyContentNew = document.getElementById('storyContentNew');
const wordCount = document.getElementById('wordCount');
const btnPostStory = document.getElementById('btnPostStory');
const successMessage = document.getElementById('successMessage');
const successClose = document.getElementById('successClose');

// M·ªü modal khi click n√∫t th√™m story
if (addStoryBtn) {
  addStoryBtn.addEventListener('click', () => {
    const user = getCurrentUser();
    if (!user) {
      alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ chia s·∫ª c√¢u chuy·ªán.');
      showPage('profile');
      return;
    }
    storyModalOverlay.classList.add('active');
  });
}

// ƒê√≥ng modal
if (storyModalClose) {
  storyModalClose.addEventListener('click', () => {
    storyModalOverlay.classList.remove('active');
  });
}

// ƒê√≥ng modal khi click b√™n ngo√†i
if (storyModalOverlay) {
  storyModalOverlay.addEventListener('click', (e) => {
    if (e.target === storyModalOverlay) {
      storyModalOverlay.classList.remove('active');
    }
  });
}

// Upload area click
if (uploadAreaNew) {
  uploadAreaNew.addEventListener('click', () => {
    fileInputNew.click();
  });
}

// File input change
if (fileInputNew) {
  fileInputNew.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        let previewHTML = '';
        
        if (file.type.startsWith('image/')) {
          previewHTML = `<img src="${e.target.result}" alt="Preview">`;
        } else if (file.type.startsWith('video/')) {
          previewHTML = `<video controls><source src="${e.target.result}" type="${file.type}">Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.</video>`;
        } else if (file.type.startsWith('audio/')) {
          previewHTML = `<audio controls><source src="${e.target.result}" type="${file.type}">Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ audio.</audio>`;
        } else {
          previewHTML = `<p>File: ${file.name}</p>`;
        }
        
        previewHTML += `<button class="remove-file" onclick="removeFile()">X√≥a</button>`;
        filePreviewNew.innerHTML = previewHTML;
        filePreviewNew.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  });
}

// X√≥a file preview
function removeFile() {
  if (filePreviewNew) {
    filePreviewNew.style.display = 'none';
    fileInputNew.value = '';
  }
}

// ƒê·∫øm s·ªë t·ª´
if (storyContentNew) {
  storyContentNew.addEventListener('input', () => {
    const content = storyContentNew.value;
    const words = content.trim() === '' ? 0 : content.trim().split(/\s+/).length;
    wordCount.textContent = `${words}/200 t·ª´`;
    
    if (words > 200) {
      wordCount.classList.add('warning');
      btnPostStory.disabled = true;
    } else {
      wordCount.classList.remove('warning');
      btnPostStory.disabled = false;
    }
  });
}

// Story form submit
if (btnPostStory) {
  btnPostStory.addEventListener('click', (e) => {
    e.preventDefault();
    
    const title = document.getElementById('storyTitleNew').value;
    const content = document.getElementById('storyContentNew').value;
    const user = getCurrentUser();
    
    if (!user) {
      alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ chia s·∫ª c√¢u chuy·ªán.');
      return;
    }
    
    if (!title || !content) {
      alert('Vui l√≤ng ƒëi·ªÅn ti√™u ƒë·ªÅ v√† n·ªôi dung c√¢u chuy·ªán.');
      return;
    }
    
    const words = content.trim().split(/\s+/).length;
    if (words > 200) {
      alert('N·ªôi dung c√¢u chuy·ªán v∆∞·ª£t qu√° 200 t·ª´. Vui l√≤ng r√∫t g·ªçn.');
      return;
    }
    
    const newStory = {
      id: Date.now(),
      title: title,
      content: content,
      author: user.name,
      authorId: user.id,
      timestamp: new Date().toISOString(),
      likes: 0,
      comments: [],
      liked: false,
      media: fileInputNew.files[0] ? URL.createObjectURL(fileInputNew.files[0]) : null,
      mediaType: fileInputNew.files[0] ? fileInputNew.files[0].type : null,
      colorClass: `note-color-${Math.floor(Math.random() * 8) + 1}`
    };
    
    // Th√™m story v√†o m·∫£ng
    stories.unshift(newStory);
    
    // L∆∞u v√†o localStorage
    saveStories();
    
    // C·∫≠p nh·∫≠t giao di·ªán
    renderStories();
    
    // ƒê√≥ng modal
    storyModalOverlay.classList.remove('active');
    
    // Reset form
    storyFormNew.reset();
    filePreviewNew.style.display = 'none';
    fileInputNew.value = '';
    wordCount.textContent = '0/200 t·ª´';
    wordCount.classList.remove('warning');
    
    // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
    showSuccessMessage();
  });
}

// Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
function showSuccessMessage() {
  if (successMessage) {
    successMessage.classList.add('show');
    
    // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
    setTimeout(() => {
      successMessage.classList.remove('show');
    }, 5000);
  }
}

// ƒê√≥ng th√¥ng b√°o th√†nh c√¥ng
if (successClose) {
  successClose.addEventListener('click', () => {
    successMessage.classList.remove('show');
  });
}

// Load stories t·ª´ localStorage
function loadStories() {
  const savedStories = localStorage.getItem('pq_stories');
  if (savedStories) {
    stories = JSON.parse(savedStories);
  }
  renderStories();
}

// Save stories to localStorage
function saveStories() {
  localStorage.setItem('pq_stories', JSON.stringify(stories));
}

// Render stories
function renderStories() {
  if (!storiesWallNew) return;
  
  storiesWallNew.innerHTML = '';
  
  if (stories.length === 0) {
    storiesWallNew.innerHTML = `
      <div class="col-12 text-center py-5" style="grid-column: 1 / -1;">
        <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Ch∆∞a c√≥ c√¢u chuy·ªán n√†o</h4>
        <p class="text-muted">H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n chia s·∫ª k√Ω ·ª©c v·ªÅ Ph√∫ Qu·ªëc!</p>
      </div>
    `;
    return;
  }
  
  stories.forEach(story => {
    const storyElement = document.createElement('div');
    storyElement.className = `story-note-new ${story.colorClass}`;
    storyElement.innerHTML = `
      <div>
        <h3>${story.title}</h3>
        ${story.media ? (
          story.mediaType && story.mediaType.startsWith('image/') ? 
            `<img src="${story.media}" alt="${story.title}" class="story-media-new">` :
          story.mediaType && story.mediaType.startsWith('video/') ? 
            `<video controls class="story-media-new"><source src="${story.media}" type="${story.mediaType}">Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.</video>` :
          story.mediaType && story.mediaType.startsWith('audio/') ? 
            `<audio controls class="story-media-new"><source src="${story.media}" type="${story.mediaType}">Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ audio.</audio>` :
            ''
        ) : ''}
        <div class="story-content-new">${story.content}</div>
      </div>
      <div>
        <div class="story-meta-new">
          <span>${story.author}</span>
          <span>${formatTimeAgo(story.timestamp)}</span>
        </div>
        <div class="story-actions-new">
          <div class="story-action-new ${story.liked ? 'liked' : ''}" onclick="likeStory(${story.id})">
            <i class="fas fa-heart"></i>
            <span>${story.likes}</span>
          </div>
          <div class="story-action-new" onclick="toggleComments(${story.id})">
            <i class="fas fa-comment"></i>
            <span>${story.comments.length}</span>
          </div>
        </div>
        <div class="story-comments" id="comments-${story.id}">
          ${story.comments.map(comment => `
            <div class="story-comment">
              <div class="story-comment-author">${comment.author}</div>
              <div class="story-comment-content">${comment.content}</div>
            </div>
          `).join('')}
          <div class="add-comment-form">
            <input type="text" class="add-comment-input" id="comment-input-${story.id}" placeholder="Vi·∫øt b√¨nh lu·∫≠n...">
            <button class="add-comment-btn" onclick="addComment(${story.id})">G·ª≠i</button>
          </div>
        </div>
      </div>
    `;
    storiesWallNew.appendChild(storyElement);
  });
}

// Like story function
function likeStory(storyId) {
  const user = getCurrentUser();
  if (!user) {
    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√≠ch c√¢u chuy·ªán.');
    return;
  }
  
  const story = stories.find(s => s.id === storyId);
  if (story) {
    if (story.liked) {
      story.likes--;
      story.liked = false;
    } else {
      story.likes++;
      story.liked = true;
    }
    saveStories();
    renderStories();
  }
}

// Toggle comments
function toggleComments(storyId) {
  const commentsDiv = document.getElementById(`comments-${storyId}`);
  if (commentsDiv) {
    if (commentsDiv.style.display === 'block') {
      commentsDiv.style.display = 'none';
    } else {
      commentsDiv.style.display = 'block';
    }
  }
}

// Add comment
function addComment(storyId) {
  const user = getCurrentUser();
  if (!user) {
    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n.');
    return;
  }
  
  const commentInput = document.getElementById(`comment-input-${storyId}`);
  if (!commentInput) return;
  
  const content = commentInput.value.trim();
  
  if (!content) {
    alert('Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n.');
    return;
  }
  
  const story = stories.find(s => s.id === storyId);
  if (story) {
    story.comments.push({
      author: user.name,
      content: content,
      timestamp: new Date().toISOString()
    });
    saveStories();
    renderStories();
    commentInput.value = '';
  }
}

// Format time ago
function formatTimeAgo(timestamp) {
  const now = new Date();
  const storyTime = new Date(timestamp);
  const diffInSeconds = Math.floor((now - storyTime) / 1000);
  
  if (diffInSeconds < 60) return 'V·ª´a xong';
  if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} ph√∫t tr∆∞·ªõc`;
  if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} gi·ªù tr∆∞·ªõc`;
  return `${Math.floor(diffInSeconds / 86400)} ng√†y tr∆∞·ªõc`;
}

/* ---------------------------
  D·ªØ li·ªáu ƒëi·ªÉm (ƒë√£ c·∫≠p nh·∫≠t v·ªõi t·ªça ƒë·ªô ch√≠nh x√°c c·ªßa b·∫°n)
----------------------------*/
const DI_TICH = [
  // Nh√≥m Thi√™n Nhi√™n (Xanh L√° pastel)
  {
    id:'vuon-quoc-gia',
    name:'V∆∞·ªùn qu·ªëc gia Ph√∫ Qu·ªëc',
    address:'V∆∞·ªùn qu·ªëc gia Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'V∆∞·ªùn qu·ªëc gia v·ªõi h·ªá sinh th√°i r·ª´ng nhi·ªát ƒë·ªõi phong ph√∫, n∆°i b·∫£o t·ªìn nhi·ªÅu lo√†i ƒë·ªông th·ª±c v·∫≠t qu√Ω hi·∫øm.',
    extra:['Di·ªán t√≠ch: 31.422 ha', 'C√≥ nhi·ªÅu lo√†i ƒë·ªông th·ª±c v·∫≠t qu√Ω hi·∫øm', 'H·ªá sinh th√°i r·ª´ng nhi·ªát ƒë·ªõi ƒëa d·∫°ng'],
    lat:10.3645, lng:103.9919,
    games:[],
    img: 'images/vuon.jpg',
    category: 'nature'
  },
  {
    id:'bai-sao',
    name:'B√£i Sao',
    address:'B√£i Sao, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'B√£i bi·ªÉn ƒë·∫πp v·ªõi c√°t tr·∫Øng m·ªãn, n∆∞·ªõc bi·ªÉn trong xanh, h√¨nh l∆∞·ª°i li·ªÅm ƒë·∫∑c tr∆∞ng.',
    extra:['C√°t tr·∫Øng m·ªãn', 'N∆∞·ªõc bi·ªÉn trong xanh', 'H√¨nh d·∫°ng l∆∞·ª°i li·ªÅm ƒë·ªôc ƒë√°o'],
    lat:10.0572, lng:104.0360,
    games:[],
    img:'images/baisao.jpg',
    category: 'nature'
  },
  {
    id:'hon-thom',
    name:'H√≤n Th∆°m',
    address:'H√≤n Th∆°m, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'H√≤n ƒë·∫£o l·ªõn th·ª© hai trong qu·∫ßn ƒë·∫£o An Th·ªõi, n·ªïi ti·∫øng v·ªõi c·∫£nh quan thi√™n nhi√™n hoang s∆°.',
    extra:['ƒê·∫£o l·ªõn th·ª© hai qu·∫ßn ƒë·∫£o An Th·ªõi', 'C·∫£nh quan thi√™n nhi√™n hoang s∆°', 'Nhi·ªÅu b√£i bi·ªÉn ƒë·∫πp'],
    lat:9.9560, lng:104.0179,
    games:[],
    img:'images/honthom.jpg',
    category: 'nature'
  },
  
  // Nh√≥m VƒÉn H√≥a - L·ªãch S·ª≠ (Cam pastel)
  {
    id:'nha-tu',
    name:'Nh√† t√π Ph√∫ Qu·ªëc',
    address:'350 ƒê. Nguy·ªÖn VƒÉn C·ª´, An Th·ªõi, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Di t√≠ch l·ªãch s·ª≠ c·∫•p Qu·ªëc gia ƒë·∫∑c bi·ªát (2014). N∆°i giam gi·ªØ nhi·ªÅu t√π binh trong kh√°ng chi·∫øn; ch·ª©ng t√≠ch tra t·∫•n, nh∆∞ng c≈©ng l√† bi·ªÉu t∆∞·ª£ng √Ω ch√≠ ki√™n c∆∞·ªùng.',
    extra:[
      'NƒÉm x√¢y d·ª±ng: 01/06/1967',
      'C√≤n g·ªçi: Nh√† lao C√¢y D·ª´a',
      'Kho·∫£ng 40.000 t√π binh t·ª´ng b·ªã giam; nhi·ªÅu t√π nh√¢n b·ªã tra t·∫•n d√£ man. C√≥ 45 cu·ªôc v∆∞·ª£t ng·ª•c ghi nh·∫≠n.'
    ],
    lat:10.044417, lng:104.017639,
    games:['quiz_nhatu', 'memory_nhatu'],
    img: 'images/nhatupq3.jpg',
    category: 'culture'
  },
  {
    id:'chua',
    name:'Ch√πa H·ªô Qu·ªëc',
    address:'426H+GVQ, D∆∞∆°ng T∆°, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Thi·ªÅn vi·ªán Tr√∫c L√¢m H·ªô Qu·ªëc ‚Äî ki·∫øn tr√∫c t√¢m linh l·ªõn, phong c√°ch c·ªï truy·ªÅn Vi·ªát.',
    extra:['Ng√¥i ch√πa l·ªõn nh·∫•t Ph√∫ Qu·ªëc', 'Ki·∫øn tr√∫c truy·ªÅn th·ªëng Vi·ªát Nam', 'Kh√¥ng gian t√¢m linh thanh t·ªãnh'],
    lat:10.110028, lng:104.029056,
    games:[],
    img: 'images/chua.jpg',
    category: 'culture'
  },
  {
    id:'dinh-ntt',
    name:'ƒê√¨nh Th·∫ßn Nguy·ªÖn Trung Tr·ª±c',
    address:'9RFV+848, G√†nh D·∫ßu, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Di t√≠ch l·ªãch s·ª≠ vƒÉn h√≥a. ƒê√¨nh th·ªù Anh h√πng d√¢n t·ªôc Nguy·ªÖn Trung Tr·ª±c (1839-1868).',
    extra:[
      'ƒê√¨nh ƒë∆∞·ª£c x√¢y d·ª±ng t·ª´ nƒÉm 1882',
      'L·ªÖ gi·ªó t·ªï ch·ª©c h√†ng nƒÉm (√¢m l·ªãch) ‚Äî ho·∫°t ƒë·ªông truy·ªÅn th·ªëng h∆°n 100 nƒÉm',
      'Nguy·ªÖn Trung Tr·ª±c n·ªïi ti·∫øng v·ªõi chi·∫øn c√¥ng ƒë·ªët t√†u Ph√°p tr√™n s√¥ng Nh·∫≠t T·∫£o.'
    ],
    lat:10.373306, lng:103.842972,
    games:['quiz_trungtruc', 'memory_trungtruc'],
    img:'images/dinhntt.jpg',
    category: 'culture'
  },
  {
    id:'baotang',
    name:'B·∫£o t√†ng C·ªôi Ngu·ªìn',
    address:'Ph√∫ Qu·ªëc, Ki√™n Giang',
    note:'B·∫£o t√†ng tr∆∞ng b√†y l·ªãch s·ª≠-vƒÉn h√≥a ƒë·ªãa ph∆∞∆°ng',
    extra:['Tr∆∞ng b√†y l·ªãch s·ª≠, vƒÉn h√≥a Ph√∫ Qu·ªëc', 'B·ªô s∆∞u t·∫≠p c·ªï v·∫≠t phong ph√∫', 'Ki·∫øn tr√∫c ƒë·ªôc ƒë√°o'],
    lat:10.192500, lng:103.967000,
    games:[],
    img:'images/coinguon.jpg',
    category: 'culture'
  },
  {
    id:'dinh-cau',
    name:'Dinh C·∫≠u',
    address:'Khu ph·ªë 2, Tp. Ph√∫ Qu·ªëc, Ki√™n Giang 92500, Vi·ªát Nam',
    note:'Di t√≠ch th·∫Øng c·∫£nh; t√≠n ng∆∞·ª°ng c·ªßa ng∆∞ d√¢n, c√≥ l·ªÖ h·ªôi h√†ng nƒÉm (15‚Äì16/10 √¢m l·ªãch).',
    extra:['X√¢y d·ª±ng: 1937 (tu s·ª≠a 1997)','Bi·ªÉu t∆∞·ª£ng t√¢m linh c·ªßa ng∆∞·ªùi d√¢n ƒë·ªãa ph∆∞∆°ng', 'V·ªã tr√≠ ƒë·∫πp nh√¨n ra bi·ªÉn'],
    lat:10.217194, lng:103.956500,
    games:[],
    img:'images/dinhcau.jpg',
    category: 'culture'
  },
  
  // Nh√≥m Gi·∫£i Tr√≠ & Hi·ªán ƒê·∫°i (T√≠m pastel)
  {
    id:'cap-treo',
    name:'C√°p treo H√≤n Th∆°m',
    address:'C√°p treo H√≤n Th∆°m, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Tuy·∫øn c√°p treo v∆∞·ª£t bi·ªÉn d√†i nh·∫•t th·∫ø gi·ªõi, k·∫øt n·ªëi ƒë·∫£o Ph√∫ Qu·ªëc v·ªõi ƒë·∫£o H√≤n Th∆°m.',
    extra:['Tuy·∫øn c√°p treo v∆∞·ª£t bi·ªÉn d√†i nh·∫•t th·∫ø gi·ªõi', 'K·∫øt n·ªëi ƒë·∫£o Ph√∫ Qu·ªëc v·ªõi H√≤n Th∆°m', 'Cung ƒë∆∞·ªùng ng·∫Øm c·∫£nh tuy·ªát ƒë·∫πp'],
    lat:10.0269, lng:104.0073,
    games:[],
    img:'images/captreo.jpg',
    category: 'entertainment'
  },
  {
    id:'grand-world',
    name:'Grand World Ph√∫ Qu·ªëc',
    address:'Grand World Ph√∫ Qu·ªëc, B√£i D√†i, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Khu ph·ª©c h·ª£p gi·∫£i tr√≠, mua s·∫Øm v√† ·∫©m th·ª±c v·ªõi ki·∫øn tr√∫c ch√¢u √Çu ƒë·ªôc ƒë√°o.',
    extra:['Khu ph·ª©c h·ª£p gi·∫£i tr√≠ hi·ªán ƒë·∫°i', 'Ki·∫øn tr√∫c ch√¢u √Çu ƒë·ªôc ƒë√°o', 'Nhi·ªÅu ho·∫°t ƒë·ªông vui ch∆°i, mua s·∫Øm'],
    lat:10.3289, lng:103.8629,
    games:[],
    img:'images/grandworld.jpg',
    category: 'entertainment'
  },
  
  // Nh√≥m ·∫®m Th·ª±c & L√†ng Ngh·ªÅ (ƒê·ªè pastel)
  {
    id:'nha-thung',
    name:'Nh√† th√πng n∆∞·ªõc m·∫Øm Ph√∫ Qu·ªëc (Ph·ª•ng H∆∞ng)',
    address:'471 ƒê. Nguy·ªÖn VƒÉn C·ª´, Khu 2, Ph√∫ Qu·ªëc, Ki√™n Giang',
    note:'Nh√† th√πng n∆∞·ªõc m·∫Øm truy·ªÅn th·ªëng; ngh·ªÅ truy·ªÅn th·ªëng c·ªßa ƒë·∫£o.',
    extra:['L·ªãch s·ª≠: h√†ng trƒÉm nƒÉm, ph∆∞∆°ng th·ª©c ·ªß mu·ªëi truy·ªÅn th·ªëng', 'N∆∞·ªõc m·∫Øm Ph√∫ Qu·ªëc n·ªïi ti·∫øng th∆°m ngon'],
    lat:10.044917, lng:104.017444,
    games:[],
    img:'images/nhathung.jpg',
    category: 'craft'
  },
  {
    id:'ngoc-trai',
    name:'C∆° s·ªü nu√¥i c·∫•y ng·ªçc trai (Ng·ªçc Hi·ªÅn Pearl)',
    address:'C∆° s·ªü nu√¥i c·∫•y ng·ªçc trai Ng·ªçc Hi·ªÅn Pearl, Ph√∫ Qu·ªëc, Ki√™n Giang',
    note:'C∆° s·ªü nu√¥i c·∫•y v√† ch·∫ø t√°c ng·ªçc trai n·ªïi ti·∫øng t·∫°i Ph√∫ Qu·ªëc.',
    extra:['Nu√¥i c·∫•y v√† ch·∫ø t√°c ng·ªçc trai', 'S·∫£n ph·∫©m ng·ªçc trai ch·∫•t l∆∞·ª£ng cao', 'Quy tr√¨nh nu√¥i c·∫•y c√¥ng phu'],
    lat:10.1701, lng:103.9703, // C·∫≠p nh·∫≠t t·ªça ƒë·ªô m·ªõi
    games:[],
    img:'images/ngoctrai.jpg',
    category: 'craft'
  },
  {
    id:'ham-ninh',
    name:'L√†ng ch√†i H√†m Ninh',
    address:'52JV+6XX, TL47, R·∫°ch H√†m, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'L√†ng ch√†i c·ªï, n·ªïi ti·∫øng h·∫£i s·∫£n t∆∞∆°i, gh·∫π H√†m Ninh.',
    extra:['L√†ng ch√†i truy·ªÅn th·ªëng l√¢u ƒë·ªùi', 'N·ªïi ti·∫øng v·ªõi gh·∫π H√†m Ninh t∆∞∆°i ngon', 'C·∫£nh bi·ªÉn ƒë·∫πp, b√¨nh y√™n'],
    lat:10.180917, lng:104.048472,
    games:[],
    img:'images/langchai.jpg',
    category: 'craft'
  }
];

/* -----------------------
  Local storage keys
------------------------*/
const STORAGE_USER = 'pq_user_v1';
const STORAGE_BADGES = 'pq_badges_v1';
const STORAGE_DONE = 'pq_done_games_v1';
const STORAGE_VISIT = 'pq_visited_v1';
const STORAGE_STORIES = 'pq_stories';

/* --------- Helpers ------------- */
function saveUser(u){ localStorage.setItem(STORAGE_USER, JSON.stringify(u)) }
function loadUser(){ return JSON.parse(localStorage.getItem(STORAGE_USER) || 'null') }
function loadBadges(){ return JSON.parse(localStorage.getItem(STORAGE_BADGES) || '[]') }
function saveBadges(a){ localStorage.setItem(STORAGE_BADGES, JSON.stringify(a)) }
function loadDone(){ return JSON.parse(localStorage.getItem(STORAGE_DONE) || '{}') }
function saveDone(o){ localStorage.setItem(STORAGE_DONE, JSON.stringify(o)) }
function loadVisited(){ return JSON.parse(localStorage.getItem(STORAGE_VISIT) || '[]') }
function saveVisited(a){ localStorage.setItem(STORAGE_VISIT, JSON.stringify(a)) }

/* ---------- UI & Navigation ---------- */
const pageHome = document.getElementById('page-home');
const pageMap = document.getElementById('page-map');
const pageProfile = document.getElementById('page-profile');
const btnStart = document.getElementById('btn-start');

// C·∫≠p nh·∫≠t s·ª± ki·ªán cho n√∫t B·∫Øt ƒë·∫ßu kh√°m ph√°
if (btnStart) {
  btnStart.onclick = () => { 
    showPage('map'); 
    window.scrollTo(0,0); 
  };
}

/* Auth modal */
const authModal = new bootstrap.Modal(document.getElementById('authModal'));
const btnProfileRegister = document.getElementById('btn-profile-register');
const btnProfileLogin = document.getElementById('btn-profile-login');

if (btnProfileRegister) {
  btnProfileRegister.addEventListener('click', ()=> {
    document.getElementById('authTitle').innerText = 'ƒêƒÉng k√Ω'; 
    document.getElementById('authSubmit').onclick = authRegister; 
    document.getElementById('authAlert').classList.add('d-none');
    authModal.show();
  });
}

if (btnProfileLogin) {
  btnProfileLogin.addEventListener('click', ()=> {
    document.getElementById('authTitle').innerText = 'ƒêƒÉng nh·∫≠p'; 
    document.getElementById('authSubmit').onclick = authLogin; 
    document.getElementById('authAlert').classList.add('d-none');
    authModal.show();
  });
}

const btnProfileLogout = document.getElementById('btn-profile-logout');
if (btnProfileLogout) {
  btnProfileLogout.addEventListener('click', ()=> {
    logoutUser();
    refreshProfileAuthUI();
    alert('ƒêƒÉng xu·∫•t th√†nh c√¥ng.');
  });
}

/* auth functions */
function authRegister(){
  const name = document.getElementById('inName').value.trim();
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  if(!name || !email || !pass){ showAuthError('ƒêi·ªÅn ƒë·ªß t√™n, email, m·∫≠t kh·∫©u'); return; }
  
  const result = registerUser(name, email, pass);
  if (result.success) {
    alert('ƒêƒÉng k√Ω th√†nh c√¥ng. Vui l√≤ng ƒëƒÉng nh·∫≠p.');
    authModal.hide();
  } else {
    showAuthError(result.message);
  }
}

function authLogin(){
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  
  const result = loginUser(email, pass);
  if (result.success) {
    authModal.hide();
    refreshProfileAuthUI();
    alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng. Xin ch√†o ' + result.user.name);
  } else {
    showAuthError(result.message);
  }
}

function showAuthError(msg){ 
  const a=document.getElementById('authAlert'); 
  if (a) {
    a.innerText=msg; 
    a.classList.remove('d-none'); 
  }
}

function refreshProfileAuthUI(){
  const u = getCurrentUser();
  const profileInfo = document.getElementById('profile-info');
  const btnLogin = document.getElementById('btn-profile-login');
  const btnRegister = document.getElementById('btn-profile-register');
  const btnLogout = document.getElementById('btn-profile-logout');
  
  if(u){ 
    if (btnLogin) btnLogin.style.display='none'; 
    if (btnRegister) btnRegister.style.display='none'; 
    if (btnLogout) btnLogout.style.display='inline-block'; 
    if (profileInfo) {
      profileInfo.innerHTML = `Xin ch√†o <strong>${u.name}</strong> ‚Äî ${u.email}`;
      profileInfo.className = 'alert alert-success';
    }
    renderUserBadges(u);
  } else { 
    if (btnLogin) btnLogin.style.display='inline-block'; 
    if (btnRegister) btnRegister.style.display='inline-block'; 
    if (btnLogout) btnLogout.style.display='none'; 
    if (profileInfo) {
      profileInfo.innerHTML = 'B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u ti·∫øn tr√¨nh v√† nh·∫≠n huy hi·ªáu.';
      profileInfo.className = 'alert alert-info';
    }
    renderProfileBadges();
  }
}

function renderUserBadges(user) {
  const wrap = document.getElementById('profile-badge-area');
  if (!wrap) return;
  
  wrap.innerHTML = '';
  
  if(!user.badges || user.badges.length === 0) {
    wrap.innerHTML = '<div class="text-muted">Ch∆∞a c√≥ huy hi·ªáu n√†o. H√£y kh√°m ph√° c√°c ƒë·ªãa ƒëi·ªÉm v√† ho√†n th√†nh th·ª≠ th√°ch!</div>';
    return;
  }
  
  user.badges.forEach(b=>{
    const el = document.createElement('div');
    el.className = 'text-center';
    el.innerHTML = `
      <img src="${b.icon}" class="badge-img" alt="${b.name}">
      <div style="font-size:12px; max-width:80px">${b.name}</div>
    `;
    wrap.appendChild(el);
  });
}

function renderProfileBadges(){
  const wrap = document.getElementById('profile-badge-area');
  if (!wrap) return;
  
  wrap.innerHTML = '';
  const arr = loadBadges();
  
  if(arr.length === 0) {
    wrap.innerHTML = '<div class="text-muted">Ch∆∞a c√≥ huy hi·ªáu n√†o. H√£y kh√°m ph√° c√°c ƒë·ªãa ƒëi·ªÉm v√† ho√†n th√†nh th·ª≠ th√°ch!</div>';
    return;
  }
  
  arr.forEach(b=>{
    const el = document.createElement('div');
    el.className = 'text-center';
    el.innerHTML = `
      <img src="${b.icon}" class="badge-img" alt="${b.name}">
      <div style="font-size:12px; max-width:80px">${b.name}</div>
    `;
    wrap.appendChild(el);
  });
}

    /* ---------- Map init ---------- */
let map;
let currentTooltip = null;

function initMap() {
  if (!document.getElementById('map')) return;
  
  map = L.map('map', {zoomControl:true}).setView([10.28,103.98], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(map);

  // T·∫°o tooltip cho marker
  currentTooltip = null;

  function createCustomIcon(category, hasGame) {
    const colorMap = {
      'nature': '#A5D6A7', // Xanh l√° pastel
      'culture': '#FFCC80', // Cam pastel
      'entertainment': '#CE93D8', // T√≠m pastel
      'craft': '#EF9A9A' // ƒê·ªè pastel
    };
    
    const color = colorMap[category] || '#90CAF9';
    
    return L.divIcon({
      className: 'custom-pin',
      html: `
        <div style="
          background: ${color}; 
          width: 24px; 
          height: 24px; 
          border-radius: 50%; 
          border: 3px solid white;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        "></div>
      `,
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });
  }

  /* render markers */
  DI_TICH.forEach(p=>{
    const m = L.marker([p.lat,p.lng], {icon: createCustomIcon(p.category, p.games.length>0)}).addTo(map);
    
    // Th√™m tooltip khi hover
    m.on('mouseover', function(e) {
      if (currentTooltip) {
        document.body.removeChild(currentTooltip);
      }
      
      currentTooltip = document.createElement('div');
      currentTooltip.className = 'marker-tooltip';
      currentTooltip.textContent = p.name;
      
      const point = map.latLngToContainerPoint(e.latlng);
      currentTooltip.style.left = (point.x + 20) + 'px';
      currentTooltip.style.top = (point.y - 10) + 'px';
      
      document.body.appendChild(currentTooltip);
    });
    
    m.on('mouseout', function() {
      if (currentTooltip) {
        document.body.removeChild(currentTooltip);
        currentTooltip = null;
      }
    });
    
    // S·ª¨A L·∫†I PH·∫¶N N√ÄY - ƒê·∫£m b·∫£o s·ª± ki·ªán click ƒë∆∞·ª£c x·ª≠ l√Ω ƒë√∫ng
    m.on('click', function(e) {
      // ƒê√≥ng tooltip n·∫øu ƒëang m·ªü
      if (currentTooltip) {
        document.body.removeChild(currentTooltip);
        currentTooltip = null;
      }
      openDiModal(p);
    });
    
    // Th√™m popup c∆° b·∫£n ƒë·ªÉ test
    m.bindPopup(`<strong>${p.name}</strong><br>${p.address}`, {
      closeButton: true,
      autoClose: false
    });
  });
}

/* modal instances */
let diModal;
if (document.getElementById('diModal')) {
  diModal = new bootstrap.Modal(document.getElementById('diModal'));
}

/* open di t√≠ch modal (with details) */
function openDiModal(p){
  if (!diModal) return;
  
  document.getElementById('diTitle').innerText = p.name;
  const extras = p.extra.map(x=>`<li>${x}</li>`).join('');
  const html = `
    <div class="row">
      <div class="col-md-5"><img src="${p.img}" alt="${p.name}" style="width:100%;border-radius:8px;object-fit:cover"></div>
      <div class="col-md-7">
        <h5 class="diatic-title">${p.name}</h5>
        <p style="margin:0">${p.address}</p>
        <p style="margin-top:8px;color:#333">${p.note}</p>
        ${extras ? `<ul>${extras}</ul>` : ''}
      </div>
    </div>
  `;
  document.getElementById('diBody').innerHTML = html;
  document.getElementById('diCoords').innerText = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
  const btnPlay = document.getElementById('btn-play');
  if(p.games && p.games.length){
    btnPlay.style.display='inline-block';
    btnPlay.onclick = ()=> { diModal.hide(); openGamePicker(p); };
  } else { btnPlay.style.display='none'; btnPlay.onclick=null; }
  // check-in button
  document.getElementById('btn-checkin').onclick = ()=> {
    const u = getCurrentUser();
    if(!u){ alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi check-in.'); return; }
    markVisited(p.id);
    awardBadgeSite(p.id,p.name);
  };
  diModal.show();
}

/* ---------- Badges & check-in logic ---------- */
function getBadges(){ return loadBadges(); }

function awardBadge(id,name,icon){
  const user = getCurrentUser();
  if (!user) return false;
  
  if(!user.badges) user.badges = [];
  if(user.badges.find(b=>b.id===id)) return false;
  
  user.badges.push({id,name,icon:icon || `https://via.placeholder.com/64/FFD54F/000?text=${encodeURIComponent(name.charAt(0))}`});
  updateUser(user);
  renderUserBadges(user);
  
  // Hi·ªÉn th·ªã popup huy hi·ªáu
  showBadgePopup(name, icon);
  return true;
}

/* mark visited and award site badge */
function markVisited(siteId){
  const user = getCurrentUser();
  if (!user) return;
  
  if(!user.visitedSites) user.visitedSites = [];
  if(!user.visitedSites.includes(siteId)){ 
    user.visitedSites.push(siteId); 
    updateUser(user);
    renderUserBadges(user);
  }
}

function awardBadgeSite(siteId, siteName){
  const id = `site_${siteId}`;
  const name = `${siteName}`;
  const badgeIcons = {
    'chua': 'images/hhchua.jpg',
    'nha-tu': 'images/hhnhatupq.jpg',
    'nha-thung': 'images/hhnhathung.jpg',
    'ham-ninh': 'images/hhlangchai.jpg',
    'baotang': 'images/hhcoinguon.jpg',
    'dinh-cau': 'images/hhdinhcau.jpg',
    'dinh-ntt': 'images/hhdinhntt.jpg',
    'vuon-quoc-gia': 'images/hhvuon.jpg',
    'bai-sao': 'images/hhbaisao.jpg',
    'hon-thom': 'images/hhhonthom.jpg',
    'cap-treo': 'images/hhcaptreo.jpg',
    'grand-world': 'images/hhgrandworld.jpg',
    'ngoc-trai': 'images/hhngoctrai.jpg'
  };
  
  const badgeIcon = badgeIcons[siteId] || `https://via.placeholder.com/64/C33/fff?text=${encodeURIComponent(siteName.split(' ')[0].charAt(0))}`;
  awardBadge(id, name, badgeIcon);
}

/* Hi·ªÉn th·ªã popup huy hi·ªáu l·ªõn */
function showBadgePopup(badgeName, badgeIcon) {
  const popup = document.getElementById('badgePopup');
  const popupImg = document.getElementById('badgePopupImg');
  const popupTitle = document.getElementById('badgePopupTitle');
  
  if (!popup || !popupImg || !popupTitle) return;
  
  popupImg.src = badgeIcon;
  popupTitle.textContent = badgeName;
  popup.style.display = 'flex';
  
  // B·∫Øn ph√°o hoa
  if (typeof confetti === 'function') {
    confetti({
      particleCount: 150,
      spread: 70,
      origin: { y: 0.6 },
      colors: ['#C62828', '#FFD54F', '#4CAF50', '#2196F3']
    });
  }
  
  const autoClose = setTimeout(() => {
    closeBadgePopup();
  }, 3000);
  
  const badgePopupClose = document.getElementById('badgePopupClose');
  if (badgePopupClose) {
    badgePopupClose.onclick = () => {
      clearTimeout(autoClose);
      closeBadgePopup();
    };
  }
  
  popup.onclick = (e) => {
    if (e.target === popup) {
      clearTimeout(autoClose);
      closeBadgePopup();
    }
  };
}

function closeBadgePopup() {
  const popup = document.getElementById('badgePopup');
  if (popup) {
    popup.style.display = 'none';
  }
}

/* record game completion */
function recordDone(siteId, gameId){
  const user = getCurrentUser();
  if (!user) return;
  
  if(!user.completedGames) user.completedGames = {};
  if(!user.completedGames[siteId]) user.completedGames[siteId] = [];
  if(!user.completedGames[siteId].includes(gameId)){ 
    user.completedGames[siteId].push(gameId); 
    updateUser(user);
    renderUserBadges(user);
  }
}

/* ---------- Game picker & implementations ---------- */
function openGamePicker(site){
  const html = `<div class="text-center">
    <h4 class="mb-4">Ch·ªçn mini-game ‚Äî ${site.name}</h4>
    <div class="d-flex flex-column gap-3 align-items-center">
      ${site.games.map(g=>`<button class="btn btn-accent btn-lg w-75 game-choice" data-game="${g}">${labelGame(g)}</button>`).join('')}
    </div>
    <p class="mt-4 text-muted">M·ªói mini-game c√≥ c√°c b∆∞·ªõc th·ª≠ th√°ch. K·∫øt qu·∫£ s·∫Ω l∆∞u v√†o h·ªì s∆° c·ªßa b·∫°n.</p>
  </div>`;
  
  showGameFullscreen('Ch·ªçn mini-game', html);
  
  document.querySelectorAll('.game-choice').forEach(btn=> btn.addEventListener('click', ()=> {
    const g = btn.dataset.game;
    startGameInstance(g, site);
  }));
}

function labelGame(id){
  const map = {
    'quiz_nhatu':'Quiz (Nh√† t√π)',
    'quiz_trungtruc':'Quiz (ƒê√¨nh)',
    'memory_nhatu':'Memory Vi·ªát (Nh√† t√π)',
    'memory_trungtruc':'Memory Vi·ªát (ƒê√¨nh)'
  };
  return map[id]||id;
}

/* ---------- GAME FULLSCREEN MODE ---------- */
const gameFullscreen = document.getElementById('gameFullscreen');
const gameFullscreenTitle = document.getElementById('gameFullscreenTitle');
const gameFullscreenBody = document.getElementById('gameFullscreenBody');
const gameFullscreenClose = document.getElementById('gameFullscreenClose');

if (gameFullscreenClose) {
  gameFullscreenClose.addEventListener('click', () => {
    hideGameFullscreen();
  });
}

function showGameFullscreen(title, content) {
  if (!gameFullscreenTitle || !gameFullscreenBody) return;
  
  gameFullscreenTitle.textContent = title;
  gameFullscreenBody.innerHTML = content;
  gameFullscreen.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function hideGameFullscreen() {
  if (gameFullscreen) {
    gameFullscreen.classList.remove('active');
    document.body.style.overflow = 'auto';
  }
}

/* ---------- Victory Popup ---------- */
const victoryPopup = document.getElementById('victoryPopup');
const victoryMessage = document.getElementById('victoryMessage');
const victoryClose = document.getElementById('victoryClose');

if (victoryClose) {
  victoryClose.addEventListener('click', () => {
    if (victoryPopup) {
      victoryPopup.style.display = 'none';
    }
  });
}

function showVictory(message) {
  if (!victoryMessage || !victoryPopup) return;
  
  victoryMessage.textContent = message;
  victoryPopup.style.display = 'flex';
  
  // B·∫Øn ph√°o hoa ·ªü ph√≠a tr∆∞·ªõc
  if (typeof confetti === 'function') {
    confetti({
      particleCount: 200,
      spread: 100,
      origin: { y: 0.3 },
      colors: ['#C62828', '#FFD54F', '#4CAF50', '#2196F3'],
      startVelocity: 30,
      gravity: 0.8
    });
    
    // Th√™m hi·ªáu ·ª©ng ph√°o hoa t·ª´ hai b√™n
    setTimeout(() => {
      confetti({
        particleCount: 100,
        angle: 60,
        spread: 80,
        origin: { x: 0, y: 0.5 },
        colors: ['#C62828', '#FFD54F']
      });
      confetti({
        particleCount: 100,
        angle: 120,
        spread: 80,
        origin: { x: 1, y: 0.5 },
        colors: ['#4CAF50', '#2196F3']
      });
    }, 500);
  }
}

/* ---------- GAME L·∫¨T TH·∫∫ (MEMORY CARD) ---------- */
const MEMORY_GAMES = {
  'memory_nhatu': {
    title: 'Memory Vi·ªát - Nh√† t√π Ph√∫ Qu·ªëc',
    cards: [
      { id: 1, image: 'images/nhatucard1.jpg', matchId: 2 },
      { id: 2, image: 'images/nhatutext1.jpg', matchId: 1 },
      { id: 3, image: 'images/nhatucard2.jpg', matchId: 4 },
      { id: 4, image: 'images/nhatutext2.jpg', matchId: 3 },
      { id: 5, image: 'images/nhatucard3.jpg', matchId: 6 },
      { id: 6, image: 'images/nhatutext3.jpg', matchId: 5 },
      { id: 7, image: 'images/nhatucard4.jpg', matchId: 8 },
      { id: 8, image: 'images/nhatutext4.jpg', matchId: 7 }
    ]
  },
  'memory_trungtruc': {
    title: 'Memory Vi·ªát - ƒê√¨nh Nguy·ªÖn Trung Tr·ª±c',
    cards: [
      { id: 1, image: 'images/dinhcard1.jpg', matchId: 2 },
      { id: 2, image: 'images/dinhtext1.jpg', matchId: 1 },
      { id: 3, image: 'images/dinhcard2.jpg', matchId: 4 },
      { id: 4, image: 'images/dinhtext2.jpg', matchId: 3 },
      { id: 5, image: 'images/dinhcard3.jpg', matchId: 6 },
      { id: 6, image: 'images/dinhtext3.jpg', matchId: 5 },
      { id: 7, image: 'images/dinhcard4.jpg', matchId: 8 },
      { id: 8, image: 'images/dinhtext4.jpg', matchId: 7 }
    ]
  }
};

let currentMemoryGame = null;
let flippedCards = [];
let matchedPairs = 0;
let canFlip = true;
let flipCount = 0;

function startMemoryGame(gameId, site) {
  const gameData = MEMORY_GAMES[gameId];
  if (!gameData) {
    alert('Game Memory Vi·ªát ch∆∞a c√≥ n·ªôi dung.');
    return;
  }
  currentMemoryGame = { id: gameId, site: site, gameData: gameData };
  flippedCards = [];
  matchedPairs = 0;
  canFlip = true;
  flipCount = 0;
  const html = `
    <div class="memory-container text-center">
      <h4 class="mb-3">${gameData.title}</h4>
      <div class="memory-stats mb-3">
        <span class="badge bg-primary">C·∫∑p ƒë√£ t√¨m: <span id="matchedCount">0</span>/4</span>
        <span class="badge bg-secondary ms-2">L∆∞·ª£t l·∫≠t: <span id="flipCount">0</span></span>
      </div>
      
      <div class="memory-board" id="memoryBoard">
        <!-- Cards will be generated here -->
      </div>
      
      <div class="memory-controls mt-4">
        <button class="btn btn-accent" onclick="finishMemoryGame()">Ho√†n th√†nh</button>
        <button class="btn btn-outline-secondary" onclick="resetMemoryGame()">Ch∆°i l·∫°i</button>
      </div>
      
      <div class="memory-complete mt-3" id="memoryComplete" style="display: none;">
        <div class="alert alert-success">
          <h5>üéâ Ch√∫c m·ª´ng!</h5>
          <p>B·∫°n ƒë√£ ho√†n th√†nh game Memory Vi·ªát!</p>
        </div>
      </div>
    </div>
  `;
  showGameFullscreen(gameData.title, html);
  initializeMemoryGame();
}

function initializeMemoryGame() {
  const board = document.getElementById('memoryBoard');
  const gameData = currentMemoryGame.gameData;
  
  const shuffledCards = [...gameData.cards].sort(() => Math.random() - 0.5);
  
  board.innerHTML = shuffledCards.map(card => `
    <div class="memory-card" data-card-id="${card.id}" data-match-id="${card.matchId}">
      <div class="card-inner">
        <div class="card-front">
          <div class="card-content">
            <i class="fas fa-question"></i>
          </div>
        </div>
        <div class="card-back">
          <div class="card-content">
            <img src="${card.image}" alt="Memory card" onerror="this.style.display='none'">
          </div>
        </div>
      </div>
    </div>
  `).join('');
  document.querySelectorAll('.memory-card').forEach(card => {
    card.addEventListener('click', handleCardClick);
  });
  flipCount = 0;
  updateFlipCount();
}

function handleCardClick() {
  if (!canFlip) return;
  if (this.classList.contains('flipped') || this.classList.contains('matched')) return;
  if (flippedCards.length >= 2) return;
  this.classList.add('flipped');
  flippedCards.push(this);
  flipCount++;
  updateFlipCount();
  if (flippedCards.length === 2) {
    canFlip = false;
    setTimeout(checkForMatch, 800);
  }
}

function checkForMatch() {
  const [card1, card2] = flippedCards;
  const matchId1 = card1.dataset.matchId;
  const matchId2 = card2.dataset.matchId;
  if (card1.dataset.cardId === matchId2 && card2.dataset.cardId === matchId1) {
    card1.classList.add('matched');
    card2.classList.add('matched');
    matchedPairs++;
    updateMatchedCount();
    if (matchedPairs === 4) {
      setTimeout(() => {
        const memoryComplete = document.getElementById('memoryComplete');
        if (memoryComplete) {
          memoryComplete.style.display = 'block';
        }
        showVictory('üéâ Xu·∫•t s·∫Øc! B·∫°n ƒë√£ ho√†n th√†nh Memory Vi·ªát!');
      }, 500);
    }
  } else {
    card1.classList.remove('flipped');
    card2.classList.remove('flipped');
  }
  flippedCards = [];
  canFlip = true;
}

function updateMatchedCount() {
  const matchedCount = document.getElementById('matchedCount');
  if (matchedCount) {
    matchedCount.textContent = matchedPairs;
  }
}

function updateFlipCount() {
  const flipCountElement = document.getElementById('flipCount');
  if (flipCountElement) {
    flipCountElement.textContent = flipCount;
  }
}

function resetMemoryGame() {
  flippedCards = [];
  matchedPairs = 0;
  canFlip = true;
  flipCount = 0;
  
  document.querySelectorAll('.memory-card').forEach(card => {
    card.classList.remove('flipped', 'matched');
  });
  
  const memoryComplete = document.getElementById('memoryComplete');
  if (memoryComplete) {
    memoryComplete.style.display = 'none';
  }
  
  updateMatchedCount();
  updateFlipCount();
  
  const board = document.getElementById('memoryBoard');
  const cards = Array.from(board.children);
  cards.sort(() => Math.random() - 0.5);
  cards.forEach(card => board.appendChild(card));
}

function finishMemoryGame() {
  if (matchedPairs === 4) {
    recordDone(currentMemoryGame.site.id, currentMemoryGame.id);
    hideGameFullscreen();
  } else {
    alert(`B·∫°n ƒë√£ t√¨m ƒë∆∞·ª£c ${matchedPairs}/4 c·∫∑p th·∫ª. H√£y ti·∫øp t·ª•c!`);
  }
}

/* ---------- GAME QUIZ ---------- */
const QUIZZES = {
  'quiz_nhatu': {
    title:'Quiz Nh√† t√π Ph√∫ Qu·ªëc',
    items:[
      {
        q:'Di t√≠ch Tr·∫°i giam Ph√∫ Qu·ªëc ƒë∆∞·ª£c ch√≠nh th·ª©c x·∫øp h·∫°ng Di t√≠ch Qu·ªëc gia ƒë·∫∑c bi·ªát v√†o th·ªùi ƒëi·ªÉm n√†o?',
        opts:['Ng√†y 30/4/1975','Ng√†y 27/7/2013','Ng√†y 31/12/2014','Ng√†y 20/10/2016'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. CƒÉn c·ª© theo Quy·∫øt ƒë·ªãnh s·ªë 2408/Qƒê-TTg ng√†y 31/12/2014 c·ªßa Th·ªß t∆∞·ªõng Ch√≠nh ph·ªß.'
      },
      {
        q:'"ƒê·ªãa ng·ª•c tr·∫ßn gian" Ph√∫ Qu·ªëc ch√≠nh th·ª©c t·ªìn t·∫°i trong kho·∫£ng th·ªùi gian n√†o?',
        opts:['T·ª´ nƒÉm 1949 ƒë·∫øn nƒÉm 1954','T·ª´ th√°ng 6/1967 ƒë·∫øn th√°ng 3/1973','T·ª´ nƒÉm 1965 ƒë·∫øn nƒÉm 1975','T·ª´ nƒÉm 1954 ƒë·∫øn nƒÉm 1975'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. Theo t∆∞ li·ªáu, tr·∫°i giam t·ªìn t·∫°i ch∆∞a ƒë·∫ßy 6 nƒÉm trong giai ƒëo·∫°n n√†y d∆∞·ªõi s·ª± qu·∫£n l√Ω c·ªßa ch√≠nh quy·ªÅn M·ªπ - Ng·ª•y.'
      },
      {
        q:'∆Ø·ªõc t√≠nh c√≥ bao nhi√™u t√π binh ƒë√£ b·ªã gi·∫øt h·∫°i t·∫°i Tr·∫°i giam Ph√∫ Qu·ªëc?',
        opts:['Kho·∫£ng 1.000 ng∆∞·ªùi','Kho·∫£ng 2.000 ng∆∞·ªùi','Kho·∫£ng 4.000 ng∆∞·ªùi','Kho·∫£ng 10.000 ng∆∞·ªùi'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. T∆∞ li·ªáu ghi r√µ con s·ªë kho·∫£ng 4.000 t√π binh ƒë√£ b·ªã gi·∫øt h·∫°i t·∫°i ƒë√¢y.'
      },
      {
        q:'M·ªôt trong nh·ªØng h√¨nh th·ª©c tra t·∫•n ƒë·∫∑c bi·ªát d√£ man, n∆°i t√π binh b·ªã nh·ªët trong c√°c c√¥ng-ten-n∆° nh·ªè ƒë∆∞·ª£c g·ªçi l√† g√¨?',
        opts:['Chu·ªìng c·ªçp xi mƒÉng','Th√πng cat-x√¥','H·∫ßm ƒë√° v√¥i','Ng·ª•c t·ªëi'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. ƒê√¢y l√† m·ªôt ki·ªÉu giam gi·ªØ ƒë∆∞·ª£c m√¥ t·∫£ trong t∆∞ li·ªáu, s·ª≠ d·ª•ng c√°c c√¥ng-ten-n∆° nh·ªè, tr√™n ƒë·ªânh ƒë·ª•c l·ªó th√¥ng h∆°i, r·∫•t ch·∫≠t h·∫πp v√† ng·ªôt ng·∫°t.'
      },
      {
        q:'C√°c t√π binh t·∫°i Tr·∫°i giam Ph√∫ Qu·ªëc ƒë√£ t·ªï ch·ª©c bao nhi√™u cu·ªôc v∆∞·ª£t ng·ª•c v·ªõi nhi·ªÅu h√¨nh th·ª©c kh√°c nhau?',
        opts:['12 cu·ªôc','25 cu·ªôc','45 cu·ªôc','52 cu·ªôc'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. Th·ªÉ hi·ªán tinh th·∫ßn ƒë·∫•u tranh b·∫•t khu·∫•t, c√°c t√π binh ƒë√£ t·ªï ch·ª©c th√†nh c√¥ng 45 cu·ªôc v∆∞·ª£t ng·ª•c.'
      },
      {
        q:'Khu v·ª±c n√†o sau ƒë√¢y KH√îNG ph·∫£i l√† m·ªôt ph·∫ßn c·ªßa Di t√≠ch Tr·∫°i giam Ph√∫ Qu·ªëc ng√†y nay?',
        opts:['Ph√¢n khu B2 (ƒë∆∞·ª£c ph·ª•c d·ª±ng)','Nghƒ©a ƒë·ªãa t√π binh (ƒê·ªìi 100)','Nh√† t√π C√¥n S∆°n','ƒê√†i t∆∞·ªüng ni·ªám li·ªát sƒ© t·∫°i ƒê·ªìi Sim'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. Nh√† t√π C√¥n S∆°n l√† m·ªôt di t√≠ch l·ªãch s·ª≠ ho√†n to√†n kh√°c, n·∫±m ·ªü C√¥n ƒê·∫£o, t·ªânh B√† R·ªãa - V≈©ng T√†u.'
      },
      {
        q:'T·ªïng di·ªán t√≠ch c·ªßa Tr·∫°i giam Ph√∫ Qu·ªëc trong l·ªãch s·ª≠ l√™n ƒë·∫øn bao nhi√™u?',
        opts:['100 hecta','200 hecta','400 hecta','500 hecta'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. Tr·∫°i giam c√≥ quy m√¥ r·∫•t l·ªõn, v·ªõi t·ªïng di·ªán t√≠ch l√™n ƒë·∫øn 400 hecta, ƒë∆∞·ª£c chia th√†nh 12 khu v·ª±c.'
      }
    ]
  },
  'quiz_trungtruc': {
    title:'Quiz ƒê√¨nh Nguy·ªÖn Trung Tr·ª±c',
    items:[
      {
        q:'Nguy·ªÖn Trung Tr·ª±c l√† th·ªß lƒ©nh n·ªïi ti·∫øng c·ªßa phong tr√†o kh√°ng chi·∫øn ch·ªëng?',
        opts:['Ch·ªëng Ph√°p','Ch·ªëng Ph√°p v√† ch·ªëng M·ªπ','Ch·ªëng M·ªπ','Ch·ªëng Nh·∫≠t'],
        ans:0,
        explain:'ƒê√°p √°n ƒë√∫ng l√† A. Nguy·ªÖn Trung Tr·ª±c l√† th·ªß lƒ©nh nghƒ©a qu√¢n ch·ªëng l·∫°i th·ª±c d√¢n Ph√°p x√¢m l∆∞·ª£c ·ªü Nam K·ª≥ v√†o n·ª≠a cu·ªëi th·∫ø k·ª∑ 19 (t·ª´ 1861-1868).'
      },
      {
        q:'Nguy·ªÖn Trung Tr·ª±c ƒë√£ ch·ªâ huy nghƒ©a qu√¢n ƒë·ªët ch√°y t√†u chi·∫øn n√†o c·ªßa Ph√°p tr√™n s√¥ng V√†m C·ªè ƒê√¥ng v√†o nƒÉm 1861, g√¢y ti·∫øng vang l·ªõn?',
        opts:['T√†u Hy V·ªçng (L\'Esp√©rance)','T√†u H·∫±ng T√¢m (La Pers√©v√©rance)','T√†u Jaccar√©','T√†u Avalanche'],
        ans:0,
        explain:'ƒê√°p √°n ƒë√∫ng l√† A. Chi·∫øn c√¥ng n·ªïi ti·∫øng nh·∫•t c·ªßa √¥ng l√† ch·ªâ huy nghƒ©a qu√¢n ƒë·ªët ch√°y ti·ªÉu h·∫°m L\'Esp√©rance (c√≥ t√™n Vi·ªát l√† "Hy V·ªçng") c·ªßa Ph√°p tr√™n s√¥ng V√†m C·ªè ƒê√¥ng nƒÉm 1861.'
      },
      {
        q:'C√¢u n√≥i b·∫•t h·ªß "Bao gi·ªù ng∆∞·ªùi T√¢y nh·ªï h·∫øt c·ªè n∆∞·ªõc Nam th√¨ m·ªõi h·∫øt ng∆∞·ªùi Nam ƒë√°nh T√¢y" ƒë∆∞·ª£c Nguy·ªÖn Trung Tr·ª±c n√≥i trong ho√†n c·∫£nh n√†o?',
        opts:['Khi ƒë·ªông vi√™n nghƒ©a qu√¢n tr∆∞·ªõc tr·∫≠n ƒë√°nh','Khi b·ªã th·ª±c d√¢n Ph√°p d·ª• h√†ng v√† k·∫øt √°n t·ª≠ h√¨nh','Khi tr·∫£ l·ªùi ph·ªèng v·∫•n c·ªßa m·ªôt nh√† b√°o Ph√°p','Trong m·ªôt b·ª©c th∆∞ g·ª≠i cho Tri·ªÅu ƒë√¨nh Hu·∫ø'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. C√¢u n√≥i b·∫•t h·ªß n√†y th·ªÉ hi·ªán kh√≠ ph√°ch ki√™n c∆∞·ªùng c·ªßa √¥ng, ƒë∆∞·ª£c √¥ng th·ªët l√™n khi ƒë·ªëi di·ªán v·ªõi c√°i ch·∫øt, tr∆∞·ªõc s·ª± d·ª• d·ªó c·ªßa k·∫ª th√π.'
      },
      {
        q:'Nguy·ªÖn Trung Tr·ª±c b·ªã th·ª±c d√¢n Ph√°p x·ª≠ ch√©m t·∫°i ƒë√¢u?',
        opts:['S√†i G√≤n','B·∫øn Tre','R·∫°ch Gi√°','C·∫ßn Th∆°'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. Sau khi kh√°ng chi·∫øn ·ªü H√≤n Ch√¥ng th·∫•t b·∫°i v√† b·ªã b·∫Øt, √¥ng b·ªã th·ª±c d√¢n Ph√°p x·ª≠ ch√©m t·∫°i ch·ª£ R·∫°ch Gi√° v√†o ng√†y 27/10/1868 (16/9 nƒÉm M·∫≠u Th√¨n).'
      },
      {
        q:'L·ªÖ h·ªôi t∆∞·ªüng ni·ªám Nguy·ªÖn Trung Tr·ª±c ƒë∆∞·ª£c t·ªï ch·ª©c h·∫±ng nƒÉm v√†o nh·ªØng ng√†y n√†o?',
        opts:['Ch·ªâ ng√†y 27 th√°ng 10 D∆∞∆°ng l·ªãch','T·ª´ ng√†y 26 ƒë·∫øn 28 th√°ng 8 √Çm l·ªãch','Ch·ªâ ng√†y 16 th√°ng 9 √Çm l·ªãch','T·ª´ ng√†y 1 ƒë·∫øn 3 th√°ng 1 D∆∞∆°ng l·ªãch'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. L·ªÖ h·ªôi ch√≠nh K·ª≥ y√™n t·∫°i ƒê√¨nh th·∫ßn Nguy·ªÖn Trung Tr·ª±c ·ªü R·∫°ch Gi√°, Ki√™n Giang ƒë∆∞·ª£c t·ªï ch·ª©c trang tr·ªçng trong 3 ng√†y t·ª´ 26 ƒë·∫øn 28 th√°ng 8 √Çm l·ªãch h·∫±ng nƒÉm, v·ªõi ng√†y ch√°nh gi·ªó (ng√†y hy sinh) l√† 27/8 √Çm l·ªãch.'
      },
      {
        q:'Anh h√πng d√¢n t·ªôc Nguy·ªÖn Trung Tr·ª±c ƒë√£ b·ªã th·ª±c d√¢n Ph√°p h√†nh quy·∫øt v√†o ng√†y n√†o?',
        opts:['Ng√†y 27 th√°ng 10 nƒÉm 1868','Ng√†y 16 th√°ng 9 nƒÉm 1868','Ng√†y 25 th√°ng 10 nƒÉm 1868','Ng√†y 16 th√°ng 9 nƒÉm 1869'],
        ans:0,
        explain:'ƒê√°p √°n ƒë√∫ng l√† A. Nguy·ªÖn Trung Tr·ª±c hy sinh v√†o ng√†y 27 th√°ng 10 nƒÉm 1868.'
      }
    ]
  }
};

/* Start quiz run: show one question at a time with explanation */
let currentQuiz = null;
let currentQIndex = 0;
let selectedOption = null;

function startQuiz(quizId, site){
  const qset = QUIZZES[quizId];
  if(!qset){ alert('Quiz ch∆∞a c√≥ n·ªôi dung.'); return; }
  currentQuiz = {id:quizId, site:site, qset:qset};
  currentQIndex = 0;
  selectedOption = null;
  renderCurrentQuestion();
}

function renderCurrentQuestion(){
  const qobj = currentQuiz.qset.items[currentQIndex];
  
  const html = `
    <div class="quiz-container">
      <div class="quiz-question">
        <h5>C√¢u ${currentQIndex+1} / ${currentQuiz.qset.items.length}</h5>
        <p class="fs-5">${qobj.q}</p>
      </div>
      
      <div class="quiz-options" id="quizOptions">
        ${qobj.opts.map((opt, i) => `
          <div class="quiz-option" data-index="${i}">
            ${opt}
          </div>
        `).join('')}
      </div>
      
      <div class="quiz-feedback" id="quizFeedback"></div>
      
      <div class="quiz-controls">
        <button class="btn btn-outline-secondary" onclick="hideGameFullscreen()">Tho√°t</button>
        <button class="btn btn-accent" id="quizNextBtn" onclick="handleAnswerAndNext()" disabled>Ti·∫øp t·ª•c</button>
      </div>
    </div>
  `;
  
  showGameFullscreen(currentQuiz.qset.title, html);
  
  document.querySelectorAll('.quiz-option').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('.quiz-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      option.classList.add('selected');
      selectedOption = parseInt(option.dataset.index);
      const quizNextBtn = document.getElementById('quizNextBtn');
      if (quizNextBtn) {
        quizNextBtn.disabled = false;
      }
    });
  });
}

function handleAnswerAndNext(){
  if(selectedOption === null){ 
    alert('Vui l√≤ng ch·ªçn 1 ƒë√°p √°n'); 
    return; 
  }
  
  const qobj = currentQuiz.qset.items[currentQIndex];
  const fb = document.getElementById('quizFeedback');
  
  if(selectedOption === qobj.ans){
    fb.innerHTML = `<div class="correct">‚úì ƒê√°p √°n ƒë√∫ng</div><div class="explain mt-2">${qobj.explain}</div>`;
    fb.className = 'quiz-feedback correct';
  } else {
    fb.innerHTML = `<div class="wrong">‚úó ƒê√°p √°n sai</div><div class="explain mt-2">ƒê√°p √°n ƒë√∫ng: <strong>${qobj.opts[qobj.ans]}</strong><br>${qobj.explain}</div>`;
    fb.className = 'quiz-feedback wrong';
  }
  
  setTimeout(()=> {
    currentQIndex++;
    if(currentQIndex < currentQuiz.qset.items.length){
      selectedOption = null;
      renderCurrentQuestion();
    } else {
      recordDone(currentQuiz.site.id, currentQuiz.id);
      showVictory('üéâ Xu·∫•t s·∫Øc! B·∫°n ƒë√£ ho√†n th√†nh quiz!');
      hideGameFullscreen();
    }
  }, 1500);
}

/* startGameInstance wrapper called from picker */
function startGameInstance(gid, site){
  if(gid.startsWith('quiz_')) startQuiz(gid, site);
  else if(gid.startsWith('memory_')) startMemoryGame(gid, site);
  else { alert('Game ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£'); }
}

/* ---------- initial UI state ---------- */
document.addEventListener('DOMContentLoaded', function() {
  console.log('üéØ Website DOM loaded');
  initData();
  refreshProfileAuthUI();
  renderProfileBadges();
  loadStories();
  initMap(); // Kh·ªüi t·∫°o b·∫£n ƒë·ªì sau khi DOM ƒë√£ s·∫µn s√†ng
});

/* ensure map resizes when switching pages */
window.addEventListener('resize', ()=> {
  if (currentPage === 'map' && typeof map !== 'undefined') {
    map.invalidateSize();
  }
});

// T·∫°m th·ªùi comment Firebase ƒë·ªÉ tr√°nh l·ªói
/*
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const analytics = firebase.analytics();
const auth = firebase.auth();
const db = firebase.firestore();

// Enable offline persistence
db.enablePersistence()
  .catch((err) => {
    console.log('Persistence failed: ', err);
  });
*/
</script>
</body>
</html>

<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc ‚Äî D·ª± √°n KHKT: T·ª± h√†o qu√™ h∆∞∆°ng</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<!-- Firebase Analytics -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
<!-- Firebase Authentication -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<!-- Firebase Firestore -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    --accent:#C62828; /* ƒë·ªè */
    --gold:#FFD54F;
    --bg:#FBFBFB;
    --nature:#A5D6A7; /* Xanh l√° pastel */
    --culture:#FFCC80; /* Cam pastel */
    --entertainment:#CE93D8; /* T√≠m pastel */
    --craft:#EF9A9A; /* ƒê·ªè pastel */
    --admin:#2196F3; /* Xanh d∆∞∆°ng cho admin */
  }
  body{font-family: "Noto Sans", system-ui, sans-serif; background:var(--bg); color:#111;}
  .container-main{max-width:1100px;margin:auto;}
  .logo{width:60px;height:60px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#B71C1C);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:22px}
  .hero{background:linear-gradient(90deg, rgba(198,40,40,0.06), rgba(255,213,79,0.02));padding:22px;border-radius:12px;margin:18px 0}
  .btn-accent{background:linear-gradient(90deg,var(--accent),#EF5350);color:white;border:none}
  .btn-admin{background:linear-gradient(90deg,var(--admin),#42A5F5);color:white;border:none}
  #map{height:64vh;border-radius:12px}
  .badge-img{width:56px;height:56px;border-radius:8px;object-fit:cover}
  .marker-emoji{font-size:20px}
  .diatic-title{font-weight:700}
  .game-card{border-radius:10px;background:white;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  footer{padding:18px 0;color:#666;text-align:center;margin-top:18px}
  .correct{color:green;font-weight:700}
  .wrong{color:#c62828;font-weight:700}
  .explain{font-size:0.95rem;color:#444}
  
  /* Overlay khi m·ªü menu */
  .menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    display: none;
  }
  .menu-overlay.active {
    display: block;
  }
  
  /* Menu dropdown */
  .menu-dropdown {
    position: absolute;
    top: 70px;
    right: 10px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    z-index: 1000;
    min-width: 200px;
    display: none;
    overflow: hidden;
  }
  .menu-dropdown.active {
    display: block;
  }
  .menu-item {
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .menu-item:hover {
    background: #f8f9fa;
  }
  .menu-item:last-child {
    border-bottom: none;
  }
  .menu-item.active {
    background: var(--accent);
    color: white;
  }
  
  /* PQ Stories - Wall of Notes */
  .stories-wall {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    padding: 20px 0;
  }
  .story-note {
    background: #fff9c4;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-left: 5px solid var(--accent);
    position: relative;
    transition: transform 0.3s;
  }
  .story-note:hover {
    transform: translateY(-5px);
  }
  .story-note::before {
    content: '';
    position: absolute;
    top: -10px;
    right: -10px;
    width: 40px;
    height: 40px;
    background: var(--accent);
    border-radius: 50%;
    opacity: 0.1;
  }
  .story-media {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  .story-content {
    margin-bottom: 15px;
    line-height: 1.6;
  }
  .story-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    color: #666;
  }
  .story-actions {
    display: flex;
    gap: 15px;
    margin-top: 10px;
  }
  .story-action {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    transition: color 0.3s;
  }
  .story-action:hover {
    color: var(--accent);
  }
  
  /* Upload form */
  .upload-form {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  .upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 20px;
  }
  .upload-area:hover {
    border-color: var(--accent);
    background: #fff5f5;
  }
  .upload-area i {
    font-size: 3rem;
    color: #dee2e6;
    margin-bottom: 15px;
  }
  
  /* Marker tooltip */
  .marker-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 14px;
    white-space: nowrap;
    z-index: 1000;
    pointer-events: none;
    transform: translateY(-100%);
    margin-top: -10px;
  }
  .marker-tooltip:after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
  }
  
 /* CSS cho game l·∫≠t th·∫ª */
  /* C·∫≠p nh·∫≠t CSS cho game l·∫≠t th·∫ª tr√™n ƒëi·ªán tho·∫°i */
@media (max-width: 767px) {
  .memory-board {
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 12px;
    max-width: 100%;
  }
  
  .memory-card {
    height: 150px !important;
    width: 100%;
    max-width: 200px;
    margin: 0 auto;
  }
  
  .card-back .card-content img {
    max-width: 100%;
    max-height: 100%;
    object-fit: cover;
  }
  
  .stories-wall {
    grid-template-columns: 1fr;
  }
  
  .menu-dropdown {
    right: 5px;
    left: 5px;
    min-width: auto;
  }
}
@media (max-width: 480px) {
  .memory-card {
    height: 140px !important;
    max-width: 180px;
  }
}
@media (max-width: 360px) {
  .memory-card {
    height: 130px !important;
    max-width: 160px;
  }
}
  .memory-container {
    max-width: 100%;
    margin: 0 auto;
    height: 100%;
    overflow-y: auto;
    padding: 15px;
  }
  .memory-stats {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .memory-board {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    max-width: 500px;
    margin: 0 auto;
  }
  .memory-card {
    aspect-ratio: 3/4;
    perspective: 1000px;
    cursor: pointer;
  }
  .card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.6s;
    transform-style: preserve-3d;
  }
  .memory-card.flipped .card-inner {
    transform: rotateY(180deg);
  }
  .memory-card.matched .card-inner {
    transform: rotateY(180deg);
  }
  .memory-card.matched {
    cursor: default;
  }
  .card-front, .card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    box-sizing: border-box;
  }
  .card-front {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  .card-back {
    background: white;
    border: 2px solid #dee2e6;
    transform: rotateY(180deg);
  }
  .card-content {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .card-back .card-content img {
    max-width: 100%;
    max-height: 100%;
    object-fit: cover;
    border-radius: 6px;
  }
  .card-front .card-content i {
    font-size: 2rem;
  }
  .memory-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
    flex-wrap: wrap;
  }
  .memory-complete {
    margin-top: 20px;
  }
  /* Hi·ªáu ·ª©ng l·∫Øc khi sai */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
  /* Hi·ªáu ·ª©ng huy hi·ªáu l·ªõn */
  .badge-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
  }
  .badge-popup-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: popIn 0.5s ease;
    max-width: 300px;
    width: 90%;
  }
  .badge-popup-img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 auto 15px;
    border: 4px solid var(--gold);
    animation: bounce 1s ease infinite;
  }
  .badge-popup-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 10px;
  }
  .badge-popup-message {
    color: #666;
    margin-bottom: 20px;
  }
  /* GAME FULLSCREEN MODE */
  .game-fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    z-index: 9999;
    overflow-y: auto;
    display: none;
  }
  .game-fullscreen.active {
    display: block;
  }
  .game-fullscreen-header {
    background: linear-gradient(90deg, var(--accent), #d32);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  .game-fullscreen-title {
    font-size: 1.3rem;
    font-weight: bold;
    margin: 0;
  }
  .game-fullscreen-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
  }
  .game-fullscreen-body {
    padding: 20px;
    height: calc(100% - 70px);
    overflow-y: auto;
  }
  .quiz-container {
    max-width: 800px;
    margin: 0 auto;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  .quiz-question {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid var(--accent);
  }
  .quiz-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 20px 0;
  }
  .quiz-option {
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
  }
  .quiz-option:hover {
    border-color: var(--accent);
    background: #fff5f5;
  }
  .quiz-option.selected {
    border-color: var(--accent);
    background: #ffeaea;
  }
  .quiz-feedback {
    margin-top: 20px;
    padding: 15px;
    border-radius: 8px;
    display: none;
  }
  .quiz-feedback.correct {
    background: #e8f5e8;
    border: 1px solid #4caf50;
    display: block;
  }
  .quiz-feedback.wrong {
    background: #ffebee;
    border: 1px solid #f44336;
    display: block;
  }
  .quiz-controls {
    margin-top: auto;
    display: flex;
    justify-content: space-between;
    padding: 20px 0;
  }
  /* Victory Popup */
  .victory-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
  }
  .victory-content {
    background: white;
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    animation: popIn 0.5s ease;
    max-width: 400px;
    width: 90%;
    position: relative;
    z-index: 10001;
  }
  .victory-title {
    font-size: 2rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 15px;
  }
  .victory-message {
    color: #666;
    font-size: 1.1rem;
    margin-bottom: 25px;
  }
  /* Profile Page */
  .profile-container {
    max-width: 800px;
    margin: 0 auto;
  }
  .profile-header {
    background: linear-gradient(135deg, var(--accent), #d32);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    text-align: center;
  }
  .profile-badges {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  .profile-auth {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes popIn {
    0% { transform: scale(0.5); opacity: 0; }
    70% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  /* ========== NEW PQ STORIES DESIGN ========== */
  #page-stories {
    min-height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 0;
    margin: 0;
  }
  
  .stories-hero {
    text-align: center;
    padding: 80px 20px 40px;
    background: linear-gradient(135deg, rgba(198,40,40,0.1) 0%, rgba(255,213,79,0.05) 100%);
    position: relative;
    overflow: hidden;
  }
  
  .stories-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="%23C62828" opacity="0.03"><circle cx="20" cy="20" r="5"/><circle cx="80" cy="30" r="8"/><circle cx="40" cy="80" r="6"/><circle cx="70" cy="70" r="4"/></svg>');
    background-size: 200px 200px;
  }
  
  .stories-hero h1 {
    font-size: 3.5rem;
    font-weight: 800;
    color: var(--accent);
    margin-bottom: 15px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    position: relative;
    z-index: 2;
  }
  
  .stories-hero p {
    font-size: 1.3rem;
    color: #555;
    max-width: 600px;
    margin: 0 auto;
    position: relative;
    z-index: 2;
  }
  
  .stories-wall-container {
    position: relative;
    padding: 40px 20px 100px;
    min-height: 60vh;
  }
  
  .stories-wall-new {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
    max-width: 1400px;
    margin: 0 auto;
    position: relative;
    z-index: 2;
  }
  
  .story-note-new {
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  
  .story-note-new::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(90deg, var(--accent), var(--gold));
  }
  
  .story-note-new:hover {
    transform: translateY(-8px) rotate(1deg);
    box-shadow: 0 15px 30px rgba(0,0,0,0.15);
  }
  
  .story-note-new h3 {
    margin-top: 0;
    font-size: 1.3rem;
    color: #333;
    line-height: 1.4;
    margin-bottom: 10px;
  }
  
  .story-content-new {
    flex-grow: 1;
    margin-bottom: 15px;
    line-height: 1.5;
    color: #555;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 5;
    -webkit-box-orient: vertical;
  }
  
  .story-media-new {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 15px;
    max-height: 200px;
    object-fit: cover;
  }
  
  .story-meta-new {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
    color: #777;
    margin-bottom: 10px;
  }
  
  .story-actions-new {
    display: flex;
    gap: 15px;
    margin-top: 10px;
  }
  
  .story-action-new {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
  }
  
  .story-action-new:hover {
    color: var(--accent);
    transform: scale(1.1);
  }
  
  .story-action-new.liked {
    color: #e74c3c;
  }
  
  .story-comments {
    margin-top: 15px;
    border-top: 1px solid rgba(0,0,0,0.1);
    padding-top: 15px;
    display: none;
  }
  
  .story-comment {
    padding: 8px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  
  .story-comment:last-child {
    border-bottom: none;
  }
  
  .story-comment-author {
    font-weight: bold;
    font-size: 0.9rem;
    color: #333;
  }
  
  .story-comment-content {
    font-size: 0.85rem;
    color: #555;
    margin-top: 3px;
  }
  
  .add-comment-form {
    margin-top: 10px;
    display: flex;
    gap: 8px;
  }
  
  .add-comment-input {
    flex-grow: 1;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 0.85rem;
    outline: none;
  }
  
  .add-comment-btn {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .add-comment-btn:hover {
    background: #b71c1c;
  }
  
  .add-story-btn-container {
    position: fixed;
    bottom: 30px;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: center;
    z-index: 10;
  }
  
  .add-story-btn {
    background: linear-gradient(135deg, var(--accent), #d32);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 15px 30px;
    font-size: 1.1rem;
    font-weight: 600;
    box-shadow: 0 5px 20px rgba(198,40,40,0.4);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 100;
  }
  
  .add-story-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(198,40,40,0.5);
  }
  
  .add-story-btn:active {
    transform: translateY(1px);
  }
  
  /* Story Modal */
  .story-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
  }
  
  .story-modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }
  
  .story-modal {
    background: white;
    border-radius: 20px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    transform: scale(0.9);
    transition: all 0.3s;
    position: relative;
  }
  
  .story-modal-overlay.active .story-modal {
    transform: scale(1);
  }
  
  .story-modal-header {
    padding: 25px 30px 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .story-modal-header h2 {
    margin: 0;
    color: var(--accent);
    font-size: 1.5rem;
  }
  
  .story-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #777;
    cursor: pointer;
    transition: color 0.3s;
  }
  
  .story-modal-close:hover {
    color: var(--accent);
  }
  
  .story-modal-body {
    padding: 20px 30px 30px;
  }
  
  .story-form-group {
    margin-bottom: 20px;
  }
  
  .story-form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
  }
  
  .story-form-input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s;
  }
  
  .story-form-input:focus {
    border-color: var(--accent);
    outline: none;
  }
  
  .story-form-textarea {
    min-height: 120px;
    resize: vertical;
  }
  
  .word-count {
    text-align: right;
    font-size: 0.85rem;
    color: #777;
    margin-top: 5px;
  }
  
  .word-count.warning {
    color: #e74c3c;
  }
  
  .upload-area-new {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 15px;
  }
  
  .upload-area-new:hover {
    border-color: var(--accent);
    background: rgba(198,40,40,0.03);
  }
  
  .upload-area-new i {
    font-size: 2.5rem;
    color: #ddd;
    margin-bottom: 10px;
    display: block;
  }
  
  .file-preview-new {
    margin-top: 15px;
    text-align: center;
  }
  
  .file-preview-new img {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    margin-bottom: 10px;
  }
  
  .file-preview-new video {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    margin-bottom: 10px;
  }
  
  .remove-file {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    font-size: 0.85rem;
    cursor: pointer;
  }
  
  .story-modal-footer {
    padding: 20px 30px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
  }
  
  .btn-post-story {
    background: linear-gradient(135deg, var(--accent), #d32);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 30px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .btn-post-story:hover {
    background: linear-gradient(135deg, #b71c1c, #c62828);
    transform: translateY(-2px);
  }
  
  .btn-post-story:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
  }
  
  /* Success Message */
  .success-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 10000;
    transform: translateX(150%);
    transition: transform 0.3s;
  }
  
  .success-message.show {
    transform: translateX(0);
  }
  
  .success-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
  }
  
  /* Note colors */
  .note-color-1 { background: #FFEAA7; }
  .note-color-2 { background: #D8BFD8; }
  .note-color-3 { background: #A5D6A7; }
  .note-color-4 { background: #81D4FA; }
  .note-color-5 { background: #FFCC80; }
  .note-color-6 { background: #F8BBD0; }
  .note-color-7 { background: #C5E1A5; }
  .note-color-8 { background: #B39DDB; }
  
  /* Analytics Dashboard */
  .analytics-dashboard {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  
  .stat-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    border-left: 4px solid var(--accent);
  }
  
  .stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 5px;
  }
  
  .stat-label {
    color: #666;
    font-size: 0.9rem;
  }
  
  .chart-container {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  /* Admin Panel */
  .admin-panel {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  
  .admin-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
  }
  
  .admin-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }
  
  .admin-controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }
  
  .data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  
  .data-table th,
  .data-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
  }
  
  .data-table th {
    background: #f8f9fa;
    font-weight: 600;
  }
  
  .data-table tr:hover {
    background: #f8f9fa;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .stories-hero h1 {
      font-size: 2.5rem;
    }
    
    .stories-hero p {
      font-size: 1.1rem;
    }
    
    .stories-wall-new {
      grid-template-columns: 1fr;
    }
    
    .story-modal {
      width: 95%;
    }
    
    .stat-card {
      margin-bottom: 15px;
    }
    
    .data-table {
      font-size: 0.85rem;
    }
    
    .data-table th,
    .data-table td {
      padding: 8px;
    }
  }
</style>
</head>
<body>
<div class="container container-main py-3">
  <!-- NAV / header -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex gap-3 align-items-center">
      <div class="logo">
        <i class="fas fa-map" style="color:white; font-size: 24px;"></i>
      </div>
      <div>
        <div style="font-weight:800;font-size:1.15rem">B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc</div>
        <div style="color:#666;font-size:0.9rem">D·ª± √°n KHKT - Gi√°o d·ª•c l√≤ng t·ª± h√†o d√¢n t·ªôc v√† t√¨nh y√™u qu√™ h∆∞∆°ng ƒë·∫•t n∆∞·ªõc cho tu·ªïi tr·∫ª tr∆∞·ªùng THPT An Th·ªõi</div>
      </div>
    </div>
    <div style="position:relative">
      <button id="nav-menu" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-bars me-1"></i>M·ª•c l·ª•c
      </button>
      <div class="menu-dropdown" id="menuDropdown">
        <div class="menu-item active" data-page="home">
          <i class="fas fa-home"></i>Trang ch·ªß
        </div>
        <div class="menu-item" data-page="map">
          <i class="fas fa-map-marked-alt"></i>B·∫£n ƒë·ªì s·ªë
        </div>
        <div class="menu-item" data-page="stories">
          <i class="fas fa-book-open"></i>PQ Stories
        </div>
        <div class="menu-item" data-page="profile">
          <i class="fas fa-user"></i>Trang c√° nh√¢n
        </div>
        <div class="menu-item" data-page="analytics">
          <i class="fas fa-chart-bar"></i>Th·ªëng k√™
        </div>
        <div class="menu-item" data-page="admin" id="adminMenuItem" style="display:none">
          <i class="fas fa-cog"></i>Qu·∫£n tr·ªã
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay khi menu m·ªü -->
  <div class="menu-overlay" id="menuOverlay"></div>

  <!-- HOME -->
  <section id="page-home">
    <div class="hero">
      <h1 style="margin:0;color:var(--accent)">B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc</h1>
      <p style="margin-top:10px;margin-bottom:8px; font-size: 1.1rem; line-height: 1.6;">
        <strong>H√†nh tr√¨nh v·ªÅ ngu·ªìn ch∆∞a bao gi·ªù s·ªëng ƒë·ªông v√† c·∫£m x√∫c ƒë·∫øn th·∫ø!</strong>
      </p>
      <p style="margin:0 0 6px 0;color:#444; line-height: 1.6">
        B·∫£n ƒê·ªì S·ªë Ph√∫ Qu·ªëc kh√¥ng ch·ªâ l√† m·ªôt website, ƒë√≥ l√† c√¢y c·∫ßu k·∫øt n·ªëi th·∫ø h·ªá tr·∫ª v·ªõi h√†nh tr√¨nh ƒë·∫ßy t·ª± h√†o c·ªßa cha √¥ng. Ch√∫ng t√¥i m·ªùi b·∫°n b∆∞·ªõc v√†o m·ªôt th·∫ø gi·ªõi n∆°i m·ªói di t√≠ch l√† m·ªôt c√¢u chuy·ªán ch·ªù ƒë∆∞·ª£c k·ªÉ, m·ªói nh√¢n v·∫≠t l·ªãch s·ª≠ l√† m·ªôt ng∆∞·ªùi h√πng ch·ªù ƒë∆∞·ª£c th·∫•u hi·ªÉu.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        T·∫°i ƒë√¢y, b·∫°n s·∫Ω:<br>
        ‚Ä¢ Ch·∫°m v√†o l·ªãch s·ª≠ b·∫±ng c·∫£m x√∫c ch√¢n th·∫≠t nh·∫•t.<br>
        ‚Ä¢ Kh√°m ph√° v·∫ª ƒë·∫πp c·ªßa qu√™ h∆∞∆°ng qua lƒÉng k√≠nh m·ªõi m·∫ª, tr·ª±c quan.<br>
        ‚Ä¢ R√®n luy·ªán t∆∞ duy ph·∫£n bi·ªán v√† k·ªπ nƒÉng k·ªÉ chuy·ªán ƒë·ªÉ tr·ªü th√†nh nh·ªØng ƒë·∫°i s·ª© vƒÉn h√≥a t∆∞∆°ng lai.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        H√£y ƒë·ªÉ ch√∫ng t√¥i ƒë·ªìng h√†nh c√πng b·∫°n tr√™n h√†nh tr√¨nh kh∆°i d·∫≠y l√≤ng t·ª± h√†o d√¢n t·ªôc v√† t√¨nh y√™u v·ªõi m·∫£nh ƒë·∫•t Ph√∫ Qu·ªëc anh h√πng.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        B·∫£n ƒë·ªì s·ªë l√† gi·∫£i ph√°p thu·ªôc khu√¥n kh·ªï d·ª± √°n khoa h·ªçc kƒ© thu·∫≠t "<strong>Gi√°o d·ª•c l√≤ng t·ª± h√†o d√¢n t·ªôc v√† t√¨nh y√™u qu√™ h∆∞∆°ng ƒë·∫•t n∆∞·ªõc cho tu·ªïi tr·∫ª THPT An Th·ªõi</strong>".
      </p>
      <div class="mt-3">
        <button id="btn-start" class="btn btn-accent btn-lg">B·∫Øt ƒë·∫ßu kh√°m ph√°</button>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-md-12">
        <div class="game-card">
          <h5>H∆∞·ªõng d·∫´n nhanh</h5>
          <ol style="padding-left:18px">
            <li>Nh·∫•n "B·∫Øt ƒë·∫ßu kh√°m ph√°" ƒë·ªÉ sang trang b·∫£n ƒë·ªì</li>
            <li>Click marker ƒë·ªÉ xem th√¥ng tin; n·∫øu c√≥ mini-game, b·∫•m "Ch∆°i"</li>
            <li>Truy c·∫≠p "PQ Stories" ƒë·ªÉ chia s·∫ª k√Ω ·ª©c c·ªßa b·∫°n</li>
            <li>V√†o "Trang c√° nh√¢n" ƒë·ªÉ xem th√†nh t√≠ch v√† huy hi·ªáu</li>
            <li>Xem "Th·ªëng k√™" ƒë·ªÉ theo d√µi ho·∫°t ƒë·ªông trang web</li>
            <li>N·∫øu l√† Admin, b·∫°n c√≥ th·ªÉ xem trang "Qu·∫£n tr·ªã" ƒë·ªÉ qu·∫£n l√Ω</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- MAP PAGE -->
  <section id="page-map" style="display:none">
    <div id="map" class="mb-3"></div>
  </section>

  <!-- PQ STORIES PAGE -->
  <section id="page-stories" style="display:none">
    <div class="stories-hero">
      <h1>PQ Stories</h1>
      <p>N∆°i b·∫°n chia s·∫ª v√† lan to·∫£ nh·ªØng c√¢u chuy·ªán ƒë·∫πp v·ªÅ Ph√∫ Qu·ªëc</p>
    </div>
    
    <div class="stories-wall-container">
      <div class="stories-wall-new" id="storiesWallNew">
        <!-- Stories will be dynamically added here -->
      </div>
    </div>
    
    <div class="add-story-btn-container">
      <button class="add-story-btn" id="addStoryBtn">
        <i class="fas fa-plus"></i>
        K·ªÉ c√¢u chuy·ªán c·ªßa ri√™ng b·∫°n t·∫°i ƒë√¢y
      </button>
    </div>
  </section>

  <!-- PROFILE PAGE -->
  <section id="page-profile" style="display:none">
    <div class="profile-container">
      <div class="profile-header">
        <h2>Trang C√° Nh√¢n</h2>
        <p class="mb-0">Qu·∫£n l√Ω t√†i kho·∫£n v√† xem th√†nh t√≠ch c·ªßa b·∫°n</p>
      </div>
      <div class="profile-auth">
        <h4 class="mb-3">T√†i kho·∫£n</h4>
        <div id="profile-info" class="alert alert-info">
          B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u ti·∫øn tr√¨nh v√† nh·∫≠n huy hi·ªáu.
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button id="btn-profile-register" class="btn btn-outline-dark">ƒêƒÉng k√Ω</button>
          <button id="btn-profile-login" class="btn btn-dark">ƒêƒÉng nh·∫≠p</button>
          <button id="btn-profile-logout" class="btn btn-outline-secondary" style="display:none">ƒêƒÉng xu·∫•t</button>
        </div>
      </div>
      <div class="profile-badges">
        <h4 class="mb-3">Huy hi·ªáu c·ªßa b·∫°n</h4>
        <div style="color:#666;font-size:0.9rem" class="mb-3">Khi ho√†n th√†nh c√°c ƒëi·ªÅu ki·ªán, huy hi·ªáu s·∫Ω hi·ªán ·ªü ƒë√¢y.</div>
        <div id="profile-badge-area" class="d-flex gap-3 flex-wrap justify-content-center">
          <!-- Badges will appear here -->
        </div>
      </div>
    </div>
  </section>

  <!-- ANALYTICS PAGE -->
  <section id="page-analytics" style="display:none">
    <div class="profile-container">
      <div class="profile-header">
        <h2>Th·ªëng k√™ & Ph√¢n t√≠ch</h2>
        <p class="mb-0">Theo d√µi ho·∫°t ƒë·ªông v√† t∆∞∆°ng t√°c tr√™n trang web</p>
      </div>
      
      <div class="analytics-dashboard">
        <h4 class="mb-4">T·ªïng quan ho·∫°t ƒë·ªông</h4>
        
        <div class="row">
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div class="stat-number" id="totalVisitors">0</div>
              <div class="stat-label">T·ªïng l∆∞·ª£t truy c·∫≠p</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div class="stat-number" id="uniqueVisitors">0</div>
              <div class="stat-label">Ng∆∞·ªùi d√πng duy nh·∫•t</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div class="stat-number" id="registeredUsers">0</div>
              <div class="stat-label">Ng∆∞·ªùi d√πng ƒëƒÉng k√Ω</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div class="stat-number" id="totalStories">0</div>
              <div class="stat-label">C√¢u chuy·ªán ƒë√£ ƒëƒÉng</div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="chart-container">
              <h5>L∆∞·ª£t truy c·∫≠p theo trang</h5>
              <div id="pageViewsChart">
                <!-- Chart will be rendered here -->
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="chart-container">
              <h5>Thi·∫øt b·ªã truy c·∫≠p</h5>
              <div id="deviceChart">
                <!-- Chart will be rendered here -->
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-12">
            <div class="chart-container">
              <h5>Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h5>
              <div id="recentActivity">
                <!-- Recent activity will be shown here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ADMIN PAGE -->
  <section id="page-admin" style="display:none">
    <div class="profile-container">
      <div class="profile-header">
        <h2>Trang Qu·∫£n Tr·ªã</h2>
        <p class="mb-0">Qu·∫£n l√Ω v√† theo d√µi to√†n b·ªô h·ªá th·ªëng</p>
      </div>
      
      <div class="admin-panel">
        <div class="admin-section">
          <h4 class="mb-3">T·ªïng quan h·ªá th·ªëng</h4>
          <div class="row">
            <div class="col-md-3 col-6 mb-3">
              <div class="stat-card">
                <div class="stat-number" id="adminTotalUsers">0</div>
                <div class="stat-label">T·ªïng ng∆∞·ªùi d√πng</div>
              </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="stat-card">
                <div class="stat-number" id="adminActiveUsers">0</div>
                <div class="stat-label">Ng∆∞·ªùi d√πng ho·∫°t ƒë·ªông (7 ng√†y)</div>
              </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="stat-card">
                <div class="stat-number" id="adminTotalStories">0</div>
                <div class="stat-label">T·ªïng c√¢u chuy·ªán</div>
              </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="stat-card">
                <div class="stat-number" id="adminTotalGames">0</div>
                <div class="stat-label">T·ªïng l∆∞·ª£t ch∆°i game</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="admin-section">
          <h4 class="mb-3">Th·ªëng k√™ chi ti·∫øt</h4>
          <div class="admin-controls">
            <button class="btn btn-admin" onclick="loadUserStats()">Th·ªëng k√™ ng∆∞·ªùi d√πng</button>
            <button class="btn btn-admin" onclick="loadStoryStats()">Th·ªëng k√™ c√¢u chuy·ªán</button>
            <button class="btn btn-admin" onclick="loadGameStats()">Th·ªëng k√™ game</button>
            <button class="btn btn-admin" onclick="exportData()">Xu·∫•t d·ªØ li·ªáu</button>
          </div>
          
          <div id="adminDataView">
            <p class="text-muted">Ch·ªçn m·ªôt t√πy ch·ªçn ƒë·ªÉ xem d·ªØ li·ªáu chi ti·∫øt</p>
          </div>
        </div>
        
        <div class="admin-section">
          <h4 class="mb-3">Qu·∫£n l√Ω n·ªôi dung</h4>
          <div class="admin-controls">
            <button class="btn btn-outline-danger" onclick="clearAllData()">X√≥a t·∫•t c·∫£ d·ªØ li·ªáu</button>
            <button class="btn btn-outline-warning" onclick="resetAnalytics()">Reset th·ªëng k√™</button>
          </div>
          <div class="alert alert-warning mt-3">
            <strong>C·∫£nh b√°o:</strong> C√°c thao t√°c qu·∫£n l√Ω n·ªôi dung kh√¥ng th·ªÉ ho√†n t√°c. H√£y ch·∫Øc ch·∫Øn tr∆∞·ªõc khi th·ª±c hi·ªán.
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer>
    ¬© D·ª± √°n KHKT ‚Äî THPT An Th·ªõi ‚Äî Mi·ªÖn ph√≠
  </footer>
</div>

<!-- Story Modal -->
<div class="story-modal-overlay" id="storyModalOverlay">
  <div class="story-modal">
    <div class="story-modal-header">
      <h2>Chia s·∫ª c√¢u chuy·ªán c·ªßa b·∫°n</h2>
      <button class="story-modal-close" id="storyModalClose">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="story-modal-body">
      <form id="storyFormNew">
        <div class="story-form-group">
          <label for="storyTitleNew">Ti√™u ƒë·ªÅ c√¢u chuy·ªán</label>
          <input type="text" class="story-form-input" id="storyTitleNew" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ h·∫•p d·∫´n...">
        </div>
        
        <div class="story-form-group">
          <label for="storyContentNew">K·ªÉ cho m·ªçi ng∆∞·ªùi nghe c√¢u chuy·ªán c·ªßa b·∫°n</label>
          <textarea class="story-form-input story-form-textarea" id="storyContentNew" placeholder="Chia s·∫ª c√¢u chuy·ªán ƒë√°ng nh·ªõ c·ªßa b·∫°n v·ªÅ Ph√∫ Qu·ªëc... (gi·ªõi h·∫°n 200 t·ª´)"></textarea>
          <div class="word-count" id="wordCount">0/200 t·ª´</div>
        </div>
        
        <div class="story-form-group">
          <label>Th√™m h√¨nh ·∫£nh, video ho·∫∑c √¢m thanh</label>
          <div class="upload-area-new" id="uploadAreaNew">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</p>
            <p class="text-muted" style="font-size: 0.9rem; margin-top: 5px;">H·ªó tr·ª£: ·∫£nh, video, √¢m thanh</p>
            <input type="file" id="fileInputNew" accept="image/*,video/*,audio/*" style="display:none">
          </div>
          <div id="filePreviewNew" class="file-preview-new" style="display:none">
            <!-- Preview will be shown here -->
          </div>
        </div>
      </form>
    </div>
    <div class="story-modal-footer">
      <button class="btn-post-story" id="btnPostStory">ƒêƒÉng story</button>
    </div>
  </div>
</div>

<!-- Success Message -->
<div class="success-message" id="successMessage">
  <i class="fas fa-check-circle"></i>
  <span>B·∫°n ƒë√£ ƒëƒÉng t·∫£i th√†nh c√¥ng c√¢u chuy·ªán c·ªßa m√¨nh</span>
  <button class="success-close" id="successClose">
    <i class="fas fa-times"></i>
  </button>
</div>

<!-- C√°c modal v√† popup kh√°c gi·ªØ nguy√™n -->
<!-- DI T√çCH MODAL -->
<div class="modal fade" id="diModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background:linear-gradient(90deg,var(--accent),#d32);color:white">
        <h5 class="modal-title" id="diTitle"></h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="diBody"></div>
      <div class="modal-footer">
        <div class="me-auto">
          <small class="text-muted">To·∫° ƒë·ªô: <span id="diCoords"></span></small>
        </div>
        <button id="btn-checkin" class="btn btn-outline-success">Check-in (T√¥i ƒë√£ ƒë·∫øn)</button>
        <button id="btn-play" class="btn btn-accent" style="display:none">Ch∆°i mini-game</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>

<!-- GAME FULLSCREEN MODE -->
<div id="gameFullscreen" class="game-fullscreen">
  <div class="game-fullscreen-header">
    <h2 class="game-fullscreen-title" id="gameFullscreenTitle">Mini-game</h2>
    <button class="game-fullscreen-close" id="gameFullscreenClose">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="game-fullscreen-body" id="gameFullscreenBody">
    <!-- N·ªôi dung game s·∫Ω ƒë∆∞·ª£c ƒë·∫∑t ·ªü ƒë√¢y -->
  </div>
</div>

<!-- VICTORY POPUP -->
<div id="victoryPopup" class="victory-popup" style="display:none">
  <div class="victory-content">
    <div class="victory-title">üéâ Chi·∫øn Th·∫Øng!</div>
    <div class="victory-message" id="victoryMessage">B·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc th·ª≠ th√°ch!</div>
    <button id="victoryClose" class="btn btn-accent btn-lg">Tuy·ªát v·ªùi!</button>
  </div>
</div>

<!-- AUTH modal -->
<div class="modal fade" id="authModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="authTitle">ƒêƒÉng k√Ω</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="authAlert" class="alert alert-danger d-none"></div>
        <input id="inName" class="form-control mb-2" placeholder="T√™n hi·ªÉn th·ªã">
        <input id="inEmail" class="form-control mb-2" placeholder="Email">
        <input id="inPass" type="password" class="form-control mb-2" placeholder="M·∫≠t kh·∫©u">
        <div class="form-text">ƒêƒÉng k√Ω t√†i kho·∫£n ƒë·ªÉ l∆∞u ti·∫øn tr√¨nh v√† nh·∫≠n huy hi·ªáu.</div>
      </div>
      <div class="modal-footer">
        <button id="authSubmit" class="btn btn-dark">X√°c nh·∫≠n</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">H·ªßy</button>
      </div>
    </div>
  </div>
</div>

<!-- Badge Popup Modal -->
<div id="badgePopup" class="badge-popup" style="display:none">
  <div class="badge-popup-content">
    <img id="badgePopupImg" src="" class="badge-popup-img" alt="Huy hi·ªáu">
    <div id="badgePopupTitle" class="badge-popup-title"></div>
    <div id="badgePopupMessage" class="badge-popup-message">Ch√∫c m·ª´ng! B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c huy hi·ªáu</div>
    <button id="badgePopupClose" class="btn btn-accent">Tuy·ªát v·ªùi!</button>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyD4uqxvZ0prim27JWYp27TvKgYHow_2a_4",
  authDomain: "phuquoc-56ceb.firebaseapp.com",
  projectId: "phuquoc-56ceb",
  storageBucket: "phuquoc-56ceb.firebasestorage.app",
  messagingSenderId: "803288687572",
  appId: "1:803288687572:web:4083ecb07af53fad17ec41",
  measurementId: "G-301FVWD1PJ"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const analytics = firebase.analytics();
const auth = firebase.auth();
const db = firebase.firestore();

// Bi·∫øn to√†n c·ª•c
let currentPage = 'home';
let stories = [];
let currentUser = null;
let isAdmin = false;

/* ---------------------------
  FIREBASE AUTHENTICATION
----------------------------*/

// Theo d√µi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
auth.onAuthStateChanged((user) => {
  currentUser = user;
  
  if (user) {
    // Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p
    console.log('User logged in:', user.email);
    
    // Ki·ªÉm tra xem c√≥ ph·∫£i admin kh√¥ng
    checkIfAdmin(user.email);
    
    // C·∫≠p nh·∫≠t UI
    refreshProfileAuthUI();
    
    // Ghi nh·∫≠n s·ª± ki·ªán ƒëƒÉng nh·∫≠p
    analytics.logEvent('login', {
      email: user.email,
      method: 'email'
    });
  } else {
    // Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng xu·∫•t
    console.log('User logged out');
    isAdmin = false;
    document.getElementById('adminMenuItem').style.display = 'none';
    refreshProfileAuthUI();
  }
});

// Ki·ªÉm tra admin
function checkIfAdmin(email) {
  // Danh s√°ch email admin (c√≥ th·ªÉ l∆∞u trong Firestore)
  const adminEmails = ['admin@phuquoc.edu.vn', 'quantri@phuquoc.edu.vn'];
  
  if (adminEmails.includes(email)) {
    isAdmin = true;
    document.getElementById('adminMenuItem').style.display = 'block';
    
    // Ghi nh·∫≠n s·ª± ki·ªán admin
    analytics.logEvent('admin_access', {
      email: email
    });
  }
}

// ƒêƒÉng k√Ω v·ªõi email/password
async function registerWithEmail(name, email, password) {
  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const user = userCredential.user;
    
    // C·∫≠p nh·∫≠t profile
    await user.updateProfile({
      displayName: name
    });
    
    // L∆∞u th√¥ng tin b·ªï sung v√†o Firestore
    await db.collection('users').doc(user.uid).set({
      name: name,
      email: email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      badges: [],
      visitedSites: [],
      completedGames: {},
      role: 'user'
    });
    
    analytics.logEvent('sign_up', {
      method: 'email'
    });
    
    return { success: true, user: user };
  } catch (error) {
    console.error('Registration error:', error);
    return { success: false, message: error.message };
  }
}

// ƒêƒÉng nh·∫≠p v·ªõi email/password
async function loginWithEmail(email, password) {
  try {
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    const user = userCredential.user;
    
    analytics.logEvent('login', {
      method: 'email'
    });
    
    return { success: true, user: user };
  } catch (error) {
    console.error('Login error:', error);
    return { success: false, message: error.message };
  }
}

// ƒêƒÉng nh·∫≠p v·ªõi Google
async function signInWithGoogle() {
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    const userCredential = await auth.signInWithPopup(provider);
    const user = userCredential.user;
    
    // Ki·ªÉm tra xem user ƒë√£ t·ªìn t·∫°i trong Firestore ch∆∞a
    const userDoc = await db.collection('users').doc(user.uid).get();
    
    if (!userDoc.exists) {
      // T·∫°o user m·ªõi trong Firestore
      await db.collection('users').doc(user.uid).set({
        name: user.displayName,
        email: user.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        badges: [],
        visitedSites: [],
        completedGames: {},
        role: 'user'
      });
      
      analytics.logEvent('sign_up', {
        method: 'google'
      });
    }
    
    analytics.logEvent('login', {
      method: 'google'
    });
    
    return { success: true, user: user };
  } catch (error) {
    console.error('Google sign in error:', error);
    return { success: false, message: error.message };
  }
}

// ƒêƒÉng xu·∫•t
async function signOutUser() {
  try {
    await auth.signOut();
    analytics.logEvent('logout');
    return { success: true };
  } catch (error) {
    console.error('Sign out error:', error);
    return { success: false, message: error.message };
  }
}

// L·∫•y th√¥ng tin user t·ª´ Firestore
async function getUserData(uid) {
  try {
    const userDoc = await db.collection('users').doc(uid).get();
    if (userDoc.exists) {
      return userDoc.data();
    }
    return null;
  } catch (error) {
    console.error('Error getting user data:', error);
    return null;
  }
}

// C·∫≠p nh·∫≠t th√¥ng tin user trong Firestore
async function updateUserData(uid, data) {
  try {
    await db.collection('users').doc(uid).update(data);
    return true;
  } catch (error) {
    console.error('Error updating user data:', error);
    return false;
  }
}

/* ---------------------------
  FIREBASE ANALYTICS & FIRESTORE
----------------------------*/

// Ghi nh·∫≠n l∆∞·ª£t truy c·∫≠p trang
function recordPageView(page) {
  analytics.logEvent('page_view', {
    page: page
  });
  
  // L∆∞u v√†o Firestore ƒë·ªÉ ph√¢n t√≠ch chi ti·∫øt
  if (currentUser) {
    db.collection('page_views').add({
      userId: currentUser.uid,
      page: page,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      userAgent: navigator.userAgent
    });
  }
}

// Ghi nh·∫≠n s·ª± ki·ªán check-in
async function recordCheckIn(siteId, siteName) {
  analytics.logEvent('check_in', {
    site_id: siteId,
    site_name: siteName
  });
  
  if (currentUser) {
    await db.collection('check_ins').add({
      userId: currentUser.uid,
      siteId: siteId,
      siteName: siteName,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // C·∫≠p nh·∫≠t user data
    const userData = await getUserData(currentUser.uid);
    if (userData) {
      const visitedSites = userData.visitedSites || [];
      if (!visitedSites.includes(siteId)) {
        visitedSites.push(siteId);
        await updateUserData(currentUser.uid, { visitedSites: visitedSites });
      }
    }
  }
}

// Ghi nh·∫≠n ho√†n th√†nh game
async function recordGameCompletion(siteId, gameId) {
  analytics.logEvent('game_complete', {
    site_id: siteId,
    game_id: gameId
  });
  
  if (currentUser) {
    await db.collection('game_completions').add({
      userId: currentUser.uid,
      siteId: siteId,
      gameId: gameId,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // C·∫≠p nh·∫≠t user data
    const userData = await getUserData(currentUser.uid);
    if (userData) {
      const completedGames = userData.completedGames || {};
      if (!completedGames[siteId]) {
        completedGames[siteId] = [];
      }
      if (!completedGames[siteId].includes(gameId)) {
        completedGames[siteId].push(gameId);
        await updateUserData(currentUser.uid, { completedGames: completedGames });
      }
    }
  }
}

// Ghi nh·∫≠n ƒëƒÉng story
async function recordStoryPost(storyId, title) {
  analytics.logEvent('story_post', {
    story_id: storyId,
    title: title
  });
  
  if (currentUser) {
    await db.collection('story_posts').add({
      userId: currentUser.uid,
      storyId: storyId,
      title: title,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
}

/* ---------------------------
  ADMIN FUNCTIONS
----------------------------*/

// T·∫£i th·ªëng k√™ ng∆∞·ªùi d√πng
async function loadUserStats() {
  try {
    const usersSnapshot = await db.collection('users').get();
    const pageViewsSnapshot = await db.collection('page_views')
      .where('timestamp', '>=', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000))
      .get();
    
    const users = [];
    const activeUserIds = new Set();
    
    pageViewsSnapshot.forEach(doc => {
      activeUserIds.add(doc.data().userId);
    });
    
    usersSnapshot.forEach(doc => {
      users.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    const html = `
      <h5>Th·ªëng k√™ ng∆∞·ªùi d√πng</h5>
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>T√™n</th>
              <th>Email</th>
              <th>Ng√†y t·∫°o</th>
              <th>ƒê·ªãa ƒëi·ªÉm ƒë√£ thƒÉm</th>
              <th>Game ƒë√£ ho√†n th√†nh</th>
              <th>Tr·∫°ng th√°i</th>
            </tr>
          </thead>
          <tbody>
            ${users.map(user => `
              <tr>
                <td>${user.name || 'N/A'}</td>
                <td>${user.email || 'N/A'}</td>
                <td>${user.createdAt ? user.createdAt.toDate().toLocaleDateString('vi-VN') : 'N/A'}</td>
                <td>${(user.visitedSites || []).length}</td>
                <td>${Object.values(user.completedGames || {}).reduce((acc, games) => acc + games.length, 0)}</td>
                <td><span class="badge ${activeUserIds.has(user.id) ? 'bg-success' : 'bg-secondary'}">${activeUserIds.has(user.id) ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
      <div class="mt-3">
        <p><strong>T·ªïng s·ªë:</strong> ${users.length} ng∆∞·ªùi d√πng</p>
        <p><strong>ƒêang ho·∫°t ƒë·ªông (7 ng√†y):</strong> ${activeUserIds.size} ng∆∞·ªùi d√πng</p>
      </div>
    `;
    
    document.getElementById('adminDataView').innerHTML = html;
  } catch (error) {
    console.error('Error loading user stats:', error);
    document.getElementById('adminDataView').innerHTML = '<div class="alert alert-danger">L·ªói khi t·∫£i th·ªëng k√™ ng∆∞·ªùi d√πng</div>';
  }
}

// T·∫£i th·ªëng k√™ c√¢u chuy·ªán
async function loadStoryStats() {
  try {
    const storiesSnapshot = await db.collection('stories').orderBy('timestamp', 'desc').get();
    const stories = [];
    
    storiesSnapshot.forEach(doc => {
      stories.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    const html = `
      <h5>Th·ªëng k√™ c√¢u chuy·ªán</h5>
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Ti√™u ƒë·ªÅ</th>
              <th>T√°c gi·∫£</th>
              <th>Ng√†y ƒëƒÉng</th>
              <th>L∆∞·ª£t th√≠ch</th>
              <th>B√¨nh lu·∫≠n</th>
            </tr>
          </thead>
          <tbody>
            ${stories.map(story => `
              <tr>
                <td>${story.title}</td>
                <td>${story.author}</td>
                <td>${story.timestamp ? story.timestamp.toDate().toLocaleDateString('vi-VN') : 'N/A'}</td>
                <td>${story.likes || 0}</td>
                <td>${(story.comments || []).length}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
      <div class="mt-3">
        <p><strong>T·ªïng s·ªë:</strong> ${stories.length} c√¢u chuy·ªán</p>
      </div>
    `;
    
    document.getElementById('adminDataView').innerHTML = html;
  } catch (error) {
    console.error('Error loading story stats:', error);
    document.getElementById('adminDataView').innerHTML = '<div class="alert alert-danger">L·ªói khi t·∫£i th·ªëng k√™ c√¢u chuy·ªán</div>';
  }
}

// T·∫£i th·ªëng k√™ game
async function loadGameStats() {
  try {
    const gameCompletionsSnapshot = await db.collection('game_completions').get();
    const checkInsSnapshot = await db.collection('check_ins').get();
    
    const gameStats = {};
    const siteStats = {};
    
    gameCompletionsSnapshot.forEach(doc => {
      const data = doc.data();
      if (!gameStats[data.gameId]) {
        gameStats[data.gameId] = 0;
      }
      gameStats[data.gameId]++;
    });
    
    checkInsSnapshot.forEach(doc => {
      const data = doc.data();
      if (!siteStats[data.siteId]) {
        siteStats[data.siteId] = 0;
      }
      siteStats[data.siteId]++;
    });
    
    const html = `
      <h5>Th·ªëng k√™ game v√† check-in</h5>
      <div class="row">
        <div class="col-md-6">
          <h6>Th·ªëng k√™ game</h6>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Game ID</th>
                  <th>S·ªë l∆∞·ª£t ho√†n th√†nh</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(gameStats).map(([gameId, count]) => `
                  <tr>
                    <td>${gameId}</td>
                    <td>${count}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
        <div class="col-md-6">
          <h6>Th·ªëng k√™ check-in</h6>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ƒê·ªãa ƒëi·ªÉm ID</th>
                  <th>S·ªë l∆∞·ª£t check-in</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(siteStats).map(([siteId, count]) => `
                  <tr>
                    <td>${siteId}</td>
                    <td>${count}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="mt-3">
        <p><strong>T·ªïng l∆∞·ª£t ch∆°i game:</strong> ${Object.values(gameStats).reduce((acc, count) => acc + count, 0)}</p>
        <p><strong>T·ªïng l∆∞·ª£t check-in:</strong> ${Object.values(siteStats).reduce((acc, count) => acc + count, 0)}</p>
      </div>
    `;
    
    document.getElementById('adminDataView').innerHTML = html;
  } catch (error) {
    console.error('Error loading game stats:', error);
    document.getElementById('adminDataView').innerHTML = '<div class="alert alert-danger">L·ªói khi t·∫£i th·ªëng k√™ game</div>';
  }
}

// Xu·∫•t d·ªØ li·ªáu
async function exportData() {
  try {
    // Thu th·∫≠p t·∫•t c·∫£ d·ªØ li·ªáu
    const [usersSnapshot, storiesSnapshot, gameCompletionsSnapshot, checkInsSnapshot, pageViewsSnapshot] = await Promise.all([
      db.collection('users').get(),
      db.collection('stories').get(),
      db.collection('game_completions').get(),
      db.collection('check_ins').get(),
      db.collection('page_views').get()
    ]);
    
    const data = {
      users: usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
      stories: storiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
      gameCompletions: gameCompletionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
      checkIns: checkInsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
      pageViews: pageViewsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
      exportDate: new Date().toISOString()
    };
    
    // T·∫°o file JSON v√† t·∫£i v·ªÅ
    const dataStr = JSON.stringify(data, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `phuquoc_data_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    document.getElementById('adminDataView').innerHTML = '<div class="alert alert-success">ƒê√£ xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng!</div>';
  } catch (error) {
    console.error('Error exporting data:', error);
    document.getElementById('adminDataView').innerHTML = '<div class="alert alert-danger">L·ªói khi xu·∫•t d·ªØ li·ªáu</div>';
  }
}

// X√≥a t·∫•t c·∫£ d·ªØ li·ªáu (ch·ªâ d√πng cho m·ª•c ƒë√≠ch ph√°t tri·ªÉn)
async function clearAllData() {
  if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ d·ªØ li·ªáu? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
    return;
  }
  
  try {
    // X√≥a t·∫•t c·∫£ collections
    const collections = ['users', 'stories', 'game_completions', 'check_ins', 'page_views'];
    
    for (const collection of collections) {
      const snapshot = await db.collection(collection).get();
      const batch = db.batch();
      snapshot.docs.forEach(doc => {
        batch.delete(doc.ref);
      });
      await batch.commit();
    }
    
    document.getElementById('adminDataView').innerHTML = '<div class="alert alert-success">ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu th√†nh c√¥ng!</div>';
  } catch (error) {
    console.error('Error clearing data:', error);
    document.getElementById('adminDataView').innerHTML = '<div class="alert alert-danger">L·ªói khi x√≥a d·ªØ li·ªáu</div>';
  }
}

// Reset th·ªëng k√™
function resetAnalytics() {
  if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset th·ªëng k√™?')) {
    return;
  }
  
  // Reset analytics local storage
  localStorage.removeItem('pq_analytics_v1');
  localStorage.removeItem('pq_visitor_id');
  
  document.getElementById('adminDataView').innerHTML = '<div class="alert alert-success">ƒê√£ reset th·ªëng k√™ th√†nh c√¥ng!</div>';
}

/* ---------------------------
  C·∫¨P NH·∫¨T C√ÅC H√ÄM HI·ªÜN C√ì ƒê·ªÇ S·ª¨ D·ª§NG FIREBASE
----------------------------*/

// C·∫≠p nh·∫≠t h√†m refreshProfileAuthUI
function refreshProfileAuthUI() {
  const profileInfo = document.getElementById('profile-info');
  const btnLogin = document.getElementById('btn-profile-login');
  const btnRegister = document.getElementById('btn-profile-register');
  const btnLogout = document.getElementById('btn-profile-logout');
  
  if (currentUser) {
    btnLogin.style.display = 'none';
    btnRegister.style.display = 'none';
    btnLogout.style.display = 'inline-block';
    profileInfo.innerHTML = `Xin ch√†o <strong>${currentUser.displayName || currentUser.email}</strong>`;
    profileInfo.className = 'alert alert-success';
    
    // Load user badges t·ª´ Firestore
    loadUserBadges();
  } else {
    btnLogin.style.display = 'inline-block';
    btnRegister.style.display = 'inline-block';
    btnLogout.style.display = 'none';
    profileInfo.innerHTML = 'B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u ti·∫øn tr√¨nh v√† nh·∫≠n huy hi·ªáu.';
    profileInfo.className = 'alert alert-info';
    renderProfileBadges();
  }
}

// C·∫≠p nh·∫≠t h√†m loadUserBadges
async function loadUserBadges() {
  if (!currentUser) return;
  
  try {
    const userData = await getUserData(currentUser.uid);
    if (userData && userData.badges) {
      renderUserBadges(userData.badges);
    } else {
      document.getElementById('profile-badge-area').innerHTML = '<div class="text-muted">Ch∆∞a c√≥ huy hi·ªáu n√†o. H√£y kh√°m ph√° c√°c ƒë·ªãa ƒëi·ªÉm v√† ho√†n th√†nh th·ª≠ th√°ch!</div>';
    }
  } catch (error) {
    console.error('Error loading user badges:', error);
  }
}

// C·∫≠p nh·∫≠t h√†m awardBadge
async function awardBadge(id, name, icon) {
  if (!currentUser) return false;
  
  try {
    const userData = await getUserData(currentUser.uid);
    const badges = userData.badges || [];
    
    if (badges.find(b => b.id === id)) return false;
    
    badges.push({ id, name, icon });
    await updateUserData(currentUser.uid, { badges });
    
    // Hi·ªÉn th·ªã popup huy hi·ªáu
    showBadgePopup(name, icon);
    
    // Ghi nh·∫≠n s·ª± ki·ªán nh·∫≠n huy hi·ªáu
    analytics.logEvent('badge_earned', {
      badge_id: id,
      badge_name: name
    });
    
    return true;
  } catch (error) {
    console.error('Error awarding badge:', error);
    return false;
  }
}

// C·∫≠p nh·∫≠t h√†m markVisited
async function markVisited(siteId) {
  if (!currentUser) return;
  
  try {
    await recordCheckIn(siteId, DI_TICH.find(p => p.id === siteId)?.name || siteId);
  } catch (error) {
    console.error('Error marking visited:', error);
  }
}

// C·∫≠p nh·∫≠t h√†m recordDone
async function recordDone(siteId, gameId) {
  if (!currentUser) return;
  
  try {
    await recordGameCompletion(siteId, gameId);
  } catch (error) {
    console.error('Error recording game completion:', error);
  }
}

/* ---------------------------
  C√ÅC H√ÄM KH·ªûI T·∫†O V√Ä C·∫§U H√åNH
----------------------------*/

// Kh·ªüi t·∫°o d·ªØ li·ªáu
function initData() {
  // Ghi nh·∫≠n l∆∞·ª£t truy c·∫≠p ƒë·∫ßu ti√™n
  analytics.logEvent('session_start');
  
  // T·∫£i stories t·ª´ Firestore
  loadStoriesFromFirestore();
  
  // C·∫≠p nh·∫≠t admin panel n·∫øu l√† admin
  if (isAdmin) {
    updateAdminPanel();
  }
}

// T·∫£i stories t·ª´ Firestore
async function loadStoriesFromFirestore() {
  try {
    const snapshot = await db.collection('stories')
      .orderBy('timestamp', 'desc')
      .limit(50)
      .get();
    
    stories = [];
    snapshot.forEach(doc => {
      stories.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    renderStories();
  } catch (error) {
    console.error('Error loading stories:', error);
    // Fallback to localStorage n·∫øu c√≥ l·ªói
    loadStoriesFromLocalStorage();
  }
}

// Fallback: t·∫£i stories t·ª´ localStorage
function loadStoriesFromLocalStorage() {
  const savedStories = localStorage.getItem('pq_stories');
  if (savedStories) {
    stories = JSON.parse(savedStories);
  }
  renderStories();
}

// L∆∞u story m·ªõi v√†o Firestore
async function saveStoryToFirestore(story) {
  try {
    const docRef = await db.collection('stories').add({
      ...story,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Ghi nh·∫≠n s·ª± ki·ªán ƒëƒÉng story
    await recordStoryPost(docRef.id, story.title);
    
    return true;
  } catch (error) {
    console.error('Error saving story to Firestore:', error);
    // Fallback to localStorage
    return saveStoryToLocalStorage(story);
  }
}

// Fallback: l∆∞u story v√†o localStorage
function saveStoryToLocalStorage(story) {
  try {
    stories.unshift(story);
    localStorage.setItem('pq_stories', JSON.stringify(stories));
    return true;
  } catch (error) {
    console.error('Error saving story to localStorage:', error);
    return false;
  }
}

// C·∫≠p nh·∫≠t admin panel
async function updateAdminPanel() {
  if (!isAdmin) return;
  
  try {
    const [usersSnapshot, storiesSnapshot, gameCompletionsSnapshot] = await Promise.all([
      db.collection('users').get(),
      db.collection('stories').get(),
      db.collection('game_completions').get()
    ]);
    
    const activeUsersSnapshot = await db.collection('page_views')
      .where('timestamp', '>=', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000))
      .get();
    
    const activeUserIds = new Set();
    activeUsersSnapshot.forEach(doc => {
      activeUserIds.add(doc.data().userId);
    });
    
    document.getElementById('adminTotalUsers').textContent = usersSnapshot.size;
    document.getElementById('adminActiveUsers').textContent = activeUserIds.size;
    document.getElementById('adminTotalStories').textContent = storiesSnapshot.size;
    document.getElementById('adminTotalGames').textContent = gameCompletionsSnapshot.size;
  } catch (error) {
    console.error('Error updating admin panel:', error);
  }
}

/* ---------------------------
  C√ÅC H√ÄM KH√ÅC GI·ªÆ NGUY√äN
----------------------------*/

// ... (gi·ªØ nguy√™n t·∫•t c·∫£ c√°c h√†m kh√°c t·ª´ code c≈© nh∆∞:
// Menu Navigation, Map functions, Game functions, Story functions, etc.)
// Ch·ªâ c·∫ßn thay th·∫ø c√°c h√†m li√™n quan ƒë·∫øn authentication v√† data storage b·∫±ng phi√™n b·∫£n Firebase

// Kh·ªüi t·∫°o ·ª©ng d·ª•ng
document.addEventListener('DOMContentLoaded', function() {
  initData();
  
  // Th√™m s·ª± ki·ªán cho n√∫t ƒëƒÉng nh·∫≠p Google
  document.getElementById('btn-google-login').addEventListener('click', async () => {
    const result = await signInWithGoogle();
    if (result.success) {
      alert('ƒêƒÉng nh·∫≠p v·ªõi Google th√†nh c√¥ng!');
    } else {
      alert('L·ªói ƒëƒÉng nh·∫≠p Google: ' + result.message);
    }
  });
  
  // C·∫≠p nh·∫≠t s·ª± ki·ªán cho form ƒëƒÉng k√Ω/ƒëƒÉng nh·∫≠p
  document.getElementById('authSubmit').addEventListener('click', async function() {
    const name = document.getElementById('inName').value.trim();
    const email = document.getElementById('inEmail').value.trim();
    const password = document.getElementById('inPass').value;
    const isRegister = document.getElementById('authTitle').innerText === 'ƒêƒÉng k√Ω';
    
    if (isRegister) {
      if (!name || !email || !password) {
        showAuthError('ƒêi·ªÅn ƒë·ªß t√™n, email, m·∫≠t kh·∫©u');
        return;
      }
      
      const result = await registerWithEmail(name, email, password);
      if (result.success) {
        authModal.hide();
        alert('ƒêƒÉng k√Ω th√†nh c√¥ng!');
      } else {
        showAuthError(result.message);
      }
    } else {
      if (!email || !password) {
        showAuthError('ƒêi·ªÅn ƒë·ªß email v√† m·∫≠t kh·∫©u');
        return;
      }
      
      const result = await loginWithEmail(email, password);
      if (result.success) {
        authModal.hide();
        alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
      } else {
        showAuthError(result.message);
      }
    }
  });
});

// ... (gi·ªØ nguy√™n ph·∫ßn c√≤n l·∫°i c·ªßa code)

</script>
</body>
</html>

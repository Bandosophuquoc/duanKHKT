<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc ‚Äî D·ª± √°n KHKT: T·ª± h√†o qu√™ h∆∞∆°ng</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --accent:#C62828; /* ƒë·ªè */
    --gold:#FFD54F;
    --bg:#FBFBFB;
  }
  body{font-family: "Noto Sans", system-ui, sans-serif; background:var(--bg); color:#111;}
  .container-main{max-width:1100px;margin:auto;}
  .logo{width:60px;height:60px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#B71C1C);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:22px}
  .hero{background:linear-gradient(90deg, rgba(198,40,40,0.06), rgba(255,213,79,0.02));padding:22px;border-radius:12px;margin:18px 0}
  .btn-accent{background:linear-gradient(90deg,var(--accent),#EF5350);color:white;border:none}
  #map{height:64vh;border-radius:12px}
  .badge-img{width:56px;height:56px;border-radius:8px;object-fit:cover}
  .marker-emoji{font-size:20px}
  .diatic-title{font-weight:700}
  .game-card{border-radius:10px;background:white;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  footer{padding:18px 0;color:#666;text-align:center;margin-top:18px}
  .correct{color:green;font-weight:700}
  .wrong{color:#c62828;font-weight:700}
  .explain{font-size:0.95rem;color:#444}
 /* CSS cho game l·∫≠t th·∫ª */
  /* C·∫≠p nh·∫≠t CSS cho game l·∫≠t th·∫ª tr√™n ƒëi·ªán tho·∫°i */
@media (max-width: 767px) {
  .memory-board {
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 12px;
    max-width: 100%;
  }
  
  .memory-card {
    height: 150px !important;
    width: 100%;
    max-width: 200px;
    margin: 0 auto;
  }
  
  .card-back .card-content img {
    max-width: 100%;
    max-height: 100%;
    object-fit: cover;
  }
}
@media (max-width: 480px) {
  .memory-card {
    height: 140px !important;
    max-width: 180px;
  }
}
@media (max-width: 360px) {
  .memory-card {
    height: 130px !important;
    max-width: 160px;
  }
}
  .memory-container {
    max-width: 100%;
    margin: 0 auto;
    height: 100%;
    overflow-y: auto;
    padding: 15px;
  }
  .memory-stats {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .memory-board {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    max-width: 500px;
    margin: 0 auto;
  }
  .memory-card {
    aspect-ratio: 3/4;
    perspective: 1000px;
    cursor: pointer;
  }
  .card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.6s;
    transform-style: preserve-3d;
  }
  .memory-card.flipped .card-inner {
    transform: rotateY(180deg);
  }
  .memory-card.matched .card-inner {
    transform: rotateY(180deg);
  }
  .memory-card.matched {
    cursor: default;
  }
  .card-front, .card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    box-sizing: border-box;
  }
  .card-front {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  .card-back {
    background: white;
    border: 2px solid #dee2e6;
    transform: rotateY(180deg);
  }
  .card-content {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .card-back .card-content img {
    max-width: 100%;
    max-height: 100%;
    object-fit: cover;
    border-radius: 6px;
  }
  .card-front .card-content i {
    font-size: 2rem;
  }
  .memory-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
    flex-wrap: wrap;
  }
  .memory-complete {
    margin-top: 20px;
  }
  /* Hi·ªáu ·ª©ng l·∫Øc khi sai */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
  /* Hi·ªáu ·ª©ng huy hi·ªáu l·ªõn */
  .badge-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
  }
  .badge-popup-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: popIn 0.5s ease;
    max-width: 300px;
    width: 90%;
  }
  .badge-popup-img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 auto 15px;
    border: 4px solid var(--gold);
    animation: bounce 1s ease infinite;
  }
  .badge-popup-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 10px;
  }
  .badge-popup-message {
    color: #666;
    margin-bottom: 20px;
  }
  /* GAME FULLSCREEN MODE */
  .game-fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    z-index: 9999;
    overflow-y: auto;
    display: none;
  }
  .game-fullscreen.active {
    display: block;
  }
  .game-fullscreen-header {
    background: linear-gradient(90deg, var(--accent), #d32);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  .game-fullscreen-title {
    font-size: 1.3rem;
    font-weight: bold;
    margin: 0;
  }
  .game-fullscreen-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
  }
  .game-fullscreen-body {
    padding: 20px;
    height: calc(100% - 70px);
    overflow-y: auto;
  }
  .quiz-container {
    max-width: 800px;
    margin: 0 auto;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  .quiz-question {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid var(--accent);
  }
  .quiz-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 20px 0;
  }
  .quiz-option {
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
  }
  .quiz-option:hover {
    border-color: var(--accent);
    background: #fff5f5;
  }
  .quiz-option.selected {
    border-color: var(--accent);
    background: #ffeaea;
  }
  .quiz-feedback {
    margin-top: 20px;
    padding: 15px;
    border-radius: 8px;
    display: none;
  }
  .quiz-feedback.correct {
    background: #e8f5e8;
    border: 1px solid #4caf50;
    display: block;
  }
  .quiz-feedback.wrong {
    background: #ffebee;
    border: 1px solid #f44336;
    display: block;
  }
  .quiz-controls {
    margin-top: auto;
    display: flex;
    justify-content: space-between;
    padding: 20px 0;
  }
  /* Victory Popup */
  .victory-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
  }
  .victory-content {
    background: white;
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    animation: popIn 0.5s ease;
    max-width: 400px;
    width: 90%;
    position: relative;
    z-index: 10001;
  }
  .victory-title {
    font-size: 2rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 15px;
  }
  .victory-message {
    color: #666;
    font-size: 1.1rem;
    margin-bottom: 25px;
  }
  /* Profile Page */
  .profile-container {
    max-width: 800px;
    margin: 0 auto;
  }
  .profile-header {
    background: linear-gradient(135deg, var(--accent), #d32);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    text-align: center;
  }
  .profile-badges {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  .profile-auth {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes popIn {
    0% { transform: scale(0.5); opacity: 0; }
    70% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  /* small responsive tweaks */
  @media (max-width:767px){ 
    .hero{padding:14px} 
    .badge-popup-content {
      padding: 20px;
    }
    .badge-popup-img {
      width: 100px;
      height: 100px;
    }
    .memory-board {
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    
    .memory-card {
      height: 80px;
    }
    .game-fullscreen-header {
      padding: 12px 15px;
    }
    .game-fullscreen-title {
      font-size: 1.1rem;
    }
    .game-fullscreen-body {
      padding: 15px;
    }
    .victory-content {
      padding: 25px;
    }
    .victory-title {
      font-size: 1.5rem;
    }
  }
  @media (max-width:480px){ 
    .memory-board {
      grid-template-columns: repeat(4, 1fr);
      gap: 5px;
    }
    
    .memory-card {
      height: 70px;
    }
    
    .card-front .card-content i {
      font-size: 1.5rem;
    }
    .quiz-option {
      padding: 12px;
    }
  }
  @media (max-width: 360px) {
    .memory-board {
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
    }
    
    .memory-card {
      height: 60px;
    }
  }
</style>
</head>
<body>
<div class="container container-main py-3">
  <!-- NAV / header -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex gap-3 align-items-center">
      <div class="logo">
        <i class="fas fa-map" style="color:white; font-size: 24px;"></i>
      </div>
      <div>
        <div style="font-weight:800;font-size:1.15rem">B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc</div>
        <div style="color:#666;font-size:0.9rem">D·ª± √°n KHKT - Gi√°o d·ª•c l√≤ng t·ª± h√†o d√¢n t·ªôc v√† t√¨nh y√™u qu√™ h∆∞∆°ng ƒë·∫•t n∆∞·ªõc cho tu·ªïi tr·∫ª tr∆∞·ªùng THPT An Th·ªõi</div>
      </div>
    </div>
    <div>
      <button id="nav-home" class="btn btn-sm btn-outline-secondary me-1">Trang ch·ªß</button>
      <button id="nav-map" class="btn btn-sm btn-accent">B·∫£n ƒë·ªì s·ªë</button>
      <button id="nav-profile" class="btn btn-sm btn-outline-primary">Trang c√° nh√¢n</button>
    </div>
  </div>
  <!-- HOME -->
  <section id="page-home">
    <div class="hero">
      <h1 style="margin:0;color:var(--accent)">B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc</h1>
      <p style="margin-top:10px;margin-bottom:8px; font-size: 1.1rem; line-height: 1.6;">
        <strong>H√†nh tr√¨nh v·ªÅ ngu·ªìn ch∆∞a bao gi·ªù s·ªëng ƒë·ªông v√† c·∫£m x√∫c ƒë·∫øn th·∫ø!</strong>
      </p>
      <p style="margin:0 0 6px 0;color:#444; line-height: 1.6">
        B·∫£n ƒê·ªì S·ªë Ph√∫ Qu·ªëc kh√¥ng ch·ªâ l√† m·ªôt website, ƒë√≥ l√† c√¢y c·∫ßu k·∫øt n·ªëi th·∫ø h·ªá tr·∫ª v·ªõi h√†nh tr√¨nh ƒë·∫ßy t·ª± h√†o c·ªßa cha √¥ng. Ch√∫ng t√¥i m·ªùi b·∫°n b∆∞·ªõc v√†o m·ªôt th·∫ø gi·ªõi n∆°i m·ªói di t√≠ch l√† m·ªôt c√¢u chuy·ªán ch·ªù ƒë∆∞·ª£c k·ªÉ, m·ªói nh√¢n v·∫≠t l·ªãch s·ª≠ l√† m·ªôt ng∆∞·ªùi h√πng ch·ªù ƒë∆∞·ª£c th·∫•u hi·ªÉu.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        T·∫°i ƒë√¢y, b·∫°n s·∫Ω:<br>
        ‚Ä¢ Ch·∫°m v√†o l·ªãch s·ª≠ b·∫±ng c·∫£m x√∫c ch√¢n th·∫≠t nh·∫•t.<br>
        ‚Ä¢ Kh√°m ph√° v·∫ª ƒë·∫πp c·ªßa qu√™ h∆∞∆°ng qua lƒÉng k√≠nh m·ªõi m·∫ª, tr·ª±c quan.<br>
        ‚Ä¢ R√®n luy·ªán t∆∞ duy ph·∫£n bi·ªán v√† k·ªπ nƒÉng k·ªÉ chuy·ªán ƒë·ªÉ tr·ªü th√†nh nh·ªØng ƒë·∫°i s·ª© vƒÉn h√≥a t∆∞∆°ng lai.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        H√£y ƒë·ªÉ ch√∫ng t√¥i ƒë·ªìng h√†nh c√πng b·∫°n tr√™n h√†nh tr√¨nh kh∆°i d·∫≠y l√≤ng t·ª± h√†o d√¢n t·ªôc v√† t√¨nh y√™u v·ªõi m·∫£nh ƒë·∫•t Ph√∫ Qu·ªëc anh h√πng.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        B·∫£n ƒë·ªì s·ªë l√† gi·∫£i ph√°p thu·ªôc khu√¥n kh·ªï d·ª± √°n khoa h·ªçc kƒ© thu·∫≠t "<strong>Gi√°o d·ª•c l√≤ng t·ª± h√†o d√¢n t·ªôc v√† t√¨nh y√™u qu√™ h∆∞∆°ng ƒë·∫•t n∆∞·ªõc cho tu·ªïi tr·∫ª THPT An Th·ªõi</strong>".
      </p>
      <div class="mt-3">
        <button id="btn-start" class="btn btn-accent btn-lg">B·∫Øt ƒë·∫ßu kh√°m ph√°</button>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-md-12">
        <div class="game-card">
          <h5>H∆∞·ªõng d·∫´n nhanh</h5>
          <ol style="padding-left:18px">
            <li>Nh·∫•n "B·∫Øt ƒë·∫ßu kh√°m ph√°" ƒë·ªÉ sang trang b·∫£n ƒë·ªì</li>
            <li>Click marker ƒë·ªÉ xem th√¥ng tin; n·∫øu c√≥ mini-game, b·∫•m "Ch∆°i"</li>
            <li>Truy c·∫≠p "Trang c√° nh√¢n" ƒë·ªÉ ƒëƒÉng k√Ω/ƒëƒÉng nh·∫≠p v√† xem huy hi·ªáu</li>
          </ol>
        </div>
      </div>
    </div>
  </section>
  <!-- MAP PAGE -->
  <section id="page-map" style="display:none">
    <div id="map" class="mb-3"></div>
  </section>
  <!-- PROFILE PAGE -->
  <section id="page-profile" style="display:none">
    <div class="profile-container">
      <div class="profile-header">
        <h2>Trang C√° Nh√¢n</h2>
        <p class="mb-0">Qu·∫£n l√Ω t√†i kho·∫£n v√† xem th√†nh t√≠ch c·ªßa b·∫°n</p>
      </div>
      <div class="profile-auth">
        <h4 class="mb-3">T√†i kho·∫£n</h4>
        <div id="profile-info" class="alert alert-info">
          B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u ti·∫øn tr√¨nh v√† nh·∫≠n huy hi·ªáu.
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button id="btn-profile-register" class="btn btn-outline-dark">ƒêƒÉng k√Ω</button>
          <button id="btn-profile-login" class="btn btn-dark">ƒêƒÉng nh·∫≠p</button>
          <button id="btn-profile-logout" class="btn btn-outline-secondary" style="display:none">ƒêƒÉng xu·∫•t</button>
        </div>
      </div>
      <div class="profile-badges">
        <h4 class="mb-3">Huy hi·ªáu c·ªßa b·∫°n</h4>
        <div style="color:#666;font-size:0.9rem" class="mb-3">Khi ho√†n th√†nh c√°c ƒëi·ªÅu ki·ªán, huy hi·ªáu s·∫Ω hi·ªán ·ªü ƒë√¢y.</div>
        <div id="profile-badge-area" class="d-flex gap-3 flex-wrap justify-content-center">
          <!-- Badges will appear here -->
        </div>
      </div>
    </div>
  </section>
  <footer>
    ¬© D·ª± √°n KHKT ‚Äî THPT An Th·ªõi ‚Äî Mi·ªÖn ph√≠
  </footer>
</div>
<!-- DI T√çCH MODAL -->
<div class="modal fade" id="diModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background:linear-gradient(90deg,var(--accent),#d32);color:white">
        <h5 class="modal-title" id="diTitle"></h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="diBody"></div>
      <div class="modal-footer">
        <div class="me-auto">
          <small class="text-muted">To·∫° ƒë·ªô: <span id="diCoords"></span></small>
        </div>
        <button id="btn-checkin" class="btn btn-outline-success">Check-in (T√¥i ƒë√£ ƒë·∫øn)</button>
        <button id="btn-play" class="btn btn-accent" style="display:none">Ch∆°i mini-game</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>
<!-- GAME FULLSCREEN MODE -->
<div id="gameFullscreen" class="game-fullscreen">
  <div class="game-fullscreen-header">
    <h2 class="game-fullscreen-title" id="gameFullscreenTitle">Mini-game</h2>
    <button class="game-fullscreen-close" id="gameFullscreenClose">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="game-fullscreen-body" id="gameFullscreenBody">
    <!-- N·ªôi dung game s·∫Ω ƒë∆∞·ª£c ƒë·∫∑t ·ªü ƒë√¢y -->
  </div>
</div>
<!-- VICTORY POPUP -->
<div id="victoryPopup" class="victory-popup" style="display:none">
  <div class="victory-content">
    <div class="victory-title">üéâ Chi·∫øn Th·∫Øng!</div>
    <div class="victory-message" id="victoryMessage">B·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc th·ª≠ th√°ch!</div>
    <button id="victoryClose" class="btn btn-accent btn-lg">Tuy·ªát v·ªùi!</button>
  </div>
</div>
<!-- AUTH modal -->
<div class="modal fade" id="authModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="authTitle">ƒêƒÉng k√Ω</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="authAlert" class="alert alert-danger d-none"></div>
        <input id="inName" class="form-control mb-2" placeholder="T√™n hi·ªÉn th·ªã">
        <input id="inEmail" class="form-control mb-2" placeholder="Gmail">
        <input id="inPass" type="password" class="form-control mb-2" placeholder="M·∫≠t kh·∫©u">
        <div class="form-text">L∆∞u t·∫°i tr√¨nh duy·ªát. ƒê·ªÉ d√πng th·ª±c, s·∫Ω h∆∞·ªõng d·∫´n t√≠ch h·ª£p Firebase.</div>
      </div>
      <div class="modal-footer">
        <button id="authSubmit" class="btn btn-dark">X√°c nh·∫≠n</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">H·ªßy</button>
      </div>
    </div>
  </div>
</div>
<!-- Badge Popup Modal -->
<div id="badgePopup" class="badge-popup" style="display:none">
  <div class="badge-popup-content">
    <img id="badgePopupImg" src="" class="badge-popup-img" alt="Huy hi·ªáu">
    <div id="badgePopupTitle" class="badge-popup-title"></div>
    <div id="badgePopupMessage" class="badge-popup-message">Ch√∫c m·ª´ng! B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c huy hi·ªáu</div>
    <button id="badgePopupClose" class="btn btn-accent">Tuy·ªát v·ªùi!</button>
  </div>
</div>
<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
/* ---------------------------
  D·ªØ li·ªáu ƒëi·ªÉm (ƒë√£ c·∫≠p nh·∫≠t v·ªõi t·ªça ƒë·ªô ch√≠nh x√°c c·ªßa b·∫°n)
----------------------------*/
const DI_TICH = [
  {
    id:'chua',
    name:'Ch√πa H·ªô Qu·ªëc',
    address:'426H+GVQ, D∆∞∆°ng T∆°, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Thi·ªÅn vi·ªán Tr√∫c L√¢m H·ªô Qu·ªëc ‚Äî ki·∫øn tr√∫c t√¢m linh l·ªõn, phong c√°ch c·ªï truy·ªÅn Vi·ªát.',
    extra:['Ng√¥i ch√πa l·ªõn nh·∫•t Ph√∫ Qu·ªëc', 'Ki·∫øn tr√∫c truy·ªÅn th·ªëng Vi·ªát Nam', 'Kh√¥ng gian t√¢m linh thanh t·ªãnh'],
    lat:10.110028, lng:104.029056,
    games:[],
    img: 'images/chua.jpg'
  },
  {
    id:'nha-tu',
    name:'Nh√† t√π Ph√∫ Qu·ªëc',
    address:'350 ƒê. Nguy·ªÖn VƒÉn C·ª´, An Th·ªõi, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Di t√≠ch l·ªãch s·ª≠ c·∫•p Qu·ªëc gia ƒë·∫∑c bi·ªát (2014). N∆°i giam gi·ªØ nhi·ªÅu t√π binh trong kh√°ng chi·∫øn; ch·ª©ng t√≠ch tra t·∫•n, nh∆∞ng c≈©ng l√† bi·ªÉu t∆∞·ª£ng √Ω ch√≠ ki√™n c∆∞·ªùng.',
    extra:[
      'NƒÉm x√¢y d·ª±ng: 01/06/1967',
      'C√≤n g·ªçi: Nh√† lao C√¢y D·ª´a',
      'Kho·∫£ng 40.000 t√π binh t·ª´ng b·ªã giam; nhi·ªÅu t√π nh√¢n b·ªã tra t·∫•n d√£ man. C√≥ 45 cu·ªôc v∆∞·ª£t ng·ª•c ghi nh·∫≠n.'
    ],
    lat:10.044417, lng:104.017639,
    games:['quiz_nhatu', 'memory_nhatu'],
    img: 'images/nhatupq3.jpg'
  },
  {
    id:'nha-thung',
    name:'Nh√† th√πng n∆∞·ªõc m·∫Øm Ph√∫ Qu·ªëc (Ph·ª•ng H∆∞ng)',
    address:'471 ƒê. Nguy·ªÖn VƒÉn C·ª´, Khu 2, Ph√∫ Qu·ªëc, Ki√™n Giang',
    note:'Nh√† th√πng n∆∞·ªõc m·∫Øm truy·ªÅn th·ªëng; ngh·ªÅ truy·ªÅn th·ªëng c·ªßa ƒë·∫£o.',
    extra:['L·ªãch s·ª≠: h√†ng trƒÉm nƒÉm, ph∆∞∆°ng th·ª©c ·ªß mu·ªëi truy·ªÅn th·ªëng', 'N∆∞·ªõc m·∫Øm Ph√∫ Qu·ªëc n·ªïi ti·∫øng th∆°m ngon'],
    lat:10.044917, lng:104.017444,
    games:[],
    img:'images/nhathung.jpg'
  },
  {
    id:'ham-ninh',
    name:'L√†ng ch√†i H√†m Ninh',
    address:'52JV+6XX, TL47, R·∫°ch H√†m, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'L√†ng ch√†i c·ªï, n·ªïi ti·∫øng h·∫£i s·∫£n t∆∞∆°i, gh·∫π H√†m Ninh.',
    extra:['L√†ng ch√†i truy·ªÅn th·ªëng l√¢u ƒë·ªùi', 'N·ªïi ti·∫øng v·ªõi gh·∫π H√†m Ninh t∆∞∆°i ngon', 'C·∫£nh bi·ªÉn ƒë·∫πp, b√¨nh y√™n'],
    lat:10.180917, lng:104.048472,
    games:[],
    img:'images/langchai.jpg'
  },
  {
    id:'baotang',
    name:'B·∫£o t√†ng C·ªôi Ngu·ªìn',
    address:'Ph√∫ Qu·ªëc, Ki√™n Giang',
    note:'B·∫£o t√†ng tr∆∞ng b√†y l·ªãch s·ª≠-vƒÉn h√≥a ƒë·ªãa ph∆∞∆°ng',
    extra:['Tr∆∞ng b√†y l·ªãch s·ª≠, vƒÉn h√≥a Ph√∫ Qu·ªëc', 'B·ªô s∆∞u t·∫≠p c·ªï v·∫≠t phong ph√∫', 'Ki·∫øn tr√∫c ƒë·ªôc ƒë√°o'],
    lat:10.192500, lng:103.967000,
    games:[],
    img:'images/coinguon.jpg'
  },
  {
    id:'dinh-cau',
    name:'Dinh C·∫≠u',
    address:'Khu ph·ªë 2, Tp. Ph√∫ Qu·ªëc, Ki√™n Giang 92500, Vi·ªát Nam',
    note:'Di t√≠ch th·∫Øng c·∫£nh; t√≠n ng∆∞·ª°ng c·ªßa ng∆∞ d√¢n, c√≥ l·ªÖ h·ªôi h√†ng nƒÉm (15‚Äì16/10 √¢m l·ªãch).',
    extra:['X√¢y d·ª±ng: 1937 (tu s·ª≠a 1997)','Bi·ªÉu t∆∞·ª£ng t√¢m linh c·ªßa ng∆∞·ªùi d√¢n ƒë·ªãa ph∆∞∆°ng', 'V·ªã tr√≠ ƒë·∫πp nh√¨n ra bi·ªÉn'],
    lat:10.217194, lng:103.956500,
    games:[],
    img:'images/dinhcau.jpg'
  },
  {
    id:'dinh-ntt',
    name:'ƒê√¨nh Th·∫ßn Nguy·ªÖn Trung Tr·ª±c',
    address:'9RFV+848, G√†nh D·∫ßu, Ph√∫ Qu·ªëc, Ki√™n Giang, Vi·ªát Nam',
    note:'Di t√≠ch l·ªãch s·ª≠ vƒÉn h√≥a. ƒê√¨nh th·ªù Anh h√πng d√¢n t·ªôc Nguy·ªÖn Trung Tr·ª±c (1839-1868).',
    extra:[
      'ƒê√¨nh ƒë∆∞·ª£c x√¢y d·ª±ng t·ª´ nƒÉm 1882',
      'L·ªÖ gi·ªó t·ªï ch·ª©c h√†ng nƒÉm (√¢m l·ªãch) ‚Äî ho·∫°t ƒë·ªông truy·ªÅn th·ªëng h∆°n 100 nƒÉm',
      'Nguy·ªÖn Trung Tr·ª±c n·ªïi ti·∫øng v·ªõi chi·∫øn c√¥ng ƒë·ªët t√†u Ph√°p tr√™n s√¥ng Nh·∫≠t T·∫£o.'
    ],
    lat:10.373306, lng:103.842972,
    games:['quiz_trungtruc', 'memory_trungtruc'],
    img:'images/dinhntt.jpg'
  }
];
/* -----------------------
  Local storage keys
------------------------*/
const STORAGE_USER = 'pq_user_v1';
const STORAGE_BADGES = 'pq_badges_v1';
const STORAGE_DONE = 'pq_done_games_v1';
const STORAGE_VISIT = 'pq_visited_v1';
/* --------- Helpers ------------- */
function saveUser(u){ localStorage.setItem(STORAGE_USER, JSON.stringify(u)) }
function loadUser(){ return JSON.parse(localStorage.getItem(STORAGE_USER) || 'null') }
function loadBadges(){ return JSON.parse(localStorage.getItem(STORAGE_BADGES) || '[]') }
function saveBadges(a){ localStorage.setItem(STORAGE_BADGES, JSON.stringify(a)) }
function loadDone(){ return JSON.parse(localStorage.getItem(STORAGE_DONE) || '{}') }
function saveDone(o){ localStorage.setItem(STORAGE_DONE, JSON.stringify(o)) }
function loadVisited(){ return JSON.parse(localStorage.getItem(STORAGE_VISIT) || '[]') }
function saveVisited(a){ localStorage.setItem(STORAGE_VISIT, JSON.stringify(a)) }
/* ---------- UI & Navigation ---------- */
const pageHome = document.getElementById('page-home');
const pageMap = document.getElementById('page-map');
const pageProfile = document.getElementById('page-profile');
const navHome = document.getElementById('nav-home');
const navMap = document.getElementById('nav-map');
const navProfile = document.getElementById('nav-profile');
const btnStart = document.getElementById('btn-start');
function showHome(){ 
  pageHome.style.display='block'; 
  pageMap.style.display='none'; 
  pageProfile.style.display='none'; 
}
function showMap(){ 
  pageHome.style.display='none'; 
  pageMap.style.display='block'; 
  pageProfile.style.display='none'; 
  setTimeout(()=> map.invalidateSize(),300); 
}
function showProfile(){ 
  pageHome.style.display='none'; 
  pageMap.style.display='none'; 
  pageProfile.style.display='block'; 
  renderProfileBadges();
  refreshProfileAuthUI();
}
navHome.onclick = showHome;
navMap.onclick = showMap;
navProfile.onclick = showProfile;
btnStart.onclick = ()=> { showMap(); window.scrollTo(0,0); }
/* Auth modal */
const authModal = new bootstrap.Modal(document.getElementById('authModal'));
document.getElementById('btn-profile-register').addEventListener('click', ()=> {
  document.getElementById('authTitle').innerText = 'ƒêƒÉng k√Ω'; 
  document.getElementById('authSubmit').onclick = authRegister; 
  document.getElementById('authAlert').classList.add('d-none');
  authModal.show();
});
document.getElementById('btn-profile-login').addEventListener('click', ()=> {
  document.getElementById('authTitle').innerText = 'ƒêƒÉng nh·∫≠p'; 
  document.getElementById('authSubmit').onclick = authLogin; 
  document.getElementById('authAlert').classList.add('d-none');
  authModal.show();
});
document.getElementById('btn-profile-logout').addEventListener('click', ()=> {
  localStorage.removeItem(STORAGE_USER);
  refreshProfileAuthUI();
  alert('ƒêƒÉng xu·∫•t th√†nh c√¥ng.');
});
/* auth functions */
function authRegister(){
  const name = document.getElementById('inName').value.trim();
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  if(!name || !email || !pass){ showAuthError('ƒêi·ªÅn ƒë·ªß t√™n, email, m·∫≠t kh·∫©u'); return; }
  const u = {name,email,pass};
  saveUser(u);
  alert('ƒêƒÉng k√Ω th√†nh c√¥ng. Vui l√≤ng ƒëƒÉng nh·∫≠p.');
  authModal.hide();
}
function authLogin(){
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  const u = loadUser();
  if(!u || u.email !== email || u.pass !== pass){ showAuthError('Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng'); return; }
  authModal.hide();
  refreshProfileAuthUI();
  alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng. Xin ch√†o ' + u.name);
}
function showAuthError(msg){ 
  const a=document.getElementById('authAlert'); 
  a.innerText=msg; 
  a.classList.remove('d-none'); 
}
function refreshProfileAuthUI(){
  const u = loadUser();
  const profileInfo = document.getElementById('profile-info');
  const btnLogin = document.getElementById('btn-profile-login');
  const btnRegister = document.getElementById('btn-profile-register');
  const btnLogout = document.getElementById('btn-profile-logout');
  
  if(u){ 
    btnLogin.style.display='none'; 
    btnRegister.style.display='none'; 
    btnLogout.style.display='inline-block'; 
    profileInfo.innerHTML = `Xin ch√†o <strong>${u.name}</strong> ‚Äî ${u.email}`;
    profileInfo.className = 'alert alert-success';
  } else { 
    btnLogin.style.display='inline-block'; 
    btnRegister.style.display='inline-block'; 
    btnLogout.style.display='none'; 
    profileInfo.innerHTML = 'B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u ti·∫øn tr√¨nh v√† nh·∫≠n huy hi·ªáu.';
    profileInfo.className = 'alert alert-info';
  }
}
/* ---------- Map init ---------- */
const map = L.map('map', {zoomControl:true}).setView([10.28,103.98], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(map);
function makeIcon(hasGame){
  const color = hasGame ? '#C62828' : '#1976D2';
  return L.divIcon({className:'custom-pin', html:`<div style="background:${color};width:18px;height:18px;border-radius:50%;border:3px solid white"></div>`, iconSize:[24,24], iconAnchor:[12,12]});
}
/* render markers */
DI_TICH.forEach(p=>{
  const m = L.marker([p.lat,p.lng], {icon: makeIcon(p.games.length>0)}).addTo(map);
  m.on('click', ()=> openDiModal(p));
});
/* modal instances */
const diModal = new bootstrap.Modal(document.getElementById('diModal'));
/* open di t√≠ch modal (with details) */
function openDiModal(p){
  document.getElementById('diTitle').innerText = p.name;
  const extras = p.extra.map(x=>`<li>${x}</li>`).join('');
  const html = `
    <div class="row">
      <div class="col-md-5"><img src="${p.img}" alt="${p.name}" style="width:100%;border-radius:8px;object-fit:cover"></div>
      <div class="col-md-7">
        <h5 class="diatic-title">${p.name}</h5>
        <p style="margin:0">${p.address}</p>
        <p style="margin-top:8px;color:#333">${p.note}</p>
        ${extras ? `<ul>${extras}</ul>` : ''}
      </div>
    </div>
  `;
  document.getElementById('diBody').innerHTML = html;
  document.getElementById('diCoords').innerText = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
  const btnPlay = document.getElementById('btn-play');
  if(p.games && p.games.length){
    btnPlay.style.display='inline-block';
    btnPlay.onclick = ()=> { diModal.hide(); openGamePicker(p); };
  } else { btnPlay.style.display='none'; btnPlay.onclick=null; }
  // check-in button
  document.getElementById('btn-checkin').onclick = ()=> {
    const u = loadUser();
    if(!u){ alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi check-in.'); return; }
    markVisited(p.id);
    awardBadgeSite(p.id,p.name);
  };
  diModal.show();
}
/* ---------- Badges & check-in logic ---------- */
function getBadges(){ return loadBadges(); }
function awardBadge(id,name,icon){
  const arr = getBadges();
  if(arr.find(b=>b.id===id)) return false;
  arr.push({id,name,icon:icon || `https://via.placeholder.com/64/FFD54F/000?text=${encodeURIComponent(name.charAt(0))}`});
  saveBadges(arr);
  renderProfileBadges();
  
  // Hi·ªÉn th·ªã popup huy hi·ªáu
  showBadgePopup(name, icon);
  return true;
}
function renderProfileBadges(){
  const wrap = document.getElementById('profile-badge-area');
  wrap.innerHTML = '';
  const arr = getBadges();
  
  if(arr.length === 0) {
    wrap.innerHTML = '<div class="text-muted">Ch∆∞a c√≥ huy hi·ªáu n√†o. H√£y kh√°m ph√° c√°c ƒë·ªãa ƒëi·ªÉm v√† ho√†n th√†nh th·ª≠ th√°ch!</div>';
    return;
  }
  
  arr.forEach(b=>{
    const el = document.createElement('div');
    el.className = 'text-center';
    el.innerHTML = `
      <img src="${b.icon}" class="badge-img" alt="${b.name}">
      <div style="font-size:12px; max-width:80px">${b.name}</div>
    `;
    wrap.appendChild(el);
  });
}
/* mark visited and award site badge */
function markVisited(siteId){
  const v = loadVisited();
  if(!v.includes(siteId)){ 
    v.push(siteId); 
    saveVisited(v); 
    renderProfileBadges(); 
  }
}
function awardBadgeSite(siteId, siteName){
  const id = `site_${siteId}`;
  const name = `${siteName}`;
  const badgeIcons = {
    'chua': 'images/hhchua.jpg',
    'nha-tu': 'images/hhnhatupq.jpg',
    'nha-thung': 'images/hhnhathung.jpg',
    'ham-ninh': 'images/hhlangchai.jpg',
    'baotang': 'images/hhcoinguon.jpg',
    'dinh-cau': 'images/hhdinhcau.jpg',
    'dinh-ntt': 'images/hhdinhntt.jpg'
  };
  
  const badgeIcon = badgeIcons[siteId] || `https://via.placeholder.com/64/C33/fff?text=${encodeURIComponent(siteName.split(' ')[0].charAt(0))}`;
  awardBadge(id, name, badgeIcon);
}
/* Hi·ªÉn th·ªã popup huy hi·ªáu l·ªõn */
function showBadgePopup(badgeName, badgeIcon) {
  const popup = document.getElementById('badgePopup');
  const popupImg = document.getElementById('badgePopupImg');
  const popupTitle = document.getElementById('badgePopupTitle');
  
  popupImg.src = badgeIcon;
  popupTitle.textContent = badgeName;
  popup.style.display = 'flex';
  
  // B·∫Øn ph√°o hoa
  confetti({
    particleCount: 150,
    spread: 70,
    origin: { y: 0.6 },
    colors: ['#C62828', '#FFD54F', '#4CAF50', '#2196F3']
  });
  
  const autoClose = setTimeout(() => {
    closeBadgePopup();
  }, 3000);
  
  document.getElementById('badgePopupClose').onclick = () => {
    clearTimeout(autoClose);
    closeBadgePopup();
  };
  
  popup.onclick = (e) => {
    if (e.target === popup) {
      clearTimeout(autoClose);
      closeBadgePopup();
    }
  };
}
function closeBadgePopup() {
  document.getElementById('badgePopup').style.display = 'none';
}
/* record game completion */
function recordDone(siteId, gameId){
  const o = loadDone();
  if(!o[siteId]) o[siteId]=[];
  if(!o[siteId].includes(gameId)){ 
    o[siteId].push(gameId); 
    saveDone(o); 
    
    // Ki·ªÉm tra v√† trao huy hi·ªáu ƒë·∫∑c bi·ªát
    checkAndAwardSpecialBadges();
    
    renderProfileBadges(); 
  }
}
// Ki·ªÉm tra v√† trao huy hi·ªáu ƒë·∫∑c bi·ªát
function checkAndAwardSpecialBadges() {
  const done = loadDone();
  
  // ƒê·∫øm t·ªïng s·ªë game ƒë√£ ho√†n th√†nh
  let totalGamesCompleted = 0;
  const allGameIds = ['quiz_nhatu', 'memory_nhatu', 'quiz_trungtruc', 'memory_trungtruc'];
  
  allGameIds.forEach(gameId => {
    const nhaTuDone = done['nha-tu'] && done['nha-tu'].includes(gameId);
    const dinhDone = done['dinh-ntt'] && done['dinh-ntt'].includes(gameId);
    
    if (nhaTuDone || dinhDone) {
      totalGamesCompleted++;
    }
  });
  
  console.log(`T·ªïng s·ªë game ƒë√£ ho√†n th√†nh: ${totalGamesCompleted}/4`);
  
  // Ki·ªÉm tra v√† trao huy hi·ªáu
  if (totalGamesCompleted >= 2 && totalGamesCompleted < 4) {
    awardBadge('nha_su_hoc_tap_su', 'Nh√† s·ª≠ h·ªçc t·∫≠p s·ª±', 'images/IMG_4803.png');
  }
  
  if (totalGamesCompleted === 4) {
    awardBadge('nha_su_hoc_tai_ba', 'Nh√† s·ª≠ h·ªçc t√†i ba', 'images/IMG_4802.png');
  }
}
/* ---------- Game picker & implementations ---------- */
function openGamePicker(site){
  const html = `<div class="text-center">
    <h4 class="mb-4">Ch·ªçn mini-game ‚Äî ${site.name}</h4>
    <div class="d-flex flex-column gap-3 align-items-center">
      ${site.games.map(g=>`<button class="btn btn-accent btn-lg w-75 game-choice" data-game="${g}">${labelGame(g)}</button>`).join('')}
    </div>
    <p class="mt-4 text-muted">M·ªói mini-game c√≥ c√°c b∆∞·ªõc th·ª≠ th√°ch. K·∫øt qu·∫£ s·∫Ω l∆∞u v√†o h·ªì s∆° c·ªßa b·∫°n.</p>
  </div>`;
  
  showGameFullscreen('Ch·ªçn mini-game', html);
  
  document.querySelectorAll('.game-choice').forEach(btn=> btn.addEventListener('click', ()=> {
    const g = btn.dataset.game;
    startGameInstance(g, site);
  }));
}
function labelGame(id){
  const map = {
    'quiz_nhatu':'Quiz (Nh√† t√π)',
    'quiz_trungtruc':'Quiz (ƒê√¨nh)',
    'memory_nhatu':'Memory Vi·ªát (Nh√† t√π)',
    'memory_trungtruc':'Memory Vi·ªát (ƒê√¨nh)'
  };
  return map[id]||id;
}
/* ---------- GAME FULLSCREEN MODE ---------- */
const gameFullscreen = document.getElementById('gameFullscreen');
const gameFullscreenTitle = document.getElementById('gameFullscreenTitle');
const gameFullscreenBody = document.getElementById('gameFullscreenBody');
const gameFullscreenClose = document.getElementById('gameFullscreenClose');
gameFullscreenClose.addEventListener('click', () => {
  hideGameFullscreen();
});
function showGameFullscreen(title, content) {
  gameFullscreenTitle.textContent = title;
  gameFullscreenBody.innerHTML = content;
  gameFullscreen.classList.add('active');
  document.body.style.overflow = 'hidden';
}
function hideGameFullscreen() {
  gameFullscreen.classList.remove('active');
  document.body.style.overflow = 'auto';
}
/* ---------- Victory Popup ---------- */
const victoryPopup = document.getElementById('victoryPopup');
const victoryMessage = document.getElementById('victoryMessage');
const victoryClose = document.getElementById('victoryClose');
victoryClose.addEventListener('click', () => {
  victoryPopup.style.display = 'none';
});
function showVictory(message) {
  victoryMessage.textContent = message;
  victoryPopup.style.display = 'flex';
  
  // B·∫Øn ph√°o hoa ·ªü ph√≠a tr∆∞·ªõc
  confetti({
    particleCount: 200,
    spread: 100,
    origin: { y: 0.3 },
    colors: ['#C62828', '#FFD54F', '#4CAF50', '#2196F3'],
    startVelocity: 30,
    gravity: 0.8
  });
  
  // Th√™m hi·ªáu ·ª©ng ph√°o hoa t·ª´ hai b√™n
  setTimeout(() => {
    confetti({
      particleCount: 100,
      angle: 60,
      spread: 80,
      origin: { x: 0, y: 0.5 },
      colors: ['#C62828', '#FFD54F']
    });
    confetti({
      particleCount: 100,
      angle: 120,
      spread: 80,
      origin: { x: 1, y: 0.5 },
      colors: ['#4CAF50', '#2196F3']
    });
  }, 500);
}
/* ---------- GAME L·∫¨T TH·∫∫ (MEMORY CARD) ---------- */
const MEMORY_GAMES = {
  'memory_nhatu': {
    title: 'Memory Vi·ªát - Nh√† t√π Ph√∫ Qu·ªëc',
    cards: [
      { id: 1, image: 'images/nhatucard1.jpg', matchId: 2 },
      { id: 2, image: 'images/nhatutext1.jpg', matchId: 1 },
      { id: 3, image: 'images/nhatucard2.jpg', matchId: 4 },
      { id: 4, image: 'images/nhatutext2.jpg', matchId: 3 },
      { id: 5, image: 'images/nhatucard3.jpg', matchId: 6 },
      { id: 6, image: 'images/nhatutext3.jpg', matchId: 5 },
      { id: 7, image: 'images/nhatucard4.jpg', matchId: 8 },
      { id: 8, image: 'images/nhatutext4.jpg', matchId: 7 }
    ]
  },
  'memory_trungtruc': {
    title: 'Memory Vi·ªát - ƒê√¨nh Nguy·ªÖn Trung Tr·ª±c',
    cards: [
      { id: 1, image: 'images/dinhcard1.jpg', matchId: 2 },
      { id: 2, image: 'images/dinhtext1.jpg', matchId: 1 },
      { id: 3, image: 'images/dinhcard2.jpg', matchId: 4 },
      { id: 4, image: 'images/dinhtext2.jpg', matchId: 3 },
      { id: 5, image: 'images/dinhcard3.jpg', matchId: 6 },
      { id: 6, image: 'images/dinhtext3.jpg', matchId: 5 },
      { id: 7, image: 'images/dinhcard4.jpg', matchId: 8 },
      { id: 8, image: 'images/dinhtext4.jpg', matchId: 7 }
    ]
  }
};
let currentMemoryGame = null;
let flippedCards = [];
let matchedPairs = 0;
let canFlip = true;
let flipCount = 0;
function startMemoryGame(gameId, site) {
  const gameData = MEMORY_GAMES[gameId];
  if (!gameData) {
    alert('Game Memory Vi·ªát ch∆∞a c√≥ n·ªôi dung.');
    return;
  }
  currentMemoryGame = { id: gameId, site: site, gameData: gameData };
  flippedCards = [];
  matchedPairs = 0;
  canFlip = true;
  flipCount = 0;
  const html = `
    <div class="memory-container text-center">
      <h4 class="mb-3">${gameData.title}</h4>
      <div class="memory-stats mb-3">
        <span class="badge bg-primary">C·∫∑p ƒë√£ t√¨m: <span id="matchedCount">0</span>/4</span>
        <span class="badge bg-secondary ms-2">L∆∞·ª£t l·∫≠t: <span id="flipCount">0</span></span>
      </div>
      
      <div class="memory-board" id="memoryBoard">
        <!-- Cards will be generated here -->
      </div>
      
      <div class="memory-controls mt-4">
        <button class="btn btn-accent" onclick="finishMemoryGame()">Ho√†n th√†nh</button>
        <button class="btn btn-outline-secondary" onclick="resetMemoryGame()">Ch∆°i l·∫°i</button>
      </div>
      
      <div class="memory-complete mt-3" id="memoryComplete" style="display: none;">
        <div class="alert alert-success">
          <h5>üéâ Ch√∫c m·ª´ng!</h5>
          <p>B·∫°n ƒë√£ ho√†n th√†nh game Memory Vi·ªát!</p>
        </div>
      </div>
    </div>
  `;
  showGameFullscreen(gameData.title, html);
  initializeMemoryGame();
}
function initializeMemoryGame() {
  const board = document.getElementById('memoryBoard');
  const gameData = currentMemoryGame.gameData;
  
  const shuffledCards = [...gameData.cards].sort(() => Math.random() - 0.5);
  
  board.innerHTML = shuffledCards.map(card => `
    <div class="memory-card" data-card-id="${card.id}" data-match-id="${card.matchId}">
      <div class="card-inner">
        <div class="card-front">
          <div class="card-content">
            <i class="fas fa-question"></i>
          </div>
        </div>
        <div class="card-back">
          <div class="card-content">
            <img src="${card.image}" alt="Memory card" onerror="this.style.display='none'">
          </div>
        </div>
      </div>
    </div>
  `).join('');
  document.querySelectorAll('.memory-card').forEach(card => {
    card.addEventListener('click', handleCardClick);
  });
  flipCount = 0;
  updateFlipCount();
}
function handleCardClick() {
  if (!canFlip) return;
  if (this.classList.contains('flipped') || this.classList.contains('matched')) return;
  if (flippedCards.length >= 2) return;
  this.classList.add('flipped');
  flippedCards.push(this);
  flipCount++;
  updateFlipCount();
  if (flippedCards.length === 2) {
    canFlip = false;
    setTimeout(checkForMatch, 800);
  }
}
function checkForMatch() {
  const [card1, card2] = flippedCards;
  const matchId1 = card1.dataset.matchId;
  const matchId2 = card2.dataset.matchId;
  if (card1.dataset.cardId === matchId2 && card2.dataset.cardId === matchId1) {
    card1.classList.add('matched');
    card2.classList.add('matched');
    matchedPairs++;
    updateMatchedCount();
    if (matchedPairs === 4) {
      setTimeout(() => {
        document.getElementById('memoryComplete').style.display = 'block';
       showVictory('üéâ Xu·∫•t s·∫Øc! B·∫°n ƒë√£ ho√†n th√†nh Memory Vi·ªát!');
      }, 500);
    }
  } else {
    card1.classList.remove('flipped');
    card2.classList.remove('flipped');
  }
  flippedCards = [];
  canFlip = true;
}
function updateMatchedCount() {
  document.getElementById('matchedCount').textContent = matchedPairs;
}
function updateFlipCount() {
  document.getElementById('flipCount').textContent = flipCount;
}
function resetMemoryGame() {
  flippedCards = [];
  matchedPairs = 0;
  canFlip = true;
  flipCount = 0;
  
  document.querySelectorAll('.memory-card').forEach(card => {
    card.classList.remove('flipped', 'matched');
  });
  
  document.getElementById('memoryComplete').style.display = 'none';
  updateMatchedCount();
  updateFlipCount();
  
  const board = document.getElementById('memoryBoard');
  const cards = Array.from(board.children);
  cards.sort(() => Math.random() - 0.5);
  cards.forEach(card => board.appendChild(card));
}
function finishMemoryGame() {
  if (matchedPairs === 4) {
    recordDone(currentMemoryGame.site.id, currentMemoryGame.id);
    hideGameFullscreen();
  } else {
    alert(`B·∫°n ƒë√£ t√¨m ƒë∆∞·ª£c ${matchedPairs}/4 c·∫∑p th·∫ª. H√£y ti·∫øp t·ª•c!`);
  }
}
/* ---------- GAME QUIZ ---------- */
const QUIZZES = {
  'quiz_nhatu': {
    title:'Quiz Nh√† t√π Ph√∫ Qu·ªëc',
    items:[
      {
        q:'Di t√≠ch Tr·∫°i giam Ph√∫ Qu·ªëc ƒë∆∞·ª£c ch√≠nh th·ª©c x·∫øp h·∫°ng Di t√≠ch Qu·ªëc gia ƒë·∫∑c bi·ªát v√†o th·ªùi ƒëi·ªÉm n√†o?',
        opts:['Ng√†y 30/4/1975','Ng√†y 27/7/2013','Ng√†y 31/12/2014','Ng√†y 20/10/2016'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. CƒÉn c·ª© theo Quy·∫øt ƒë·ªãnh s·ªë 2408/Qƒê-TTg ng√†y 31/12/2014 c·ªßa Th·ªß t∆∞·ªõng Ch√≠nh ph·ªß.'
      },
      {
        q:'"ƒê·ªãa ng·ª•c tr·∫ßn gian" Ph√∫ Qu·ªëc ch√≠nh th·ª©c t·ªìn t·∫°i trong kho·∫£ng th·ªùi gian n√†o?',
        opts:['T·ª´ nƒÉm 1949 ƒë·∫øn nƒÉm 1954','T·ª´ th√°ng 6/1967 ƒë·∫øn th√°ng 3/1973','T·ª´ nƒÉm 1965 ƒë·∫øn nƒÉm 1975','T·ª´ nƒÉm 1954 ƒë·∫øn nƒÉm 1975'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. Theo t∆∞ li·ªáu, tr·∫°i giam t·ªìn t·∫°i ch∆∞a ƒë·∫ßy 6 nƒÉm trong giai ƒëo·∫°n n√†y d∆∞·ªõi s·ª± qu·∫£n l√Ω c·ªßa ch√≠nh quy·ªÅn M·ªπ - Ng·ª•y.'
      },
      {
        q:'∆Ø·ªõc t√≠nh c√≥ bao nhi√™u t√π binh ƒë√£ b·ªã gi·∫øt h·∫°i t·∫°i Tr·∫°i giam Ph√∫ Qu·ªëc?',
        opts:['Kho·∫£ng 1.000 ng∆∞·ªùi','Kho·∫£ng 2.000 ng∆∞·ªùi','Kho·∫£ng 4.000 ng∆∞·ªùi','Kho·∫£ng 10.000 ng∆∞·ªùi'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. T∆∞ li·ªáu ghi r√µ con s·ªë kho·∫£ng 4.000 t√π binh ƒë√£ b·ªã gi·∫øt h·∫°i t·∫°i ƒë√¢y.'
      },
      {
        q:'M·ªôt trong nh·ªØng h√¨nh th·ª©c tra t·∫•n ƒë·∫∑c bi·ªát d√£ man, n∆°i t√π binh b·ªã nh·ªët trong c√°c c√¥ng-ten-n∆° nh·ªè ƒë∆∞·ª£c g·ªçi l√† g√¨?',
        opts:['Chu·ªìng c·ªçp xi mƒÉng','Th√πng cat-x√¥','H·∫ßm ƒë√° v√¥i','Ng·ª•c t·ªëi'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. ƒê√¢y l√† m·ªôt ki·ªÉu giam gi·ªØ ƒë∆∞·ª£c m√¥ t·∫£ trong t∆∞ li·ªáu, s·ª≠ d·ª•ng c√°c c√¥ng-ten-n∆° nh·ªè, tr√™n ƒë·ªânh ƒë·ª•c l·ªó th√¥ng h∆°i, r·∫•t ch·∫≠t h·∫πp v√† ng·ªôt ng·∫°t.'
      },
      {
        q:'C√°c t√π binh t·∫°i Tr·∫°i giam Ph√∫ Qu·ªëc ƒë√£ t·ªï ch·ª©c bao nhi√™u cu·ªôc v∆∞·ª£t ng·ª•c v·ªõi nhi·ªÅu h√¨nh th·ª©c kh√°c nhau?',
        opts:['12 cu·ªôc','25 cu·ªôc','45 cu·ªôc','52 cu·ªôc'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. Th·ªÉ hi·ªán tinh th·∫ßn ƒë·∫•u tranh b·∫•t khu·∫•t, c√°c t√π binh ƒë√£ t·ªï ch·ª©c th√†nh c√¥ng 45 cu·ªôc v∆∞·ª£t ng·ª•c.'
      },
      {
        q:'Khu v·ª±c n√†o sau ƒë√¢y KH√îNG ph·∫£i l√† m·ªôt ph·∫ßn c·ªßa Di t√≠ch Tr·∫°i giam Ph√∫ Qu·ªëc ng√†y nay?',
        opts:['Ph√¢n khu B2 (ƒë∆∞·ª£c ph·ª•c d·ª±ng)','Nghƒ©a ƒë·ªãa t√π binh (ƒê·ªìi 100)','Nh√† t√π C√¥n S∆°n','ƒê√†i t∆∞·ªüng ni·ªám li·ªát sƒ© t·∫°i ƒê·ªìi Sim'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. Nh√† t√π C√¥n S∆°n l√† m·ªôt di t√≠ch l·ªãch s·ª≠ ho√†n to√†n kh√°c, n·∫±m ·ªü C√¥n ƒê·∫£o, t·ªânh B√† R·ªãa - V≈©ng T√†u.'
      },
      {
        q:'T·ªïng di·ªán t√≠ch c·ªßa Tr·∫°i giam Ph√∫ Qu·ªëc trong l·ªãch s·ª≠ l√™n ƒë·∫øn bao nhi√™u?',
        opts:['100 hecta','200 hecta','400 hecta','500 hecta'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. Tr·∫°i giam c√≥ quy m√¥ r·∫•t l·ªõn, v·ªõi t·ªïng di·ªán t√≠ch l√™n ƒë·∫øn 400 hecta, ƒë∆∞·ª£c chia th√†nh 12 khu v·ª±c.'
      }
    ]
  },
  'quiz_trungtruc': {
    title:'Quiz ƒê√¨nh Nguy·ªÖn Trung Tr·ª±c',
    items:[
      {
        q:'Nguy·ªÖn Trung Tr·ª±c l√† th·ªß lƒ©nh n·ªïi ti·∫øng c·ªßa phong tr√†o kh√°ng chi·∫øn ch·ªëng?',
        opts:['Ch·ªëng Ph√°p','Ch·ªëng Ph√°p v√† ch·ªëng M·ªπ','Ch·ªëng M·ªπ','Ch·ªëng Nh·∫≠t'],
        ans:0,
        explain:'ƒê√°p √°n ƒë√∫ng l√† A. Nguy·ªÖn Trung Tr·ª±c l√† th·ªß lƒ©nh nghƒ©a qu√¢n ch·ªëng l·∫°i th·ª±c d√¢n Ph√°p x√¢m l∆∞·ª£c ·ªü Nam K·ª≥ v√†o n·ª≠a cu·ªëi th·∫ø k·ª∑ 19 (t·ª´ 1861-1868).'
      },
      {
        q:'Nguy·ªÖn Trung Tr·ª±c ƒë√£ ch·ªâ huy nghƒ©a qu√¢n ƒë·ªët ch√°y t√†u chi·∫øn n√†o c·ªßa Ph√°p tr√™n s√¥ng V√†m C·ªè ƒê√¥ng v√†o nƒÉm 1861, g√¢y ti·∫øng vang l·ªõn?',
        opts:['T√†u Hy V·ªçng (L\'Esp√©rance)','T√†u H·∫±ng T√¢m (La Pers√©v√©rance)','T√†u Jaccar√©','T√†u Avalanche'],
        ans:0,
        explain:'ƒê√°p √°n ƒë√∫ng l√† A. Chi·∫øn c√¥ng n·ªïi ti·∫øng nh·∫•t c·ªßa √¥ng l√† ch·ªâ huy nghƒ©a qu√¢n ƒë·ªët ch√°y ti·ªÉu h·∫°m L\'Esp√©rance (c√≥ t√™n Vi·ªát l√† "Hy V·ªçng") c·ªßa Ph√°p tr√™n s√¥ng V√†m C·ªè ƒê√¥ng nƒÉm 1861.'
      },
      {
        q:'C√¢u n√≥i b·∫•t h·ªß "Bao gi·ªù ng∆∞·ªùi T√¢y nh·ªï h·∫øt c·ªè n∆∞·ªõc Nam th√¨ m·ªõi h·∫øt ng∆∞·ªùi Nam ƒë√°nh T√¢y" ƒë∆∞·ª£c Nguy·ªÖn Trung Tr·ª±c n√≥i trong ho√†n c·∫£nh n√†o?',
        opts:['Khi ƒë·ªông vi√™n nghƒ©a qu√¢n tr∆∞·ªõc tr·∫≠n ƒë√°nh','Khi b·ªã th·ª±c d√¢n Ph√°p d·ª• h√†ng v√† k·∫øt √°n t·ª≠ h√¨nh','Khi tr·∫£ l·ªùi ph·ªèng v·∫•n c·ªßa m·ªôt nh√† b√°o Ph√°p','Trong m·ªôt b·ª©c th∆∞ g·ª≠i cho Tri·ªÅu ƒë√¨nh Hu·∫ø'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. C√¢u n√≥i b·∫•t h·ªß n√†y th·ªÉ hi·ªán kh√≠ ph√°ch ki√™n c∆∞·ªùng c·ªßa √¥ng, ƒë∆∞·ª£c √¥ng th·ªët l√™n khi ƒë·ªëi di·ªán v·ªõi c√°i ch·∫øt, tr∆∞·ªõc s·ª± d·ª• d·ªó c·ªßa k·∫ª th√π.'
      },
      {
        q:'Nguy·ªÖn Trung Tr·ª±c b·ªã th·ª±c d√¢n Ph√°p x·ª≠ ch√©m t·∫°i ƒë√¢u?',
        opts:['S√†i G√≤n','B·∫øn Tre','R·∫°ch Gi√°','C·∫ßn Th∆°'],
        ans:2,
        explain:'ƒê√°p √°n ƒë√∫ng l√† C. Sau khi kh√°ng chi·∫øn ·ªü H√≤n Ch√¥ng th·∫•t b·∫°i v√† b·ªã b·∫Øt, √¥ng b·ªã th·ª±c d√¢n Ph√°p x·ª≠ ch√©m t·∫°i ch·ª£ R·∫°ch Gi√° v√†o ng√†y 27/10/1868 (16/9 nƒÉm M·∫≠u Th√¨n).'
      },
      {
        q:'L·ªÖ h·ªôi t∆∞·ªüng ni·ªám Nguy·ªÖn Trung Tr·ª±c ƒë∆∞·ª£c t·ªï ch·ª©c h·∫±ng nƒÉm v√†o nh·ªØng ng√†y n√†o?',
        opts:['Ch·ªâ ng√†y 27 th√°ng 10 D∆∞∆°ng l·ªãch','T·ª´ ng√†y 26 ƒë·∫øn 28 th√°ng 8 √Çm l·ªãch','Ch·ªâ ng√†y 16 th√°ng 9 √Çm l·ªãch','T·ª´ ng√†y 1 ƒë·∫øn 3 th√°ng 1 D∆∞∆°ng l·ªãch'],
        ans:1,
        explain:'ƒê√°p √°n ƒë√∫ng l√† B. L·ªÖ h·ªôi ch√≠nh K·ª≥ y√™n t·∫°i ƒê√¨nh th·∫ßn Nguy·ªÖn Trung Tr·ª±c ·ªü R·∫°ch Gi√°, Ki√™n Giang ƒë∆∞·ª£c t·ªï ch·ª©c trang tr·ªçng trong 3 ng√†y t·ª´ 26 ƒë·∫øn 28 th√°ng 8 √Çm l·ªãch h·∫±ng nƒÉm, v·ªõi ng√†y ch√°nh gi·ªó (ng√†y hy sinh) l√† 27/8 √Çm l·ªãch.'
      },
      {
        q:'Anh h√πng d√¢n t·ªôc Nguy·ªÖn Trung Tr·ª±c ƒë√£ b·ªã th·ª±c d√¢n Ph√°p h√†nh quy·∫øt v√†o ng√†y n√†o?',
        opts:['Ng√†y 27 th√°ng 10 nƒÉm 1868','Ng√†y 16 th√°ng 9 nƒÉm 1868','Ng√†y 25 th√°ng 10 nƒÉm 1868','Ng√†y 16 th√°ng 9 nƒÉm 1869'],
        ans:0,
        explain:'ƒê√°p √°n ƒë√∫ng l√† A. Nguy·ªÖn Trung Tr·ª±c hy sinh v√†o ng√†y 27 th√°ng 10 nƒÉm 1868.'
      }
    ]
  }
};
/* Start quiz run: show one question at a time with explanation */
let currentQuiz = null;
let currentQIndex = 0;
let selectedOption = null;
function startQuiz(quizId, site){
  const qset = QUIZZES[quizId];
  if(!qset){ alert('Quiz ch∆∞a c√≥ n·ªôi dung.'); return; }
  currentQuiz = {id:quizId, site:site, qset:qset};
  currentQIndex = 0;
  selectedOption = null;
  renderCurrentQuestion();
}
function renderCurrentQuestion(){
  const qobj = currentQuiz.qset.items[currentQIndex];
  
  const html = `
    <div class="quiz-container">
      <div class="quiz-question">
        <h5>C√¢u ${currentQIndex+1} / ${currentQuiz.qset.items.length}</h5>
        <p class="fs-5">${qobj.q}</p>
      </div>
      
      <div class="quiz-options" id="quizOptions">
        ${qobj.opts.map((opt, i) => `
          <div class="quiz-option" data-index="${i}">
            ${opt}
          </div>
        `).join('')}
      </div>
      
      <div class="quiz-feedback" id="quizFeedback"></div>
      
      <div class="quiz-controls">
        <button class="btn btn-outline-secondary" onclick="hideGameFullscreen()">Tho√°t</button>
        <button class="btn btn-accent" id="quizNextBtn" onclick="handleAnswerAndNext()" disabled>Ti·∫øp t·ª•c</button>
      </div>
    </div>
  `;
  
  showGameFullscreen(currentQuiz.qset.title, html);
  
  document.querySelectorAll('.quiz-option').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('.quiz-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      option.classList.add('selected');
      selectedOption = parseInt(option.dataset.index);
      document.getElementById('quizNextBtn').disabled = false;
    });
  });
}
function handleAnswerAndNext(){
  if(selectedOption === null){ 
    alert('Vui l√≤ng ch·ªçn 1 ƒë√°p √°n'); 
    return; 
  }
  
  const qobj = currentQuiz.qset.items[currentQIndex];
  const fb = document.getElementById('quizFeedback');
  
  if(selectedOption === qobj.ans){
    fb.innerHTML = `<div class="correct">‚úì ƒê√°p √°n ƒë√∫ng</div><div class="explain mt-2">${qobj.explain}</div>`;
    fb.className = 'quiz-feedback correct';
  } else {
    fb.innerHTML = `<div class="wrong">‚úó ƒê√°p √°n sai</div><div class="explain mt-2">ƒê√°p √°n ƒë√∫ng: <strong>${qobj.opts[qobj.ans]}</strong><br>${qobj.explain}</div>`;
    fb.className = 'quiz-feedback wrong';
  }
  
  setTimeout(()=> {
    currentQIndex++;
    if(currentQIndex < currentQuiz.qset.items.length){
      selectedOption = null;
      renderCurrentQuestion();
    } else {
      recordDone(currentQuiz.site.id, currentQuiz.id);
      showVictory('üéâ Xu·∫•t s·∫Øc! B·∫°n ƒë√£ ho√†n th√†nh quiz!');
      hideGameFullscreen();
    }
  }, 1500);
}
/* startGameInstance wrapper called from picker */
function startGameInstance(gid, site){
  if(gid.startsWith('quiz_')) startQuiz(gid, site);
  else if(gid.startsWith('memory_')) startMemoryGame(gid, site);
  else { alert('Game ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£'); }
}
/* ---------- initial UI state ---------- */
refreshProfileAuthUI();
renderProfileBadges();
/* ensure map resizes when switching pages */
window.addEventListener('resize', ()=> map.invalidateSize());
</script>
</body>
</html>

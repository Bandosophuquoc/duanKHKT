<!doctype html>
<html lang="vi">
<head>
<!-- Firebase SDK - CHỈ GIỮ LẠI 1 BỘ -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bản đồ số Phú Quốc — Dự án KHKT: Tự hào quê hương</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* CSS của bạn giữ nguyên */
  :root{
    --accent:#C62828; /* đỏ */
    --gold:#FFD54F;
    --bg:#FBFBFB;
    --nature:#A5D6A7; /* Xanh lá pastel */
    --culture:#FFCC80; /* Cam pastel */
    --entertainment:#CE93D8; /* Tím pastel */
    --craft:#EF9A9A; /* Đỏ pastel */
  }
  body{font-family: "Noto Sans", system-ui, sans-serif; background:var(--bg); color:#111;}
  .container-main{max-width:1100px;margin:auto;}
  .logo{width:60px;height:60px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#B71C1C);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:22px}
  .hero{background:linear-gradient(90deg, rgba(198,40,40,0.06), rgba(255,213,79,0.02));padding:22px;border-radius:12px;margin:18px 0}
  .btn-accent{background:linear-gradient(90deg,var(--accent),#EF5350);color:white;border:none}
  #map{height:64vh;border-radius:12px}
  .badge-img{width:56px;height:56px;border-radius:8px;object-fit:cover}
  .marker-emoji{font-size:20px}
  .diatic-title{font-weight:700}
  .game-card{border-radius:10px;background:white;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  footer{padding:18px 0;color:#666;text-align:center;margin-top:18px}
  .correct{color:green;font-weight:700}
  .wrong{color:#c62828;font-weight:700}
  .explain{font-size:0.95rem;color:#444}
  
  /* Overlay khi mở menu */
  .menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    display: none;
  }
  .menu-overlay.active {
    display: block;
  }
  
  /* Menu dropdown */
  .menu-dropdown {
    position: absolute;
    top: 70px;
    right: 10px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    z-index: 1000;
    min-width: 200px;
    display: none;
    overflow: hidden;
  }
  .menu-dropdown.active {
    display: block;
  }
  .menu-item {
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .menu-item:hover {
    background: #f8f9fa;
  }
  .menu-item:last-child {
    border-bottom: none;
  }
  .menu-item.active {
    background: var(--accent);
    color: white;
  }
  
  /* ... (phần CSS còn lại giữ nguyên) ... */
</style>
</head>
<body>
<div class="container container-main py-3">
  <!-- NAV / header -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex gap-3 align-items-center">
      <div class="logo">
        <i class="fas fa-map" style="color:white; font-size: 24px;"></i>
      </div>
      <div>
        <div style="font-weight:800;font-size:1.15rem">Bản đồ số Phú Quốc</div>
        <div style="color:#666;font-size:0.9rem">Dự án KHKT - Giáo dục lòng tự hào dân tộc và tình yêu quê hương đất nước cho tuổi trẻ trường THPT An Thới</div>
      </div>
    </div>
    <div style="position:relative">
      <button id="nav-menu" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-bars me-1"></i>Mục lục
      </button>
      <div class="menu-dropdown" id="menuDropdown">
        <div class="menu-item active" data-page="home">
          <i class="fas fa-home"></i>Trang chủ
        </div>
        <div class="menu-item" data-page="map">
          <i class="fas fa-map-marked-alt"></i>Bản đồ số
        </div>
        <div class="menu-item" data-page="stories">
          <i class="fas fa-book-open"></i>PQ Stories
        </div>
        <div class="menu-item" data-page="profile">
          <i class="fas fa-user"></i>Trang cá nhân
        </div>
        <div class="menu-item" data-page="analytics">
          <i class="fas fa-chart-bar"></i>Thống kê
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay khi menu mở -->
  <div class="menu-overlay" id="menuOverlay"></div>

  <!-- HOME -->
  <section id="page-home">
    <div class="hero">
      <h1 style="margin:0;color:var(--accent)">Bản đồ số Phú Quốc</h1>
      <p style="margin-top:10px;margin-bottom:8px; font-size: 1.1rem; line-height: 1.6;">
        <strong>Hành trình về nguồn chưa bao giờ sống động và cảm xúc đến thế!</strong>
      </p>
      <p style="margin:0 0 6px 0;color:#444; line-height: 1.6">
        Bản Đồ Số Phú Quốc không chỉ là một website, đó là cây cầu kết nối thế hệ trẻ với hành trình đầy tự hào của cha ông. Chúng tôi mời bạn bước vào một thế giới nơi mỗi di tích là một câu chuyện chờ được kể, mỗi nhân vật lịch sử là một người hùng chờ được thấu hiểu.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        Tại đây, bạn sẽ:<br>
        • Chạm vào lịch sử bằng cảm xúc chân thật nhất.<br>
        • Khám phá vẻ đẹp của quê hương qua lăng kính mới mẻ, trực quan.<br>
        • Rèn luyện tư duy phản biện và kỹ năng kể chuyện để trở thành những đại sứ văn hóa tương lai.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        Hãy để chúng tôi đồng hành cùng bạn trên hành trình khơi dậy lòng tự hào dân tộc và tình yêu với mảnh đất Phú Quốc anh hùng.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        Bản đồ số là giải pháp thuộc khuôn khổ dự án khoa học kĩ thuật "<strong>Giáo dục lòng tự hào dân tộc và tình yêu quê hương đất nước cho tuổi trẻ THPT An Thới</strong>".
      </p>
      <div class="mt-3">
        <button id="btn-start" class="btn btn-accent btn-lg">Bắt đầu khám phá</button>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-md-12">
        <div class="game-card">
          <h5>Hướng dẫn nhanh</h5>
          <ol style="padding-left:18px">
            <li>Nhấn "Bắt đầu khám phá" để sang trang bản đồ</li>
            <li>Click marker để xem thông tin; nếu có mini-game, bấm "Chơi"</li>
            <li>Truy cập "PQ Stories" để chia sẻ ký ức của bạn</li>
            <li>Vào "Trang cá nhân" để xem thành tích và huy hiệu</li>
            <li>Xem "Thống kê" để theo dõi hoạt động trang web</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- MAP PAGE -->
  <section id="page-map" style="display:none">
    <div id="map" class="mb-3"></div>
  </section>

  <!-- PQ STORIES PAGE -->
  <section id="page-stories" style="display:none">
    <div class="stories-hero">
      <h1>PQ Stories</h1>
      <p>Nơi bạn chia sẻ và lan toả những câu chuyện đẹp về Phú Quốc</p>
    </div>
    
    <div class="stories-wall-container">
      <div class="stories-wall-new" id="storiesWallNew">
        <!-- Stories will be dynamically added here -->
      </div>
    </div>
    
    <div class="add-story-btn-container">
      <button class="add-story-btn" id="addStoryBtn">
        <i class="fas fa-plus"></i>
        Kể câu chuyện của riêng bạn tại đây
      </button>
    </div>
  </section>

  <!-- PROFILE PAGE -->
  <section id="page-profile" style="display:none">
    <div class="profile-container">
      <div class="profile-header">
        <h2>Trang Cá Nhân</h2>
        <p class="mb-0">Quản lý tài khoản và xem thành tích của bạn</p>
      </div>
      <div class="profile-auth">
        <h4 class="mb-3">Tài khoản</h4>
        <div id="profile-info" class="alert alert-info">
          Bạn chưa đăng nhập. Vui lòng đăng nhập để lưu tiến trình và nhận huy hiệu.
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button id="btn-profile-register" class="btn btn-outline-dark">Đăng ký</button>
          <button id="btn-profile-login" class="btn btn-dark">Đăng nhập</button>
          <button id="btn-profile-logout" class="btn btn-outline-secondary" style="display:none">Đăng xuất</button>
        </div>
      </div>
      <div class="profile-badges">
        <h4 class="mb-3">Huy hiệu của bạn</h4>
        <div style="color:#666;font-size:0.9rem" class="mb-3">Khi hoàn thành các điều kiện, huy hiệu sẽ hiện ở đây.</div>
        <div id="profile-badge-area" class="d-flex gap-3 flex-wrap justify-content-center">
          <!-- Badges will appear here -->
        </div>
      </div>
    </div>
  </section>

  <!-- ANALYTICS PAGE -->
  <section id="page-analytics" style="display:none">
    <div class="profile-container">
      <div class="profile-header">
        <h2>Thống kê & Phân tích</h2>
        <p class="mb-0">Theo dõi hoạt động và tương tác trên trang web</p>
      </div>
      
      <div class="analytics-dashboard">
        <h4 class="mb-4">Tổng quan hoạt động</h4>
        
        <div class="row">
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div class="stat-number" id="totalVisitors">0</div>
              <div class="stat-label">Tổng lượt truy cập</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div class="stat-number" id="uniqueVisitors">0</div>
              <div class="stat-label">Người dùng duy nhất</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div class="stat-number" id="registeredUsers">0</div>
              <div class="stat-label">Người dùng đăng ký</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div class="stat-number" id="totalStories">0</div>
              <div class="stat-label">Câu chuyện đã đăng</div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="chart-container">
              <h5>Lượt truy cập theo trang</h5>
              <div id="pageViewsChart">
                <!-- Chart will be rendered here -->
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="chart-container">
              <h5>Thiết bị truy cập</h5>
              <div id="deviceChart">
                <!-- Chart will be rendered here -->
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-12">
            <div class="chart-container">
              <h5>Hoạt động gần đây</h5>
              <div id="recentActivity">
                <!-- Recent activity will be shown here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer>
    Dự án KHKT — THPT An Thới \
  </footer>
</div>

<!-- Các modal khác giữ nguyên -->
<!-- Story Modal -->
<div class="story-modal-overlay" id="storyModalOverlay">
  <!-- ... nội dung modal ... -->
</div>

<!-- Success Message -->
<div class="success-message" id="successMessage">
  <!-- ... nội dung success message ... -->
</div>

<!-- DI TÍCH MODAL -->
<div class="modal fade" id="diModal" tabindex="-1">
  <!-- ... nội dung modal ... -->
</div>

<!-- GAME FULLSCREEN MODE -->
<div id="gameFullscreen" class="game-fullscreen">
  <!-- ... nội dung game ... -->
</div>

<!-- VICTORY POPUP -->
<div id="victoryPopup" class="victory-popup" style="display:none">
  <!-- ... nội dung victory ... -->
</div>

<!-- AUTH modal -->
<div class="modal fade" id="authModal" tabindex="-1">
  <!-- ... nội dung auth modal ... -->
</div>

<!-- Badge Popup Modal -->
<div id="badgePopup" class="badge-popup" style="display:none">
  <!-- ... nội dung badge popup ... -->
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
// ĐẶT TOÀN BỘ CODE JAVASCRIPT TRONG MỘT HÀM DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing app...');

/* ---------------------------
  CẬP NHẬT: Thêm tính năng Menu, PQ Stories và Hệ thống đăng ký/đăng nhập
----------------------------*/

// Biến toàn cục mới
let currentPage = 'home';
let stories = [];

/* ---------- HỆ THỐNG ĐĂNG KÝ/ĐĂNG NHẬP ---------- */
const STORAGE_USERS = 'pq_users_v2';
const STORAGE_SESSIONS = 'pq_sessions_v1';
const STORAGE_ANALYTICS = 'pq_analytics_v1';

// Khởi tạo dữ liệu
function initData() {
  // Khởi tạo users nếu chưa có
  if (!localStorage.getItem(STORAGE_USERS)) {
    localStorage.setItem(STORAGE_USERS, JSON.stringify([]));
  }
  
  // Khởi tạo analytics nếu chưa có
  if (!localStorage.getItem(STORAGE_ANALYTICS)) {
    const initialAnalytics = {
      totalVisits: 0,
      uniqueVisitors: new Set(),
      pageViews: {
        home: 0,
        map: 0,
        stories: 0,
        profile: 0,
        analytics: 0
      },
      devices: {
        desktop: 0,
        mobile: 0,
        tablet: 0
      },
      userActions: [],
      registeredUsers: 0
    };
    localStorage.setItem(STORAGE_ANALYTICS, JSON.stringify(initialAnalytics));
  }
  
  // Ghi nhận lượt truy cập
  recordVisit();
}

// Ghi nhận lượt truy cập
function recordVisit() {
  const analytics = getAnalytics();
  analytics.totalVisits++;
  
  // Tạo visitor ID nếu chưa có
  let visitorId = localStorage.getItem('pq_visitor_id');
  if (!visitorId) {
    visitorId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('pq_visitor_id', visitorId);
  }
  
  analytics.uniqueVisitors.add(visitorId);
  
  // Xác định thiết bị
  const userAgent = navigator.userAgent.toLowerCase();
  if (/mobile|android|iphone|ipad/.test(userAgent)) {
    analytics.devices.mobile++;
  } else if (/tablet|ipad/.test(userAgent)) {
    analytics.devices.tablet++;
  } else {
    analytics.devices.desktop++;
  }
  
  // Ghi nhận hành động
  analytics.userActions.push({
    type: 'page_visit',
    page: currentPage,
    timestamp: new Date().toISOString(),
    visitorId: visitorId
  });
  
  // Giới hạn số lượng hành động lưu trữ
  if (analytics.userActions.length > 1000) {
    analytics.userActions = analytics.userActions.slice(-500);
  }
  
  saveAnalytics(analytics);
}

// Ghi nhận lượt xem trang
function recordPageView(page) {
  const analytics = getAnalytics();
  if (analytics.pageViews[page] !== undefined) {
    analytics.pageViews[page]++;
    
    analytics.userActions.push({
      type: 'page_view',
      page: page,
      timestamp: new Date().toISOString(),
      visitorId: localStorage.getItem('pq_visitor_id')
    });
    
    saveAnalytics(analytics);
  }
}

// Lấy dữ liệu analytics
function getAnalytics() {
  const data = JSON.parse(localStorage.getItem(STORAGE_ANALYTICS) || '{}');
  // Khôi phục Set từ Array
  if (data.uniqueVisitors && Array.isArray(data.uniqueVisitors)) {
    data.uniqueVisitors = new Set(data.uniqueVisitors);
  }
  return data;
}

// Lưu dữ liệu analytics
function saveAnalytics(analytics) {
  // Chuyển Set thành Array để lưu trữ
  const dataToSave = {
    ...analytics,
    uniqueVisitors: Array.from(analytics.uniqueVisitors)
  };
  localStorage.setItem(STORAGE_ANALYTICS, JSON.stringify(dataToSave));
}

// Hiển thị analytics
function renderAnalytics() {
  const analytics = getAnalytics();
  
  // Cập nhật số liệu
  document.getElementById('totalVisitors').textContent = analytics.totalVisits;
  document.getElementById('uniqueVisitors').textContent = analytics.uniqueVisitors.size;
  document.getElementById('registeredUsers').textContent = analytics.registeredUsers || 0;
  document.getElementById('totalStories').textContent = stories.length;
  
  // Hiển thị lượt xem trang
  const pageViewsHtml = Object.entries(analytics.pageViews).map(([page, views]) => `
    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
      <span>${getPageName(page)}</span>
      <span class="badge bg-primary">${views}</span>
    </div>
  `).join('');
  document.getElementById('pageViewsChart').innerHTML = pageViewsHtml || '<p class="text-muted">Chưa có dữ liệu</p>';
  
  // Hiển thị thiết bị
  const deviceHtml = Object.entries(analytics.devices).map(([device, count]) => `
    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
      <span>${getDeviceName(device)}</span>
      <span class="badge bg-info">${count}</span>
    </div>
  `).join('');
  document.getElementById('deviceChart').innerHTML = deviceHtml || '<p class="text-muted">Chưa có dữ liệu</p>';
  
  // Hiển thị hoạt động gần đây
  const recentActions = analytics.userActions.slice(-10).reverse();
  const activityHtml = recentActions.map(action => `
    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
      <div>
        <small class="text-muted">${formatTimeAgo(action.timestamp)}</small>
        <div>${getActionDescription(action)}</div>
      </div>
    </div>
  `).join('');
  document.getElementById('recentActivity').innerHTML = activityHtml || '<p class="text-muted">Chưa có hoạt động nào</p>';
}

function getPageName(page) {
  const pages = {
    home: 'Trang chủ',
    map: 'Bản đồ',
    stories: 'PQ Stories',
    profile: 'Trang cá nhân',
    analytics: 'Thống kê'
  };
  return pages[page] || page;
}

function getDeviceName(device) {
  const devices = {
    desktop: 'Máy tính',
    mobile: 'Điện thoại',
    tablet: 'Máy tính bảng'
  };
  return devices[device] || device;
}

function getActionDescription(action) {
  switch (action.type) {
    case 'page_visit':
      return `Truy cập ${getPageName(action.page)}`;
    case 'page_view':
      return `Xem ${getPageName(action.page)}`;
    case 'user_register':
      return 'Đăng ký tài khoản mới';
    case 'user_login':
      return 'Đăng nhập';
    case 'story_post':
      return 'Đăng câu chuyện mới';
    default:
      return action.type;
  }
}

/* ---------- HỆ THỐNG NGƯỜI DÙNG ---------- */
function getUsers() {
  return JSON.parse(localStorage.getItem(STORAGE_USERS) || '[]');
}

function saveUsers(users) {
  localStorage.setItem(STORAGE_USERS, JSON.stringify(users));
}

function findUserByEmail(email) {
  const users = getUsers();
  return users.find(user => user.email === email);
}

function registerUser(name, email, password) {
  const users = getUsers();
  
  // Kiểm tra email đã tồn tại
  if (findUserByEmail(email)) {
    return { success: false, message: 'Email đã được sử dụng' };
  }
  
  // Tạo user mới
  const newUser = {
    id: 'user_' + Date.now(),
    name: name,
    email: email,
    password: password, // Trong thực tế nên mã hóa password
    createdAt: new Date().toISOString(),
    badges: [],
    visitedSites: [],
    completedGames: {}
  };
  
  users.push(newUser);
  saveUsers(users);
  
  // Cập nhật analytics
  const analytics = getAnalytics();
  analytics.registeredUsers = users.length;
  analytics.userActions.push({
    type: 'user_register',
    email: email,
    timestamp: new Date().toISOString()
  });
  saveAnalytics(analytics);
  
  return { success: true, user: newUser };
}

function loginUser(email, password) {
  const user = findUserByEmail(email);
  
  if (!user) {
    return { success: false, message: 'Email không tồn tại' };
  }
  
  if (user.password !== password) {
    return { success: false, message: 'Mật khẩu không đúng' };
  }
  
  // Tạo session
  const session = {
    userId: user.id,
    token: 'token_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // 7 ngày
  };
  
  localStorage.setItem(STORAGE_SESSIONS, JSON.stringify(session));
  
  // Cập nhật analytics
  const analytics = getAnalytics();
  analytics.userActions.push({
    type: 'user_login',
    email: email,
    timestamp: new Date().toISOString()
  });
  saveAnalytics(analytics);
  
  return { success: true, user: user };
}

function getCurrentUser() {
  const session = JSON.parse(localStorage.getItem(STORAGE_SESSIONS) || 'null');
  
  if (!session || new Date(session.expiresAt) < new Date()) {
    // Session hết hạn
    localStorage.removeItem(STORAGE_SESSIONS);
    return null;
  }
  
  const users = getUsers();
  return users.find(user => user.id === session.userId) || null;
}

function logoutUser() {
  localStorage.removeItem(STORAGE_SESSIONS);
  return { success: true };
}

function updateUser(user) {
  const users = getUsers();
  const index = users.findIndex(u => u.id === user.id);
  if (index !== -1) {
    users[index] = user;
    saveUsers(users);
    return true;
  }
  return false;
}

/* ---------- Menu Navigation ---------- */
const menuBtn = document.getElementById('nav-menu');
const menuDropdown = document.getElementById('menuDropdown');
const menuOverlay = document.getElementById('menuOverlay');
const menuItems = document.querySelectorAll('.menu-item');

console.log('Menu elements:', {menuBtn, menuDropdown, menuOverlay, menuItems});

// Toggle menu
if (menuBtn) {
  menuBtn.addEventListener('click', (e) => {
    console.log('Menu button clicked');
    e.stopPropagation();
    menuDropdown.classList.toggle('active');
    menuOverlay.classList.toggle('active');
  });
}

// Đóng menu khi click overlay
if (menuOverlay) {
  menuOverlay.addEventListener('click', () => {
    console.log('Menu overlay clicked');
    menuDropdown.classList.remove('active');
    menuOverlay.classList.remove('active');
  });
}

// Xử lý chọn menu item
if (menuItems.length > 0) {
  menuItems.forEach(item => {
    item.addEventListener('click', () => {
      const page = item.dataset.page;
      console.log('Menu item clicked:', page);
      showPage(page);
      menuDropdown.classList.remove('active');
      menuOverlay.classList.remove('active');
      
      // Cập nhật active state
      menuItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
    });
  });
}

// Hàm hiển thị trang
function showPage(page) {
  console.log('Showing page:', page);
  // Ẩn tất cả các trang
  document.querySelectorAll('section[id^="page-"]').forEach(section => {
    section.style.display = 'none';
  });
  
  // Hiển thị trang được chọn
  const targetPage = document.getElementById(`page-${page}`);
  if (targetPage) {
    targetPage.style.display = 'block';
    
    // Ghi nhận lượt xem trang
    recordPageView(page);
    
    // Xử lý đặc biệt cho từng trang
    if (page === 'map') {
      setTimeout(() => {
        if (typeof map !== 'undefined') {
          map.invalidateSize();
        }
      }, 300);
    } else if (page === 'stories') {
      loadStories();
    } else if (page === 'analytics') {
      renderAnalytics();
    }
    
    currentPage = page;
  } else {
    console.error('Page not found:', `page-${page}`);
  }
}

/* ---------- NEW PQ STORIES FUNCTIONALITY ---------- */
const addStoryBtn = document.getElementById('addStoryBtn');
const storyModalOverlay = document.getElementById('storyModalOverlay');
const storyModalClose = document.getElementById('storyModalClose');
const storyFormNew = document.getElementById('storyFormNew');
const uploadAreaNew = document.getElementById('uploadAreaNew');
const fileInputNew = document.getElementById('fileInputNew');
const filePreviewNew = document.getElementById('filePreviewNew');
const storiesWallNew = document.getElementById('storiesWallNew');
const storyContentNew = document.getElementById('storyContentNew');
const wordCount = document.getElementById('wordCount');
const btnPostStory = document.getElementById('btnPostStory');
const successMessage = document.getElementById('successMessage');
const successClose = document.getElementById('successClose');

// Mở modal khi click nút thêm story
if (addStoryBtn) {
  addStoryBtn.addEventListener('click', () => {
    console.log('Add story button clicked');
    const user = getCurrentUser();
    if (!user) {
      alert('Vui lòng đăng nhập để chia sẻ câu chuyện.');
      showPage('profile');
      return;
    }
    storyModalOverlay.classList.add('active');
  });
}

// Đóng modal
if (storyModalClose) {
  storyModalClose.addEventListener('click', () => {
    storyModalOverlay.classList.remove('active');
  });
}

// Đóng modal khi click bên ngoài
if (storyModalOverlay) {
  storyModalOverlay.addEventListener('click', (e) => {
    if (e.target === storyModalOverlay) {
      storyModalOverlay.classList.remove('active');
    }
  });
}

// Upload area click
if (uploadAreaNew) {
  uploadAreaNew.addEventListener('click', () => {
    fileInputNew.click();
  });
}

// File input change
if (fileInputNew) {
  fileInputNew.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        let previewHTML = '';
        
        if (file.type.startsWith('image/')) {
          previewHTML = `<img src="${e.target.result}" alt="Preview">`;
        } else if (file.type.startsWith('video/')) {
          previewHTML = `<video controls><source src="${e.target.result}" type="${file.type}">Trình duyệt của bạn không hỗ trợ video.</video>`;
        } else if (file.type.startsWith('audio/')) {
          previewHTML = `<audio controls><source src="${e.target.result}" type="${file.type}">Trình duyệt của bạn không hỗ trợ audio.</audio>`;
        } else {
          previewHTML = `<p>File: ${file.name}</p>`;
        }
        
        previewHTML += `<button class="remove-file" onclick="removeFile()">Xóa</button>`;
        filePreviewNew.innerHTML = previewHTML;
        filePreviewNew.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  });
}

// Xóa file preview
window.removeFile = function() {
  filePreviewNew.style.display = 'none';
  fileInputNew.value = '';
}

// Đếm số từ
if (storyContentNew) {
  storyContentNew.addEventListener('input', () => {
    const content = storyContentNew.value;
    const words = content.trim() === '' ? 0 : content.trim().split(/\s+/).length;
    wordCount.textContent = `${words}/200 từ`;
    
    if (words > 200) {
      wordCount.classList.add('warning');
      btnPostStory.disabled = true;
    } else {
      wordCount.classList.remove('warning');
      btnPostStory.disabled = false;
    }
  });
}

// Story form submit
if (btnPostStory) {
  btnPostStory.addEventListener('click', (e) => {
    e.preventDefault();
    
    const title = document.getElementById('storyTitleNew').value;
    const content = document.getElementById('storyContentNew').value;
    const user = getCurrentUser();
    
    if (!user) {
      alert('Vui lòng đăng nhập để chia sẻ câu chuyện.');
      return;
    }
    
    if (!title || !content) {
      alert('Vui lòng điền tiêu đề và nội dung câu chuyện.');
      return;
    }
    
    const words = content.trim().split(/\s+/).length;
    if (words > 200) {
      alert('Nội dung câu chuyện vượt quá 200 từ. Vui lòng rút gọn.');
      return;
    }
    
    const newStory = {
      id: Date.now(),
      title: title,
      content: content,
      author: user.name,
      authorId: user.id,
      timestamp: new Date().toISOString(),
      likes: 0,
      comments: [],
      liked: false,
      media: fileInputNew.files[0] ? URL.createObjectURL(fileInputNew.files[0]) : null,
      mediaType: fileInputNew.files[0] ? fileInputNew.files[0].type : null,
      colorClass: `note-color-${Math.floor(Math.random() * 8) + 1}`
    };
    
    // Thêm story vào mảng
    stories.unshift(newStory);
    
    // Lưu vào localStorage
    saveStories();
    
    // Cập nhật giao diện
    renderStories();
    
    // Đóng modal
    storyModalOverlay.classList.remove('active');
    
    // Reset form
    storyFormNew.reset();
    filePreviewNew.style.display = 'none';
    fileInputNew.value = '';
    wordCount.textContent = '0/200 từ';
    wordCount.classList.remove('warning');
    
    // Hiển thị thông báo thành công
    showSuccessMessage();
  });
}

// Hiển thị thông báo thành công
function showSuccessMessage() {
  successMessage.classList.add('show');
  
  // Tự động ẩn sau 5 giây
  setTimeout(() => {
    successMessage.classList.remove('show');
  }, 5000);
}

// Đóng thông báo thành công
if (successClose) {
  successClose.addEventListener('click', () => {
    successMessage.classList.remove('show');
  });
}

// Load stories từ localStorage
function loadStories() {
  const savedStories = localStorage.getItem('pq_stories');
  if (savedStories) {
    stories = JSON.parse(savedStories);
  }
  renderStories();
}

// Save stories to localStorage
function saveStories() {
  localStorage.setItem('pq_stories', JSON.stringify(stories));
}

// Render stories
function renderStories() {
  if (!storiesWallNew) return;
  
  storiesWallNew.innerHTML = '';
  
  if (stories.length === 0) {
    storiesWallNew.innerHTML = `
      <div class="col-12 text-center py-5" style="grid-column: 1 / -1;">
        <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Chưa có câu chuyện nào</h4>
        <p class="text-muted">Hãy là người đầu tiên chia sẻ ký ức về Phú Quốc!</p>
      </div>
    `;
    return;
  }
  
  stories.forEach(story => {
    const storyElement = document.createElement('div');
    storyElement.className = `story-note-new ${story.colorClass}`;
    storyElement.innerHTML = `
      <div>
        <h3>${story.title}</h3>
        ${story.media ? (
          story.mediaType.startsWith('image/') ? 
            `<img src="${story.media}" alt="${story.title}" class="story-media-new">` :
          story.mediaType.startsWith('video/') ? 
            `<video controls class="story-media-new"><source src="${story.media}" type="${story.mediaType}">Trình duyệt của bạn không hỗ trợ video.</video>` :
          story.mediaType.startsWith('audio/') ? 
            `<audio controls class="story-media-new"><source src="${story.media}" type="${story.mediaType}">Trình duyệt của bạn không hỗ trợ audio.</audio>` :
            ''
        ) : ''}
        <div class="story-content-new">${story.content}</div>
      </div>
      <div>
        <div class="story-meta-new">
          <span>${story.author}</span>
          <span>${formatTimeAgo(story.timestamp)}</span>
        </div>
        <div class="story-actions-new">
          <div class="story-action-new ${story.liked ? 'liked' : ''}" onclick="likeStory(${story.id})">
            <i class="fas fa-heart"></i>
            <span>${story.likes}</span>
          </div>
          <div class="story-action-new" onclick="toggleComments(${story.id})">
            <i class="fas fa-comment"></i>
            <span>${story.comments.length}</span>
          </div>
        </div>
        <div class="story-comments" id="comments-${story.id}">
          ${story.comments.map(comment => `
            <div class="story-comment">
              <div class="story-comment-author">${comment.author}</div>
              <div class="story-comment-content">${comment.content}</div>
            </div>
          `).join('')}
          <div class="add-comment-form">
            <input type="text" class="add-comment-input" id="comment-input-${story.id}" placeholder="Viết bình luận...">
            <button class="add-comment-btn" onclick="addComment(${story.id})">Gửi</button>
          </div>
        </div>
      </div>
    `;
    storiesWallNew.appendChild(storyElement);
  });
}

// Like story function
window.likeStory = function(storyId) {
  const user = getCurrentUser();
  if (!user) {
    alert('Vui lòng đăng nhập để thích câu chuyện.');
    return;
  }
  
  const story = stories.find(s => s.id === storyId);
  if (story) {
    if (story.liked) {
      story.likes--;
      story.liked = false;
    } else {
      story.likes++;
      story.liked = true;
    }
    saveStories();
    renderStories();
  }
}

// Toggle comments
window.toggleComments = function(storyId) {
  const commentsDiv = document.getElementById(`comments-${storyId}`);
  if (commentsDiv.style.display === 'block') {
    commentsDiv.style.display = 'none';
  } else {
    commentsDiv.style.display = 'block';
  }
}

// Add comment
window.addComment = function(storyId) {
  const user = getCurrentUser();
  if (!user) {
    alert('Vui lòng đăng nhập để bình luận.');
    return;
  }
  
  const commentInput = document.getElementById(`comment-input-${storyId}`);
  const content = commentInput.value.trim();
  
  if (!content) {
    alert('Vui lòng nhập nội dung bình luận.');
    return;
  }
  
  const story = stories.find(s => s.id === storyId);
  if (story) {
    story.comments.push({
      author: user.name,
      content: content,
      timestamp: new Date().toISOString()
    });
    saveStories();
    renderStories();
    commentInput.value = '';
  }
}

// Format time ago
function formatTimeAgo(timestamp) {
  const now = new Date();
  const storyTime = new Date(timestamp);
  const diffInSeconds = Math.floor((now - storyTime) / 1000);
  
  if (diffInSeconds < 60) return 'Vừa xong';
  if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} phút trước`;
  if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} giờ trước`;
  return `${Math.floor(diffInSeconds / 86400)} ngày trước`;
}

/* ---------------------------
  Dữ liệu điểm (đã cập nhật với tọa độ chính xác của bạn)
----------------------------*/
const DI_TICH = [
  // ... (dữ liệu DI_TICH giữ nguyên) ...
];

/* -----------------------
  Local storage keys
------------------------*/
const STORAGE_USER = 'pq_user_v1';
const STORAGE_BADGES = 'pq_badges_v1';
const STORAGE_DONE = 'pq_done_games_v1';
const STORAGE_VISIT = 'pq_visited_v1';
const STORAGE_STORIES = 'pq_stories';

/* --------- Helpers ------------- */
function saveUser(u){ localStorage.setItem(STORAGE_USER, JSON.stringify(u)) }
function loadUser(){ return JSON.parse(localStorage.getItem(STORAGE_USER) || 'null') }
function loadBadges(){ return JSON.parse(localStorage.getItem(STORAGE_BADGES) || '[]') }
function saveBadges(a){ localStorage.setItem(STORAGE_BADGES, JSON.stringify(a)) }
function loadDone(){ return JSON.parse(localStorage.getItem(STORAGE_DONE) || '{}') }
function saveDone(o){ localStorage.setItem(STORAGE_DONE, JSON.stringify(o)) }
function loadVisited(){ return JSON.parse(localStorage.getItem(STORAGE_VISIT) || '[]') }
function saveVisited(a){ localStorage.setItem(STORAGE_VISIT, JSON.stringify(a)) }
function saveStories(){ localStorage.setItem(STORAGE_STORIES, JSON.stringify(stories)) }

/* ---------- UI & Navigation ---------- */
const btnStart = document.getElementById('btn-start');

// Cập nhật sự kiện cho nút Bắt đầu khám phá
if (btnStart) {
  btnStart.addEventListener('click', () => { 
    console.log('Start button clicked');
    showPage('map'); 
    window.scrollTo(0,0); 
  });
}

/* Auth modal */
const authModal = new bootstrap.Modal(document.getElementById('authModal'));

// Đăng ký
const btnProfileRegister = document.getElementById('btn-profile-register');
if (btnProfileRegister) {
  btnProfileRegister.addEventListener('click', ()=> {
    document.getElementById('authTitle').innerText = 'Đăng ký'; 
    document.getElementById('authSubmit').onclick = authRegister; 
    document.getElementById('authAlert').classList.add('d-none');
    authModal.show();
  });
}

// Đăng nhập
const btnProfileLogin = document.getElementById('btn-profile-login');
if (btnProfileLogin) {
  btnProfileLogin.addEventListener('click', ()=> {
    document.getElementById('authTitle').innerText = 'Đăng nhập'; 
    document.getElementById('authSubmit').onclick = authLogin; 
    document.getElementById('authAlert').classList.add('d-none');
    authModal.show();
  });
}

// Đăng xuất
const btnProfileLogout = document.getElementById('btn-profile-logout');
if (btnProfileLogout) {
  btnProfileLogout.addEventListener('click', ()=> {
    logoutUser();
    refreshProfileAuthUI();
    alert('Đăng xuất thành công.');
  });
}

/* auth functions */
function authRegister(){
  const name = document.getElementById('inName').value.trim();
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  if(!name || !email || !pass){ showAuthError('Điền đủ tên, email, mật khẩu'); return; }
  
  const result = registerUser(name, email, pass);
  if (result.success) {
    alert('Đăng ký thành công. Vui lòng đăng nhập.');
    authModal.hide();
  } else {
    showAuthError(result.message);
  }
}

function authLogin(){
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  
  const result = loginUser(email, pass);
  if (result.success) {
    authModal.hide();
    refreshProfileAuthUI();
    alert('Đăng nhập thành công. Xin chào ' + result.user.name);
  } else {
    showAuthError(result.message);
  }
}

function showAuthError(msg){ 
  const a=document.getElementById('authAlert'); 
  a.innerText=msg; 
  a.classList.remove('d-none'); 
}

function refreshProfileAuthUI(){
  const u = getCurrentUser();
  const profileInfo = document.getElementById('profile-info');
  const btnLogin = document.getElementById('btn-profile-login');
  const btnRegister = document.getElementById('btn-profile-register');
  const btnLogout = document.getElementById('btn-profile-logout');
  
  if(u){ 
    if (btnLogin) btnLogin.style.display='none'; 
    if (btnRegister) btnRegister.style.display='none'; 
    if (btnLogout) btnLogout.style.display='inline-block'; 
    if (profileInfo) {
      profileInfo.innerHTML = `Xin chào <strong>${u.name}</strong> — ${u.email}`;
      profileInfo.className = 'alert alert-success';
    }
    renderUserBadges(u);
  } else { 
    if (btnLogin) btnLogin.style.display='inline-block'; 
    if (btnRegister) btnRegister.style.display='inline-block'; 
    if (btnLogout) btnLogout.style.display='none'; 
    if (profileInfo) {
      profileInfo.innerHTML = 'Bạn chưa đăng nhập. Vui lòng đăng nhập để lưu tiến trình và nhận huy hiệu.';
      profileInfo.className = 'alert alert-info';
    }
    renderProfileBadges();
  }
}

function renderUserBadges(user) {
  const wrap = document.getElementById('profile-badge-area');
  if (!wrap) return;
  
  wrap.innerHTML = '';
  
  if(!user.badges || user.badges.length === 0) {
    wrap.innerHTML = '<div class="text-muted">Chưa có huy hiệu nào. Hãy khám phá các địa điểm và hoàn thành thử thách!</div>';
    return;
  }
  
  user.badges.forEach(b=>{
    const el = document.createElement('div');
    el.className = 'text-center';
    el.innerHTML = `
      <img src="${b.icon}" class="badge-img" alt="${b.name}">
      <div style="font-size:12px; max-width:80px">${b.name}</div>
    `;
    wrap.appendChild(el);
  });
}

/* ---------- Map init ---------- */
let map;
if (document.getElementById('map')) {
  map = L.map('map', {zoomControl:true}).setView([10.28,103.98], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);

  // Tạo tooltip cho marker
  let currentTooltip = null;

  function createCustomIcon(category, hasGame) {
    const colorMap = {
      'nature': '#A5D6A7', // Xanh lá pastel
      'culture': '#FFCC80', // Cam pastel
      'entertainment': '#CE93D8', // Tím pastel
      'craft': '#EF9A9A' // Đỏ pastel
    };
    
    const color = colorMap[category] || '#90CAF9';
    
    return L.divIcon({
      className: 'custom-pin',
      html: `
        <div style="
          background: ${color}; 
          width: 24px; 
          height: 24px; 
          border-radius: 50%; 
          border: 3px solid white;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        "></div>
      `,
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });
  }

  /* render markers */
  DI_TICH.forEach(p=>{
    const m = L.marker([p.lat,p.lng], {icon: createCustomIcon(p.category, p.games.length>0)}).addTo(map);
    
    // Thêm tooltip khi hover
    m.on('mouseover', function(e) {
      if (currentTooltip) {
        document.body.removeChild(currentTooltip);
      }
      
      currentTooltip = document.createElement('div');
      currentTooltip.className = 'marker-tooltip';
      currentTooltip.textContent = p.name;
      
      const point = map.latLngToContainerPoint(e.latlng);
      currentTooltip.style.left = (point.x + 20) + 'px';
      currentTooltip.style.top = (point.y - 10) + 'px';
      
      document.body.appendChild(currentTooltip);
    });
    
    m.on('mouseout', function() {
      if (currentTooltip) {
        document.body.removeChild(currentTooltip);
        currentTooltip = null;
      }
    });
    
    // SỬA LẠI PHẦN NÀY - Đảm bảo sự kiện click được xử lý đúng
    m.on('click', function(e) {
      // Đóng tooltip nếu đang mở
      if (currentTooltip) {
        document.body.removeChild(currentTooltip);
        currentTooltip = null;
      }
      openDiModal(p);
    });
    
    // Thêm popup cơ bản để test
    m.bindPopup(`<strong>${p.name}</strong><br>${p.address}`, {
      closeButton: true,
      autoClose: false
    });
  });
}

/* modal instances */
const diModal = new bootstrap.Modal(document.getElementById('diModal'));

/* open di tích modal (with details) */
function openDiModal(p){
  document.getElementById('diTitle').innerText = p.name;
  const extras = p.extra.map(x=>`<li>${x}</li>`).join('');
  const html = `
    <div class="row">
      <div class="col-md-5"><img src="${p.img}" alt="${p.name}" style="width:100%;border-radius:8px;object-fit:cover"></div>
      <div class="col-md-7">
        <h5 class="diatic-title">${p.name}</h5>
        <p style="margin:0">${p.address}</p>
        <p style="margin-top:8px;color:#333">${p.note}</p>
        ${extras ? `<ul>${extras}</ul>` : ''}
      </div>
    </div>
  `;
  document.getElementById('diBody').innerHTML = html;
  document.getElementById('diCoords').innerText = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
  const btnPlay = document.getElementById('btn-play');
  if(p.games && p.games.length){
    btnPlay.style.display='inline-block';
    btnPlay.onclick = ()=> { diModal.hide(); openGamePicker(p); };
  } else { btnPlay.style.display='none'; btnPlay.onclick=null; }
  // check-in button
  document.getElementById('btn-checkin').onclick = ()=> {
    const u = getCurrentUser();
    if(!u){ alert('Vui lòng đăng nhập trước khi check-in.'); return; }
    markVisited(p.id);
    awardBadgeSite(p.id,p.name);
  };
  diModal.show();
}

/* ---------- Badges & check-in logic ---------- */
function getBadges(){ return loadBadges(); }

function awardBadge(id,name,icon){
  const user = getCurrentUser();
  if (!user) return false;
  
  if(!user.badges) user.badges = [];
  if(user.badges.find(b=>b.id===id)) return false;
  
  user.badges.push({id,name,icon:icon || `https://via.placeholder.com/64/FFD54F/000?text=${encodeURIComponent(name.charAt(0))}`});
  updateUser(user);
  renderUserBadges(user);
  
  // Hiển thị popup huy hiệu
  showBadgePopup(name, icon);
  return true;
}

function renderProfileBadges(){
  const wrap = document.getElementById('profile-badge-area');
  if (!wrap) return;
  
  wrap.innerHTML = '';
  const arr = getBadges();
  
  if(arr.length === 0) {
    wrap.innerHTML = '<div class="text-muted">Chưa có huy hiệu nào. Hãy khám phá các địa điểm và hoàn thành thử thách!</div>';
    return;
  }
  
  arr.forEach(b=>{
    const el = document.createElement('div');
    el.className = 'text-center';
    el.innerHTML = `
      <img src="${b.icon}" class="badge-img" alt="${b.name}">
      <div style="font-size:12px; max-width:80px">${b.name}</div>
    `;
    wrap.appendChild(el);
  });
}

/* mark visited and award site badge */
function markVisited(siteId){
  const user = getCurrentUser();
  if (!user) return;
  
  if(!user.visitedSites) user.visitedSites = [];
  if(!user.visitedSites.includes(siteId)){ 
    user.visitedSites.push(siteId); 
    updateUser(user);
    renderUserBadges(user);
  }
}

function awardBadgeSite(siteId, siteName){
  const id = `site_${siteId}`;
  const name = `${siteName}`;
  const badgeIcons = {
    'chua': 'images/hhchua.jpg',
    'nha-tu': 'images/hhnhatupq.jpg',
    'nha-thung': 'images/hhnhathung.jpg',
    'ham-ninh': 'images/hhlangchai.jpg',
    'baotang': 'images/hhcoinguon.jpg',
    'dinh-cau': 'images/hhdinhcau.jpg',
    'dinh-ntt': 'images/hhdinhntt.jpg',
    'vuon-quoc-gia': 'images/hhvuon.jpg',
    'bai-sao': 'images/hhbaisao.jpg',
    'hon-thom': 'images/hhhonthom.jpg',
    'cap-treo': 'images/hhcaptreo.jpg',
    'grand-world': 'images/hhgrandworld.jpg',
    'ngoc-trai': 'images/hhngoctrai.jpg'
  };
  
  const badgeIcon = badgeIcons[siteId] || `https://via.placeholder.com/64/C33/fff?text=${encodeURIComponent(siteName.split(' ')[0].charAt(0))}`;
  awardBadge(id, name, badgeIcon);
}

/* Hiển thị popup huy hiệu lớn */
function showBadgePopup(badgeName, badgeIcon) {
  const popup = document.getElementById('badgePopup');
  const popupImg = document.getElementById('badgePopupImg');
  const popupTitle = document.getElementById('badgePopupTitle');
  
  popupImg.src = badgeIcon;
  popupTitle.textContent = badgeName;
  popup.style.display = 'flex';
  
  // Bắn pháo hoa
  confetti({
    particleCount: 150,
    spread: 70,
    origin: { y: 0.6 },
    colors: ['#C62828', '#FFD54F', '#4CAF50', '#2196F3']
  });
  
  const autoClose = setTimeout(() => {
    closeBadgePopup();
  }, 3000);
  
  document.getElementById('badgePopupClose').onclick = () => {
    clearTimeout(autoClose);
    closeBadgePopup();
  };
  
  popup.onclick = (e) => {
    if (e.target === popup) {
      clearTimeout(autoClose);
      closeBadgePopup();
    }
  };
}

function closeBadgePopup() {
  document.getElementById('badgePopup').style.display = 'none';
}

/* record game completion */
function recordDone(siteId, gameId){
  const user = getCurrentUser();
  if (!user) return;
  
  if(!user.completedGames) user.completedGames = {};
  if(!user.completedGames[siteId]) user.completedGames[siteId] = [];
  if(!user.completedGames[siteId].includes(gameId)){ 
    user.completedGames[siteId].push(gameId); 
    updateUser(user);
    renderUserBadges(user);
  }
}

/* ---------- Game picker & implementations ---------- */
function openGamePicker(site){
  const html = `<div class="text-center">
    <h4 class="mb-4">Chọn mini-game — ${site.name}</h4>
    <div class="d-flex flex-column gap-3 align-items-center">
      ${site.games.map(g=>`<button class="btn btn-accent btn-lg w-75 game-choice" data-game="${g}">${labelGame(g)}</button>`).join('')}
    </div>
    <p class="mt-4 text-muted">Mỗi mini-game có các bước thử thách. Kết quả sẽ lưu vào hồ sơ của bạn.</p>
  </div>`;
  
  showGameFullscreen('Chọn mini-game', html);
  
  document.querySelectorAll('.game-choice').forEach(btn=> btn.addEventListener('click', ()=> {
    const g = btn.dataset.game;
    startGameInstance(g, site);
  }));
}

function labelGame(id){
  const map = {
    'quiz_nhatu':'Quiz (Nhà tù)',
    'quiz_trungtruc':'Quiz (Đình)',
    'memory_nhatu':'Memory Việt (Nhà tù)',
    'memory_trungtruc':'Memory Việt (Đình)'
  };
  return map[id]||id;
}

/* ---------- GAME FULLSCREEN MODE ---------- */
const gameFullscreen = document.getElementById('gameFullscreen');
const gameFullscreenTitle = document.getElementById('gameFullscreenTitle');
const gameFullscreenBody = document.getElementById('gameFullscreenBody');
const gameFullscreenClose = document.getElementById('gameFullscreenClose');

if (gameFullscreenClose) {
  gameFullscreenClose.addEventListener('click', () => {
    hideGameFullscreen();
  });
}

function showGameFullscreen(title, content) {
  gameFullscreenTitle.textContent = title;
  gameFullscreenBody.innerHTML = content;
  gameFullscreen.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function hideGameFullscreen() {
  gameFullscreen.classList.remove('active');
  document.body.style.overflow = 'auto';
}

/* ---------- Victory Popup ---------- */
const victoryPopup = document.getElementById('victoryPopup');
const victoryMessage = document.getElementById('victoryMessage');
const victoryClose = document.getElementById('victoryClose');

if (victoryClose) {
  victoryClose.addEventListener('click', () => {
    victoryPopup.style.display = 'none';
  });
}

function showVictory(message) {
  victoryMessage.textContent = message;
  victoryPopup.style.display = 'flex';
  
  // Bắn pháo hoa ở phía trước
  confetti({
    particleCount: 200,
    spread: 100,
    origin: { y: 0.3 },
    colors: ['#C62828', '#FFD54F', '#4CAF50', '#2196F3'],
    startVelocity: 30,
    gravity: 0.8
  });
  
  // Thêm hiệu ứng pháo hoa từ hai bên
  setTimeout(() => {
    confetti({
      particleCount: 100,
      angle: 60,
      spread: 80,
      origin: { x: 0, y: 0.5 },
      colors: ['#C62828', '#FFD54F']
    });
    confetti({
      particleCount: 100,
      angle: 120,
      spread: 80,
      origin: { x: 1, y: 0.5 },
      colors: ['#4CAF50', '#2196F3']
    });
  }, 500);
}

/* ---------- GAME LẬT THẺ (MEMORY CARD) ---------- */
const MEMORY_GAMES = {
  'memory_nhatu': {
    title: 'Memory Việt - Nhà tù Phú Quốc',
    cards: [
      { id: 1, image: 'images/nhatucard1.jpg', matchId: 2 },
      { id: 2, image: 'images/nhatutext1.jpg', matchId: 1 },
      { id: 3, image: 'images/nhatucard2.jpg', matchId: 4 },
      { id: 4, image: 'images/nhatutext2.jpg', matchId: 3 },
      { id: 5, image: 'images/nhatucard3.jpg', matchId: 6 },
      { id: 6, image: 'images/nhatutext3.jpg', matchId: 5 },
      { id: 7, image: 'images/nhatucard4.jpg', matchId: 8 },
      { id: 8, image: 'images/nhatutext4.jpg', matchId: 7 }
    ]
  },
  'memory_trungtruc': {
    title: 'Memory Việt - Đình Nguyễn Trung Trực',
    cards: [
      { id: 1, image: 'images/dinhcard1.jpg', matchId: 2 },
      { id: 2, image: 'images/dinhtext1.jpg', matchId: 1 },
      { id: 3, image: 'images/dinhcard2.jpg', matchId: 4 },
      { id: 4, image: 'images/dinhtext2.jpg', matchId: 3 },
      { id: 5, image: 'images/dinhcard3.jpg', matchId: 6 },
      { id: 6, image: 'images/dinhtext3.jpg', matchId: 5 },
      { id: 7, image: 'images/dinhcard4.jpg', matchId: 8 },
      { id: 8, image: 'images/dinhtext4.jpg', matchId: 7 }
    ]
  }
};

let currentMemoryGame = null;
let flippedCards = [];
let matchedPairs = 0;
let canFlip = true;
let flipCount = 0;

function startMemoryGame(gameId, site) {
  const gameData = MEMORY_GAMES[gameId];
  if (!gameData) {
    alert('Game Memory Việt chưa có nội dung.');
    return;
  }
  currentMemoryGame = { id: gameId, site: site, gameData: gameData };
  flippedCards = [];
  matchedPairs = 0;
  canFlip = true;
  flipCount = 0;
  const html = `
    <div class="memory-container text-center">
      <h4 class="mb-3">${gameData.title}</h4>
      <div class="memory-stats mb-3">
        <span class="badge bg-primary">Cặp đã tìm: <span id="matchedCount">0</span>/4</span>
        <span class="badge bg-secondary ms-2">Lượt lật: <span id="flipCount">0</span></span>
      </div>
      
      <div class="memory-board" id="memoryBoard">
        <!-- Cards will be generated here -->
      </div>
      
      <div class="memory-controls mt-4">
        <button class="btn btn-accent" onclick="finishMemoryGame()">Hoàn thành</button>
        <button class="btn btn-outline-secondary" onclick="resetMemoryGame()">Chơi lại</button>
      </div>
      
      <div class="memory-complete mt-3" id="memoryComplete" style="display: none;">
        <div class="alert alert-success">
          <h5>🎉 Chúc mừng!</h5>
          <p>Bạn đã hoàn thành game Memory Việt!</p>
        </div>
      </div>
    </div>
  `;
  showGameFullscreen(gameData.title, html);
  initializeMemoryGame();
}

function initializeMemoryGame() {
  const board = document.getElementById('memoryBoard');
  const gameData = currentMemoryGame.gameData;
  
  const shuffledCards = [...gameData.cards].sort(() => Math.random() - 0.5);
  
  board.innerHTML = shuffledCards.map(card => `
    <div class="memory-card" data-card-id="${card.id}" data-match-id="${card.matchId}">
      <div class="card-inner">
        <div class="card-front">
          <div class="card-content">
            <i class="fas fa-question"></i>
          </div>
        </div>
        <div class="card-back">
          <div class="card-content">
            <img src="${card.image}" alt="Memory card" onerror="this.style.display='none'">
          </div>
        </div>
      </div>
    </div>
  `).join('');
  document.querySelectorAll('.memory-card').forEach(card => {
    card.addEventListener('click', handleCardClick);
  });
  flipCount = 0;
  updateFlipCount();
}

function handleCardClick() {
  if (!canFlip) return;
  if (this.classList.contains('flipped') || this.classList.contains('matched')) return;
  if (flippedCards.length >= 2) return;
  this.classList.add('flipped');
  flippedCards.push(this);
  flipCount++;
  updateFlipCount();
  if (flippedCards.length === 2) {
    canFlip = false;
    setTimeout(checkForMatch, 800);
  }
}

function checkForMatch() {
  const [card1, card2] = flippedCards;
  const matchId1 = card1.dataset.matchId;
  const matchId2 = card2.dataset.matchId;
  if (card1.dataset.cardId === matchId2 && card2.dataset.cardId === matchId1) {
    card1.classList.add('matched');
    card2.classList.add('matched');
    matchedPairs++;
    updateMatchedCount();
    if (matchedPairs === 4) {
      setTimeout(() => {
        document.getElementById('memoryComplete').style.display = 'block';
       showVictory('🎉 Xuất sắc! Bạn đã hoàn thành Memory Việt!');
      }, 500);
    }
  } else {
    card1.classList.remove('flipped');
    card2.classList.remove('flipped');
  }
  flippedCards = [];
  canFlip = true;
}

function updateMatchedCount() {
  document.getElementById('matchedCount').textContent = matchedPairs;
}

function updateFlipCount() {
  document.getElementById('flipCount').textContent = flipCount;
}

function resetMemoryGame() {
  flippedCards = [];
  matchedPairs = 0;
  canFlip = true;
  flipCount = 0;
  
  document.querySelectorAll('.memory-card').forEach(card => {
    card.classList.remove('flipped', 'matched');
  });
  
  document.getElementById('memoryComplete').style.display = 'none';
  updateMatchedCount();
  updateFlipCount();
  
  const board = document.getElementById('memoryBoard');
  const cards = Array.from(board.children);
  cards.sort(() => Math.random() - 0.5);
  cards.forEach(card => board.appendChild(card));
}

function finishMemoryGame() {
  if (matchedPairs === 4) {
    recordDone(currentMemoryGame.site.id, currentMemoryGame.id);
    hideGameFullscreen();
  } else {
    alert(`Bạn đã tìm được ${matchedPairs}/4 cặp thẻ. Hãy tiếp tục!`);
  }
}

/* ---------- GAME QUIZ ---------- */
const QUIZZES = {
  'quiz_nhatu': {
    title:'Quiz Nhà tù Phú Quốc',
    items:[
      {
        q:'Di tích Trại giam Phú Quốc được chính thức xếp hạng Di tích Quốc gia đặc biệt vào thời điểm nào?',
        opts:['Ngày 30/4/1975','Ngày 27/7/2013','Ngày 31/12/2014','Ngày 20/10/2016'],
        ans:2,
        explain:'Đáp án đúng là C. Căn cứ theo Quyết định số 2408/QĐ-TTg ngày 31/12/2014 của Thủ tướng Chính phủ.'
      },
      {
        q:'"Địa ngục trần gian" Phú Quốc chính thức tồn tại trong khoảng thời gian nào?',
        opts:['Từ năm 1949 đến năm 1954','Từ tháng 6/1967 đến tháng 3/1973','Từ năm 1965 đến năm 1975','Từ năm 1954 đến năm 1975'],
        ans:1,
        explain:'Đáp án đúng là B. Theo tư liệu, trại giam tồn tại chưa đầy 6 năm trong giai đoạn này dưới sự quản lý của chính quyền Mỹ - Ngụy.'
      },
      {
        q:'Ước tính có bao nhiêu tù binh đã bị giết hại tại Trại giam Phú Quốc?',
        opts:['Khoảng 1.000 người','Khoảng 2.000 người','Khoảng 4.000 người','Khoảng 10.000 người'],
        ans:2,
        explain:'Đáp án đúng là C. Tư liệu ghi rõ con số khoảng 4.000 tù binh đã bị giết hại tại đây.'
      },
      {
        q:'Một trong những hình thức tra tấn đặc biệt dã man, nơi tù binh bị nhốt trong các công-ten-nơ nhỏ được gọi là gì?',
        opts:['Chuồng cọp xi măng','Thùng cat-xô','Hầm đá vôi','Ngục tối'],
        ans:1,
        explain:'Đáp án đúng là B. Đây là một kiểu giam giữ được mô tả trong tư liệu, sử dụng các công-ten-nơ nhỏ, trên đỉnh đục lỗ thông hơi, rất chật hẹp và ngột ngạt.'
      },
      {
        q:'Các tù binh tại Trại giam Phú Quốc đã tổ chức bao nhiêu cuộc vượt ngục với nhiều hình thức khác nhau?',
        opts:['12 cuộc','25 cuộc','45 cuộc','52 cuộc'],
        ans:2,
        explain:'Đáp án đúng là C. Thể hiện tinh thần đấu tranh bất khuất, các tù binh đã tổ chức thành công 45 cuộc vượt ngục.'
      },
      {
        q:'Khu vực nào sau đây KHÔNG phải là một phần của Di tích Trại giam Phú Quốc ngày nay?',
        opts:['Phân khu B2 (được phục dựng)','Nghĩa địa tù binh (Đồi 100)','Nhà tù Côn Sơn','Đài tưởng niệm liệt sĩ tại Đồi Sim'],
        ans:2,
        explain:'Đáp án đúng là C. Nhà tù Côn Sơn là một di tích lịch sử hoàn toàn khác, nằm ở Côn Đảo, tỉnh Bà Rịa - Vũng Tàu.'
      },
      {
        q:'Tổng diện tích của Trại giam Phú Quốc trong lịch sử lên đến bao nhiêu?',
        opts:['100 hecta','200 hecta','400 hecta','500 hecta'],
        ans:2,
        explain:'Đáp án đúng là C. Trại giam có quy mô rất lớn, với tổng diện tích lên đến 400 hecta, được chia thành 12 khu vực.'
      }
    ]
  },
  'quiz_trungtruc': {
    title:'Quiz Đình Nguyễn Trung Trực',
    items:[
      {
        q:'Nguyễn Trung Trực là thủ lĩnh nổi tiếng của phong trào kháng chiến chống?',
        opts:['Chống Pháp','Chống Pháp và chống Mỹ','Chống Mỹ','Chống Nhật'],
        ans:0,
        explain:'Đáp án đúng là A. Nguyễn Trung Trực là thủ lĩnh nghĩa quân chống lại thực dân Pháp xâm lược ở Nam Kỳ vào nửa cuối thế kỷ 19 (từ 1861-1868).'
      },
      {
        q:'Nguyễn Trung Trực đã chỉ huy nghĩa quân đốt cháy tàu chiến nào của Pháp trên sông Vàm Cỏ Đông vào năm 1861, gây tiếng vang lớn?',
        opts:['Tàu Hy Vọng (L\'Espérance)','Tàu Hằng Tâm (La Persévérance)','Tàu Jaccaré','Tàu Avalanche'],
        ans:0,
        explain:'Đáp án đúng là A. Chiến công nổi tiếng nhất của ông là chỉ huy nghĩa quân đốt cháy tiểu hạm L\'Espérance (có tên Việt là "Hy Vọng") của Pháp trên sông Vàm Cỏ Đông năm 1861.'
      },
      {
        q:'Câu nói bất hủ "Bao giờ người Tây nhổ hết cỏ nước Nam thì mới hết người Nam đánh Tây" được Nguyễn Trung Trực nói trong hoàn cảnh nào?',
        opts:['Khi động viên nghĩa quân trước trận đánh','Khi bị thực dân Pháp dụ hàng và kết án tử hình','Khi trả lời phỏng vấn của một nhà báo Pháp','Trong một bức thư gửi cho Triều đình Huế'],
        ans:1,
        explain:'Đáp án đúng là B. Câu nói bất hủ này thể hiện khí phách kiên cường của ông, được ông thốt lên khi đối diện với cái chết, trước sự dụ dỗ của kẻ thù.'
      },
      {
        q:'Nguyễn Trung Trực bị thực dân Pháp xử chém tại đâu?',
        opts:['Sài Gòn','Bến Tre','Rạch Giá','Cần Thơ'],
        ans:2,
        explain:'Đáp án đúng là C. Sau khi kháng chiến ở Hòn Chông thất bại và bị bắt, ông bị thực dân Pháp xử chém tại chợ Rạch Giá vào ngày 27/10/1868 (16/9 năm Mậu Thìn).'
      },
      {
        q:'Lễ hội tưởng niệm Nguyễn Trung Trực được tổ chức hằng năm vào những ngày nào?',
        opts:['Chỉ ngày 27 tháng 10 Dương lịch','Từ ngày 26 đến 28 tháng 8 Âm lịch','Chỉ ngày 16 tháng 9 Âm lịch','Từ ngày 1 đến 3 tháng 1 Dương lịch'],
        ans:1,
        explain:'Đáp án đúng là B. Lễ hội chính Kỳ yên tại Đình thần Nguyễn Trung Trực ở Rạch Giá, Kiên Giang được tổ chức trang trọng trong 3 ngày từ 26 đến 28 tháng 8 Âm lịch hằng năm, với ngày chánh giỗ (ngày hy sinh) là 27/8 Âm lịch.'
      },
      {
        q:'Anh hùng dân tộc Nguyễn Trung Trực đã bị thực dân Pháp hành quyết vào ngày nào?',
        opts:['Ngày 27 tháng 10 năm 1868','Ngày 16 tháng 9 năm 1868','Ngày 25 tháng 10 năm 1868','Ngày 16 tháng 9 năm 1869'],
        ans:0,
        explain:'Đáp án đúng là A. Nguyễn Trung Trực hy sinh vào ngày 27 tháng 10 năm 1868.'
      }
    ]
  }
};

/* Start quiz run: show one question at a time with explanation */
let currentQuiz = null;
let currentQIndex = 0;
let selectedOption = null;

function startQuiz(quizId, site){
  const qset = QUIZZES[quizId];
  if(!qset){ alert('Quiz chưa có nội dung.'); return; }
  currentQuiz = {id:quizId, site:site, qset:qset};
  currentQIndex = 0;
  selectedOption = null;
  renderCurrentQuestion();
}

function renderCurrentQuestion(){
  const qobj = currentQuiz.qset.items[currentQIndex];
  
  const html = `
    <div class="quiz-container">
      <div class="quiz-question">
        <h5>Câu ${currentQIndex+1} / ${currentQuiz.qset.items.length}</h5>
        <p class="fs-5">${qobj.q}</p>
      </div>
      
      <div class="quiz-options" id="quizOptions">
        ${qobj.opts.map((opt, i) => `
          <div class="quiz-option" data-index="${i}">
            ${opt}
          </div>
        `).join('')}
      </div>
      
      <div class="quiz-feedback" id="quizFeedback"></div>
      
      <div class="quiz-controls">
        <button class="btn btn-outline-secondary" onclick="hideGameFullscreen()">Thoát</button>
        <button class="btn btn-accent" id="quizNextBtn" onclick="handleAnswerAndNext()" disabled>Tiếp tục</button>
      </div>
    </div>
  `;
  
  showGameFullscreen(currentQuiz.qset.title, html);
  
  document.querySelectorAll('.quiz-option').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('.quiz-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      option.classList.add('selected');
      selectedOption = parseInt(option.dataset.index);
      document.getElementById('quizNextBtn').disabled = false;
    });
  });
}

function handleAnswerAndNext(){
  if(selectedOption === null){ 
    alert('Vui lòng chọn 1 đáp án'); 
    return; 
  }
  
  const qobj = currentQuiz.qset.items[currentQIndex];
  const fb = document.getElementById('quizFeedback');
  
  if(selectedOption === qobj.ans){
    fb.innerHTML = `<div class="correct">✓ Đáp án đúng</div><div class="explain mt-2">${qobj.explain}</div>`;
    fb.className = 'quiz-feedback correct';
  } else {
    fb.innerHTML = `<div class="wrong">✗ Đáp án sai</div><div class="explain mt-2">Đáp án đúng: <strong>${qobj.opts[qobj.ans]}</strong><br>${qobj.explain}</div>`;
    fb.className = 'quiz-feedback wrong';
  }
  
  setTimeout(()=> {
    currentQIndex++;
    if(currentQIndex < currentQuiz.qset.items.length){
      selectedOption = null;
      renderCurrentQuestion();
    } else {
      recordDone(currentQuiz.site.id, currentQuiz.id);
      showVictory('🎉 Xuất sắc! Bạn đã hoàn thành quiz!');
      hideGameFullscreen();
    }
  }, 1500);
}

/* startGameInstance wrapper called from picker */
function startGameInstance(gid, site){
  if(gid.startsWith('quiz_')) startQuiz(gid, site);
  else if(gid.startsWith('memory_')) startMemoryGame(gid, site);
  else { alert('Game chưa được hỗ trợ'); }
}

/* ---------- initial UI state ---------- */
initData();
refreshProfileAuthUI();
renderProfileBadges();
loadStories();

/* ensure map resizes when switching pages */
window.addEventListener('resize', ()=> {
  if (currentPage === 'map' && typeof map !== 'undefined') {
    map.invalidateSize();
  }
});

console.log('App initialization complete');
}); // Kết thúc DOMContentLoaded
</script>
</body>
</html>

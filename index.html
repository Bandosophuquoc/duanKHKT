<!doctype html>
<html lang="vi">
<head>
<!-- Thêm vào sau Font Awesome -->
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="https://unpkg.com/typed.js@2.0.16/dist/typed.umd.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PQStoryMap — Dự án KHKT: Tự hào quê hương</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --accent:#C62828; /* đỏ */
    --gold:#FFD54F;
    --bg:#FBFBFB;
    --nature:#A5D6A7; /* Xanh lá pastel */
    --culture:#FFCC80; /* Cam pastel */
    --entertainment:#CE93D8; /* Tím pastel */
    --craft:#EF9A9A; /* Đỏ pastel */
  }
  body{font-family: "Noto Sans", system-ui, sans-serif; background:var(--bg); color:#111;}
  .container-main{max-width:1100px;margin:auto;}
  .logo{width:60px;height:60px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#B71C1C);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:22px}
  .hero{background:linear-gradient(90deg, rgba(198,40,40,0.06), rgba(255,213,79,0.02));padding:22px;border-radius:12px;margin:18px 0}
  .btn-accent{background:linear-gradient(90deg,var(--accent),#EF5350);color:white;border:none}
  #map{height:64vh;border-radius:12px}
  .badge-img{width:56px;height:56px;border-radius:8px;object-fit:cover}
  .marker-emoji{font-size:20px}
  .diatic-title{font-weight:700}
  .game-card{border-radius:10px;background:white;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  footer{padding:18px 0;color:#666;text-align:center;margin-top:18px}
  .correct{color:green;font-weight:700}
  .wrong{color:#c62828;font-weight:700}
  .explain{font-size:0.95rem;color:#444}
/* Thêm vào phần style */
 .carousel-control-prev, .carousel-control-next {
  width: 40px;
  height: 40px;
  background: rgba(0,0,0,0.5);
  border-radius: 50%;
  top: 50%;
  transform: translateY(-50%);
}
.carousel-control-prev {
  left: 10px;
}
.carousel-control-next {
  right: 10px;
}
.carousel-control-prev-icon, 
.carousel-control-next-icon {
  width: 20px;
  height: 20px;
}
  
  /* Overlay khi mở menu */
  .menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    display: none;
  }
  .menu-overlay.active {
    display: block;
  }
  
  /* Menu dropdown */
  .menu-dropdown {
    position: absolute;
    top: 70px;
    right: 10px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    z-index: 1000;
    min-width: 200px;
    display: none;
    overflow: hidden;
  }
  .menu-dropdown.active {
    display: block;
  }
  .menu-item {
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .menu-item:hover {
    background: #f8f9fa;
  }
  .menu-item:last-child {
    border-bottom: none;
  }
  .menu-item.active {
    background: var(--accent);
    color: white;
  }
  
  /* PQ Stories - Wall of Notes */
  .stories-wall {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    padding: 20px 0;
  }
  .story-note {
    background: #fff9c4;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-left: 5px solid var(--accent);
    position: relative;
    transition: transform 0.3s;
  }
  .story-note:hover {
    transform: translateY(-5px);
  }
  .story-note::before {
    content: '';
    position: absolute;
    top: -10px;
    right: -10px;
    width: 40px;
    height: 40px;
    background: var(--accent);
    border-radius: 50%;
    opacity: 0.1;
  }
  .story-media {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  .story-content {
    margin-bottom: 15px;
    line-height: 1.6;
  }
  .story-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    color: #666;
  }
  .story-actions {
    display: flex;
    gap: 15px;
    margin-top: 10px;
  }
  .story-action {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    transition: color 0.3s;
  }
  .story-action:hover {
    color: var(--accent);
  }
  
  /* Upload form */
  .upload-form {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  .upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 20px;
  }
  .upload-area:hover {
    border-color: var(--accent);
    background: #fff5f5;
  }
  .upload-area i {
    font-size: 3rem;
    color: #dee2e6;
    margin-bottom: 15px;
  }
  
  /* Marker tooltip */
  .marker-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 14px;
    white-space: nowrap;
    z-index: 1000;
    pointer-events: none;
    transform: translateY(-100%);
    margin-top: -10px;
  }
  .marker-tooltip:after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
  }
  
 /* CSS cho game lật thẻ */
  /* Cập nhật CSS cho game lật thẻ trên điện thoại */
@media (max-width: 767px) {
  .memory-board {
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 12px;
    max-width: 100%;
  }
  
  .memory-card {
    height: 150px !important;
    width: 100%;
    max-width: 200px;
    margin: 0 auto;
  }
  
  .card-back .card-content img {
    max-width: 100%;
    max-height: 100%;
    object-fit: cover;
  }
  
  .stories-wall {
    grid-template-columns: 1fr;
  }
  
  .menu-dropdown {
    right: 5px;
    left: 5px;
    min-width: auto;
  }
}
@media (max-width: 480px) {
  .memory-card {
    height: 140px !important;
    max-width: 180px;
  }
}
@media (max-width: 360px) {
  .memory-card {
    height: 130px !important;
    max-width: 160px;
  }
}
  .memory-container {
    max-width: 100%;
    margin: 0 auto;
    height: 100%;
    overflow-y: auto;
    padding: 15px;
  }
  .memory-stats {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .memory-board {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    max-width: 500px;
    margin: 0 auto;
  }
  .memory-card {
    aspect-ratio: 3/4;
    perspective: 1000px;
    cursor: pointer;
  }
  .card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.6s;
    transform-style: preserve-3d;
  }
  .memory-card.flipped .card-inner {
    transform: rotateY(180deg);
  }
  .memory-card.matched .card-inner {
    transform: rotateY(180deg);
  }
  .memory-card.matched {
    cursor: default;
  }
  .card-front, .card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    box-sizing: border-box;
  }
  .card-front {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  .card-back {
    background: white;
    border: 2px solid #dee2e6;
    transform: rotateY(180deg);
  }
  .card-content {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .card-back .card-content img {
    max-width: 100%;
    max-height: 100%;
    object-fit: cover;
    border-radius: 6px;
  }
  .card-front .card-content i {
    font-size: 2rem;
  }
  .memory-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
    flex-wrap: wrap;
  }
  .memory-complete {
    margin-top: 20px;
  }
  /* Hiệu ứng lắc khi sai */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
  /* Hiệu ứng huy hiệu lớn */
  .badge-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
  }
  .badge-popup-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: popIn 0.5s ease;
    max-width: 300px;
    width: 90%;
  }
  .badge-popup-img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 auto 15px;
    border: 4px solid var(--gold);
    animation: bounce 1s ease infinite;
  }
  .badge-popup-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 10px;
  }
  .badge-popup-message {
    color: #666;
    margin-bottom: 20px;
  }
  /* GAME FULLSCREEN MODE */
  .game-fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    z-index: 9999;
    overflow-y: auto;
    display: none;
  }
  .game-fullscreen.active {
    display: block;
  }
  .game-fullscreen-header {
    background: linear-gradient(90deg, var(--accent), #d32);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  .game-fullscreen-title {
    font-size: 1.3rem;
    font-weight: bold;
    margin: 0;
  }
  .game-fullscreen-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
  }
  .game-fullscreen-body {
    padding: 20px;
    height: calc(100% - 70px);
    overflow-y: auto;
  }
  .quiz-container {
    max-width: 800px;
    margin: 0 auto;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  .quiz-question {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid var(--accent);
  }
  .quiz-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: 20px 0;
  }
  .quiz-option {
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
  }
  .quiz-option:hover {
    border-color: var(--accent);
    background: #fff5f5;
  }
  .quiz-option.selected {
    border-color: var(--accent);
    background: #ffeaea;
  }
  .quiz-feedback {
    margin-top: 20px;
    padding: 15px;
    border-radius: 8px;
    display: none;
  }
  .quiz-feedback.correct {
    background: #e8f5e8;
    border: 1px solid #4caf50;
    display: block;
  }
  .quiz-feedback.wrong {
    background: #ffebee;
    border: 1px solid #f44336;
    display: block;
  }
  .quiz-controls {
    margin-top: auto;
    display: flex;
    justify-content: space-between;
    padding: 20px 0;
  }
  /* Victory Popup */
  .victory-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
  }
  .victory-content {
    background: white;
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    animation: popIn 0.5s ease;
    max-width: 400px;
    width: 90%;
    position: relative;
    z-index: 10001;
  }
  .victory-title {
    font-size: 2rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 15px;
  }
  .victory-message {
    color: #666;
    font-size: 1.1rem;
    margin-bottom: 25px;
  }
  /* Profile Page */
  .profile-container {
    max-width: 800px;
    margin: 0 auto;
  }
  .profile-header {
    background: linear-gradient(135deg, var(--accent), #d32);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    text-align: center;
  }
  .profile-badges {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  .profile-auth {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes popIn {
    0% { transform: scale(0.5); opacity: 0; }
    70% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  /* ========== NEW PQ STORIES DESIGN ========== */
  #page-stories {
    min-height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 0;
    margin: 0;
  }
  
  .stories-hero {
    text-align: center;
    padding: 80px 20px 40px;
    background: linear-gradient(135deg, rgba(198,40,40,0.1) 0%, rgba(255,213,79,0.05) 100%);
    position: relative;
    overflow: hidden;
  }
  
  .stories-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="%23C62828" opacity="0.03"><circle cx="20" cy="20" r="5"/><circle cx="80" cy="30" r="8"/><circle cx="40" cy="80" r="6"/><circle cx="70" cy="70" r="4"/></svg>');
    background-size: 200px 200px;
  }
  
  .stories-hero h1 {
    font-size: 3.5rem;
    font-weight: 800;
    color: var(--accent);
    margin-bottom: 15px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    position: relative;
    z-index: 2;
  }
  
  .stories-hero p {
    font-size: 1.3rem;
    color: #555;
    max-width: 600px;
    margin: 0 auto;
    position: relative;
    z-index: 2;
  }
  
  .stories-wall-container {
    position: relative;
    padding: 40px 20px 100px;
    min-height: 60vh;
  }
  
  .stories-wall-new {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
    max-width: 1400px;
    margin: 0 auto;
    position: relative;
    z-index: 2;
  }
  
  .story-note-new {
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  
  .story-note-new::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(90deg, var(--accent), var(--gold));
  }
  
  .story-note-new:hover {
    transform: translateY(-8px) rotate(1deg);
    box-shadow: 0 15px 30px rgba(0,0,0,0.15);
  }
  
  .story-note-new h3 {
    margin-top: 0;
    font-size: 1.3rem;
    color: #333;
    line-height: 1.4;
    margin-bottom: 10px;
  }
  
  .story-content-new {
    flex-grow: 1;
    margin-bottom: 15px;
    line-height: 1.5;
    color: #555;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 5;
    -webkit-box-orient: vertical;
  }
  
  .story-media-new {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 15px;
    max-height: 200px;
    object-fit: cover;
  }
  
  .story-meta-new {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
    color: #777;
    margin-bottom: 10px;
  }
  
  .story-actions-new {
    display: flex;
    gap: 15px;
    margin-top: 10px;
  }
  
  .story-action-new {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
  }
  
  .story-action-new:hover {
    color: var(--accent);
    transform: scale(1.1);
  }
  
  .story-action-new.liked {
    color: #e74c3c;
  }
  
  .story-comments {
    margin-top: 15px;
    border-top: 1px solid rgba(0,0,0,0.1);
    padding-top: 15px;
    display: none;
  }
  
  .story-comment {
    padding: 8px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  
  .story-comment:last-child {
    border-bottom: none;
  }
  
  .story-comment-author {
    font-weight: bold;
    font-size: 0.9rem;
    color: #333;
  }
  
  .story-comment-content {
    font-size: 0.85rem;
    color: #555;
    margin-top: 3px;
  }
  
  .add-comment-form {
    margin-top: 10px;
    display: flex;
    gap: 8px;
  }
  
  .add-comment-input {
    flex-grow: 1;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 0.85rem;
    outline: none;
  }
  
  .add-comment-btn {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .add-comment-btn:hover {
    background: #b71c1c;
  }
  
  .add-story-btn-container {
    position: fixed;
    bottom: 30px;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: center;
    z-index: 10;
  }
  
  .add-story-btn {
    background: linear-gradient(135deg, var(--accent), #d32);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 15px 30px;
    font-size: 1.1rem;
    font-weight: 600;
    box-shadow: 0 5px 20px rgba(198,40,40,0.4);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 100;
  }
  
  .add-story-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(198,40,40,0.5);
  }
  
  .add-story-btn:active {
    transform: translateY(1px);
  }
  
  /* Story Modal */
  .story-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
  }
  
  .story-modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }
  
  .story-modal {
    background: white;
    border-radius: 20px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    transform: scale(0.9);
    transition: all 0.3s;
    position: relative;
  }
  
  .story-modal-overlay.active .story-modal {
    transform: scale(1);
  }
  
  .story-modal-header {
    padding: 25px 30px 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .story-modal-header h2 {
    margin: 0;
    color: var(--accent);
    font-size: 1.5rem;
  }
  
  .story-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #777;
    cursor: pointer;
    transition: color 0.3s;
  }
  
  .story-modal-close:hover {
    color: var(--accent);
  }
  
  .story-modal-body {
    padding: 20px 30px 30px;
  }
  
  .story-form-group {
    margin-bottom: 20px;
  }
  
  .story-form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
  }
  
  .story-form-input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s;
  }
  
  .story-form-input:focus {
    border-color: var(--accent);
    outline: none;
  }
  
  .story-form-textarea {
    min-height: 120px;
    resize: vertical;
  }
  
  .word-count {
    text-align: right;
    font-size: 0.85rem;
    color: #777;
    margin-top: 5px;
  }
  
  .word-count.warning {
    color: #e74c3c;
  }
  
  .upload-area-new {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 15px;
  }
  
  .upload-area-new:hover {
    border-color: var(--accent);
    background: rgba(198,40,40,0.03);
  }
  
  .upload-area-new i {
    font-size: 2.5rem;
    color: #ddd;
    margin-bottom: 10px;
    display: block;
  }
  
  .file-preview-new {
    margin-top: 15px;
    text-align: center;
  }
  
  .file-preview-new img {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    margin-bottom: 10px;
  }
  
  .file-preview-new video {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    margin-bottom: 10px;
  }
  
  .remove-file {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    font-size: 0.85rem;
    cursor: pointer;
  }
  
  .story-modal-footer {
    padding: 20px 30px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
  }
  
  .btn-post-story {
    background: linear-gradient(135deg, var(--accent), #d32);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 30px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .btn-post-story:hover {
    background: linear-gradient(135deg, #b71c1c, #c62828);
    transform: translateY(-2px);
  }
  
  .btn-post-story:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
  }
  
  /* Success Message */
  .success-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 10000;
    transform: translateX(150%);
    transition: transform 0.3s;
  }
  
  .success-message.show {
    transform: translateX(0);
  }
  
  .success-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
  }
  
  /* Note colors */
  .note-color-1 { background: #FFEAA7; }
  .note-color-2 { background: #D8BFD8; }
  .note-color-3 { background: #A5D6A7; }
  .note-color-4 { background: #81D4FA; }
  .note-color-5 { background: #FFCC80; }
  .note-color-6 { background: #F8BBD0; }
  .note-color-7 { background: #C5E1A5; }
  .note-color-8 { background: #B39DDB; }
 /* ========== STORYTELLING EXPERIENCE ========== */
.story-modal-overlay {
  background: rgba(0, 0, 0, 0.9) !important;
}

.story-page {
  min-height: 80vh;
  padding: 40px 20px;
  display: none;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.8s ease;
}

.story-page.active {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

.story-mystery {
  text-align: center;
  color: white;
  padding: 60px 20px;
}

.mystery-image {
  width: 200px;
  height: 200px;
  margin: 0 auto 30px;
  border-radius: 50%;
  background: linear-gradient(45deg, #8B0000, #B22222);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 4rem;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.mystery-question {
  font-size: 1.8rem;
  font-weight: 300;
  margin-bottom: 30px;
  line-height: 1.4;
}

.story-content {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 15px;
  padding: 30px;
  margin: 20px 0;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.story-timeline {
  position: relative;
  padding-left: 30px;
}

.story-timeline::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 3px;
  background: linear-gradient(to bottom, var(--accent), var(--gold));
}

.timeline-item {
  margin-bottom: 40px;
  position: relative;
}

.timeline-item::before {
  content: '';
  position: absolute;
  left: -33px;
  top: 5px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--accent);
  border: 3px solid white;
}

.timeline-year {
  font-size: 1.3rem;
  font-weight: bold;
  color: var(--accent);
  margin-bottom: 10px;
}

.timeline-content {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 10px;
  border-left: 4px solid var(--accent);
}

.story-image-reveal {
  width: 100%;
  border-radius: 10px;
  margin: 15px 0;
  opacity: 0;
  transform: scale(0.9);
  transition: all 0.8s ease;
}

.story-image-reveal.revealed {
  opacity: 1;
  transform: scale(1);
}

.story-controls {
  position: fixed;
  bottom: 30px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 15px;
  z-index: 1000;
}

.story-btn {
  background: linear-gradient(135deg, var(--accent), #d32);
  color: white;
  border: none;
  border-radius: 25px;
  padding: 12px 25px;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 5px 15px rgba(198, 40, 40, 0.4);
}

.story-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(198, 40, 40, 0.6);
}

.story-btn:disabled {
  background: #6c757d;
  transform: none;
  box-shadow: none;
  cursor: not-allowed;
}

.story-progress {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: rgba(255, 255, 255, 0.2);
  z-index: 1001;
}

.story-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--gold));
  width: 0%;
  transition: width 0.5s ease;
}

.typed-cursor {
  color: var(--gold);
  font-weight: bold;
}

/* Hiệu ứng giấy cũ */
.vintage-paper {
  background: #f5e8c8;
  padding: 25px;
  border-radius: 8px;
  position: relative;
  border: 1px solid #d4b78c;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.vintage-paper::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.1"><path d="M0,0 L100,0 L100,100 L0,100 Z" fill="none" stroke="%238B4513" stroke-width="2"/></svg>');
  pointer-events: none;
}
  
  /* Responsive */
  @media (max-width: 768px) {
    .stories-hero h1 {
      font-size: 2.5rem;
    }
    
    .stories-hero p {
      font-size: 1.1rem;
    }
    
    .stories-wall-new {
      grid-template-columns: 1fr;
    }
    
    .story-modal {
      width: 95%;
    }
    
    .stat-card {
      margin-bottom: 15px;
    }
/* Style cho modal di tích */
.modal-header {
  background: linear-gradient(135deg, var(--accent), #d32f2f) !important;
  color: white;
  border-bottom: none;
}

.modal-header .btn-close {
  filter: brightness(0) invert(1);
}

.diatic-title {
  color: var(--accent);
  font-weight: 700;
  font-size: 1.4rem;
  margin-bottom: 15px;
  border-left: 4px solid var(--accent);
  padding-left: 12px;
}

/* Style cho các nút trong modal */
.modal-footer .btn {
  border-radius: 8px;
  font-weight: 600;
  transition: all 0.3s ease;
}

.modal-footer .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-warning {
  background: linear-gradient(135deg, #FF9800, #F57C00);
  border: none;
  color: white;
}

.btn-accent {
  background: linear-gradient(135deg, var(--accent), #d32f2f);
  border: none;
  color: white;
}
  }
</style>
</head>
<body>
<div class="container container-main py-3">
  <!-- NAV / header -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex gap-3 align-items-center">
      <div class="logo">
        <i class="fas fa-map" style="color:white; font-size: 24px;"></i>
      </div>
      <div>
        <div style="font-weight:800;font-size:1.15rem">PQStoryMap</div>
        <div style="color:#666;font-size:0.9rem">Dự án KHKT - Giáo dục lòng tự hào dân tộc và tình yêu quê hương đất nước cho tuổi trẻ trường THPT An Thới</div>
      </div>
    </div>
    <div style="position:relative">
      <button id="nav-menu" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-bars me-1"></i>Mục lục
      </button>
      <div class="menu-dropdown" id="menuDropdown">
        <div class="menu-item active" data-page="home">
          <i class="fas fa-home"></i>Trang chủ
        </div>
        <div class="menu-item" data-page="map">
          <i class="fas fa-map-marked-alt"></i>Bản đồ số
        </div>
        <div class="menu-item" data-page="stories">
          <i class="fas fa-book-open"></i>PQ Stories
        </div>
        <div class="menu-item" data-page="profile">
          <i class="fas fa-user"></i>Trang cá nhân
        </div>
          </div>
    </div>
  </div>

  <!-- Overlay khi menu mở -->
  <div class="menu-overlay" id="menuOverlay"></div>

  <!-- HOME -->
  <section id="page-home">
    <div class="hero">
      <h1 style="margin:0;color:var(--accent)">PQStoryMap</h1>
      <p style="margin-top:10px;margin-bottom:8px; font-size: 1.1rem; line-height: 1.6;">
        <strong>Hành trình về nguồn chưa bao giờ sống động và cảm xúc đến thế!</strong>
      </p>
      <p style="margin:0 0 6px 0;color:#444; line-height: 1.6">
        PQStoryMap không chỉ là một website, đó là cây cầu kết nối thế hệ trẻ với hành trình đầy tự hào của cha ông. Chúng tôi mời bạn bước vào một thế giới nơi mỗi di tích là một câu chuyện chờ được kể, mỗi nhân vật lịch sử là một người hùng chờ được thấu hiểu.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        Tại đây, bạn sẽ:<br>
        • Chạm vào lịch sử bằng cảm xúc chân thật nhất.<br>
        • Khám phá vẻ đẹp của quê hương qua lăng kính mới mẻ, trực quan.<br>
        • Rèn luyện tư duy phản biện và kỹ năng kể chuyện để trở thành những đại sứ văn hóa tương lai.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        Hãy để chúng tôi đồng hành cùng bạn trên hành trình khơi dậy lòng tự hào dân tộc và tình yêu với mảnh đất Phú Quốc anh hùng.
      </p>
      <p style="margin:0 0 8px 0;color:#444; line-height: 1.6">
        Bản đồ số là giải pháp thuộc khuôn khổ dự án khoa học kĩ thuật "<strong>Giáo dục lòng tự hào dân tộc và tình yêu quê hương đất nước cho tuổi trẻ THPT An Thới</strong>".
      </p>
      <div class="mt-3">
        <button id="btn-start" class="btn btn-accent btn-lg">Bắt đầu khám phá</button>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-md-12">
        <div class="game-card">
          <h5>Hướng dẫn nhanh</h5>
          <ol style="padding-left:18px">
            <li>Nhấn "Bắt đầu khám phá" để sang trang bản đồ</li>
            <li>Click marker để xem thông tin; nếu có mini-game, bấm "Chơi"</li>
            <li>Truy cập "PQ Stories" để chia sẻ ký ức của bạn</li>
            <li>Vào "Trang cá nhân" để xem thành tích và huy hiệu</li>
            <li>Xem "Thống kê" để theo dõi hoạt động trang web</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- MAP PAGE -->
  <section id="page-map" style="display:none">
    <div id="map" class="mb-3"></div>
  </section>

  <!-- PQ STORIES PAGE -->
  <section id="page-stories" style="display:none">
    <div class="stories-hero">
      <h1>PQ Stories</h1>
      <p>Nơi bạn chia sẻ và lan toả những câu chuyện đẹp về Phú Quốc</p>
    </div>
    
    <div class="stories-wall-container">
      <div class="stories-wall-new" id="storiesWallNew">
        <!-- Stories will be dynamically added here -->
      </div>
    </div>
    
    <div class="add-story-btn-container">
      <button class="add-story-btn" id="addStoryBtn">
        <i class="fas fa-plus"></i>
        Kể câu chuyện của riêng bạn tại đây
      </button>
    </div>
  </section>

  <!-- PROFILE PAGE -->
  <section id="page-profile" style="display:none">
    <div class="profile-container">
      <div class="profile-header">
        <h2>Trang Cá Nhân</h2>
        <p class="mb-0">Quản lý tài khoản và xem thành tích của bạn</p>
      </div>
      <div class="profile-auth">
        <h4 class="mb-3">Tài khoản</h4>
        <div id="profile-info" class="alert alert-info">
          Bạn chưa đăng nhập. Vui lòng đăng nhập để lưu tiến trình và nhận huy hiệu.
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button id="btn-profile-register" class="btn btn-outline-dark">Đăng ký</button>
          <button id="btn-profile-login" class="btn btn-dark">Đăng nhập</button>
          <button id="btn-profile-logout" class="btn btn-outline-secondary" style="display:none">Đăng xuất</button>
        </div>
      </div>
      <div class="profile-badges">
        <h4 class="mb-3">Huy hiệu của bạn</h4>
        <div style="color:#666;font-size:0.9rem" class="mb-3">Khi hoàn thành các điều kiện, huy hiệu sẽ hiện ở đây.</div>
        <div id="profile-badge-area" class="d-flex gap-3 flex-wrap justify-content-center">
          <!-- Badges will appear here -->
        </div>
      </div>
    </div>
  </section>

  <footer>
    Dự án KHKT — THPT An Thới 
  </footer>
</div>

<!-- Story Modal -->
<div class="story-modal-overlay" id="storyModalOverlay">
  <div class="story-modal">
    <div class="story-modal-header">
      <h2>Chia sẻ câu chuyện của bạn</h2>
      <button class="story-modal-close" id="storyModalClose">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="story-modal-body">
      <form id="storyFormNew">
        <div class="story-form-group">
          <label for="storyTitleNew">Tiêu đề câu chuyện</label>
          <input type="text" class="story-form-input" id="storyTitleNew" placeholder="Nhập tiêu đề hấp dẫn...">
        </div>
        
        <div class="story-form-group">
          <label for="storyContentNew">Kể cho mọi người nghe câu chuyện của bạn</label>
          <textarea class="story-form-input story-form-textarea" id="storyContentNew" placeholder="Chia sẻ câu chuyện đáng nhớ của bạn về Phú Quốc... (giới hạn 200 từ)"></textarea>
          <div class="word-count" id="wordCount">0/200 từ</div>
        </div>
        
        <div class="story-form-group">
          <label>Thêm hình ảnh, video hoặc âm thanh</label>
          <div class="upload-area-new" id="uploadAreaNew">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Kéo thả file vào đây hoặc click để chọn</p>
            <p class="text-muted" style="font-size: 0.9rem; margin-top: 5px;">Hỗ trợ: ảnh, video, âm thanh</p>
            <input type="file" id="fileInputNew" accept="image/*,video/*,audio/*" style="display:none">
          </div>
          <div id="filePreviewNew" class="file-preview-new" style="display:none">
            <!-- Preview will be shown here -->
          </div>
        </div>
      </form>
    </div>
    <div class="story-modal-footer">
      <button class="btn-post-story" id="btnPostStory">Đăng story</button>
    </div>
  </div>
</div>

<!-- Success Message -->
<div class="success-message" id="successMessage">
  <i class="fas fa-check-circle"></i>
  <span>Bạn đã đăng tải thành công câu chuyện của mình</span>
  <button class="success-close" id="successClose">
    <i class="fas fa-times"></i>
  </button>
</div>
<!-- Storytelling Experience Modal -->
<div class="modal fade" id="storyModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" style="background: transparent; border: none;">
     <div class="modal-header" style="background: transparent; border: none; position: absolute; top: 20px; left: 20px; right: 20px; z-index: 1002; display: flex; justify-content: space-between; align-items: center;">
  <!-- THÊM DÒNG NÀY -->
  <h5 class="modal-title text-white m-0" style="font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
    <i class="fas fa-landmark me-2"></i>NHÀ TÙ PHÚ QUỐC
  </h5>
  <button class="btn-close btn-close-white" data-bs-dismiss="modal" style="filter: brightness(0) invert(1);"></button>
</div>        
        <div class="story-modal-content">
          <!-- Trang 1: Mở đầu bí ẩn -->
          <div class="story-page active" id="page1">
            <div class="story-mystery">
              <!-- THÊM TIÊU ĐỀ Ở ĐÂY -->
              <h1 class="text-center mb-4" style="color: var(--gold); font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                NHÀ TÙ PHÚ QUỐC
              </h1>
              
              <div class="mystery-image">
                <i class="fas fa-landmark"></i>
              </div>
              <div class="mystery-question" id="typed-question"></div>
              <p style="color: #ccc; font-size: 1.1rem; margin-bottom: 30px;">
                Di tích lịch sử Quốc gia đặc biệt - Chứng tích của ý chí kiên cường
              </p>
              
              <!-- THÊM ẢNH MINH HỌA NHỎ Ở TRANG ĐẦU -->
              <div class="row justify-content-center mt-4">
                <div class="col-3" data-aos="fade-up">
                  <img src="images/nhatutoancanh.jpg" alt="Nhà tù Phú Quốc" 
                       class="img-fluid rounded shadow" 
                       style="border: 2px solid var(--gold);">
                </div>
                <div class="col-3" data-aos="fade-up" data-aos-delay="200">
                  <img src="images/nhatupq2.jpg" alt="Khu trưng bày" 
                       class="img-fluid rounded shadow" 
                       style="border: 2px solid var(--gold);">
                </div>
                <div class="col-3" data-aos="fade-up" data-aos-delay="400">
                  <img src="images/nhatupqhienvat.jpg" alt="Hiện vật" 
                       class="img-fluid rounded shadow" 
                       style="border: 2px solid var(--gold);">
                </div>
              </div>
              
              <button class="story-btn mt-4" onclick="nextPage(2)">
                Bắt đầu hành trình <i class="fas fa-arrow-right ms-2"></i>
              </button>
            </div>
          </div>

          <!-- Trang 2: Dòng thời gian -->
          <div class="story-page" id="page2">
            <div class="story-content">
              <h3 class="text-center mb-4" style="color: var(--accent);">Dòng Thời Gian Lịch Sử</h3>
              
              <div class="story-timeline">
                <div class="timeline-item" data-aos="fade-right">
                  <div class="timeline-year">1967</div>
                  <div class="timeline-content vintage-paper">
                    <p>Nhà tù Phú Quốc chính thức được xây dựng vào ngày 1/6/1967 với tên gọi "Nhà lao Cây Dừa"</p>
                    <!-- THÊM ẢNH -->
                    <div class="text-center mt-3">
                      <img src="images/nhatu-1967.jpg" alt="Nhà tù năm 1967" 
                           class="img-fluid rounded" style="max-height: 200px;">
                    </div>
                  </div>
                </div>
                
                <div class="timeline-item" data-aos="fade-right" data-aos-delay="200">
                  <div class="timeline-year">1967-1973</div>
                  <div class="timeline-content vintage-paper">
                    <p>Hơn 40,000 tù binh đã bị giam giữ tại đây. Nơi đây trở thành "địa ngục trần gian" với các hình thức tra tấn dã man</p>
                    <!-- THÊM ẢNH -->
                    <div class="text-center mt-3">
                      <img src="images/tubinh.jpg" alt="Tù binh" 
                           class="img-fluid rounded" style="max-height: 200px;">
                    </div>
                  </div>
                </div>
                
                <div class="timeline-item" data-aos="fade-right" data-aos-delay="400">
                  <div class="timeline-year">2014</div>
                  <div class="timeline-content vintage-paper">
                    <p>Được xếp hạng Di tích Quốc gia đặc biệt, trở thành biểu tượng của ý chí kiên cường</p>
                    <!-- THÊM ẢNH -->
                    <div class="text-center mt-3">
                      <img src="images/ditich.jpg" alt="Di tích ngày nay" 
                           class="img-fluid rounded" style="max-height: 200px;">
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="story-controls">
              <button class="story-btn" onclick="prevPage(1)">
                <i class="fas fa-arrow-left me-2"></i>Quay lại
              </button>
              <button class="story-btn" onclick="nextPage(3)">
                Tiếp tục <i class="fas fa-arrow-right ms-2"></i>
              </button>
            </div>
          </div>

          <!-- Trang 3: Hình ảnh và câu chuyện -->
          <div class="story-page" id="page3">
            <div class="story-content">
              <h3 class="text-center mb-4" style="color: var(--accent);">Chứng Tích Lịch Sử</h3>
              
              <!-- ẢNH LỚN CHÍNH -->
              <div data-aos="zoom-in">
                <img src="images/nhatupq1.jpg" alt="Nhà tù Phú Quốc" class="story-image-reveal" 
                     onload="this.classList.add('revealed')" style="width: 100%; border-radius: 10px; max-height: 400px; object-fit: cover;">
              </div>
              
              <div class="vintage-paper mt-4" data-aos="fade-up">
                <h5><i class="fas fa-quote-left text-muted me-2"></i>Câu chuyện từ quá khứ</h5>
                <p class="mb-0">"Dù bị tra tấn dã man, những người tù vẫn giữ vững khí tiết. Họ đã biến nhà tù thành trường học cách mạng, nơi truyền dạy lòng yêu nước và ý chí đấu tranh..."</p>
              </div>

              <!-- THÊM BỘ SƯU TẬP ẢNH -->
              <div class="row mt-4">
                <div class="col-md-4" data-aos="fade-up">
                  <div class="text-center">
                    <img src="images/chuongcopkemgai.jpg" alt="Chuồng cọp" class="img-fluid rounded shadow" style="max-height: 150px;">
                    <p class="small text-muted mt-2">Chuồng cọp kẽm gai</p>
                  </div>
                </div>
                <div class="col-md-4" data-aos="fade-up" data-aos-delay="200">
                  <div class="text-center">
                    <img src="images/hientat.jpg" alt="Hiện vật" class="img-fluid rounded shadow" style="max-height: 150px;">
                    <p class="small text-muted mt-2">Hiện vật lịch sử</p>
                  </div>
                </div>
                <div class="col-md-4" data-aos="fade-up" data-aos-delay="400">
                  <div class="text-center">
                    <img src="images/tutuong.jpg" alt="Tượng đài" class="img-fluid rounded shadow" style="max-height: 150px;">
                    <p class="small text-muted mt-2">Tượng đài tưởng niệm</p>
                  </div>
                </div>
              </div>

              <div class="row mt-4">
                <div class="col-md-6" data-aos="fade-right">
                  <div class="vintage-paper h-100">
                    <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>Hình thức tra tấn</h6>
                    <ul class="mb-0">
                      <li>Chuồng cọp kẽm gai</li>
                      <li>Đóng đinh vào tay</li>
                      <li>Ăn cơm nhạt</li>
                      <li>Gõ thùng, đục răng</li>
                    </ul>
                    <!-- ẢNH MINH HỌA -->
                    <div class="text-center mt-3">
                      <img src="images/trantan.jpg" alt="Tra tấn" class="img-fluid rounded" style="max-height: 120px;">
                    </div>
                  </div>
                </div>
                <div class="col-md-6" data-aos="fade-left">
                  <div class="vintage-paper h-100">
                    <h6><i class="fas fa-medal text-success me-2"></i>Ý chí kiên cường</h6>
                    <ul class="mb-0">
                      <li>45 cuộc vượt ngục</li>
                      <li>Tổ chức học tập</li>
                      <li>Đấu tranh chính trị</li>
                      <li>Đoàn kết tương trợ</li>
                    </ul>
                    <!-- ẢNH MINH HỌA -->
                    <div class="text-center mt-3">
                      <img src="images/vuotnguc.jpg" alt="Vượt ngục" class="img-fluid rounded" style="max-height: 120px;">
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="story-controls">
              <button class="story-btn" onclick="prevPage(2)">
                <i class="fas fa-arrow-left me-2"></i>Quay lại
              </button>
              <button class="story-btn" onclick="nextPage(4)">
                Tiếp tục <i class="fas fa-arrow-right ms-2"></i>
              </button>
            </div>
          </div>

          <!-- Trang 4: Kết thúc và thông điệp -->
          <div class="story-page" id="page4">
            <div class="story-content text-center">
              <div data-aos="zoom-in">
                <div class="mystery-image" style="background: linear-gradient(45deg, #4CAF50, #2E7D32); width: 150px; height: 150px; margin: 0 auto 30px;">
                  <i class="fas fa-peace" style="color: white; font-size: 3rem;"></i>
                </div>
              </div>
              
              <h3 style="color: var(--accent);" data-aos="fade-up">Bài Học Từ Lịch Sử</h3>
              
              <div class="vintage-paper mt-4" data-aos="fade-up" data-aos-delay="200">
                <p class="lead">"Di tích Nhà tù Phú Quốc không chỉ là chứng tích của một thời đau thương, mà còn là minh chứng hùng hồn cho ý chí kiên cường, lòng yêu nước và khát vọng tự do của dân tộc Việt Nam."</p>
              </div>

              <!-- THÊM ẢNH HIỆN TRẠNG NGÀY NAY -->
              <div class="row mt-4">
                <div class="col-md-8 mx-auto">
                  <div data-aos="fade-up" data-aos-delay="400">
                    <img src="images/hientai.jpg" alt="Nhà tù ngày nay" class="img-fluid rounded shadow">
                    <p class="small text-muted mt-2">Di tích Nhà tù Phú Quốc ngày nay - Nơi giáo dục truyền thống</p>
                  </div>
                </div>
              </div>

              <div class="vintage-paper mt-4" data-aos="fade-up" data-aos-delay="600">
                <h6>Thông điệp cho thế hệ trẻ:</h6>
                <p class="mb-0">Hãy trân trọng hòa bình, phát huy tinh thần bất khuất của cha ông, và góp phần xây dựng đất nước ngày càng phát triển.</p>
              </div>

              <div class="mt-5" data-aos="fade-up" data-aos-delay="800">
                <button class="story-btn me-3" onclick="closeStoryModal()">
                  <i class="fas fa-check me-2"></i>Hoàn thành
                </button>
                <button class="btn btn-outline-secondary" onclick="restartStory()">
                  <i class="fas fa-redo me-2"></i>Xem lại
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
<!-- Các modal và popup khác giữ nguyên -->
<!-- DI TÍCH MODAL -->
<div class="modal fade" id="diModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background:linear-gradient(90deg,var(--accent),#d32);color:white">
        <h5 class="modal-title" id="diTitle"></h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="diBody"></div>
      <div class="modal-footer">
        <div class="me-auto">
          <small class="text-muted">Toạ độ: <span id="diCoords"></span></small>
        </div>
        <button id="btn-checkin" class="btn btn-outline-success">Check-in (Tôi đã đến)</button>
        <button id="btn-play" class="btn btn-accent" style="display:none">Chơi mini-game</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<!-- GAME FULLSCREEN MODE -->
<div id="gameFullscreen" class="game-fullscreen">
  <div class="game-fullscreen-header">
    <h2 class="game-fullscreen-title" id="gameFullscreenTitle">Mini-game</h2>
    <button class="game-fullscreen-close" id="gameFullscreenClose">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="game-fullscreen-body" id="gameFullscreenBody">
    <!-- Nội dung game sẽ được đặt ở đây -->
  </div>
</div>

<!-- VICTORY POPUP -->
<div id="victoryPopup" class="victory-popup" style="display:none">
  <div class="victory-content">
    <div class="victory-title">🎉 Chiến Thắng!</div>
    <div class="victory-message" id="victoryMessage">Bạn đã hoàn thành xuất sắc thử thách!</div>
    <button id="victoryClose" class="btn btn-accent btn-lg">Tuyệt vời!</button>
  </div>
</div>

<!-- AUTH modal -->
<div class="modal fade" id="authModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="authTitle">Đăng ký</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="authAlert" class="alert alert-danger d-none"></div>
        <input id="inName" class="form-control mb-2" placeholder="Tên hiển thị">
        <input id="inEmail" class="form-control mb-2" placeholder="Email">
        <input id="inPass" type="password" class="form-control mb-2" placeholder="Mật khẩu">
        <div class="form-text">Lưu tại trình duyệt. Để dùng thực, sẽ hướng dẫn tích hợp Firebase.</div>
      </div>
      <div class="modal-footer">
        <button id="authSubmit" class="btn btn-dark">Xác nhận</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
      </div>
    </div>
  </div>
</div>

<!-- Badge Popup Modal -->
<div id="badgePopup" class="badge-popup" style="display:none">
  <div class="badge-popup-content">
    <img id="badgePopupImg" src="" class="badge-popup-img" alt="Huy hiệu">
    <div id="badgePopupTitle" class="badge-popup-title"></div>
    <div id="badgePopupMessage" class="badge-popup-message">Chúc mừng! Bạn đã nhận được huy hiệu</div>
    <button id="badgePopupClose" class="btn btn-accent">Tuyệt vời!</button>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
/* ---------------------------
  HỆ THỐNG ĐĂNG NHẬP ĐA THIẾT BỊ - ĐƠN GIẢN & ỔN ĐỊNH
----------------------------*/

// Biến toàn cục
let currentPage = 'home';
let stories = [];
let currentUser = null;

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCB9Ff43rlcqrR8huhMk3Z-vVuSxL63TGI",
  authDomain: "pqstorymap.xyz",
  projectId: "phuquoc-map-6bb91", 
  storageBucket: "phuquoc-map-6bb91.firebasestorage.app",
  messagingSenderId: "1035203802998",
  appId: "1:1035203802998:web:1d509c4f2bb00dc341ec57",
  measurementId: "G-YEYE6GKYVZ"
};

// Khai báo Firebase
let auth, db;

/* ---------- FIREBASE ĐƠN GIẢN ---------- */
function initFirebase() {
  try {
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
      console.log('✅ Firebase initialized');
    }
    
    auth = firebase.auth();
    db = firebase.firestore();
    
    // Theo dõi trạng thái đăng nhập
    auth.onAuthStateChanged((user) => {
      if (user) {
        console.log('🔥 User logged in:', user.email);
        currentUser = {
          id: user.uid,
          name: user.displayName || user.email,
          email: user.email,
          badges: [],
          visitedSites: [],
          completedGames: {}
        };
        
        // Load user data từ Firestore
        loadUserData(user.uid);
      } else {
        console.log('🔥 User logged out');
        currentUser = null;
      }
      refreshProfileAuthUI();
    });
    
    return true;
  } catch (error) {
    console.log('⚠️ Firebase failed, using localStorage');
    return false;
  }
}

// Load user data từ Firestore
async function loadUserData(uid) {
  try {
    const userDoc = await db.collection('users').doc(uid).get();
    if (userDoc.exists) {
      const userData = userDoc.data();
      currentUser.badges = userData.badges || [];
      currentUser.visitedSites = userData.visitedSites || [];
      currentUser.completedGames = userData.completedGames || {};
      console.log('✅ User data loaded');
    }
  } catch (error) {
    console.log('⚠️ Cannot load user data');
  }
}

// Save user data lên Firestore
async function saveUserData() {
  if (!currentUser || !auth.currentUser) return;
  
  try {
    await db.collection('users').doc(auth.currentUser.uid).set({
      badges: currentUser.badges,
      visitedSites: currentUser.visitedSites,
      completedGames: currentUser.completedGames,
      lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
    console.log('✅ User data saved');
  } catch (error) {
    console.log('⚠️ Cannot save user data');
  }
}

/* ---------- ĐĂNG KÝ/ĐĂNG NHẬP ĐƠN GIẢN ---------- */
async function authRegister(){
  const name = document.getElementById('inName').value.trim();
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  
  if(!name || !email || !pass){ 
    showAuthError('Điền đủ tên, email, mật khẩu'); 
    return; 
  }
  
  if (pass.length < 6) {
    showAuthError('Mật khẩu phải có ít nhất 6 ký tự');
    return;
  }
  
  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
    const user = userCredential.user;
    
    // Cập nhật tên hiển thị
    await user.updateProfile({ displayName: name });
    
    // Tạo user document
    await db.collection('users').doc(user.uid).set({
      name: name,
      email: email,
      badges: [],
      visitedSites: [],
      completedGames: {},
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    authModal.hide();
    alert('🎉 Đăng ký thành công! Chào mừng ' + name);
    
  } catch (error) {
    let message = 'Lỗi đăng ký';
    if (error.code === 'auth/email-already-in-use') {
      message = 'Email đã được sử dụng';
    } else if (error.code === 'auth/weak-password') {
      message = 'Mật khẩu quá yếu';
    }
    showAuthError(message);
  }
}

async function authLogin(){
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  
  if(!email || !pass){ 
    showAuthError('Điền đủ email và mật khẩu'); 
    return; 
  }
  
  try {
    await auth.signInWithEmailAndPassword(email, pass);
    authModal.hide();
    alert('✅ Đăng nhập thành công!');
    
  } catch (error) {
    let message = 'Lỗi đăng nhập';
    if (error.code === 'auth/user-not-found') {
      message = 'Email không tồn tại';
    } else if (error.code === 'auth/wrong-password') {
      message = 'Mật khẩu không đúng';
    }
    showAuthError(message);
  }
}

async function logoutUser(){
  try {
    await auth.signOut();
    alert('Đăng xuất thành công');
  } catch (error) {
    console.log('Logout error:', error);
  }
}

function showAuthError(msg){ 
  const a = document.getElementById('authAlert'); 
  if (a) {
    a.innerText = msg; 
    a.classList.remove('d-none'); 
  }
}

/* ---------- LOCALSTORAGE FALLBACK (Đơn giản) ---------- */
const STORAGE_USERS = 'pq_users';
const STORAGE_SESSION = 'pq_session';

function getCurrentUser() {
  // Ưu tiên Firebase user
  if (currentUser) return currentUser;
  
  // Fallback localStorage
  const session = JSON.parse(localStorage.getItem(STORAGE_SESSION) || 'null');
  if (session && new Date(session.expiresAt) > new Date()) {
    const users = JSON.parse(localStorage.getItem(STORAGE_USERS) || '[]');
    const user = users.find(u => u.id === session.userId);
    if (user) {
      console.log('📱 Using localStorage user');
      return user;
    }
  }
  return null;
}

function updateUser(user) {
  // Nếu dùng Firebase
  if (currentUser && auth.currentUser) {
    saveUserData();
    return true;
  }
  
  // Fallback localStorage
  const users = JSON.parse(localStorage.getItem(STORAGE_USERS) || '[]');
  const index = users.findIndex(u => u.id === user.id);
  if (index !== -1) {
    users[index] = user;
    localStorage.setItem(STORAGE_USERS, JSON.stringify(users));
    return true;
  }
  return false;
}

/* ---------- PROFILE UI ---------- */
function refreshProfileAuthUI(){
  const user = getCurrentUser();
  const profileInfo = document.getElementById('profile-info');
  const btnLogin = document.getElementById('btn-profile-login');
  const btnRegister = document.getElementById('btn-profile-register');
  const btnLogout = document.getElementById('btn-profile-logout');
  
  if (user) {
    btnLogin.style.display = 'none';
    btnRegister.style.display = 'none';
    btnLogout.style.display = 'inline-block';
    
    const source = currentUser ? '🔥 Firebase' : '📱 LocalStorage';
    profileInfo.innerHTML = `Xin chào <strong>${user.name}</strong> — ${user.email}<br><small>${source}</small>`;
    profileInfo.className = 'alert alert-success';
    
    renderUserBadges(user);
  } else {
    btnLogin.style.display = 'inline-block';
    btnRegister.style.display = 'inline-block';
    btnLogout.style.display = 'none';
    
    profileInfo.innerHTML = 'Bạn chưa đăng nhập. Vui lòng đăng nhập để lưu tiến trình.';
    profileInfo.className = 'alert alert-info';
    
    renderProfileBadges();
  }
}

function renderUserBadges(user) {
  const wrap = document.getElementById('profile-badge-area');
  if (!wrap) return;
  
  wrap.innerHTML = '';
  
  if (!user.badges || user.badges.length === 0) {
    wrap.innerHTML = '<div class="text-muted">Chưa có huy hiệu nào. Hãy khám phá các địa điểm!</div>';
    return;
  }
  
  user.badges.forEach(badge => {
    const el = document.createElement('div');
    el.className = 'text-center';
    el.innerHTML = `
      <img src="${badge.icon}" class="badge-img" alt="${badge.name}">
      <div style="font-size:12px; max-width:80px">${badge.name}</div>
    `;
    wrap.appendChild(el);
  });
}

function renderProfileBadges() {
  const wrap = document.getElementById('profile-badge-area');
  if (!wrap) return;
  
  wrap.innerHTML = '<div class="text-muted">Đăng nhập để xem huy hiệu của bạn</div>';
}

/* ---------- BADGES & GAME SYSTEM ---------- */
function awardBadge(id, name, icon) {
  const user = getCurrentUser();
  if (!user) {
    alert('Vui lòng đăng nhập để nhận huy hiệu');
    return false;
  }
  
  if (!user.badges) user.badges = [];
  if (user.badges.find(b => b.id === id)) return false;
  
  user.badges.push({ id, name, icon });
  
  // Cập nhật user data
  if (updateUser(user)) {
    showBadgePopup(name, icon);
    return true;
  }
  return false;
}

function markVisited(siteId) {
  const user = getCurrentUser();
  if (!user) return;
  
  if (!user.visitedSites) user.visitedSites = [];
  if (!user.visitedSites.includes(siteId)) {
    user.visitedSites.push(siteId);
    updateUser(user);
  }
}

function recordDone(siteId, gameId) {
  const user = getCurrentUser();
  if (!user) return;
  
  if (!user.completedGames) user.completedGames = {};
  if (!user.completedGames[siteId]) user.completedGames[siteId] = [];
  if (!user.completedGames[siteId].includes(gameId)) {
    user.completedGames[siteId].push(gameId);
    updateUser(user);
  }
}

/* ---------- KHỞI TẠO ỨNG DỤNG ---------- */
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 Starting application...');
  // Đảm bảo modal được khởi tạo
if (document.getElementById('diModal')) {
  diModal = new bootstrap.Modal(document.getElementById('diModal'));
}
  // Khởi tạo Firebase
  const firebaseOK = initFirebase();
  
  if (!firebaseOK) {
    console.log('⚠️ Using localStorage mode only');
  }
  
  // Khởi tạo các component
  initData();
  refreshProfileAuthUI();
  loadStories();
  initMap();
  // Thiết lập real-time listener cho stories
if (firebaseOK) {
  setupStoriesListener();
}
  console.log('✅ Application started successfully');
});


/* ---------- Menu Navigation ---------- */
const menuBtn = document.getElementById('nav-menu');
const menuDropdown = document.getElementById('menuDropdown');
const menuOverlay = document.getElementById('menuOverlay');
const menuItems = document.querySelectorAll('.menu-item');

menuBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  menuDropdown.classList.toggle('active');
  menuOverlay.classList.toggle('active');
});

menuOverlay.addEventListener('click', () => {
  menuDropdown.classList.remove('active');
  menuOverlay.classList.remove('active');
});

menuItems.forEach(item => {
  item.addEventListener('click', () => {
    const page = item.dataset.page;
    showPage(page);
    menuDropdown.classList.remove('active');
    menuOverlay.classList.remove('active');
    menuItems.forEach(i => i.classList.remove('active'));
    item.classList.add('active');
  });
});

function showPage(page) {
  document.querySelectorAll('section[id^="page-"]').forEach(section => {
    section.style.display = 'none';
  });
  
  document.getElementById(`page-${page}`).style.display = 'block';
  
  if (page === 'map') {
    setTimeout(() => {
      if (typeof map !== 'undefined') map.invalidateSize();
    }, 300);
  } else if (page === 'stories') {
    loadStories();
  }
  currentPage = page;
}

/* ---------- STORIES SYSTEM VỚI FIRESTORE ---------- */
async function loadStories() {
  try {
    // Thử load từ Firestore trước
    const storiesRef = db.collection('stories');
    const snapshot = await storiesRef.orderBy('timestamp', 'desc').get();
    
    stories = [];
    snapshot.forEach(doc => {
      const storyData = doc.data();
      stories.push({
        id: doc.id,
        ...storyData
      });
    });
    
    console.log('✅ Stories loaded from Firestore:', stories.length);
    renderStories();
    
  } catch (error) {
    console.log('⚠️ Cannot load from Firestore, using localStorage');
    // Fallback to localStorage
    const savedStories = localStorage.getItem('pq_stories');
    if (savedStories) {
      stories = JSON.parse(savedStories);
    }
    renderStories();
  }
}

async function saveStoryToFirestore(story) {
  try {
    const storyRef = db.collection('stories').doc(story.id.toString());
    await storyRef.set({
      title: story.title,
      content: story.content,
      author: story.author,
      authorId: story.authorId,
      timestamp: story.timestamp,
      likes: story.likes,
      likedBy: story.likedBy || [],
      comments: story.comments || [],
      media: story.media,
      mediaType: story.mediaType,
      colorClass: story.colorClass
    });
    console.log('✅ Story saved to Firestore');
    return true;
  } catch (error) {
    console.log('⚠️ Cannot save to Firestore:', error);
    return false;
  }
}

async function updateStoryInFirestore(storyId, updates) {
  try {
    const storyRef = db.collection('stories').doc(storyId.toString());
    await storyRef.update(updates);
    console.log('✅ Story updated in Firestore');
    return true;
  } catch (error) {
    console.log('⚠️ Cannot update in Firestore:', error);
    return false;
  }
}

async function saveStories() {
  // Lưu vào localStorage như backup
  localStorage.setItem('pq_stories', JSON.stringify(stories));
}

async function likeStory(storyId) {
  const user = getCurrentUser();
  if (!user) {
    alert('Vui lòng đăng nhập để thích câu chuyện.');
    return;
  }
  
  const story = stories.find(s => s.id === storyId);
  if (story) {
    // Kiểm tra xem user đã like chưa
    const userLiked = story.likedBy && story.likedBy.includes(user.id);
    
    if (userLiked) {
      // Bỏ like
      story.likes--;
      story.likedBy = story.likedBy.filter(id => id !== user.id);
    } else {
      // Thêm like
      story.likes++;
      if (!story.likedBy) story.likedBy = [];
      story.likedBy.push(user.id);
    }
    
    // Cập nhật UI
    story.liked = !userLiked;
    
    // Đồng bộ lên Firestore
    await updateStoryInFirestore(storyId, {
      likes: story.likes,
      likedBy: story.likedBy
    });
    
    saveStories();
    renderStories();
  }
}

async function addComment(storyId) {
  const user = getCurrentUser();
  if (!user) {
    alert('Vui lòng đăng nhập để bình luận.');
    return;
  }
  
  const commentInput = document.getElementById(`comment-input-${storyId}`);
  if (!commentInput) return;
  
  const content = commentInput.value.trim();
  if (!content) {
    alert('Vui lòng nhập nội dung bình luận.');
    return;
  }
  
  const story = stories.find(s => s.id === storyId);
  if (story) {
    const newComment = {
      id: Date.now().toString(),
      author: user.name,
      authorId: user.id,
      content: content,
      timestamp: new Date().toISOString()
    };
    
    if (!story.comments) story.comments = [];
    story.comments.push(newComment);
    
    // Đồng bộ lên Firestore
    await updateStoryInFirestore(storyId, {
      comments: story.comments
    });
    
    saveStories();
    renderStories();
    commentInput.value = '';
  }
}

function toggleComments(storyId) {
  const commentsDiv = document.getElementById(`comments-${storyId}`);
  if (commentsDiv) {
    commentsDiv.style.display = commentsDiv.style.display === 'block' ? 'none' : 'block';
  }
}

function formatTimeAgo(timestamp) {
  const now = new Date();
  const storyTime = new Date(timestamp);
  const diffInSeconds = Math.floor((now - storyTime) / 1000);
  
  if (diffInSeconds < 60) return 'Vừa xong';
  if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} phút trước`;
  if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} giờ trước`;
  return `${Math.floor(diffInSeconds / 86400)} ngày trước`;
}

function renderStories() {
  const storiesWallNew = document.getElementById('storiesWallNew');
  if (!storiesWallNew) return;
  
  storiesWallNew.innerHTML = '';
  
  if (stories.length === 0) {
    storiesWallNew.innerHTML = `
      <div class="col-12 text-center py-5" style="grid-column: 1 / -1;">
        <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Chưa có câu chuyện nào</h4>
        <p class="text-muted">Hãy là người đầu tiên chia sẻ ký ức về Phú Quốc!</p>
      </div>
    `;
    return;
  }
  
  const currentUser = getCurrentUser();
  
  stories.forEach(story => {
    const userLiked = currentUser && story.likedBy && story.likedBy.includes(currentUser.id);
    
    const storyElement = document.createElement('div');
    storyElement.className = `story-note-new ${story.colorClass}`;
    storyElement.innerHTML = `
      <div>
        <h3>${story.title}</h3>
        ${story.media ? (
          story.mediaType && story.mediaType.startsWith('image/') ? 
            `<img src="${story.media}" alt="${story.title}" class="story-media-new">` :
          story.mediaType && story.mediaType.startsWith('video/') ? 
            `<video controls class="story-media-new"><source src="${story.media}" type="${story.mediaType}">Trình duyệt của bạn không hỗ trợ video.</video>` :
          story.mediaType && story.mediaType.startsWith('audio/') ? 
            `<audio controls class="story-media-new"><source src="${story.media}" type="${story.mediaType}">Trình duyệt của bạn không hỗ trợ audio.</audio>` :
            ''
        ) : ''}
        <div class="story-content-new">${story.content}</div>
      </div>
      <div>
        <div class="story-meta-new">
          <span>${story.author}</span>
          <span>${formatTimeAgo(story.timestamp)}</span>
        </div>
        <div class="story-actions-new">
          <div class="story-action-new ${userLiked ? 'liked' : ''}" onclick="likeStory('${story.id}')">
            <i class="fas fa-heart"></i>
            <span>${story.likes || 0}</span>
          </div>
          <div class="story-action-new" onclick="toggleComments('${story.id}')">
            <i class="fas fa-comment"></i>
            <span>${story.comments ? story.comments.length : 0}</span>
          </div>
        </div>
        <div class="story-comments" id="comments-${story.id}">
          ${story.comments ? story.comments.map(comment => `
            <div class="story-comment">
              <div class="story-comment-author">${comment.author}</div>
              <div class="story-comment-content">${comment.content}</div>
              <div class="story-comment-time" style="font-size:0.7rem;color:#888;margin-top:2px">
                ${formatTimeAgo(comment.timestamp)}
              </div>
            </div>
          `).join('') : ''}
          <div class="add-comment-form">
            <input type="text" class="add-comment-input" id="comment-input-${story.id}" placeholder="Viết bình luận...">
            <button class="add-comment-btn" onclick="addComment('${story.id}')">Gửi</button>
          </div>
        </div>
      </div>
    `;
    storiesWallNew.appendChild(storyElement);
  });
}

/* ---------- REAL-TIME UPDATES ---------- */
function setupStoriesListener() {
  try {
    const storiesRef = db.collection('stories');
    
    storiesRef.orderBy('timestamp', 'desc')
      .onSnapshot((snapshot) => {
        console.log('📡 Real-time update received');
        
        snapshot.docChanges().forEach((change) => {
          const storyData = change.doc.data();
          const storyId = change.doc.id;
          
          if (change.type === 'added') {
            // Kiểm tra xem story đã tồn tại chưa
            const existingIndex = stories.findIndex(s => s.id === storyId);
            if (existingIndex === -1) {
              stories.unshift({
                id: storyId,
                ...storyData
              });
            }
          }
          
          if (change.type === 'modified') {
            const existingIndex = stories.findIndex(s => s.id === storyId);
            if (existingIndex !== -1) {
              stories[existingIndex] = {
                id: storyId,
                ...storyData
              };
            }
          }
          
          if (change.type === 'removed') {
            stories = stories.filter(s => s.id !== storyId);
          }
        });
        
        // Sắp xếp lại theo thời gian
        stories.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        // Cập nhật giao diện
        renderStories();
        
      }, (error) => {
        console.log('⚠️ Real-time listener error:', error);
      });
      
  } catch (error) {
    console.log('⚠️ Cannot setup real-time listener');
  }
}

/* ---------- MAP SYSTEM ---------- */
let map;
let currentTooltip = null;

function initMap() {
  if (!document.getElementById('map')) return;
  
  // Giới hạn khu vực bản đồ cho Phú Quốc
  const phuQuocBounds = L.latLngBounds(
    L.latLng(9.8, 103.7),   // Tây Nam (góc dưới bên trái)
    L.latLng(10.5, 104.2)   // Đông Bắc (góc trên bên phải)
  );
  
  // Tạo bản đồ với các tùy chọn giới hạn
  map = L.map('map', {
    zoomControl: true,
    maxBounds: phuQuocBounds,           // Giới hạn khu vực
    maxBoundsViscosity: 1.0,            // Độ "dính" khi kéo ra biên
    minZoom: 10,                        // Zoom tối thiểu
    maxZoom: 16                         // Zoom tối đa
  }).setView([10.28, 103.98], 11);
  
  // Thêm tile layer với bounds
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap',
    bounds: phuQuocBounds              // Giới hạn tile chỉ trong khu vực
  }).addTo(map);
  
  // Đặt giới hạn cho bản đồ
  map.setMaxBounds(phuQuocBounds);
  
  // Phần còn lại của hàm giữ nguyên...
  function createCustomIcon(category) {
    const colorMap = {
      'nature': '#A5D6A7',
      'culture': '#FFCC80', 
      'entertainment': '#CE93D8',
      'craft': '#EF9A9A'
    };
    
    const color = colorMap[category] || '#90CAF9';
    
    return L.divIcon({
      className: 'custom-pin',
      html: `
        <div style="
          background: ${color}; 
          width: 24px; 
          height: 24px; 
          border-radius: 50%; 
          border: 3px solid white;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        "></div>
      `,
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });
  }

  // Dữ liệu địa điểm
  const DI_TICH = [
    // Nhóm Thiên Nhiên (Xanh Lá pastel)
    {
      id:'vuon-quoc-gia',
      name:'Vườn quốc gia Phú Quốc',
      address:'Vườn quốc gia Phú Quốc, Kiên Giang, Việt Nam',
      note:'Vườn quốc gia với hệ sinh thái rừng nhiệt đới phong phú, nơi bảo tồn nhiều loài động thực vật quý hiếm.',
      extra:[
'Diện tích: 31.422 ha', 
'Vườn quốc gia Phú Quốc có đến 12.794 ha rừng',
'Có nhiều loài động thực vật quý hiếm: 929 loài thực vật, 89 loài san hô cứng, 19 loài san hô mềm, 125 loài cá ở rặng san hô, 132 loài thân mềm, 32 loài da gai và 62 loài rong biển,...',
'Hệ sinh thái rừng nhiệt đới đa dạng'],
      lat:10.3645, lng:103.9919,
      games:[],
      img: [
      'images/vuonqg.jpg',
      'images/vuon.jpg',
      'images/vuon1.jpg',
      'images/vuon2.jpg',
      'images/vuon3.jpg',
      'images/vuon4.jpg',
      'images/vuon5.jpg',
      ],
      category: 'nature'
    },
    {
      id:'bai-sao',
      name:'Bãi Sao',
      address:'Bãi Sao, Phú Quốc, Kiên Giang, Việt Nam',
      note:'Bãi biển đẹp với cát trắng mịn, nước biển trong xanh, hình lưỡi liềm đặc trưng.',
      extra:[
'Bãi cát dài 7km', 
'Biển ở Bãi Sao rất êm và nước khá nông, kể cả vào mùa mưa nên rất thích hợp để cảm nhận “nhịp đập” của biển cả.', 
'Hình dạng lưỡi liềm độc đáo',
'Du khách cũng có thể vừa tắm biển vừa chơi các trò chơi thú vị như: bóng ném, chèo thuyền Kayak, cano kéo dù, lái moto nước, phao chuối',
],
      lat:10.0572, lng:104.0360,
      games:[],
      img: [
      'images/baisao.jpg',
      'images/baisao1.jpg',
      'images/baisao2.jpg',
      'images/baisao3.jpg',
      'images/baisao4.jpg',
      'images/baisao5.jpg',
      'images/baisao6.jpg',
      'images/baisao7.jpg',
      'images/baisao8.jpg',
      'images/baisao9.jpg',
      ],
      category: 'nature'
    },
    {
      id:'hon-thom',
      name:'Hòn Thơm',
      address:'Hòn Thơm, Phú Quốc, Kiên Giang, Việt Nam',
      note:'Hòn đảo lớn thứ hai trong quần đảo An Thới, nổi tiếng với cảnh quan thiên nhiên hoang sơ.',
      extra: [
'Nằm cách cảng An Thới khoảng 6km', 
'Điểm nhấn của hòn đảo là phong cảnh hoang sơ, thơ mộng với màu nước trong xanh, nhiều ghềnh đá đẹp và lạ mắt.', 
'Nhiều bãi biển đẹp như bãi Nồm, bãi Nam, bãi Chướng, bãi Trào', 
'Hòn Thơm phát triển theo hướng du lịch giải trí và nghỉ dưỡng với cáp treo và quần thể vui chơi giải trí biển Sun World Hon Thom Nature Park',
],
      lat:9.9560, lng:104.0179,
      games:[],
      img: [
      'images/honthom.jpg',
      'images/honthom1.jpg',
      'images/honthom2.jpg',
      'images/honthom3.jpg',
      'images/honthom4.jpg',
      'images/honthom5.jpg',
      ],

      category: 'nature'
    },
    
    // Nhóm Văn Hóa - Lịch Sử (Cam pastel)
    {
      id:'nha-tu',
      name:'Nhà tù Phú Quốc',
      address:'350 Đ. Nguyễn Văn Cừ, An Thới, Phú Quốc, Kiên Giang, Việt Nam',
      note:'Di tích lịch sử cấp Quốc gia đặc biệt (2014). Nơi giam giữ nhiều tù binh trong kháng chiến; chứng tích tra tấn, nhưng cũng là biểu tượng ý chí kiên cường.',
      extra:[
        'Năm xây dựng: 01/06/1967',
        'Còn gọi: Nhà lao Cây Dừa',
        'Khoảng 40.000 tù binh từng bị giam; nhiều tù nhân bị tra tấn dã man. Có 45 cuộc vượt ngục ghi nhận.',
        'Các hình thức tra tấn dã man: đóng kim, chuồng cọp kẽm gai, ăn cơm nhạt, gõ thùng, đục răng, đóng đinh,..',
      ],
      lat:10.044417, lng:104.017639,
      games:['quiz_nhatu', 'memory_nhatu'],
      img: [
      'images/nhatupq1.jpg',
      'images/nhatuphuquoc2.jpg',
      'images/nhatupq3.jpg',
      'images/nhatupq4.jpg',
      'images/nhatupq5.jpg',
      'images/nhatupq6.jpg',
      'images/nhatupq7.jpg',
      'images/nhatupq8.jpg',
      'images/nhatupq9.jpg',
      'images/nhatupq10.jpg',
      'images/nhatupq11.jpg',
      'images/nhatupq12.jpg', ],
      category: 'culture'
    },
    {
      id:'chua',
      name:'Chùa Hộ Quốc',
      address:'426H+GVQ, Dương Tơ, Phú Quốc, Kiên Giang, Việt Nam',
      note:'Thiền viện Trúc Lâm Hộ Quốc — kiến trúc tâm linh lớn, phong cách cổ truyền Việt.',
      extra:['Ngôi chùa lớn nhất Phú Quốc', 'Kiến trúc truyền thống Việt Nam', 'Không gian tâm linh thanh tịnh'],
      lat:10.110028, lng:104.029056,
      games:[],
      img: [
      'images/chua.jpg',
      'images/chua1.jpg',
      'images/chua2.jpg',
      'images/chua3.jpg',
      'images/chua4.jpg',
      'images/chua5.jpg',  ],
      category: 'culture'
    },
    {
      id:'dinh-ntt',
      name:'Đình Thần Nguyễn Trung Trực',
      address:'9RFV+848, Gành Dầu, Phú Quốc, Kiên Giang, Việt Nam',
      note:'Di tích lịch sử văn hóa. Đình thờ Anh hùng dân tộc Nguyễn Trung Trực (1839-1868).',
      extra:[
       'Nguyễn Trung Trực là vị anh hùng có công lớn trong công cuộc chống thực dân Pháp giành lại Rạch Giá.',
        'Với chiến tích lẫy lừng đánh chìm tàu Hy Vọng của Pháp trên sông Nhật Tảo và trận đánh tiêu diệt đồn Rạch Giá, Kiên Giang.',
        'Tháng 9/1868 ông bị thực dân Pháp bắt tại Phú Quốc. Ngày 27/10/1868 chúng đưa ông về Rạch Giá và xử tử tại đây.',
      'Đình được xây dựng từ năm 1993',
     'Sở hữu nhiều kiến trúc độc đáo của ông cha ta thời xưa. Với đường nét hoa văn, chất liệu xây dựng và màu sắc đậm chất văn hóa Nam Bộ xưa.',
        'Vào ngày 26 đến ngày 28 tháng 8 âm lịch hàng năm, đền thờ Nguyễn Trung Trực Phú Quốc đón người dân địa phương về đây dâng hương, tưởng nhớ đến công lao của ông.',
      ],
      lat:10.373306, lng:103.842972,
      games:['quiz_trungtruc', 'memory_trungtruc'],
      img:'images/dinhntt.jpg',
      category: 'culture'
    },
    {
      id:'baotang',
      name:'Bảo tàng Cội Nguồn',
      address:'Số 149, đường Trần Hưng Đạo, Dương Đông, Phú Quốc',
      note:'Bảo tàng tư nhân nhưng sở hữu nhiều hiện vật quý giá về văn hoá - lịch sử của Phú Quốc',
      extra:['Năm khởi công xây dựng: 2009', 'Quy mô lớn với nhiều hạng mục như nhà trưng bày, nhà sàn truyền thống, khu quà lưu niệm,..(rộng khoảng 6 ha)', 'Sở hữu nhiều bộ sưu tập gốm, đá, sứ,..Ngoài ra còn có bộ sưu tập biển, rừng Phú Quốc'],
      lat:10.192500, lng:103.967000,
      games:[],
      img:[
      'images/coinguon.jpg',
      'images/coinguon2.jpg',
      'images/coinguon3.jpg',
      'images/coinguon4.jpg',
      'images/coinguon5.jpg',
      'images/coinguon6.jpg',
      'images/coinguon7.jpg',
      'images/bt.jpg',
      'images/bt1.jpg',
      'images/bt2.jpg',
      'images/bt3.jpg',
      'images/bt4.jpg',
      'images/bt5.jpg',
      'images/bt6.jpg',
      'images/bt7.jpg',
      'images/bt8.jpg',
      'images/bt9.jpg',
      'images/bt10.jpg',
      'images/bt11.jpg',
      'images/bt12.jpg',
      'images/bt13.jpg',
      'images/bt14.jpg',
      'images/bt15.jpg',
       ],
      category: 'culture'
    },
    {
    id:'quang-truong',
      name:'Quảng trường Hồ Chí Minh',
      address:'6XHH+66W, Dương Đông, Phú Quốc, An Giang, Việt Nam',
      note:'Quảng trường Hồ Chí Minh và tượng đài Bác Hồ là công trình có ý nghĩa chính trị, văn hoá và lịch sử sâu sắc, đặc biệt là nơi tôn vinh công lao to lớn của Chủ tịch Hồ Chí Minh',
        extra:[
        'Quảng trường nơi đặt tượng đài Bác Hồ với quy mô 7,45 ha tại khu vực trung tâm đô thị', 
        'Tượng Bác được đúc bằng hợp kim đồng, tổng chiều cao 20,7 m',
        'Phía sau lưng tượng đài là bức phù điêu hai mặt, chạm nổi, dài 63m, nơi cao nhất 10,8 m, nằm trên bệ cao 1,2 m. Phù điêu gồm 484 tấm đá trắng ghép lại với nhau.',
        'Bên cạnh đó, kết hợp với đền thờ, nhà trưng bày về Chủ tịch Hồ Chí Minh, nhà đón tiếp, sân quảng trường và nhiều hạng mục khác tạo thành một quần thể công trình có ý nghĩa chính trị, văn hóa to lớn và sâu sắc, mang tầm quốc gia và quốc tế.'
      ],
      lat:10.2286667, lng:103.9770556,
      games:[],
      img: [
      'images/quangtruong.jpg',
      'images/quangtruong1.jpg',
      'images/quangtruong2.jpg',
   ],
      category: 'culture',
    },

    {
      id:'dinh-cau',
      name:'Dinh Cậu',
      address:'Khu phố 2, Tp. Phú Quốc, Kiên Giang 92500, Việt Nam',
      note:'Di tích thắng cảnh; tín ngưỡng của ngư dân, có lễ hội hàng năm (15–16/10 âm lịch).',
      extra:[
'Xây dựng: 1937 (tu sửa 1997)', 
'Là nơi thờ phụng Chúa Ngọc Nương Nương và Cậu Tài, Cậu Quý',
'Hằng năm, vào ngày 15 và 16 tháng 10 âm lịch, lễ hội Dinh Cậu được tổ chức long trọng với nhiều nghi thức truyền thống nhằm tôn vinh và tưởng nhớ các vị thần này, thu hút đông đảo người dân và du khách đến tham dự.', 
'Vị trí đẹp nhìn ra biển',
],
      lat:10.217194, lng:103.956500,
      games:[],
     img:[
      'images/dinhcau.jpg',
      'images/dc1.jpg',
      'images/dc2.jpg',
      'images/dc3.jpg',
      'images/dc4.jpg',
      'images/dc5.jpg',
      'images/dc6.jpg',
      'images/dc7.jpg',
      'images/dc8.jpg',
      ],
      category: 'culture'
    },
    
    // Nhóm Giải Trí & Hiện Đại (Tím pastel)
    {
      id:'cap-treo',
      name:'Cáp treo Hòn Thơm',
      address:'Cáp treo Hòn Thơm, Phú Quốc, Kiên Giang, Việt Nam',
      note:'Tuyến cáp treo vượt biển dài nhất thế giới, kết nối đảo Phú Quốc với đảo Hòn Thơm.',
      extra: [ 
     'Cáp treo Hòn Thơm Phú Quốc có chiều dài 7899,9m xuất phát từ ga An Thới, qua đảo Hòn Dừa, Hòn Rỏi và kết thúc ở Hòn Thơm, Phú Quốc.',
    'Cáp treo Hòn Thơm Phú Quốc được tổ chức Guinness thế giới chứng nhận là Cáp treo 3 dây dài nhất thế giới',
    ],
      lat:10.0269, lng:104.0073,
      games:[],
      img:[
      'images/captreo.jpg',
      'images/ct1.jpg',
      'images/ct2.jpg',
      'images/ct3.jpg',
      'images/ct4.jpg',
      ],
      category: 'entertainment'
    },
    {
      id:'grand-world',
      name:'Grand World Phú Quốc',
      address:'Grand World Phú Quốc, Bãi Dài, Phú Quốc, Kiên Giang, Việt Nam',
      note:'Khu phức hợp giải trí, mua sắm và ẩm thực với kiến trúc châu Âu độc đáo.',
      extra:[
'Grand World Phú Quốc bao gồm 23 khu khác nhau với các chức năng riêng biệt: Bảo tàng gấu Teddy Bear Museum, Kênh đào Venice Phú Quốc, Công viên nghệ thuật đương đại Urban Park, Nhà tre Bamboo Legend, Quảng trường Vũ điệu Nhiệt đới',
      ],
      lat:10.3289, lng:103.8629,
      games:[],
      img:[ 
'images/grandworld.jpg',
'images/gw1.jpg', 
'images/gw2.jpg',
'images/gw3.jpg', 
'images/gw4.jpg', 
],
      category: 'entertainment'
    },
    
    // Nhóm Ẩm Thực & Làng Nghề (Đỏ pastel)
    {
      id:'nha-thung',
      name:'Nhà thùng nước mắm Phú Quốc (Phụng Hưng)',
      address:'471 Đ. Nguyễn Văn Cừ, Khu 2, Phú Quốc, Kiên Giang',
      note:'Nhà thùng nước mắm truyền thống; nghề truyền thống của đảo.',
      extra: [
      'Lịch sử nhà thùng nước mắm Phú Quốc đã có từ 200 năm trước.',
      'Tận dụng nguồn cá cơm dồi dào từ biển cả, người dân nơi đây bắt đầu tập trung sản xuất nước mắm theo phương thức ủ muối bí truyền, hình thành nên các làng nghề nước mắm sôi động trên đảo ngọc.',
      'Thiết bị chính ở các nhà thùng nước mắm Phú Quốc là những thùng gỗ có kích thước “khủng”. Thùng thường được làm bằng gỗ bời lời hoặc gỗ vên vên, cao khoảng từ 2 - 4m, đường kính khoảng 1,5 - 3m. Với kích thước “siêu to khổng lồ”, thùng có thể chứa khoảng từ 7 - 13 tấn cá cơm trên mỗi lần ủ.',
      'Thời gian ủ tối thiểu là 12 tháng. Tuy nhiên, ở một số nhà thùng nước mắm nổi tiếng Phú Quốc, thời gian ủ có thể kéo dài lên đến 15 tháng để đảm bảo cho ra đời tinh chất nước mắm hảo hạng nhất.',
      ],
      lat:10.044917, lng:104.017444,
      games:[],
      img:[
'images/nhathung.jpg', 
'images/nt1.jpg',
],
      category: 'craft'
    },
    {
      id:'ngoc-trai',
      name:'Cơ sở nuôi cấy ngọc trai (Ngọc Hiền Pearl)',
      address:'Cơ sở nuôi cấy ngọc trai Ngọc Hiền Pearl, Phú Quốc, Kiên Giang',
      note:'Cơ sở nuôi cấy và chế tác ngọc trai nổi tiếng tại Phú Quốc.',
      extra: [ 
'Cơ sở nuôi cấy ngọc trai có quy mô lớn nhất tại đảo Phú Quốc, sở hữu nông trại 1000ha và quy trình nuôi cấy kết hợp công nghệ Nhật – Úc.',
'Những món trang sức cao cấp mang giá trị thẩm mỹ và tinh thần bền vững.',
],
      lat:10.1701, lng:103.9703,
      games:[],
      img: [
'images/ngoctrai.jpg',
'images/ngoctrai1.jpg',
],
      category: 'craft'
    },
    {
      id:'ham-ninh',
      name:'Làng chài Hàm Ninh',
      address:'52JV+6XX, TL47, Rạch Hàm, Phú Quốc, Kiên Giang, Việt Nam',
      note:'Làng chài cổ, nổi tiếng hải sản tươi, ghẹ Hàm Ninh.',
      extra:['Làng chài truyền thống lâu đời', 'Nổi tiếng với ghẹ Hàm Ninh tươi ngon', 'Cảnh biển đẹp, bình yên'],
      lat:10.180917, lng:104.048472,
      games:[],
      img: [
'images/langchai.jpg', 
'images/lc1.jpg',
'images/lc2.jpg',
'images/lc3.jpg',
],
      category: 'craft'
    }
  ];

  DI_TICH.forEach(p => {
    const m = L.marker([p.lat,p.lng], {icon: createCustomIcon(p.category)}).addTo(map);
    
    m.on('mouseover', function(e) {
      if (currentTooltip) {
        document.body.removeChild(currentTooltip);
      }
      
      currentTooltip = document.createElement('div');
      currentTooltip.className = 'marker-tooltip';
      currentTooltip.textContent = p.name;
      
      const point = map.latLngToContainerPoint(e.latlng);
      currentTooltip.style.left = (point.x + 20) + 'px';
      currentTooltip.style.top = (point.y - 10) + 'px';
      
      document.body.appendChild(currentTooltip);
    });
    
    m.on('mouseout', function() {
      if (currentTooltip) {
        document.body.removeChild(currentTooltip);
        currentTooltip = null;
      }
    });
    
    m.on('click', function(e) {
      if (currentTooltip) {
        document.body.removeChild(currentTooltip);
        currentTooltip = null;
      }
      openDiModal(p);
    });
    
    m.bindPopup(`<strong>${p.name}</strong><br>${p.address}`);
  });
}

/* ---------- MODAL & GAME SYSTEMS ---------- */
let diModal;
if (document.getElementById('diModal')) {
  diModal = new bootstrap.Modal(document.getElementById('diModal'));
}
function openDiModal(p){
function openDiModal(p){
  console.log('Opening modal for:', p.name);
  console.log('Has games:', p.games && p.games.length);
  console.log('Is nha-tu:', p.id === 'nha-tu');
}
  if (!diModal) return;
  
  document.getElementById('diTitle').innerText = p.name;
  const extras = p.extra.map(x => `<li>${x}</li>`).join('');
  
  // Tạo HTML cho carousel nếu có nhiều ảnh
  let imageHTML = '';
  if (Array.isArray(p.img) && p.img.length > 0) {
    imageHTML = `
      <div id="carousel-${p.id}" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
          ${p.img.map((imgSrc, index) => `
            <div class="carousel-item ${index === 0 ? 'active' : ''}">
              <img src="${imgSrc}" class="d-block w-100" alt="${p.name} - Ảnh ${index + 1}" 
                   style="border-radius:8px;object-fit:cover;height:300px">
            </div>
          `).join('')}
        </div>
        ${p.img.length > 1 ? `
          <button class="carousel-control-prev" type="button" data-bs-target="#carousel-${p.id}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carousel-${p.id}" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        ` : ''}
      </div>
    `;
  } else {
    // Nếu chỉ có 1 ảnh
    const imgSrc = typeof p.img === 'string' ? p.img : (p.img && p.img[0] ? p.img[0] : '');
    imageHTML = `<img src="${imgSrc}" alt="${p.name}" style="width:100%;border-radius:8px;object-fit:cover;height:300px">`;
  }
  
  const html = `
    <div class="row">
      <div class="col-md-5">
        ${imageHTML}
      </div>
      <div class="col-md-7">
        <h5 class="diatic-title">${p.name}</h5>
        <p style="margin:0">${p.address}</p>
        <p style="margin-top:8px;color:#333">${p.note}</p>
        ${extras ? `<ul>${extras}</ul>` : ''}
      </div>
    </div>
  `;
  
  document.getElementById('diBody').innerHTML = html;
  document.getElementById('diCoords').innerText = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
  
  // TẠO NÚT BUTTONS CHO MODAL FOOTER
  const modalFooter = document.querySelector('#diModal .modal-footer');
  
  let buttonsHTML = `
    <div class="me-auto">
      <small class="text-muted">Toạ độ: <span id="diCoords">${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}</span></small>
    </div>
  `;
  
  // THÊM NÚT "TRẢI NGHIỆM KỂ CHUYỆN" CHO NHÀ TÙ PHÚ QUỐC
  if (p.id === 'nha-tu') {
    buttonsHTML += `
      <button id="btn-story" class="btn btn-warning">
        <i class="fas fa-book-open me-2"></i>Trải nghiệm kể chuyện
      </button>
    `;
  }
  
  // THÊM NÚT CHECK-IN
  buttonsHTML += `
    <button id="btn-checkin" class="btn btn-outline-success">
      <i class="fas fa-map-marker-alt me-2"></i>Check-in (Tôi đã đến)
    </button>
  `;
  
  // THÊM NÚT MINI-GAME NẾU CÓ
  if(p.games && p.games.length){
    buttonsHTML += `
      <button id="btn-play" class="btn btn-accent">
        <i class="fas fa-gamepad me-2"></i>Chơi mini-game
      </button>
    `;
  }
  
  // THÊM NÚT ĐÓNG
  buttonsHTML += `
    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
      <i class="fas fa-times me-2"></i>Đóng
    </button>
  `;
  
  modalFooter.innerHTML = buttonsHTML;
  
  // THÊM EVENT LISTENERS CHO CÁC NÚT
  document.getElementById('btn-checkin').onclick = () => {
    const user = getCurrentUser();
    if(!user){ 
      alert('Vui lòng đăng nhập trước khi check-in.'); 
      return; 
    }
    markVisited(p.id);
    awardBadgeSite(p.id, p.name);
    alert('✓ Check-in thành công tại ' + p.name);
  };
  
  // EVENT CHO NÚT TRẢI NGHIỆM KỂ CHUYỆN
  if (p.id === 'nha-tu') {
    document.getElementById('btn-story').onclick = () => { 
      diModal.hide(); 
      setTimeout(() => openStoryExperience(), 300);
    };
  }
  
  // EVENT CHO NÚT MINI-GAME
  if(p.games && p.games.length){
    document.getElementById('btn-play').onclick = () => { 
      diModal.hide(); 
      setTimeout(() => openGamePicker(p), 300);
    };
  }
  
  diModal.show();
}
  
function awardBadgeSite(siteId, siteName) {
  const badgeIcons = {
    'chua': 'images/hhchua.jpg',
    'nha-tu': 'images/hhnhatupq.jpg',
    'nha-thung': 'images/hhnhathung.jpg',
    'ham-ninh': 'images/hhlangchai.jpg',
    'baotang': 'images/hhcoinguon.jpg',
    'dinh-cau': 'images/hhdinhcau.jpg',
    'dinh-ntt': 'images/hhdinhntt.jpg',
    'vuon-quoc-gia': 'images/hhvuon.jpg',
    'bai-sao': 'images/hhbaisao.jpg',
    'hon-thom': 'images/hhhonthom.jpg',
    'cap-treo': 'images/hhcaptreo.jpg',
    'grand-world': 'images/hhgrandworld.jpg',
    'ngoc-trai': 'images/hhngoctrai.jpg'
  };
  
  const badgeIcon = badgeIcons[siteId] || `https://via.placeholder.com/64/C33/fff?text=${siteName.charAt(0)}`;
  awardBadge(`site_${siteId}`, siteName, badgeIcon);
}

function showBadgePopup(badgeName, badgeIcon) {
  const popup = document.getElementById('badgePopup');
  const popupImg = document.getElementById('badgePopupImg');
  const popupTitle = document.getElementById('badgePopupTitle');
  
  if (!popup || !popupImg || !popupTitle) return;
  
  popupImg.src = badgeIcon;
  popupTitle.textContent = badgeName;
  popup.style.display = 'flex';
  
  if (typeof confetti === 'function') {
    confetti({
      particleCount: 150,
      spread: 70,
      origin: { y: 0.6 },
      colors: ['#C62828', '#FFD54F', '#4CAF50', '#2196F3']
    });
  }
  
  setTimeout(() => {
    closeBadgePopup();
  }, 3000);
  
  document.getElementById('badgePopupClose').onclick = closeBadgePopup;
}

function closeBadgePopup() {
  const popup = document.getElementById('badgePopup');
  if (popup) popup.style.display = 'none';
}

/* ---------- GAME SYSTEMS ---------- */
const QUIZZES = {
  'quiz_nhatu': {
    title:'Quiz Nhà tù Phú Quốc',
    items:[
      {
        q:'Di tích Trại giam Phú Quốc được chính thức xếp hạng Di tích Quốc gia đặc biệt vào thời điểm nào?',
        opts:['Ngày 30/4/1975','Ngày 27/7/2013','Ngày 31/12/2014','Ngày 20/10/2016'],
        ans:2,
        explain:'Đáp án đúng là C. Căn cứ theo Quyết định số 2408/QĐ-TTg ngày 31/12/2014 của Thủ tướng Chính phủ.'
      },
      {
        q:'"Địa ngục trần gian" Phú Quốc chính thức tồn tại trong khoảng thời gian nào?',
        opts:['Từ năm 1949 đến năm 1954','Từ tháng 6/1967 đến tháng 3/1973','Từ năm 1965 đến năm 1975','Từ năm 1954 đến năm 1975'],
        ans:1,
        explain:'Đáp án đúng là B. Theo tư liệu, trại giam tồn tại chưa đầy 6 năm trong giai đoạn này dưới sự quản lý của chính quyền Mỹ - Ngụy.'
      }
    ]
  },
  'quiz_trungtruc': {
    title:'Quiz Đình Nguyễn Trung Trực',
    items:[
      {
        q:'Nguyễn Trung Trực là thủ lĩnh nổi tiếng của phong trào kháng chiến chống?',
        opts:['Chống Pháp','Chống Pháp và chống Mỹ','Chống Mỹ','Chống Nhật'],
        ans:0,
        explain:'Đáp án đúng là A. Nguyễn Trung Trực là thủ lĩnh nghĩa quân chống lại thực dân Pháp xâm lược ở Nam Kỳ vào nửa cuối thế kỷ 19 (từ 1861-1868).'
      },
      {
        q:'Nguyễn Trung Trực đã chỉ huy nghĩa quân đốt cháy tàu chiến nào của Pháp trên sông Vàm Cỏ Đông vào năm 1861, gây tiếng vang lớn?',
        opts:['Tàu Hy Vọng (L\'Espérance)','Tàu Hằng Tâm (La Persévérance)','Tàu Jaccaré','Tàu Avalanche'],
        ans:0,
        explain:'Đáp án đúng là A. Chiến công nổi tiếng nhất của ông là chỉ huy nghĩa quân đốt cháy tiểu hạm L\'Espérance (có tên Việt là "Hy Vọng") của Pháp trên sông Vàm Cỏ Đông năm 1861.'
      }
    ]
  }
};

const MEMORY_GAMES = {
  'memory_nhatu': {
    title: 'Memory Việt - Nhà tù Phú Quốc',
    cards: [
      { id: 1, image: 'images/nhatucard1.jpg', matchId: 2 },
      { id: 2, image: 'images/nhatutext1.jpg', matchId: 1 },
      { id: 3, image: 'images/nhatucard2.jpg', matchId: 4 },
      { id: 4, image: 'images/nhatutext2.jpg', matchId: 3 }
    ]
  },
  'memory_trungtruc': {
    title: 'Memory Việt - Đình Nguyễn Trung Trực',
    cards: [
      { id: 1, image: 'images/dinhcard1.jpg', matchId: 2 },
      { id: 2, image: 'images/dinhtext1.jpg', matchId: 1 },
      { id: 3, image: 'images/dinhcard2.jpg', matchId: 4 },
      { id: 4, image: 'images/dinhtext2.jpg', matchId: 3 }
    ]
  }
};

let currentQuiz = null;
let currentQIndex = 0;
let selectedOption = null;

function openGamePicker(site){
  const html = `<div class="text-center">
    <h4 class="mb-4">Chọn mini-game — ${site.name}</h4>
    <div class="d-flex flex-column gap-3 align-items-center">
      ${site.games.map(g=>`<button class="btn btn-accent btn-lg w-75 game-choice" data-game="${g}">${labelGame(g)}</button>`).join('')}
    </div>
    <p class="mt-4 text-muted">Mỗi mini-game có các bước thử thách. Kết quả sẽ lưu vào hồ sơ của bạn.</p>
  </div>`;
  
  showGameFullscreen('Chọn mini-game', html);
  
  document.querySelectorAll('.game-choice').forEach(btn=> btn.addEventListener('click', ()=> {
    const g = btn.dataset.game;
    startGameInstance(g, site);
  }));
}

function labelGame(id){
  const map = {
    'quiz_nhatu':'Quiz (Nhà tù)',
    'quiz_trungtruc':'Quiz (Đình)',
    'memory_nhatu':'Memory Việt (Nhà tù)',
    'memory_trungtruc':'Memory Việt (Đình)'
  };
  return map[id]||id;
}

function startGameInstance(gid, site){
  if(gid.startsWith('quiz_')) startQuiz(gid, site);
  else if(gid.startsWith('memory_')) startMemoryGame(gid, site);
  else { alert('Game chưa được hỗ trợ'); }
}

function startQuiz(quizId, site){
  const qset = QUIZZES[quizId];
  if(!qset){ alert('Quiz chưa có nội dung.'); return; }
  currentQuiz = {id:quizId, site:site, qset:qset};
  currentQIndex = 0;
  selectedOption = null;
  renderCurrentQuestion();
}

function renderCurrentQuestion(){
  const qobj = currentQuiz.qset.items[currentQIndex];
  
  const html = `
    <div class="quiz-container">
      <div class="quiz-question">
        <h5>Câu ${currentQIndex+1} / ${currentQuiz.qset.items.length}</h5>
        <p class="fs-5">${qobj.q}</p>
      </div>
      
      <div class="quiz-options" id="quizOptions">
        ${qobj.opts.map((opt, i) => `
          <div class="quiz-option" data-index="${i}">
            ${opt}
          </div>
        `).join('')}
      </div>
      
      <div class="quiz-feedback" id="quizFeedback"></div>
      
      <div class="quiz-controls">
        <button class="btn btn-outline-secondary" onclick="hideGameFullscreen()">Thoát</button>
        <button class="btn btn-accent" id="quizNextBtn" onclick="handleAnswerAndNext()" disabled>Tiếp tục</button>
      </div>
    </div>
  `;
  
  showGameFullscreen(currentQuiz.qset.title, html);
  
  document.querySelectorAll('.quiz-option').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('.quiz-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      option.classList.add('selected');
      selectedOption = parseInt(option.dataset.index);
      const quizNextBtn = document.getElementById('quizNextBtn');
      if (quizNextBtn) {
        quizNextBtn.disabled = false;
      }
    });
  });
}

function handleAnswerAndNext(){
  if(selectedOption === null){ 
    alert('Vui lòng chọn 1 đáp án'); 
    return; 
  }
  
  const qobj = currentQuiz.qset.items[currentQIndex];
  const fb = document.getElementById('quizFeedback');
  
  if(selectedOption === qobj.ans){
    fb.innerHTML = `<div class="correct">✓ Đáp án đúng</div><div class="explain mt-2">${qobj.explain}</div>`;
    fb.className = 'quiz-feedback correct';
  } else {
    fb.innerHTML = `<div class="wrong">✗ Đáp án sai</div><div class="explain mt-2">Đáp án đúng: <strong>${qobj.opts[qobj.ans]}</strong><br>${qobj.explain}</div>`;
    fb.className = 'quiz-feedback wrong';
  }
  
  setTimeout(()=> {
    currentQIndex++;
    if(currentQIndex < currentQuiz.qset.items.length){
      selectedOption = null;
      renderCurrentQuestion();
    } else {
      recordDone(currentQuiz.site.id, currentQuiz.id);
      showVictory('🎉 Xuất sắc! Bạn đã hoàn thành quiz!');
      hideGameFullscreen();
    }
  }, 1500);
}

let currentMemoryGame = null;
let flippedCards = [];
let matchedPairs = 0;
let canFlip = true;
let flipCount = 0;

function startMemoryGame(gameId, site) {
  const gameData = MEMORY_GAMES[gameId];
  if (!gameData) {
    alert('Game Memory Việt chưa có nội dung.');
    return;
  }
  currentMemoryGame = { id: gameId, site: site, gameData: gameData };
  flippedCards = [];
  matchedPairs = 0;
  canFlip = true;
  flipCount = 0;
  const html = `
    <div class="memory-container text-center">
      <h4 class="mb-3">${gameData.title}</h4>
      <div class="memory-stats mb-3">
        <span class="badge bg-primary">Cặp đã tìm: <span id="matchedCount">0</span>/2</span>
        <span class="badge bg-secondary ms-2">Lượt lật: <span id="flipCount">0</span></span>
      </div>
      
      <div class="memory-board" id="memoryBoard">
        <!-- Cards will be generated here -->
      </div>
      
      <div class="memory-controls mt-4">
        <button class="btn btn-accent" onclick="finishMemoryGame()">Hoàn thành</button>
        <button class="btn btn-outline-secondary" onclick="resetMemoryGame()">Chơi lại</button>
      </div>
      
      <div class="memory-complete mt-3" id="memoryComplete" style="display: none;">
        <div class="alert alert-success">
          <h5>🎉 Chúc mừng!</h5>
          <p>Bạn đã hoàn thành game Memory Việt!</p>
        </div>
      </div>
    </div>
  `;
  showGameFullscreen(gameData.title, html);
  initializeMemoryGame();
}

function initializeMemoryGame() {
  const board = document.getElementById('memoryBoard');
  const gameData = currentMemoryGame.gameData;
  
  const shuffledCards = [...gameData.cards].sort(() => Math.random() - 0.5);
  
  board.innerHTML = shuffledCards.map(card => `
    <div class="memory-card" data-card-id="${card.id}" data-match-id="${card.matchId}">
      <div class="card-inner">
        <div class="card-front">
          <div class="card-content">
            <i class="fas fa-question"></i>
          </div>
        </div>
        <div class="card-back">
          <div class="card-content">
            <img src="${card.image}" alt="Memory card" onerror="this.style.display='none'">
          </div>
        </div>
      </div>
    </div>
  `).join('');
  document.querySelectorAll('.memory-card').forEach(card => {
    card.addEventListener('click', handleCardClick);
  });
  flipCount = 0;
  updateFlipCount();
}

function handleCardClick() {
  if (!canFlip) return;
  if (this.classList.contains('flipped') || this.classList.contains('matched')) return;
  if (flippedCards.length >= 2) return;
  this.classList.add('flipped');
  flippedCards.push(this);
  flipCount++;
  updateFlipCount();
  if (flippedCards.length === 2) {
    canFlip = false;
    setTimeout(checkForMatch, 800);
  }
}

function checkForMatch() {
  const [card1, card2] = flippedCards;
  const matchId1 = card1.dataset.matchId;
  const matchId2 = card2.dataset.matchId;
  if (card1.dataset.cardId === matchId2 && card2.dataset.cardId === matchId1) {
    card1.classList.add('matched');
    card2.classList.add('matched');
    matchedPairs++;
    updateMatchedCount();
    if (matchedPairs === 2) {
      setTimeout(() => {
        const memoryComplete = document.getElementById('memoryComplete');
        if (memoryComplete) {
          memoryComplete.style.display = 'block';
        }
        showVictory('🎉 Xuất sắc! Bạn đã hoàn thành Memory Việt!');
      }, 500);
    }
  } else {
    card1.classList.remove('flipped');
    card2.classList.remove('flipped');
  }
  flippedCards = [];
  canFlip = true;
}

function updateMatchedCount() {
  const matchedCount = document.getElementById('matchedCount');
  if (matchedCount) {
    matchedCount.textContent = matchedPairs;
  }
}

function updateFlipCount() {
  const flipCountElement = document.getElementById('flipCount');
  if (flipCountElement) {
    flipCountElement.textContent = flipCount;
  }
}

function resetMemoryGame() {
  flippedCards = [];
  matchedPairs = 0;
  canFlip = true;
  flipCount = 0;
  
  document.querySelectorAll('.memory-card').forEach(card => {
    card.classList.remove('flipped', 'matched');
  });
  
  const memoryComplete = document.getElementById('memoryComplete');
  if (memoryComplete) {
    memoryComplete.style.display = 'none';
  }
  
  updateMatchedCount();
  updateFlipCount();
  
  const board = document.getElementById('memoryBoard');
  const cards = Array.from(board.children);
  cards.sort(() => Math.random() - 0.5);
  cards.forEach(card => board.appendChild(card));
}

function finishMemoryGame() {
  if (matchedPairs === 2) {
    recordDone(currentMemoryGame.site.id, currentMemoryGame.id);
    hideGameFullscreen();
  } else {
    alert(`Bạn đã tìm được ${matchedPairs}/2 cặp thẻ. Hãy tiếp tục!`);
  }
}

/* ---------- GAME FULLSCREEN MODE ---------- */
const gameFullscreen = document.getElementById('gameFullscreen');
const gameFullscreenTitle = document.getElementById('gameFullscreenTitle');
const gameFullscreenBody = document.getElementById('gameFullscreenBody');
const gameFullscreenClose = document.getElementById('gameFullscreenClose');

if (gameFullscreenClose) {
  gameFullscreenClose.addEventListener('click', () => {
    hideGameFullscreen();
  });
}

function showGameFullscreen(title, content) {
  if (!gameFullscreenTitle || !gameFullscreenBody) return;
  
  gameFullscreenTitle.textContent = title;
  gameFullscreenBody.innerHTML = content;
  gameFullscreen.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function hideGameFullscreen() {
  if (gameFullscreen) {
    gameFullscreen.classList.remove('active');
    document.body.style.overflow = 'auto';
  }
}

/* ---------- Victory Popup ---------- */
const victoryPopup = document.getElementById('victoryPopup');
const victoryMessage = document.getElementById('victoryMessage');
const victoryClose = document.getElementById('victoryClose');

if (victoryClose) {
  victoryClose.addEventListener('click', () => {
    if (victoryPopup) {
      victoryPopup.style.display = 'none';
    }
  });
}

function showVictory(message) {
  if (!victoryMessage || !victoryPopup) return;
  
  victoryMessage.textContent = message;
  victoryPopup.style.display = 'flex';
  
  if (typeof confetti === 'function') {
    confetti({
      particleCount: 200,
      spread: 100,
      origin: { y: 0.3 },
      colors: ['#C62828', '#FFD54F', '#4CAF50', '#2196F3'],
      startVelocity: 30,
      gravity: 0.8
    });
    
    setTimeout(() => {
      confetti({
        particleCount: 100,
        angle: 60,
        spread: 80,
        origin: { x: 0, y: 0.5 },
        colors: ['#C62828', '#FFD54F']
      });
      confetti({
        particleCount: 100,
        angle: 120,
        spread: 80,
        origin: { x: 1, y: 0.5 },
        colors: ['#4CAF50', '#2196F3']
      });
    }, 500);
  }
}

/* ---------- KHỞI TẠO DATA ---------- */
function initData() {
  // Khởi tạo stories nếu chưa có
  if (!localStorage.getItem('pq_stories')) {
    localStorage.setItem('pq_stories', JSON.stringify([]));
  }
}

/* ---------- EVENT LISTENERS ---------- */
const authModal = new bootstrap.Modal(document.getElementById('authModal'));

document.getElementById('btn-profile-register').addEventListener('click', () => {
  document.getElementById('authTitle').innerText = 'Đăng ký';
  document.getElementById('authSubmit').onclick = authRegister;
  document.getElementById('authAlert').classList.add('d-none');
  authModal.show();
});

document.getElementById('btn-profile-login').addEventListener('click', () => {
  document.getElementById('authTitle').innerText = 'Đăng nhập';
  document.getElementById('authSubmit').onclick = authLogin;
  document.getElementById('authAlert').classList.add('d-none');
  authModal.show();
});

document.getElementById('btn-profile-logout').addEventListener('click', logoutUser);

document.getElementById('btn-start').addEventListener('click', () => {
  showPage('map');
  window.scrollTo(0,0);
});

// Stories event listeners
document.getElementById('addStoryBtn').addEventListener('click', () => {
  const user = getCurrentUser();
  if (!user) {
    alert('Vui lòng đăng nhập để chia sẻ câu chuyện.');
    showPage('profile');
    return;
  }
  document.getElementById('storyModalOverlay').classList.add('active');
});

document.getElementById('storyModalClose').addEventListener('click', () => {
  document.getElementById('storyModalOverlay').classList.remove('active');
});

document.getElementById('storyModalOverlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('storyModalOverlay')) {
    document.getElementById('storyModalOverlay').classList.remove('active');
  }
});

document.getElementById('uploadAreaNew').addEventListener('click', () => {
  document.getElementById('fileInputNew').click();
});

document.getElementById('fileInputNew').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      let previewHTML = '';
      
      if (file.type.startsWith('image/')) {
        previewHTML = `<img src="${e.target.result}" alt="Preview">`;
      } else if (file.type.startsWith('video/')) {
        previewHTML = `<video controls><source src="${e.target.result}" type="${file.type}">Trình duyệt của bạn không hỗ trợ video.</video>`;
      } else if (file.type.startsWith('audio/')) {
        previewHTML = `<audio controls><source src="${e.target.result}" type="${file.type}">Trình duyệt của bạn không hỗ trợ audio.</audio>`;
      } else {
        previewHTML = `<p>File: ${file.name}</p>`;
      }
      
      previewHTML += `<button class="remove-file" onclick="removeFile()">Xóa</button>`;
      document.getElementById('filePreviewNew').innerHTML = previewHTML;
      document.getElementById('filePreviewNew').style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
});

function removeFile() {
  document.getElementById('filePreviewNew').style.display = 'none';
  document.getElementById('fileInputNew').value = '';
}

document.getElementById('storyContentNew').addEventListener('input', () => {
  const content = document.getElementById('storyContentNew').value;
  const words = content.trim() === '' ? 0 : content.trim().split(/\s+/).length;
  document.getElementById('wordCount').textContent = `${words}/200 từ`;
  
  if (words > 200) {
    document.getElementById('wordCount').classList.add('warning');
    document.getElementById('btnPostStory').disabled = true;
  } else {
    document.getElementById('wordCount').classList.remove('warning');
    document.getElementById('btnPostStory').disabled = false;
  }
});

  document.getElementById('btnPostStory').addEventListener('click', async (e) => {
  e.preventDefault();
  
  const title = document.getElementById('storyTitleNew').value;
  const content = document.getElementById('storyContentNew').value;
  const user = getCurrentUser();
  
  if (!user) {
    alert('Vui lòng đăng nhập để chia sẻ câu chuyện.');
    return;
  }
  
  if (!title || !content) {
    alert('Vui lòng điền tiêu đề và nội dung câu chuyện.');
    return;
  }
  
  const words = content.trim().split(/\s+/).length;
  if (words > 200) {
    alert('Nội dung câu chuyện vượt quá 200 từ. Vui lòng rút gọn.');
    return;
  }
  
  const storyId = Date.now().toString();
  
  const newStory = {
    id: storyId,
    title: title,
    content: content,
    author: user.name,
    authorId: user.id,
    timestamp: new Date().toISOString(),
    likes: 0,
    likedBy: [],
    comments: [],
    media: document.getElementById('fileInputNew').files[0] ? URL.createObjectURL(document.getElementById('fileInputNew').files[0]) : null,
    mediaType: document.getElementById('fileInputNew').files[0] ? document.getElementById('fileInputNew').files[0].type : null,
    colorClass: `note-color-${Math.floor(Math.random() * 8) + 1}`
  };
  
  // Thêm story vào mảng local
  stories.unshift(newStory);
  
  // Lưu vào Firestore
  const firestoreSuccess = await saveStoryToFirestore(newStory);
  
  if (!firestoreSuccess) {
    // Nếu Firestore thất bại, lưu vào localStorage
    saveStories();
  }
  
  // Cập nhật giao diện
  renderStories();
  
  // Đóng modal
  document.getElementById('storyModalOverlay').classList.remove('active');
  
  // Reset form
  document.getElementById('storyFormNew').reset();
  document.getElementById('filePreviewNew').style.display = 'none';
  document.getElementById('fileInputNew').value = '';
  document.getElementById('wordCount').textContent = '0/200 từ';
  document.getElementById('wordCount').classList.remove('warning');
  
  // Hiển thị thông báo thành công
  showSuccessMessage();
});
function showSuccessMessage() {
  const successMessage = document.getElementById('successMessage');
  if (successMessage) {
    successMessage.classList.add('show');
    
    setTimeout(() => {
      successMessage.classList.remove('show');
    }, 5000);
  }
}

document.getElementById('successClose').addEventListener('click', () => {
  document.getElementById('successMessage').classList.remove('show');
});

/* ---------- ANALYTICS ---------- */
function renderAnalytics() {
  // Placeholder for analytics functionality
  document.getElementById('totalVisitors').textContent = '0';
  document.getElementById('uniqueVisitors').textContent = '0';
  document.getElementById('registeredUsers').textContent = '0';
  document.getElementById('totalStories').textContent = stories.length;
  
  document.getElementById('pageViewsChart').innerHTML = '<p class="text-muted">Chưa có dữ liệu</p>';
  document.getElementById('deviceChart').innerHTML = '<p class="text-muted">Chưa có dữ liệu</p>';
  document.getElementById('recentActivity').innerHTML = '<p class="text-muted">Chưa có hoạt động nào</p>';
}
/* ---------- STORYTELLING EXPERIENCE ---------- */
let currentStoryPage = 1;
const totalStoryPages = 4;
let storyTyped = null;

function openStoryExperience() {
  currentStoryPage = 1;
  const storyModal = new bootstrap.Modal(document.getElementById('storyModal'));
  storyModal.show();
  
  // Khởi tạo AOS
  AOS.init({
    duration: 800,
    once: true
  });
  
  // Reset progress
  updateStoryProgress();
  
  // Khởi tạo typed.js sau khi modal hiển thị
  setTimeout(() => {
    if (!storyTyped) {
      storyTyped = new Typed('#typed-question', {
        strings: ['Bạn có biết nơi nào từng được mệnh danh là "địa ngục trần gian"...^1000\nnhưng cũng là biểu tượng của ý chí kiên cường?'],
        typeSpeed: 40,
        backSpeed: 0,
        backDelay: 1000,
        startDelay: 500,
        showCursor: true,
        cursorChar: '|',
        loop: false
      });
    }
  }, 500);
}

function nextPage(nextPageNum) {
  if (nextPageNum > totalStoryPages) return;
  
  // Ẩn trang hiện tại
  document.getElementById(`page${currentStoryPage}`).classList.remove('active');
  
  // Hiển thị trang mới
  currentStoryPage = nextPageNum;
  document.getElementById(`page${currentStoryPage}`).classList.add('active');
  
  // Cập nhật progress
  updateStoryProgress();
  
  // Refresh AOS để kích hoạt animation
  setTimeout(() => {
    AOS.refresh();
  }, 300);
}

function prevPage(prevPageNum) {
  if (prevPageNum < 1) return;
  
  document.getElementById(`page${currentStoryPage}`).classList.remove('active');
  currentStoryPage = prevPageNum;
  document.getElementById(`page${currentStoryPage}`).classList.add('active');
  updateStoryProgress();
  
  setTimeout(() => {
    AOS.refresh();
  }, 300);
}

function updateStoryProgress() {
  const progress = (currentStoryPage / totalStoryPages) * 100;
  document.getElementById('storyProgress').style.width = `${progress}%`;
}

function closeStoryModal() {
  const storyModal = bootstrap.Modal.getInstance(document.getElementById('storyModal'));
  storyModal.hide();
  
  // Ghi nhận user đã xem story
  const user = getCurrentUser();
  if (user) {
    recordDone('nha-tu', 'story_experience');
  }
}

function restartStory() {
  nextPage(1);
}

// Cập nhật hàm openDiModal để thêm nút mới
function openDiModal(p) {
  if (!diModal) return;
  
  // ... phần code hiện tại giữ nguyên ...
  
  // THÊM NÚT MỚI - đặt sau nút check-in
  const btnPlay = document.getElementById('btn-play');
  if(p.games && p.games.length){
    btnPlay.style.display = 'inline-block';
    btnPlay.onclick = () => { diModal.hide(); openGamePicker(p); };
  } else { 
    btnPlay.style.display = 'none'; 
    btnPlay.onclick = null; 
  }
  
  // THÊM NÚT TRẢI NGHIỆM KỂ CHUYỆN - chỉ cho Nhà tù Phú Quốc
  let storyBtnHtml = '';
  if (p.id === 'nha-tu') {
    storyBtnHtml = `<button id="btn-story" class="btn btn-warning">
      <i class="fas fa-book-open me-2"></i>Trải nghiệm kể chuyện
    </button>`;
  }
  
  document.getElementById('btn-checkin').onclick = () => {
    const user = getCurrentUser();
    if(!user){ 
      alert('Vui lòng đăng nhập trước khi check-in.'); 
      return; 
    }
    markVisited(p.id);
    awardBadgeSite(p.id, p.name);
  };
  
  // Thêm nút story vào modal footer
  const modalFooter = document.querySelector('#diModal .modal-footer');
  if (p.id === 'nha-tu') {
    modalFooter.innerHTML = `
      <div class="me-auto">
        <small class="text-muted">Toạ độ: <span id="diCoords"></span></small>
      </div>
      ${storyBtnHtml}
      <button id="btn-checkin" class="btn btn-outline-success">Check-in (Tôi đã đến)</button>
      <button id="btn-play" class="btn btn-accent" style="display:none">Chơi mini-game</button>
      <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
    `;
    
    // Thêm event listener cho nút story
    document.getElementById('btn-story').onclick = () => { 
      diModal.hide(); 
      setTimeout(() => openStoryExperience(), 300);
    };
  }
  
  diModal.show();
}
</script>
</body>
</html>

